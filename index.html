<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™© (Public View v9.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; aspect-ratio: 1/1; cursor: pointer; border: 1px solid transparent; }
        @media (min-width: 1024px) { .calendar-day { min-height: 56px; } }
        .calendar-day:hover { background-color: #f9fafb; border-color: #fbcfe8; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-day.not-current { opacity: 0.2; pointer-events: none; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
        .event-dot { width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.today .event-dot { background-color: white; }
        
        .event-snippet { 
            font-size: 10px; 
            color: #1f2937; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
            margin-top: 3px; 
            line-height: 1.2; 
            font-weight: 800; 
            background-color: rgba(236, 72, 153, 0.18); 
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (min-width: 1024px) { .event-snippet { font-size: 11px; } }
        .calendar-day.today .event-snippet { color: white; background-color: rgba(255, 255, 255, 0.2); }
        .calendar-day.thursday .event-snippet { color: #be123c; background-color: rgba(159, 18, 57, 0.13); }

        .score-zero { background-color: #fee2e2 !important; color: #ef4444 !important; }
        .score-cell { transition: background 0.2s; }
        .score-cell:hover { background-color: #f8fafb; }

        /* Mobile Card Styles for Members */
        .member-card {
            background: white;
            border: 1px solid #f3f4f6;
            border-radius: 1.25rem;
            padding: 1rem;
            transition: all 0.2s;
        }
        .member-card:hover {
            border-color: #fbcfe8;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.08);
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @supports (padding-top: env(safe-area-inset-top)) { body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); } }
        @media (max-width: 640px) {
            .calendar-grid { gap: 0.125rem; font-size: 0.65rem; }
            .calendar-day { min-height: 38px; padding: 0.125rem; }
            .calendar-head { font-size: 0.6rem; padding-bottom: 4px; }
            .event-snippet { font-size: 8px; padding: 0px 1px; }
            #msgBox { left: 1rem; right: 1rem; transform: translateX(0) translateY(100px) !important; width: auto; padding: 0.75rem 1rem; }
            #msgBox.show { transform: translateX(0) translateY(0) !important; }
        }
        @media (max-width: 768px) { table { font-size: 0.65rem; } table th, table td { padding: 0.5rem 0.375rem !important; } table th { font-size: 9px; } }
        .overflow-y-auto, .overflow-x-auto { -webkit-overflow-scrolling: touch; }
        .nav-item, button { -webkit-tap-highlight-color: transparent; }

        /* Sticky first column for analysis table on mobile */
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table thead th:nth-child(2),
        .analysis-table-wrap table tbody td:nth-child(1),
        .analysis-table-wrap table tbody td:nth-child(2) {
            position: sticky;
            z-index: 20;
            background: inherit;
        }
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table tbody td:nth-child(1) {
            left: 0;
        }
        .analysis-table-wrap table thead th:nth-child(2),
        .analysis-table-wrap table tbody td:nth-child(2) {
            left: 50px;
        }
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table thead th:nth-child(2) {
            background: #f9fafb;
        }
        .analysis-table-wrap table tbody tr td:nth-child(1),
        .analysis-table-wrap table tbody tr td:nth-child(2) {
            background: white;
        }
        .analysis-table-wrap table tbody tr:hover td:nth-child(1),
        .analysis-table-wrap table tbody tr:hover td:nth-child(2) {
            background: #f9fafb;
        }
        .analysis-table-wrap table tbody tr td:nth-child(2) {
            border-right: 2px solid #f3f4f6;
        }
        .analysis-table-wrap table thead th:nth-child(2) {
            border-right: 2px solid #e5e7eb;
        }

        /* Sticky columns for analysis table



        thead th { position: sticky; top: 0; z-index: 20; background: inherit; }



        /* Sticky table header */
        .stick-head { border-collapse: separate; border-spacing: 0; }
        .stick-head thead th { position: sticky; top: 0; z-index: 10; background: #f9fafb; }

        /* ===== DARK MODE ===== */
        body.dark { background-color: #0f1117; color: #c9cdd4; }
        body.dark .bg-gray-50, body.dark main { background-color: #0f1117 !important; }
        body.dark .bg-white, body.dark .member-card { background-color: #1a1d27 !important; color: #c9cdd4; border-color: #2a2d3a !important; }
        body.dark aside { background-color: #14161e !important; border-color: #2a2d3a !important; }
        body.dark header { background-color: #14161e !important; border-color: #2a2d3a !important; }
        body.dark .border-gray-100, body.dark .border-gray-200, body.dark .border-gray-50 { border-color: #2a2d3a !important; }
        body.dark .text-gray-800, body.dark .text-slate-800 { color: #e0e3ea !important; }
        body.dark .text-gray-700 { color: #b8bcc6 !important; }
        body.dark .text-gray-600 { color: #8b90a0 !important; }
        body.dark .text-gray-500 { color: #6b7080 !important; }
        body.dark .text-gray-400 { color: #555a6a !important; }
        body.dark .bg-gray-100 { background-color: #22252f !important; }
        body.dark .bg-gray-50 { background-color: #1a1d27 !important; }
        body.dark input, body.dark select { background-color: #22252f !important; color: #c9cdd4 !important; border-color: #333848 !important; }
        body.dark input::placeholder { color: #555a6a !important; }

        /* í…Œì´ë¸” */
        body.dark table thead { background-color: #14161e !important; }
        body.dark table thead th { background-color: #14161e !important; color: #6b7080 !important; border-color: #2a2d3a !important; }
        body.dark table tbody td { background-color: #1a1d27 !important; border-color: #22252f !important; }
        body.dark table tbody tr:hover td { background-color: #22252f !important; }
        body.dark .stick-head thead th { background: #14161e !important; }
        body.dark .analysis-table-wrap table tbody tr td:nth-child(1),
        body.dark .analysis-table-wrap table tbody tr td:nth-child(2) { background: #1a1d27 !important; }
        body.dark .analysis-table-wrap table tbody tr:hover td:nth-child(1),
        body.dark .analysis-table-wrap table tbody tr:hover td:nth-child(2) { background: #22252f !important; }
        body.dark .analysis-table-wrap table thead th:nth-child(1),
        body.dark .analysis-table-wrap table thead th:nth-child(2) { background: #14161e !important; }
        body.dark .analysis-table-wrap table tbody tr td:nth-child(2) { border-right-color: #2a2d3a !important; }
        body.dark .analysis-table-wrap table thead th:nth-child(2) { border-right-color: #333848 !important; }

        /* ì‚¬ì´ë“œë°” */
        body.dark .nav-item:hover { background-color: #22252f !important; }
        body.dark .nav-item.active { background-color: #1e1a2e !important; color: #c084fc !important; box-shadow: inset 4px 0 0 #a855f7 !important; }
        body.dark .bg-gray-50\/50 { background-color: #14161e !important; }

        /* ê·¸ë¦¼ì ì œê±° (ë‹¤í¬ì—ì„  ì•ˆ ë³´ì„) */
        body.dark .shadow-sm, body.dark .shadow-lg, body.dark .shadow-md { box-shadow: none !important; }

        /* ë¡œë”© */
        body.dark #loadingOverlay { background: #0f1117 !important; }

        /* í•‘í¬/ì»¬ëŸ¬í’€ ìš”ì†Œë“¤ â†’ ë‹¤í¬ëª¨ë“œì—ì„œ ë®¤íŠ¸ */
        body.dark .bg-pink-50, body.dark .bg-pink-50\/30 { background-color: rgba(168,85,247,0.08) !important; }
        body.dark .text-pink-600, body.dark .text-pink-500 { color: #a78bfa !important; }
        body.dark .border-pink-100, body.dark .border-pink-50 { border-color: #2a2540 !important; }
        body.dark .bg-red-50, body.dark .bg-red-50\/20, body.dark .bg-red-50\/50 { background-color: rgba(239,68,68,0.08) !important; }
        body.dark .text-red-500, body.dark .text-red-600, body.dark .text-red-400 { color: #f87171 !important; }
        body.dark .border-red-100 { border-color: #3a2020 !important; }
        body.dark .text-blue-500, body.dark .text-blue-600 { color: #93c5fd !important; }
        body.dark .text-green-500, body.dark .text-green-600 { color: #86efac !important; }
        body.dark .text-amber-500, body.dark .text-amber-600 { color: #fbbf24 !important; }
        body.dark .text-orange-500 { color: #fb923c !important; }
        body.dark .text-purple-600, body.dark .text-purple-500 { color: #c084fc !important; }
        body.dark .text-indigo-500 { color: #a5b4fc !important; }

        /* ë±ƒì§€/íƒœê·¸ â†’ ë‹¤í¬ì—ì„œ í†µì¼ëœ ë®¤íŠ¸ í†¤ */
        body.dark [style*="background:#fdf2f8"], body.dark [style*="background:#fff1f2"],
        body.dark [style*="background:#eef2ff"], body.dark [style*="background:#fefce8"],
        body.dark [style*="background:#eff6ff"], body.dark [style*="background:#fffbeb"] {
            background: #22252f !important; border-color: #333848 !important;
        }

        /* ê¸¸ë“œ ë±ƒì§€ ìƒ‰ìƒ ë®¤íŠ¸ */
        body.dark .bg-pink-500, body.dark .bg-rose-600 { background-color: #7c3aed !important; }
        body.dark .bg-indigo-500 { background-color: #6366f1 !important; }
        body.dark .bg-amber-500 { background-color: #d97706 !important; }
        body.dark .bg-blue-500 { background-color: #3b82f6 !important; }
        body.dark .bg-orange-500 { background-color: #ea580c !important; }

        /* MVP ì¹´ë“œ â†’ ë‹¤í¬ì—ì„  ë‹¨ìƒ‰ ë°°ê²½ */
        body.dark .bg-gradient-to-br { background: #1a1d27 !important; }
        body.dark [class*="from-blue-50"], body.dark [class*="from-yellow-50"],
        body.dark [class*="from-emerald-50"], body.dark [class*="from-purple-50"] {
            background: #1a1d27 !important;
        }
        body.dark [class*="border-blue-100"], body.dark [class*="border-orange-100"],
        body.dark [class*="border-emerald-100"], body.dark [class*="border-purple-100"] {
            border-color: #2a2d3a !important;
        }
        body.dark .bg-white\/40 { background-color: rgba(255,255,255,0.05) !important; }

        /* ê°€ì´ë“œ í˜ì´ì§€ */
        body.dark .bg-gradient-to-r { background: #1a1d27 !important; }
        body.dark [class*="from-pink-50"] { background: #1a1d27 !important; }

        /* ìº˜ë¦°ë” */
        body.dark .calendar-day { color: #8b90a0; }
        body.dark .calendar-day:hover { background-color: #22252f; border-color: #333848; }
        body.dark .calendar-day.today { background-color: #7c3aed; color: white; }
        body.dark .calendar-day.thursday { background-color: rgba(124,58,237,0.15); color: #c084fc; border-color: rgba(124,58,237,0.3); }
        body.dark .event-snippet { background-color: rgba(124,58,237,0.15); color: #c9cdd4; }
        body.dark .calendar-day.today .event-snippet { background-color: rgba(255,255,255,0.15); color: white; }
        body.dark .calendar-day.thursday .event-snippet { color: #c084fc; background-color: rgba(124,58,237,0.12); }

        /* í–‰ í•˜ì´ë¼ì´íŠ¸ (ì§ìœ„ë³„) â†’ ë‹¤í¬ëª¨ë“œì—ì„œëŠ” JSì—ì„œ ì§ì ‘ ì²˜ë¦¬ */
        body.dark .hover\:bg-pink-50\/30:hover { background-color: rgba(124,58,237,0.1) !important; }

        /* ë²„íŠ¼ */
        body.dark .bg-pink-500 { background-color: #7c3aed !important; }
        body.dark .hover\:bg-pink-100:hover { background-color: #22252f !important; }
        body.dark .hover\:bg-gray-100:hover { background-color: #22252f !important; }

        /* ìŠ¤í¬ë¡¤ë°” */
        body.dark ::-webkit-scrollbar-track { background: #14161e; }
        body.dark ::-webkit-scrollbar-thumb { background: #333848; }
        body.dark ::-webkit-scrollbar-thumb:hover { background: #444a5a; }

        /* ëª¨ë‹¬ */
        body.dark .personal-suro-content { background: #1a1d27; }

        /* ê°œì¸ ìˆ˜ë¡œ ëª¨ë‹¬ */
        .personal-suro-modal { position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem; }
        .personal-suro-content { background:white;border-radius:1.5rem;width:100%;max-width:500px;max-height:85vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden; }

        /* ëª¨ë°”ì¼ ìˆ˜ë¡œ ë¶„ì„ ìµœì í™” */
        @media (max-width: 640px) {
            .grid-cols-3 { grid-template-columns: 1fr !important; }
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr) !important; }
            .analysis-table-wrap table { font-size: 0.6rem; }
            .analysis-table-wrap table th, .analysis-table-wrap table td { padding: 0.375rem 0.25rem !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <div id="loadingOverlay">
        <div class="text-center w-72">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-2xl mx-auto mb-6">ëš </div>
            <p class="text-gray-800 font-black text-lg tracking-tight mb-1">ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬</p>
            <p id="loadingStatus" class="text-gray-400 font-bold text-xs mb-6">ì„œë²„ ì—°ê²° ì¤‘...</p>
            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden mb-3">
                <div id="loadingBar" class="h-full bg-gradient-to-r from-pink-400 to-rose-400 rounded-full transition-all duration-500 ease-out" style="width:5%"></div>
            </div>
            <p id="loadingPct" class="text-[10px] text-gray-300 font-bold">0%</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-4 right-4 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 z-[200] bg-slate-900 text-white px-5 lg:px-8 py-3 lg:py-4 rounded-xl lg:rounded-2xl shadow-2xl flex items-center gap-3 lg:gap-4 border border-white/10 max-w-md mx-auto sm:mx-0">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-[1000] w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-200 text-xl">ëš </div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™©</h1><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">PUBLIC VIEW</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto no-scrollbar">
            <p class="px-4 pt-1 pb-1 text-[9px] text-gray-400 font-bold uppercase tracking-widest">ê¸¸ë“œ ì•ˆë‚´</p>
            <button onclick="router('guide_intro')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_intro"><i class="fas fa-heart w-5 text-center text-xs"></i><span>ê¸¸ë“œ ì†Œê°œ</span></button>
            <button onclick="router('guide_ranks')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_ranks"><i class="fas fa-medal w-5 text-center text-xs"></i><span>ì§ìœ„ & ë¶€ìº</span></button>
            <button onclick="router('guide_links')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_links"><i class="fas fa-link w-5 text-center text-xs"></i><span>ë§í¬ ëª¨ìŒ</span></button>
            <div class="my-2 border-t border-gray-200"></div>
            <p class="px-4 pt-1 pb-1 text-[9px] text-gray-400 font-bold uppercase tracking-widest">ê¸¸ë“œ ë°ì´í„°</p>
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard"><i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members"><i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ëª©ë¡</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis"><i class="fas fa-chart-line w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="bail"><i class="fas fa-gem w-5 text-center"></i><span>ë³´ì„ê¸ˆ í˜„í™©</span></button>
            <button onclick="router('penalty')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="penalty"><i class="fas fa-exclamation-triangle w-5 text-center"></i><span>ë²Œì  í˜„í™©</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> Database Connected</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-[990] hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative z-0">
        <header class="h-14 lg:h-16 bg-white border-b border-gray-200 flex items-center justify-between px-3 lg:px-8 shrink-0 z-10 shadow-sm relative">
            <div class="flex items-center gap-2 lg:gap-4 min-w-0"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600 shrink-0"><i class="fas fa-bars text-lg"></i></button><h2 id="pageTitle" class="text-base lg:text-xl font-bold text-gray-800 tracking-tight truncate">ëŒ€ì‹œë³´ë“œ</h2></div>
            <div class="flex items-center gap-2 lg:gap-4 shrink-0">
                <div class="px-3 lg:px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-[10px] lg:text-[11px] font-bold border border-pink-100 shadow-sm hidden sm:block">
                    âœ¨ <span id="anniversaryLabel">ë¡œë”© ì¤‘...</span>
                </div>
                <div class="flex items-center gap-1" id="totalMembersCount">
                    <span class="text-[9px] lg:text-[10px] text-gray-300 font-bold">ë¡œë”© ì¤‘...</span>
                </div>
                <button id="darkToggle" onclick="window.toggleDark()" class="w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm" title="ë‹¤í¬ëª¨ë“œ"><i class="fas fa-adjust text-xs lg:text-base"></i></button>
                <button id="refreshBtn" onclick="fetchMembers()" class="w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt text-xs lg:text-base"></i></button>

            <button id="loginBtn" onclick="window.doLogin()" class="px-3 py-1.5 bg-pink-500 text-white rounded-xl text-[10px] font-bold hover:bg-pink-600 transition-all"><i class="fas fa-lock mr-1"></i>ê´€ë¦¬ì</button>
            <div id="userInfo" class="hidden flex items-center gap-2">
                <span id="userName" class="text-[10px] font-bold text-gray-500"></span>
                <button onclick="window.doLogout()" class="text-[10px] text-gray-400 hover:text-red-500 font-bold"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            </div>
        </header>
        <div id="contentArea" class="flex-1 overflow-y-auto p-2 sm:p-3 lg:p-6 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <div id="eventDetailModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 lg:p-10 border border-gray-50 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-5 lg:mb-6 shrink-0">
                <h3 id="eventDetailDate" class="text-xl lg:text-2xl font-black text-slate-800 tracking-tighter">Date</h3>
                <button onclick="closeModal('eventDetailModal')" class="text-gray-400 hover:text-gray-600 text-lg lg:text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="eventListForDate" class="flex flex-col gap-2 overflow-y-auto no-scrollbar max-h-[60vh]">
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://luglshrfkkeacmefnvlm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1Z2xzaHJma2tlYWNtZWZudmxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjE0NTIsImV4cCI6MjA4NzYzNzQ1Mn0.LrJ-ejXJGqVGzrJyL5nFW45J92-MxrcKuEpE2EGNsIo';
        const supaDb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["íˆì–´ë¡œ","íŒ”ë¼ë”˜","ë‹¤í¬ë‚˜ì´íŠ¸","ì•„í¬ë©”ì´ì§€(ë¶ˆ,ë…)","ì•„í¬ë©”ì´ì§€(ì¬,ì½œ)","ë¹„ìˆ","ë³´ìš°ë§ˆìŠ¤í„°","ì‹ ê¶","íŒ¨ìŠ¤íŒŒì¸ë”","ë‚˜ì´íŠ¸ë¡œë“œ","ì„€ë„ì–´","ë“€ì–¼ë¸”ë ˆì´ë“œ","ë°”ì´í¼","ìº¡í‹´","ìºë…¼ë§ˆìŠ¤í„°","ë¯¸í•˜ì¼","ì†Œìš¸ë§ˆìŠ¤í„°","í”Œë ˆì„ìœ„ìë“œ","ìœˆë“œë¸Œë ˆì´ì»¤","ë‚˜ì´íŠ¸ì›Œì»¤","ìŠ¤íŠ¸ë¼ì´ì»¤","ì•„ë€","ì—ë°˜","ë£¨ë¯¸ë„ˆìŠ¤","ë©”ë¥´ì„¸ë°ìŠ¤","íŒ¬í…€","ì€ì›”","ë°ëª¬ìŠ¬ë ˆì´ì–´","ë°ëª¬ì–´ë²¤ì ¸","ë¸”ë˜ìŠ¤í„°","ë°°í‹€ë©”ì´ì§€","ì™€ì¼ë“œí—Œí„°","ë©”ì¹´ë‹‰","ì œë…¼","ì¹´ì´ì €","ì¹´ì¸","ì¹´ë°ë‚˜","ì—”ì ¤ë¦­ë²„ìŠ¤í„°","ë¼ë¼","í˜¸ì˜","ì•„ë¸","ì¼ë¦¬ì›€","ì•„í¬","ì¹¼ë¦¬","ì œë¡œ","í‚¤ë„¤ì‹œìŠ¤","ë Œ"];
        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        let initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ', 'ìŠ¤ì½˜', 'ë°˜ì£½(íœ´ë©´)'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë¶€íŒ¬ì¼€ì´í¬', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜', 'ë¶€ì¼€ì´í¬', 'ë°˜ì£½(íœ´ë©´)'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)']
        };
        const ITEMS_PER_PAGE = 17;

        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'guide_intro',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            events: [],
            penaltyHistory: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'avg', sortOrder: 'desc', search: '' },
            analysisGuild: 'ëš ì¹´ë¡±',
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            guildRanks: initialGuildRanks,
            currentSelectedDate: null,
            pagination: { members: 1, analysis: 1 } 
        };

        window.showMsg = (text, type = 'info') => {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        };

        // ===== ë‹¤í¬ëª¨ë“œ =====
        window.toggleDark = () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
            const icon = document.querySelector('#darkToggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun text-xs lg:text-base text-amber-400' : 'fas fa-adjust text-xs lg:text-base';
        };
        // ì €ì¥ëœ ë‹¤í¬ëª¨ë“œ ë³µì›
        if (localStorage.getItem('darkMode') === '1') {
            document.body.classList.add('dark');
            setTimeout(() => {
                const icon = document.querySelector('#darkToggle i');
                if (icon) icon.className = 'fas fa-sun text-xs lg:text-base text-amber-400';
            }, 100);
        }

        // ===== ê°œì¸ ìˆ˜ë¡œ ë°ì´í„° ëª¨ë‹¬ =====
        window.showPersonalSuro = (memberName) => {
            const member = appState.members.find(m => m.name === memberName);
            if (!member) return;

            const headers = [...appState.suroHeaders];
            const scores = headers.map(h => Math.round(Number(member.suro?.[h])) || 0);
            const validScores = scores.filter(s => s > 0);
            const avg = validScores.length > 0 ? Math.round(validScores.reduce((a,b) => a+b, 0) / validScores.length) : 0;
            const mx = validScores.length > 0 ? Math.max(...validScores) : 0;
            const mn = validScores.length > 0 ? Math.min(...validScores) : 0;
            const participation = scores.length > 0 ? Math.round((validScores.length / scores.length) * 100) : 0;

            const getWedStr = (h) => {
                const p = h.split('~');
                return p.length > 1 ? p[1].replace('ìˆ˜ë¡œ ì ìˆ˜', '').trim() : h.trim();
            };

            const recentScores = scores.slice(-4);
            const recentHeaders = headers.slice(-4);
            const maxBarVal = Math.max(...recentScores, 1);
            const dk = document.body.classList.contains('dark');

            // ìµœê·¼ ì¶”ì„¸ ë°”
            var trendHtml = '';
            recentHeaders.forEach(function(h, i) {
                var s = recentScores[i];
                var pct = Math.round((s / maxBarVal) * 100);
                var prev = i > 0 ? recentScores[i-1] : 0;
                var diffHtml = '';
                if (prev > 0 && s > 0) {
                    var dp = ((s - prev) / prev * 100);
                    if (s > prev) diffHtml = '<span class="text-red-500 text-[9px] ml-1">\u25B2' + dp.toFixed(1) + '%</span>';
                    else if (s < prev) diffHtml = '<span class="text-blue-500 text-[9px] ml-1">\u25BC' + Math.abs(dp).toFixed(1) + '%</span>';
                }
                trendHtml += '<div><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold '+(dk?'text-gray-400':'text-gray-600')+'">' + getWedStr(h) + '</span><span class="text-xs font-black '+(s===0?'text-red-400':dk?'text-gray-200':'text-gray-700')+'">' + (s>0?s.toLocaleString():'0') + diffHtml + '</span></div><div class="w-full '+(dk?'bg-gray-700':'bg-gray-100')+' rounded-full h-2.5 overflow-hidden"><div class="h-full rounded-full transition-all duration-700 '+(s===0?'bg-red-300':'bg-gradient-to-r from-pink-400 to-rose-400')+'" style="width:'+pct+'%"></div></div></div>';
            });

            // ì „ì²´ ê¸°ë¡
            var allHtml = '';
            var revHeaders = [...headers].reverse();
            revHeaders.forEach(function(h, i) {
                var idx2 = headers.length - 1 - i;
                var s = scores[idx2];
                var cls = s === 0 ? (dk?'bg-red-900/20 text-red-400':'bg-red-50 text-red-400') : (i%2===0?(dk?'bg-gray-800':'bg-gray-50'):'');
                allHtml += '<div class="flex justify-between items-center py-1.5 px-2 rounded-lg text-[11px] font-bold '+cls+'"><span class="'+(dk?'text-gray-400':'text-gray-500')+'">' + getWedStr(h) + '</span><span class="'+(s===0?'text-red-400':dk?'text-gray-200':'text-gray-700')+'">' + (s>0?s.toLocaleString():'0') + '</span></div>';
            });

            var overlay = document.createElement('div');
            overlay.className = 'personal-suro-modal';
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

            function statCard(label, value, colorName) {
                return '<div class="text-center p-3 rounded-xl '+(dk?'bg-'+colorName+'-900/30 border border-'+colorName+'-800/30':'bg-'+colorName+'-50 border border-'+colorName+'-100')+'"><p class="text-[8px] '+(dk?'text-'+colorName+'-300':'text-'+colorName+'-500')+' font-bold uppercase">'+label+'</p><p class="text-lg font-black '+(dk?'text-'+colorName+'-300':'text-'+colorName+'-600')+'">'+value+'</p></div>';
            }

            overlay.innerHTML = '<div class="personal-suro-content">' +
                '<div class="p-5 border-b '+(dk?'border-gray-700':'border-gray-100')+' flex justify-between items-center shrink-0">' +
                    '<div class="flex items-center gap-3">' + window.getNicknameIcon(member.role) +
                        '<div><h3 class="text-lg font-bold '+(dk?'text-gray-100':'text-gray-800')+'">' + member.name + '</h3>' +
                        '<p class="text-[10px] '+(dk?'text-gray-400':'text-gray-500')+'">' + member.guild + ' \xB7 ' + (member.class||'-') + ' \xB7 ' + (member.role||'-') + '</p></div>' +
                    '</div>' +
                    '<button onclick="this.closest(\'.personal-suro-modal\').remove()" class="w-8 h-8 rounded-full '+(dk?'bg-gray-700 hover:bg-gray-600 text-gray-300':'bg-gray-100 hover:bg-gray-200 text-gray-500')+' flex items-center justify-center transition-colors"><i class="fas fa-times"></i></button>' +
                '</div>' +
                '<div class="p-5 flex-1 overflow-y-auto">' +
                    '<div class="grid grid-cols-4 gap-2 mb-5">' +
                        statCard('\uD3C9\uADE0', avg.toLocaleString(), 'pink') +
                        statCard('\uCD5C\uACE0', mx.toLocaleString(), 'blue') +
                        statCard('\uCD5C\uC800', mn.toLocaleString(), 'amber') +
                        statCard('\uCC38\uC5EC\uC728', participation+'%', 'green') +
                    '</div>' +
                    '<div class="mb-5"><p class="text-[10px] '+(dk?'text-gray-400':'text-gray-500')+' font-bold uppercase tracking-widest mb-3">\uCD5C\uADFC \uCD94\uC138</p><div class="space-y-2">' + trendHtml + '</div></div>' +
                    '<div><p class="text-[10px] '+(dk?'text-gray-400':'text-gray-500')+' font-bold uppercase tracking-widest mb-3">\uC804\uCCB4 \uAE30\uB85D ('+headers.length+'\uC8FC\uCC28)</p><div class="max-h-[200px] overflow-y-auto space-y-1">' + allHtml + '</div></div>' +
                '</div>' +
            '</div>';

            document.body.appendChild(overlay);
        };
        window.showLoading = (show) => { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); };
        window.setLoadProgress = (pct, status) => {
            const bar = document.getElementById('loadingBar');
            const pctEl = document.getElementById('loadingPct');
            const statusEl = document.getElementById('loadingStatus');
            if(bar) bar.style.width = pct + '%';
            if(pctEl) pctEl.textContent = pct + '%';
            if(status && statusEl) statusEl.textContent = status;
        };
        
        window.getAnniversaryInfo = () => {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years, remainingDays };
        };
        
        window.updateAnniversaryLabel = () => {
            const anniv = window.getAnniversaryInfo();
            const el = document.getElementById('anniversaryLabel');
            if (el) el.innerText = `ëš ì¹´ë¡±ì´ ìƒì„±ëœ ì§€ ${anniv.totalDays}ì¼ (${anniv.years}ë…„ ${anniv.remainingDays}ì¼)`;
        };

        window.calculateTotalSuro = (guildName) => {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members
                .filter(m => (m.guild || '').trim() === guildName.trim())
                .reduce((s, m) => s + (Math.round(Number(m.suro?.[lastHeader])) || 0), 0);
        };

        window.getAdminBailStats = () => {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        };

        let ROLE_PRIORITY = {'ë§ˆì¹´ë¡±':0,'ë‹¤ì¿ ì•„ì¦ˆ':1,'í¬ë¼ìš´':2,'íŒŒë¥´í˜':3,'í‹°ë¼ë¯¸ìŠˆ':4,'í¬ë¡œì¹¸ìŠˆ':5,'ë¡¤ì¼€ì´í¬':6,'íŒ¬ì¼€ì´í¬':7,'ì™€í”Œ':8,'ìŠ¤ì½˜':9,'ë°˜ì£½':10,'ë°˜ì£½(íœ´ë©´)':10,'ëš ì¼€ì´í¬':2,'ëš ë¸Œë ˆë“œ':3,'ì•„ì¸ìŠˆí˜ë„ˆ':4,'ë¶€íŒ¬ì¼€ì´í¬':5,'ìˆ˜í”Œë ˆ':6,'ëš ìŠ¤ì½˜':7,'ë¶€ì¼€ì´í¬':8};

        function smartCompare(a, b, field, order) {
            let valA = a[field]; let valB = b[field];
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }
            if (field === 'role') {
                const pA = ROLE_PRIORITY[valA] !== undefined ? ROLE_PRIORITY[valA] : 99;
                const pB = ROLE_PRIORITY[valB] !== undefined ? ROLE_PRIORITY[valB] : 99;
                if (pA !== pB) return order === 'asc' ? pA - pB : pB - pA;
                return 0;
            }
            if (valA === valB) return 0;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const strA = String(valA || ""); const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        window.getNicknameIcon = (role) => {
            if (role === 'ë§ˆì¹´ë¡±') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === 'ë‹¤ì¿ ì•„ì¦ˆ') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        };

        let ROLE_DISPLAY = {
            'í¬ë¼ìš´':  { emoji:'ğŸ‘‘', color:'text-amber-600' },
            'íŒŒë¥´í˜':  { emoji:'ğŸ¨', color:'text-blue-600' },
            'í‹°ë¼ë¯¸ìŠˆ': { emoji:'ğŸ°', color:'text-blue-600' },
            'í¬ë¡œì¹¸ìŠˆ': { emoji:'ğŸ¥', color:'text-green-600' },
            'ë¡¤ì¼€ì´í¬': { emoji:'ğŸ¥', color:'text-pink-600' },
            'íŒ¬ì¼€ì´í¬': { emoji:'ğŸ¥', color:'text-pink-500' },
            'ì™€í”Œ':    { emoji:'ğŸ§‡', color:'text-orange-500' },
            'ìŠ¤ì½˜':    { emoji:'ğŸª', color:'text-gray-500' },
            'ë°˜ì£½(íœ´ë©´)':{ emoji:'ğŸ«“', color:'text-gray-400' },
            'ë°˜ì£½':    { emoji:'ğŸ«“', color:'text-gray-400' },
            'ë§ˆì¹´ë¡±':  { emoji:'ğŸ‘‘', color:'text-blue-600' },
            'ë‹¤ì¿ ì•„ì¦ˆ': { emoji:'ğŸ‘‘', color:'text-pink-600' },
            'ëš ì¼€ì´í¬': { emoji:'ğŸ‚', color:'text-pink-600' },
            'ëš ë¸Œë ˆë“œ': { emoji:'ğŸ', color:'text-pink-500' },
            'ì•„ì¸ìŠˆí˜ë„ˆ':{ emoji:'â˜•', color:'text-amber-500' },
            'ë¶€íŒ¬ì¼€ì´í¬':{ emoji:'ğŸ¥', color:'text-amber-500' },
            'ìˆ˜í”Œë ˆ':  { emoji:'ğŸ®', color:'text-orange-500' },
            'ëš ìŠ¤ì½˜':  { emoji:'ğŸª', color:'text-gray-500' },
            'ë¶€ì¼€ì´í¬': { emoji:'ğŸ°', color:'text-gray-400' }
        };
        let SURO_EXEMPT = ['í¬ë¼ìš´','íŒŒë¥´í˜','í‹°ë¼ë¯¸ìŠˆ','í¬ë¡œì¹¸ìŠˆ'];
        let SURO_EXEMPT_LABEL = 'ì•„ì¸ìŠˆí˜ë„ˆ';
        let SURO_EXEMPT_NOTE = 'í¬ë¡œì¹¸ìŠˆ ì´ìƒ â€” ë¶€ìº ì „ë¶€ ìˆ˜ë¡œ ë©´ì œ';
        let SITE_CONFIG = null;
        let ROW_HIGHLIGHT_ROLES = {
            'í¬ë¼ìš´': { background:'linear-gradient(to right,#FFF9E6,#FFF3CC)', borderLeft:'3px solid #F0C050' },
            'íŒŒë¥´í˜': { background:'linear-gradient(to right,#EBF0FF,#E4EAFF)', borderLeft:'3px solid #8EA8F0' },
            'í‹°ë¼ë¯¸ìŠˆ': { background:'linear-gradient(to right,#EBF0FF,#E8EDFF)', borderLeft:'3px solid #A0B4E8' },
            'í¬ë¡œì¹¸ìŠˆ': { background:'linear-gradient(to right,#EEFFEE,#E5FAE5)', borderLeft:'3px solid #92D050' }
        };

        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const d = ROLE_DISPLAY[rank];
            const emoji = d ? d.emoji : '';
            const suffix = SURO_EXEMPT.includes(rank) ? ` <span class="text-[8px] text-blue-400 font-bold">(${SURO_EXEMPT_LABEL})</span>` : '';
            const displayName = rank === 'ë°˜ì£½' ? 'ë°˜ì£½(íœ´ë©´)' : rank;
            return `${emoji} ${displayName}${suffix}`;
        }

        function formatRoleHtml(role) {
            const d = ROLE_DISPLAY[role];
            if (!d) return `<span class="text-[10px] text-gray-500">${role || '-'}</span>`;
            const displayName = role === 'ë°˜ì£½' ? 'ë°˜ì£½(íœ´ë©´)' : role;
            const suffix = SURO_EXEMPT.includes(role) ? `<span class="text-[7px] text-blue-400 font-bold ml-0.5">(${SURO_EXEMPT_LABEL})</span>` : '';
            return `<span class="text-[10px] font-bold ${d.color}">${d.emoji} ${displayName}</span>${suffix}`;
        }

        window.getSuroPeriodHeader = (dateObj) => { 
            const now = dateObj || new Date(); 
            const day = now.getDay(); 
            let daysSinceWed = day - 3; 
            if (daysSinceWed < 0) daysSinceWed += 7; 
            const endDate = new Date(now); 
            endDate.setDate(now.getDate() - daysSinceWed); 
            const startDate = new Date(endDate); 
            startDate.setDate(endDate.getDate() - 6); 
            const f = (d) => { 
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(ëª©) ~ ${f(endDate)}(ìˆ˜) ìˆ˜ë¡œ ì ìˆ˜`; 
        };

        window.fetchMembers = async () => {
            window.showLoading(true);
            try {
                // í—¬í¼: 1000í–‰ ì œí•œ ìš°íšŒ
                async function fetchAll(table, orderCol, selectCols = '*', ascending = true) {
                    const pageSize = 1000;
                    let allData = [], from = 0;
                    while (true) {
                        const { data, error } = await supaDb.from(table).select(selectCols).order(orderCol, { ascending }).range(from, from + pageSize - 1);
                        if (error) throw error;
                        allData = allData.concat(data || []);
                        if (!data || data.length < pageSize) break;
                        from += pageSize;
                    }
                    return allData;
                }

                // site_config ë¡œë“œ (ë””ìì¸ ì„¤ì •)
                try {
                    const { data: cfgRow } = await supaDb.from('site_config').select('config').eq('id', 1).maybeSingle();
                    if (cfgRow && cfgRow.config) {
                        const cfg = cfgRow.config;
                        SITE_CONFIG = cfg;
                        if (cfg.guilds) appState.guilds = cfg.guilds;
                        if (cfg.ranks) {
                            initialGuildRanks = cfg.ranks;
                            appState.guildRanks = cfg.ranks;
                        }
                        if (cfg.roleDisplay) ROLE_DISPLAY = cfg.roleDisplay;
                        if (cfg.suroExempt) SURO_EXEMPT = cfg.suroExempt;
                        if (cfg.suroExemptLabel) SURO_EXEMPT_LABEL = cfg.suroExemptLabel;
                        if (cfg.suroExemptNote) SURO_EXEMPT_NOTE = cfg.suroExemptNote;
                        if (cfg.rolePriority) ROLE_PRIORITY = cfg.rolePriority;
                        if (cfg.guildStartDate) GUILD_START_DATE = new Date(cfg.guildStartDate);
                        if (cfg.rowHighlightRoles) ROW_HIGHLIGHT_ROLES = cfg.rowHighlightRoles;
                    }
                } catch(e) { console.warn('site_config ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', e); }

                const members = await fetchAll('members', 'name');
                const periods = await fetchAll('suro_periods', 'id', '*');
                const scores = await fetchAll('suro_scores', 'id', '*');
                const bail = await fetchAll('bail_history', 'id', 'receiver, amount', false);
                const penalty = await fetchAll('penalty_history', 'id', 'points', false);
                const events = await fetchAll('events', 'date', '*', false);

                // Build suro score map
                const scoreMap = {};
                members.forEach(m => scoreMap[m.id] = {});
                scores.forEach(s => {
                    const period = periods.find(p => p.id === s.period_id);
                    if (period && scoreMap[s.member_id]) {
                        scoreMap[s.member_id][period.period_label] = s.score;
                    }
                });

                appState.suroHeaders = periods.map(p => p.period_label);
                appState.members = members.map(m => ({
                    id: String(m.id),
                    name: m.name,
                    guild: m.guild,
                    role: m.role,
                    class: m.class || '',
                    level: m.level || 0,
                    isMain: m.is_main,
                    mainCharName: m.main_char_name || '',
                    joinDate: m.join_date || '',
                    suro: scoreMap[m.id] || {}
                }));
                appState.history = [];
                appState.bailHistory = bail.map(h => ({
                    receiver: h.receiver,
                    amount: h.amount
                }));
                appState.events = events.map(e => ({
                    id: e.id,
                    date: (e.date || '').split('T')[0].trim(),
                    title: e.title,
                    content: e.content
                }));
                appState.penaltyHistory = penalty.map(h => ({
                    name: '******',
                    points: h.points,
                    reason: 'ë¹„ê³µê°œ'
                }));
                appState._penaltyCounts = {};
                penalty.forEach((h, i) => {
                    appState._penaltyCounts['******_' + i] = Number(h.points);
                });
                appState._activePenaltyCount = penalty.length;

                const countEl = document.getElementById('totalMembersCount');
                if (countEl) {
                    const counts = {};
                    appState.guilds.forEach(g => counts[g.name] = 0);
                    appState.members.forEach(m => {
                        if (counts[m.guild] !== undefined) counts[m.guild]++;
                    });
                    
                    const aliases = {};
                    appState.guilds.forEach(g => { aliases[g.name] = g.name.substring(0, 1); });
                    const defaultBadgeStyles = {
                        'ëš ì¹´ë¡±': 'background:#fdf2f8;color:#db2777;border-color:#fbcfe8',
                        'ëš±ì¹´ë¡±': 'background:#fff1f2;color:#e11d48;border-color:#fecdd3',
                        'ë°¤ì¹´ë¡±': 'background:#eef2ff;color:#4f46e5;border-color:#c7d2fe',
                        'ë³„ì¹´ë¡±': 'background:#fefce8;color:#ca8a04;border-color:#fef08a',
                        'ë‹¬ì¹´ë¡±': 'background:#eff6ff;color:#2563eb;border-color:#bfdbfe',
                        'ê¿€ì¹´ë¡±': 'background:#fffbeb;color:#d97706;border-color:#fde68a'
                    };
                    const cfgBadge = SITE_CONFIG?.guildBadgeStyles || {};
                    const guildBadgeStyles = {};
                    appState.guilds.forEach(g => {
                        if (cfgBadge[g.name]) {
                            const b = cfgBadge[g.name];
                            guildBadgeStyles[g.name] = `background:${b.bg};color:${b.text};border-color:${b.border}`;
                        } else {
                            guildBadgeStyles[g.name] = defaultBadgeStyles[g.name] || 'background:#f3f4f6;color:#666';
                        }
                    });

                    countEl.innerHTML = appState.guilds.map(g => {
                        const name = aliases[g.name] || g.name.substring(0, 1);
                        const s = guildBadgeStyles[g.name] || 'background:#f3f4f6;color:#666';
                        return `<span style="${s};border:1px solid;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:900">${name} ${counts[g.name]}</span>`;
                    }).join('');
                }
                window.updateAnniversaryLabel();
            } catch (e) { 
                console.error("Fetch Error:", e); 
                alert("ğŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨\n\nSupabase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                window.setLoadProgress(100, 'ì™„ë£Œ!');
                setTimeout(() => window.showLoading(false), 300);
                window.router(appState.activeTab);
            }
        };

        window.router = (tab) => {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ëª©ë¡', analysis: 'ìˆ˜ë¡œ ë¶„ì„', bail: 'ë³´ì„ê¸ˆ í˜„í™©', penalty: 'ë²Œì  í˜„í™©', guide_intro: 'ê¸¸ë“œ ì†Œê°œ', guide_ranks: 'ì§ìœ„ & ë¶€ìº', guide_links: 'ë§í¬ ëª¨ìŒ', suro_input: 'ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥', sheet: 'DB ì‹œíŠ¸ ë·°ì–´', guide_edit: 'ê°€ì´ë“œ í¸ì§‘', history: 'ìš´ì˜ ì´ë ¥', sync: 'ê¸¸ë“œì› ë™ê¸°í™”', settings: 'ì„¤ì •' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') window.renderDashboard(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
            else if (tab.startsWith('guide_')) window.renderGuide(content, tab.replace('guide_',''));
            else if (tab === 'suro_input' && isAdmin()) window.renderSuroInput(content);
            else if (tab === 'sheet' && isAdmin()) window.renderSheet(content);
            else if (tab === 'guide_edit' && isAdmin()) window.renderGuideEditor(content);
            else if (tab === 'history' && isAdmin()) window.renderHistory(content);
            else if (tab === 'sync' && isAdmin()) window.renderSync(content);
            else if (tab === 'settings' && isAdmin()) { window.renderSettings(content); setTimeout(() => window._loadAdminList && window._loadAdminList(), 100); }
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            if (window.innerWidth < 1024) { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        };

        window.renderCutoffCards = () => {
            const cutoffs = SITE_CONFIG?.cutoffs || {};
            const guildNames = Object.keys(cutoffs);
            if (guildNames.length === 0) return '<p class="text-xs text-gray-400 col-span-2 text-center py-4">ì»¤íŠ¸ë¼ì¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

            const guildIcons = { 'ëš ì¹´ë¡±': 'fa-crown', 'ëš±ì¹´ë¡±': 'fa-heart' };
            const guildTitleColors = { 'ëš ì¹´ë¡±': 'text-pink-500', 'ëš±ì¹´ë¡±': 'text-pink-600' };
            const guildIconColors = { 'ëš ì¹´ë¡±': 'text-pink-500', 'ëš±ì¹´ë¡±': 'text-pink-400' };

            return guildNames.map(gName => {
                const items = cutoffs[gName] || [];
                const icon = guildIcons[gName] || 'fa-star';
                const titleColor = guildTitleColors[gName] || 'text-gray-600';
                const iconColor = guildIconColors[gName] || 'text-gray-400';

                // ìˆ˜ë¡œ ë©´ì œ êµ¬ë¶„ì„  ìœ„ì¹˜: ë©´ì œ ì§ìœ„ ì¤‘ ë§ˆì§€ë§‰ í•­ëª©ì˜ index
                let suroExemptIdx = -1;
                for (let i = 0; i < items.length; i++) {
                    if (SURO_EXEMPT.includes(items[i].rank)) {
                        const nextItem = items[i + 1];
                        if (!nextItem || !SURO_EXEMPT.includes(nextItem.rank)) {
                            suroExemptIdx = i;
                            break;
                        }
                    }
                }

                const rowsHtml = items.map((c, idx) => {
                    const rd = ROLE_DISPLAY[c.rank] || {};
                    const emoji = rd.emoji || '';
                    const cssText = c.cssText || 'text-gray-600';
                    const cssValue = c.cssValue || 'text-gray-500';
                    const cssBg = c.cssBg || 'bg-gray-50';
                    const cssBorder = c.cssBorder || 'border-gray-100';
                    const cssGradient = c.cssGradient;
                    const noteHtml = c.note ? ` <span class="text-[9px] text-gray-400">(${c.note})</span>` : '';

                    let rowClass = `${cssBg} border ${cssBorder}`;
                    if (cssGradient) {
                        rowClass = `bg-gradient-to-r ${cssGradient} border ${cssBorder}`;
                    }

                    let exemptNoteHtml = '';
                    if (idx === suroExemptIdx && SURO_EXEMPT_NOTE) {
                        exemptNoteHtml = `<div class="text-[9px] text-blue-500 font-bold pl-2.5 py-1 flex items-center gap-1"><i class="fas fa-angle-double-up text-[8px]"></i> ${SURO_EXEMPT_NOTE}</div>`;
                    }

                    return `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg ${rowClass}"><span class="${cssText}">${emoji} ${c.rank}</span><span class="${cssValue}">${c.label}${noteHtml}</span></div>${exemptNoteHtml}`;
                }).join('');

                return `<div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                    <h3 class="text-[10px] lg:text-xs font-bold ${titleColor} uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas ${icon} ${iconColor}"></i> ${gName} ì§ìœ„ ì»¤íŠ¸ë¼ì¸</h3>
                    <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${rowsHtml}</div>
                </div>`;
            }).join('');
        };

        window._publicDashboard = (container) => {
            const ddunT = window.calculateTotalSuro('ëš ì¹´ë¡±'); 
            const ddungT = window.calculateTotalSuro('ëš±ì¹´ë¡±');
            
            // ë™ì  ì§ìœ„ë³„ ì¸ì› ìƒì„± (site_config ê¸°ë°˜)
            const ranks = SITE_CONFIG?.ranks || {};
            const roleDisplay = SITE_CONFIG?.roleDisplay || ROLE_DISPLAY || {};
            const guildBadge = SITE_CONFIG?.guildBadgeStyles || {};
            // cutoffsê°€ ìˆëŠ” ê¸¸ë“œë§Œ ì§ìœ„ë³„ ì¸ì› í‘œì‹œ (ë©”ì¸ê¸¸ë“œ)
            const cutoffGuilds = Object.keys(SITE_CONFIG?.cutoffs || {});
            
            const roleCountCards = cutoffGuilds.map(gName => {
                const gMembers = appState.members.filter(m => m.guild === gName);
                const gRanks = ranks[gName] || [];
                const gRoleCounts = {};
                gMembers.forEach(m => { const r = m.role || 'ë¯¸ì„¤ì •'; gRoleCounts[r] = (gRoleCounts[r] || 0) + 1; });
                
                const badge = guildBadge[gName] || {};
                const titleColor = badge.text ? `color:${badge.text}` : '';
                
                // roleDisplay ê¸°ë°˜ ìƒ‰ìƒ ë§¤í•‘
                const roleColorMap = {
                    'text-blue-600': 'text-blue-600 bg-blue-50 border-blue-100',
                    'text-pink-600': 'text-pink-600 bg-pink-50 border-pink-100',
                    'text-pink-500': 'text-pink-500 bg-pink-50 border-pink-100',
                    'text-amber-600': 'text-amber-600 bg-amber-50 border-amber-100',
                    'text-amber-500': 'text-amber-500 bg-amber-50 border-amber-100',
                    'text-indigo-600': 'text-indigo-600 bg-indigo-50 border-indigo-100',
                    'text-green-600': 'text-green-600 bg-green-50 border-green-100',
                    'text-emerald-600': 'text-emerald-600 bg-emerald-50 border-emerald-100',
                    'text-orange-500': 'text-orange-600 bg-orange-50 border-orange-100',
                    'text-purple-600': 'text-purple-600 bg-purple-50 border-purple-100',
                    'text-rose-600': 'text-rose-600 bg-rose-50 border-rose-100',
                    'text-gray-500': 'text-gray-600 bg-gray-50 border-gray-100',
                    'text-gray-400': 'text-gray-400 bg-gray-50 border-gray-100',
                };
                
                const rowsHtml = gRanks.filter(r => gRoleCounts[r]).map(r => {
                    const rd = roleDisplay[r] || {};
                    const emoji = rd.emoji || '';
                    const colorCls = roleColorMap[rd.color] || 'text-gray-600 bg-gray-50 border-gray-100';
                    return `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border ${colorCls}"><span>${emoji} ${r}</span><span class="font-black">${gRoleCounts[r]}ëª…</span></div>`;
                }).join('');
                
                // ë¯¸ì„¤ì • í¬í•¨
                const extraRoles = Object.keys(gRoleCounts).filter(r => !gRanks.includes(r));
                const extraHtml = extraRoles.map(r => {
                    const rd = roleDisplay[r] || {};
                    const emoji = rd.emoji || '';
                    return `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border bg-gray-50 border-gray-100 text-gray-500"><span>${emoji} ${r}</span><span class="font-black">${gRoleCounts[r]}ëª…</span></div>`;
                }).join('');
                
                const guildIcon = (appState.guilds.find(g => g.name === gName) || {}).icon || 'fa-users';
                
                return `<div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                    <h3 class="text-[10px] lg:text-xs font-bold uppercase tracking-widest mb-3 flex items-center gap-2" style="${titleColor}"><i class="fas ${guildIcon}"></i> ${gName} ì§ìœ„ë³„ ì¸ì› <span class="text-gray-400 font-bold">(${gMembers.length}ëª…)</span></h3>
                    <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${rowsHtml}${extraHtml}</div>
                </div>`;
            }).join('');
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-6">
                    <div class="grid grid-cols-2 gap-3 lg:gap-6 h-auto lg:h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="bg-gradient-to-br from-pink-400 to-rose-400 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none">
                            <div class="absolute top-0 right-0 p-4 opacity-20 text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-sm font-bold opacity-80 uppercase tracking-widest text-center">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="bg-white border border-gray-100 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-100 transition-all flex flex-col justify-center relative overflow-hidden">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-pink-600 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“…</span>
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-600 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[11px] font-bold text-gray-600 w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-600 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        ${window.renderCutoffCards()}
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        ${roleCountCards}
                    </div>
                </div>
                <div class="flex flex-col gap-8 h-full">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col min-h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-4 shrink-0">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-chart-bar text-pink-400"></i> ì§ì—… ë¶„í¬ë„</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 border border-gray-100">
                                <option value="all">ì „ì²´ë³´ê¸°</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar relative">
                            <div id="jobChartContainer" class="flex flex-col gap-4"></div>
                        </div>
                        <button onclick="window.toggleJobChart()" id="jobToggleBtn" class="mt-3 py-2 text-[10px] font-bold text-gray-400 hover:text-pink-600 transition-all flex items-center justify-center gap-1"><i class="fas fa-chevron-down text-[8px]" id="jobToggleIcon"></i> <span id="jobToggleText">ë”ë³´ê¸°</span></button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3 lg:gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-4 lg:p-8 rounded-2xl lg:rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-600 transition-colors"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-lg text-gray-800 group-hover:text-pink-600">${g.name}</span><span class="text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[10px] text-gray-400 font-bold mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };

        window.renderCalendar = () => { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month + 1, 0).getDate(); 
            const prevLast = new Date(year, month, 0).getDate();
            const today = new Date();
            
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">ì¼</div><div class="calendar-head">ì›”</div><div class="calendar-head">í™”</div><div class="calendar-head">ìˆ˜</div><div class="calendar-head text-pink-500">ëª©</div><div class="calendar-head">ê¸ˆ</div><div class="calendar-head text-blue-400">í† </div>`; 
            
            for(let i=first; i>0; i--) {
                html += `<div class="calendar-day not-current"><span>${prevLast - i + 1}</span></div>`;
            }

            for(let d=1; d<=last; d++) { 
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEvents = appState.events.filter(e => {
                    const eDate = (e.date || '').split('T')[0].trim();
                    return eDate === dateStr;
                });
                
                const isToday = today.getFullYear()===year && today.getMonth()===month && today.getDate()===d;
                const isThursday = new Date(year, month, d).getDay() === 4;

                let cls = "calendar-day text-gray-600";
                if(isThursday) cls += " thursday";
                if(isToday) cls += " today";
                
                let eventHtml = '';
                if(dayEvents.length > 0) {
                    eventHtml += `<div class="event-dot"></div>`;
                    dayEvents.slice(0, 2).forEach(e => {
                        eventHtml += `<div class="event-snippet" title="${e.title}">${e.title}</div>`;
                    });
                    if (dayEvents.length > 2) eventHtml += `<div class="text-[9px] text-pink-400 mt-0.5 leading-none font-bold">+${dayEvents.length - 2}</div>`;
                }
                html += `<div class="${cls}" onclick="window.showEventDetail('${dateStr}')"><span>${d}</span>${eventHtml}</div>`; 
            } 
            
            const totalCells = first + last;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for(let i=1; i<=extraCells; i++) {
                html += `<div class="calendar-day not-current"><span>${i}</span></div>`;
            }

            return html + `</div>`; 
        };

        window.showEventDetail = (dateStr) => {
            appState.currentSelectedDate = dateStr;
            const modal = document.getElementById('eventDetailModal');
            document.getElementById('eventDetailDate').innerText = dateStr;
            
            const dayEvents = appState.events.filter(e => e.date === dateStr);
            const listContainer = document.getElementById('eventListForDate');
            listContainer.innerHTML = '';
            
            if (dayEvents.length > 0) {
                dayEvents.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'p-4 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold text-gray-600 space-y-1';
                    item.innerHTML = `<div class="text-pink-600 text-sm">${e.title}</div>${e.content ? `<div class="text-gray-400 text-[11px] whitespace-pre-wrap">${e.content}</div>` : ''}`;
                    listContainer.appendChild(item);
                });
            } else {
                listContainer.innerHTML = `<p class="text-xs text-gray-400 text-center py-4">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };

        window.changePage = (type, delta) => {
            appState.pagination[type] += delta;
            if (type === 'members') window.updateMemberTable();
        };

        window._analysisSearchTimer = null;
        window.setAnalysisSearch = (val) => {
            appState.analysisFilters.search = val;
            if (window._analysisSearchTimer) clearTimeout(window._analysisSearchTimer);
            window._analysisSearchTimer = setTimeout(() => { window.updateAnalysisTable(); }, 200);
        };

        window.updateAnalysisTable = () => {
            const tbody = document.getElementById('analysisTableBody');
            if (!tbody) return;
            const gName = appState.analysisGuild;
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const rawSearch = (appState.analysisFilters.search || '').trim();
            const searchTokens = rawSearch.length > 0 ? rawSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) : [];
            const displayTargets = searchTokens.length > 0
                ? guildTargets.filter(m => { const mn = m.isMain ? m.name : (m.mainCharName||''); return searchTokens.some(t => m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t)); })
                : guildTargets;
            const recentHeaders = [...appState.suroHeaders];
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;
            const processedList = displayTargets.map(m => { const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0); const vs = scores.filter(s => s > 0); return { ...m, avg: vs.length > 0 ? Math.round(vs.reduce((a,b)=>a+b,0)/vs.length) : 0, recentScores: scores }; });
            const f = appState.analysisFilters.sortField, o = appState.analysisFilters.sortOrder;
            processedList.sort((a,b) => { if(f.startsWith('date_')){const th=f.replace('date_',''),hi=recentHeaders.indexOf(th),ph=hi>0?recentHeaders[hi-1]:null;const rate=(m)=>{const c=Math.round(Number(m.suro?.[th]))||0;if(!ph)return c>0?-500:-1000;const p=Math.round(Number(m.suro?.[ph]))||0;if(c===0&&p===0)return-1000;if(p===0&&c>0)return-500;return((c-p)/p)*100;};const rA=rate(a),rB=rate(b);if(rA===rB){const cA=Math.round(Number(a.suro?.[th]))||0,cB=Math.round(Number(b.suro?.[th]))||0;return o==='asc'?cA-cB:cB-cA;}return o==='asc'?rA-rB:rB-rA;}if(f==='avg')return o==='asc'?a.avg-b.avg:b.avg-a.avg;if(f==='score'){const vA=Math.round(Number(a.suro?.[currentHeader]))||0,vB=Math.round(Number(b.suro?.[currentHeader]))||0;return o==='asc'?vA-vB:vB-vA;}return smartCompare(a,b,f,o); });
            tbody.innerHTML = processedList.map((m,i) => { let row = `<tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50 cursor-pointer" onclick="window.showPersonalSuro(this.dataset.name)" data-name="${m.name}"><td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50">${i+1}</td><td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50 bg-white"><div class="flex items-center leading-none overflow-hidden text-ellipsis">${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}${m.level>0?'<span class="text-[8px] text-gray-400 font-mono ml-1">Lv.'+m.level+'</span>':''}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div></div></td><td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>`; m.recentScores.forEach((s,si) => { let dh='',ps=si>0?m.recentScores[si-1]:0; if(s>0||(s===0&&ps>0)){if(ps>0){const dp=((s-ps)/ps*100);if(s>ps)dh=`<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² ${dp.toFixed(1)}%</span>`;else if(s<ps)dh=`<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">â–¼ ${Math.abs(dp).toFixed(1)}%</span>`;else dh=`<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;}else if(s>0)dh=`<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² NEW</span>`;}row+=`<td class="p-3 min-w-[100px] text-right font-mono align-middle ${s===0?'bg-red-50/20 text-red-400 group-hover:bg-red-50/50':'bg-white text-gray-700 group-hover:bg-gray-50'}"><div class="flex flex-col justify-center items-end leading-tight min-h-[28px]"><span class="${s>0?'text-xs':'text-gray-400'}">${s>0?s.toLocaleString():'0'}</span>${dh}</div></td>`; }); return row + '</tr>'; }).join('');
        };

        window.renderAnalysis = (container, gName) => {
            appState.analysisGuild = gName;
            
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const rawSearch = (appState.analysisFilters.search || '').trim();
            const searchTokens = rawSearch.length > 0 ? rawSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) : [];
            const displayTargets = searchTokens.length > 0
                ? guildTargets.filter(m => { const mn = m.isMain ? m.name : (m.mainCharName||''); return searchTokens.some(t => m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t)); })
                : guildTargets;
            
            const getWedStr = (h) => {
                if (!h) return '';
                const p = h.split('~');
                return p.length > 1 ? p[1].replace('ìˆ˜ë¡œ ì ìˆ˜', '').trim() : h.trim();
            };
            const getShortWedStr = (h) => {
                const str = getWedStr(h);
                const p = str.split('-');
                return p.length >= 3 ? p[1] + '-' + p[2].substring(0,2) : str;
            };

            const recentHeaders = [...appState.suroHeaders]; 
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;

            const displayTotal = currentHeader ? guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[currentHeader])) || 0), 0) : 0;
            const zeroPointMembers = currentHeader ? guildTargets.filter(m => (Math.round(Number(m.suro?.[currentHeader])) || 0) === 0) : [];
            
            const processedList = displayTargets.map(m => {
                const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0);
                const validScores = scores.filter(s => s > 0);
                const avg = validScores.length > 0 ? Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length) : 0;
                return { ...m, avg: avg, recentScores: scores };
            });

            let topScores = [];
            let scoreIncreases = [];
            let pctIncreases = [];
            let avgIncreases = [];

            if (recentHeaders.length >= 2 && currentHeader) {
                const prevHeader = recentHeaders[recentHeaders.length - 2];
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    const prevScore = Math.round(Number(m.suro?.[prevHeader])) || 0;
                    
                    const pastScores = recentHeaders.slice(0, -1).map(h => Math.round(Number(m.suro?.[h])) || 0).filter(s => s > 0);
                    const pastAvg = pastScores.length > 0 ? Math.round(pastScores.reduce((a,b)=>a+b,0) / pastScores.length) : 0;

                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }

                    if (prevScore > 0 && currScore > prevScore) {
                        const increase = currScore - prevScore;
                        const increasePct = (increase / prevScore) * 100;
                        scoreIncreases.push({ name: m.name, val: increase, role: m.role });
                        pctIncreases.push({ name: m.name, val: increasePct, role: m.role });
                    }
                    
                    if (pastAvg > 0 && currScore > pastAvg) {
                        const aboveAvg = currScore - pastAvg;
                        avgIncreases.push({ name: m.name, val: aboveAvg, role: m.role });
                    }
                });
            } else if (currentHeader) {
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }
                });
            }

            topScores.sort((a,b) => b.val - a.val);
            scoreIncreases.sort((a,b) => b.val - a.val);
            pctIncreases.sort((a,b) => b.val - a.val);
            avgIncreases.sort((a,b) => b.val - a.val);

            const topScoreHighMVP = topScores.slice(0, 5);
            const topScoreMVP = scoreIncreases.slice(0, 5);
            const topPctMVP = pctIncreases.slice(0, 5);
            const topAvgMVP = avgIncreases.slice(0, 5);

            window._mvpFullData = { high: topScores, score: scoreIncreases, pct: pctIncreases, avg: avgIncreases };

            processedList.sort((a, b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                
                if (f.startsWith('date_')) {
                    const targetHeader = f.replace('date_', '');
                    const headerIdx = recentHeaders.indexOf(targetHeader);
                    const prevHeader = headerIdx > 0 ? recentHeaders[headerIdx - 1] : null;

                    const getIncRate = (m) => {
                        const curr = Math.round(Number(m.suro?.[targetHeader])) || 0;
                        if (!prevHeader) return curr > 0 ? -500 : -1000;
                        const prev = Math.round(Number(m.suro?.[prevHeader])) || 0;
                        if (curr === 0 && prev === 0) return -1000; 
                        if (prev === 0 && curr > 0) return -500; 
                        return ((curr - prev) / prev) * 100;
                    };

                    const rateA = getIncRate(a);
                    const rateB = getIncRate(b);
                    
                    if (rateA === rateB) {
                        const currA = Math.round(Number(a.suro?.[targetHeader])) || 0;
                        const currB = Math.round(Number(b.suro?.[targetHeader])) || 0;
                        return o === 'asc' ? currA - currB : currB - currA;
                    }
                    return o === 'asc' ? rateA - rateB : rateB - rateA;
                }

                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Math.round(Number(a.suro?.[currentHeader])) || 0;
                    const vB = Math.round(Number(b.suro?.[currentHeader])) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            const analysisGuildsOptions = ['ëš ì¹´ë¡±', 'ëš±ì¹´ë¡±'];
            
            const renderMvpList = (list, type) => {
                if(list.length === 0) return `<div class="flex items-center justify-center h-full pb-2"><span class="text-[10px] text-gray-400 font-bold">ë°ì´í„° ë¶€ì¡±</span></div>`;
                
                let colorBase = '';
                if(type === 'high') colorBase = 'blue';
                else if(type === 'score') colorBase = 'orange';
                else if(type === 'pct') colorBase = 'emerald';
                else if(type === 'avg') colorBase = 'purple';

                return `<div class="flex flex-col gap-1.5 z-10 w-full mt-2">
                    ${list.map((m, idx) => {
                        let displayVal = '';
                        if(type === 'high') displayVal = Math.round(m.val).toLocaleString();
                        else if(type === 'score') displayVal = '+' + Math.round(m.val).toLocaleString();
                        else if(type === 'pct') displayVal = 'â–²' + m.val.toFixed(1) + '%';
                        else if(type === 'avg') displayVal = '+' + Math.round(m.val).toLocaleString();

                        return `<div class="flex justify-between items-center text-[10px] leading-none bg-white/40 rounded px-1.5 py-1">
                            <div class="flex items-center gap-1.5 overflow-hidden">
                                <span class="font-black text-${colorBase}-500 inline-block w-2.5 text-center">${idx+1}</span>
                                <span class="font-bold text-gray-800 truncate" style="max-width: 60px;" title="${m.name}">${m.name}</span>
                            </div>
                            <span class="font-black text-${colorBase}-600 shrink-0">${displayVal}</span>
                        </div>`;
                    }).join('')}
                </div>`;
            };

            container.innerHTML = `
            <div class="flex flex-col fade-in h-full">
                <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ (ê³ ì •) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 shrink-0 pb-3 bg-gray-50 z-20">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0 w-full sm:w-auto">
                        ${analysisGuildsOptions.map(gNameOption => `<button onclick="window.renderAnalysis(document.getElementById('contentArea'), '${gNameOption}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all shrink-0 ${gNameOption === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-100'}">${gNameOption}</button>`).join('')}
                    </div>
                    <div class="relative w-full sm:w-64 shrink-0">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.setAnalysisSearch(this.value)" value="${appState.analysisFilters.search || ''}" class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-100 rounded-xl outline-none text-xs font-bold shadow-sm focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„/ë³¸ìº/ì§ì—… ê²€ìƒ‰ (ë‹¤ì¤‘ê²€ìƒ‰)">
                    </div>
                </div>

                <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
                <div class="flex-1 overflow-y-auto min-h-0 flex flex-col gap-3">

                <!-- â˜… ìƒë‹¨ ìš”ì•½ í•œ ì¤„ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 shrink-0 font-bold">
                    <div class="bg-white py-2.5 px-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center gap-3">
                        <span class="text-[8px] text-gray-400 uppercase tracking-widest">ì „ì²´ ì´ì </span>
                        <span class="text-base font-black text-gray-800 tracking-tighter">${displayTotal.toLocaleString()}</span>
                    </div>
                    <div class="bg-red-50 py-2.5 px-4 rounded-xl border border-red-100 shadow-sm flex items-center justify-center gap-3">
                        <span class="text-[8px] text-red-500 uppercase tracking-widest">ğŸš¨ ë¯¸ì°¸ì—¬</span>
                        <span class="text-base font-black text-red-600">${zeroPointMembers.length}ëª…</span>
                    </div>
                    <div class="bg-white py-2.5 px-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center gap-3 cursor-pointer group" onclick="window.expandChart()">
                        <span class="text-[8px] text-gray-400 uppercase tracking-widest">ìµœê·¼ ì£¼ì°¨</span>
                        <span class="text-sm font-bold text-gray-700">${currentHeader ? getWedStr(currentHeader) : 'ì—†ìŒ'}</span>
                        <span class="text-[8px] text-gray-300 group-hover:text-pink-400"><i class="fas fa-chart-line"></i></span>
                    </div>
                </div>
                <canvas id="analysisChart" style="display:none;"></canvas>

                <!-- â˜… MVP 4ê°œ í•œ ì¤„ -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 font-bold shrink-0">
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-blue-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('high')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-blue-500"><i class="fas fa-crown"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-blue-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-star"></i> ì´ë²ˆ ì£¼ ê³ ë“ì </p><span class="text-[8px] text-blue-300 group-hover/mvp:text-blue-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topScoreHighMVP, 'high')}
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-orange-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('score')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-orange-500"><i class="fas fa-trophy"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-orange-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-arrow-trend-up"></i> ì ìˆ˜ ë–¡ìƒ</p><span class="text-[8px] text-orange-300 group-hover/mvp:text-orange-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topScoreMVP, 'score')}
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-emerald-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('pct')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-emerald-500"><i class="fas fa-chart-line"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-emerald-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-percent"></i> ìƒìŠ¹ë¥ </p><span class="text-[8px] text-emerald-300 group-hover/mvp:text-emerald-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topPctMVP, 'pct')}
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-fuchsia-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-purple-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('avg')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-purple-500"><i class="fas fa-bolt"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-purple-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-balance-scale"></i> í‰ê· ëŒ€ë¹„ ë–¡ìƒ</p><span class="text-[8px] text-purple-300 group-hover/mvp:text-purple-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topAvgMVP, 'avg')}
                        </div>
                </div>

                <!-- â˜… ì „ì²´ ë°ì´í„° í…Œì´ë¸” (ì „ì²´ ë„ˆë¹„) -->
                <div class="min-h-[80vh]">
                    <div class="bg-white rounded-xl lg:rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden h-full relative">
                        <div class="p-3 lg:p-4 border-b border-gray-50 flex justify-between items-center shrink-0 bg-white relative z-40">
                            <h3 class="text-[10px] lg:text-xs font-bold text-gray-800 uppercase tracking-widest">ì „ì²´ ë°ì´í„° (ëˆ„ì )</h3>
                            <button onclick="window.expandTable()" class="text-[9px] text-gray-300 hover:text-pink-400 transition-colors flex items-center gap-1 font-bold"><i class="fas fa-expand-alt"></i> í™•ëŒ€</button>
                        </div>
                        <div id="analysisTableWrapper" class="analysis-table-wrap flex-1 overflow-auto bg-white scroll-smooth relative">
                            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                                <thead class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="p-3 text-center min-w-[50px] bg-gray-50">RANK</th>
                                        <th class="p-3 sortable cursor-pointer hover:bg-gray-200 min-w-[140px] bg-gray-50" onclick="window.setAnalysisSort('name')">ìºë¦­í„°ëª…${sortIcon('name')}</th>
                                        <th class="p-3 text-center sortable bg-pink-50 text-pink-600 cursor-pointer min-w-[110px]" onclick="window.setAnalysisSort('avg')">í‰ê·  (ì°¸ì—¬)${sortIcon('avg')}</th>
                                        ${recentHeaders.map((h, idx) => {
                                            const displayStr = getWedStr(h);
                                            return `<th class="p-3 min-w-[100px] text-right font-medium cursor-pointer hover:bg-gray-200 transition-colors select-none" onclick="window.setAnalysisSort('date_${h}')" title="í´ë¦­í•˜ì—¬ ìƒìŠ¹ë¥  ìˆœìœ¼ë¡œ ì •ë ¬">${displayStr}${sortIcon('date_'+h)}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody id="analysisTableBody" class="font-bold text-gray-700">
                                    ${processedList.map((m, i) => {
                                        const globalIndex = i + 1;
                                        return `
                                        <tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50 cursor-pointer" onclick="window.showPersonalSuro(this.dataset.name)" data-name="${m.name}">
                                            <td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50 bg-white">${globalIndex}</td>
                                            <td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50 bg-white">
                                                <div class="flex items-center leading-none overflow-hidden text-ellipsis">
                                                    ${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}${m.level > 0 ? '<span class="text-[8px] text-gray-400 font-mono ml-1">Lv.' + m.level + '</span>' : ''}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div>
                                                </div>
                                            </td>
                                            <td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>
                                            ${m.recentScores.map((s, scoreIdx) => {
                                                let diffHtml = '';
                                                let prevScore = 0;
                                                
                                                if (scoreIdx > 0) {
                                                    prevScore = m.recentScores[scoreIdx - 1];
                                                }

                                                if (s > 0 || (s === 0 && prevScore > 0)) {
                                                    if (prevScore > 0) {
                                                        const diffPct = ((s - prevScore) / prevScore * 100);
                                                        if (s > prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² ${diffPct.toFixed(1)}%</span>`;
                                                        } else if (s < prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">â–¼ ${Math.abs(diffPct).toFixed(1)}%</span>`;
                                                        } else {
                                                            diffHtml = `<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;
                                                        }
                                                    } else if (s > 0) {
                                                        diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² NEW</span>`;
                                                    }
                                                }

                                                return `
                                                <td class="p-3 min-w-[100px] text-right font-mono align-middle ${s === 0 ? 'bg-red-50/20 text-red-400 group-hover:bg-red-50/50' : 'bg-white text-gray-700 group-hover:bg-gray-50'}">
                                                    <div class="flex flex-col justify-center items-end leading-tight min-h-[28px]">
                                                        <span class="${s > 0 ? 'text-xs' : 'text-gray-400'}">${s > 0 ? s.toLocaleString() : '0'}</span>
                                                        ${diffHtml}
                                                    </div>
                                                </td>
                                                `;
                                            }).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>`;

            setTimeout(() => {
                const tableWrapper = document.getElementById('analysisTableWrapper');
                if (tableWrapper) {
                    tableWrapper.scrollLeft = tableWrapper.scrollWidth;
                }
            }, 100);

            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: recentHeaders.map(h => getShortWedStr(h)), 
                    datasets: [{ 
                        label: 'ê¸¸ë“œ ì´ì ', 
                        data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)), 
                        borderColor: '#ec4899', 
                        borderWidth: 3, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(236, 72, 153, 0.05)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    } 
                } 
            });

            window.expandMvp = (type) => {
                var data = (window._mvpFullData && window._mvpFullData[type]) || [];
                if (data.length === 0) return;
                var titles = { high: 'ì´ë²ˆ ì£¼ ê³ ë“ì  ì „ì²´ ë­í‚¹', score: 'ì ìˆ˜ ë–¡ìƒ ì „ì²´ ë­í‚¹', pct: 'ìƒìŠ¹ë¥  ì „ì²´ ë­í‚¹', avg: 'í‰ê· ëŒ€ë¹„ ë–¡ìƒ ì „ì²´ ë­í‚¹' };
                var colors = { high: ['blue','from-blue-50 to-cyan-50','border-blue-100'], score: ['orange','from-yellow-50 to-orange-50','border-orange-100'], pct: ['emerald','from-emerald-50 to-teal-50','border-emerald-100'], avg: ['purple','from-purple-50 to-fuchsia-50','border-purple-100'] };
                var c = colors[type] || colors.high;
                var formatVal = function(m) { if(type==='high') return Math.round(m.val).toLocaleString(); if(type==='score') return '+'+Math.round(m.val).toLocaleString(); if(type==='pct') return '\u25B2'+m.val.toFixed(1)+'%'; if(type==='avg') return '+'+Math.round(m.val).toLocaleString(); return m.val; };
                var overlay = document.createElement('div');
                overlay.id = 'mvpModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
                overlay.onclick = function(e) { if(e.target === overlay) overlay.remove(); };
                var modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;width:100%;max-width:480px;max-height:80vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;';
                modal.innerHTML = '<div class="p-4 border-b border-gray-100 flex justify-between items-center shrink-0 bg-gradient-to-r '+c[1]+'"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">'+titles[type]+'</h3><button onclick="document.getElementById(\'mvpModal\').remove()" class="w-8 h-8 rounded-full bg-white/60 hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-1">' + data.map(function(m,i){ return '<div class="flex justify-between items-center py-2 px-3 rounded-xl '+(i<3?'bg-gradient-to-r '+c[1]+' border '+c[2]:i%2===0?'bg-gray-50':'')+' transition-colors"><div class="flex items-center gap-3 overflow-hidden"><span class="font-black text-'+c[0]+'-500 w-7 text-center text-sm '+(i<3?'':'text-gray-400')+'">'+(i+1)+'</span><div class="flex items-center gap-1.5">'+window.getNicknameIcon(m.role)+'<span class="font-bold text-gray-800 text-sm truncate" style="max-width:180px;">'+m.name+'</span></div></div><span class="font-black text-'+c[0]+'-600 text-sm shrink-0 '+(i>=3?'text-gray-600':'')+'">'+formatVal(m)+'</span></div>'; }).join('') + '</div><div class="p-3 border-t border-gray-100 text-center shrink-0"><span class="text-[10px] text-gray-400 font-bold">\uCD1D '+data.length+'\uBA85</span></div>';
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
            };

            window.expandTable = () => {
                var ex = document.getElementById('tableModal'); if(ex) ex.remove();
                var overlay = document.createElement('div');
                overlay.id = 'tableModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:0.75rem;';
                overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };
                var modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;width:100%;max-width:95vw;height:90vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;';
                var gName = appState.analysisGuild;
                var guildTargets = appState.members.filter(function(m){ return m.guild===gName; });
                var recentHeaders = [].concat(appState.suroHeaders);
                var getWedStr = function(h){ var m2=h.match(/(\d+)-(\d+)-(\d+)\(.\)\s*~\s*(\d+)-(\d+)-(\d+)/); return m2?m2[4]+'/'+m2[5]+'/'+m2[6]:h; };
                var modalSort = { field: appState.analysisFilters.sortField, order: appState.analysisFilters.sortOrder };
                var modalSearch = '';
                function renderModalTable(){
                    var searchTokens = modalSearch.length>0 ? modalSearch.toLowerCase().split(/[\s,]+/).filter(function(t){return t.length>0;}) : [];
                    var filtered = searchTokens.length>0 ? guildTargets.filter(function(m){ var mn=m.isMain?m.name:(m.mainCharName||''); return searchTokens.some(function(t){ return m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t); }); }) : guildTargets;
                    var currentHeader = recentHeaders.length>0?recentHeaders[recentHeaders.length-1]:null;
                    var processed = filtered.map(function(m){ var scores=recentHeaders.map(function(h){return Math.round(Number(m.suro&&m.suro[h]))||0;}); var vs=scores.filter(function(s){return s>0;}); return Object.assign({},m,{avg:vs.length>0?Math.round(vs.reduce(function(a,b){return a+b;},0)/vs.length):0,recentScores:scores}); });
                    var f=modalSort.field, o=modalSort.order;
                    processed.sort(function(a,b){
                        if(f.startsWith('date_')){var th=f.replace('date_',''),hi=recentHeaders.indexOf(th),ph=hi>0?recentHeaders[hi-1]:null;var rate=function(m){var c=Math.round(Number(m.suro&&m.suro[th]))||0;if(!ph)return c>0?-500:-1000;var p=Math.round(Number(m.suro&&m.suro[ph]))||0;if(c===0&&p===0)return-1000;if(p===0&&c>0)return-500;return((c-p)/p)*100;};var rA=rate(a),rB=rate(b);if(rA===rB){var cA=Math.round(Number(a.suro&&a.suro[th]))||0,cB=Math.round(Number(b.suro&&b.suro[th]))||0;return o==='asc'?cA-cB:cB-cA;}return o==='asc'?rA-rB:rB-rA;}
                        if(f==='avg')return o==='asc'?a.avg-b.avg:b.avg-a.avg;
                        if(f==='score'){var vA=Math.round(Number(a.suro&&a.suro[currentHeader]))||0,vB=Math.round(Number(b.suro&&b.suro[currentHeader]))||0;return o==='asc'?vA-vB:vB-vA;}
                        return o==='asc'?String(a.name).localeCompare(String(b.name)):String(b.name).localeCompare(String(a.name));
                    });
                    var si=function(col){return modalSort.field===col?(modalSort.order==='asc'?' \u25B2':' \u25BC'):'';};
                    var thead=document.getElementById('modalTableHead');
                    var tbody=document.getElementById('modalTableBody');
                    if(thead) thead.innerHTML='<tr><th class="p-3 text-center min-w-[50px] bg-gray-50">RANK</th><th class="p-3 min-w-[140px] cursor-pointer hover:bg-gray-200 bg-gray-50" onclick="window._modalSort(\'name\')">\uCE90\uB9AD\uD130\uBA85'+si('name')+'</th><th class="p-3 text-center min-w-[110px] cursor-pointer bg-pink-50 text-pink-600 hover:bg-pink-100" onclick="window._modalSort(\'avg\')">\uD3C9\uADE0 (\uCC38\uC5EC)'+si('avg')+'</th>'+recentHeaders.map(function(h){return '<th class="p-3 min-w-[100px] text-right cursor-pointer hover:bg-gray-200 bg-gray-50" onclick="window._modalSort(\'date_'+h+'\')">'+getWedStr(h)+si('date_'+h)+'</th>';}).join('')+'</tr>';
                    if(tbody) tbody.innerHTML=processed.map(function(m,i){
                        var row='<tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50 cursor-pointer" onclick="window.showPersonalSuro(this.dataset.name)" data-name="'+m.name.replace(/"/g,'&quot;')+'"><td class="p-3 text-center text-gray-400 bg-white">'+(i+1)+'</td><td class="p-3 text-gray-800 bg-white"><div class="flex items-center leading-none">'+window.getNicknameIcon(m.role)+'<div class="flex flex-col min-w-0"><span class="truncate">'+m.name+(m.level>0?'<span class="text-[8px] text-gray-400 font-mono ml-1">Lv.'+m.level+'</span>':'')+'</span><span class="text-[9px] text-gray-400 font-medium truncate">'+(m.class||'')+'</span></div></div></td><td class="p-3 text-center text-pink-600 bg-pink-50/30">'+m.avg.toLocaleString()+'</td>';
                        m.recentScores.forEach(function(s,si2){var dh='',ps=si2>0?m.recentScores[si2-1]:0;if(s>0||(s===0&&ps>0)){if(ps>0){var dp=((s-ps)/ps*100);if(s>ps)dh='<span class="text-[9px] text-red-500 font-bold block mt-0.5">\u25B2 '+dp.toFixed(1)+'%</span>';else if(s<ps)dh='<span class="text-[9px] text-blue-500 font-bold block mt-0.5">\u25BC '+Math.abs(dp).toFixed(1)+'%</span>';else dh='<span class="text-[9px] text-gray-400 font-bold block mt-0.5">- 0.0%</span>';}else if(s>0)dh='<span class="text-[9px] text-red-500 font-bold block mt-0.5">\u25B2 NEW</span>';}row+='<td class="p-3 min-w-[100px] text-right font-mono '+(s===0?'bg-red-50/20 text-red-400':'text-gray-700')+'"><div class="flex flex-col items-end leading-tight min-h-[28px]"><span class="'+(s>0?'text-xs':'text-gray-400')+'">'+(s>0?s.toLocaleString():'0')+'</span>'+dh+'</div></td>';});
                        return row+'</tr>';
                    }).join('');
                }
                window._modalSort=function(col){if(modalSort.field===col){modalSort.order=modalSort.order==='asc'?'desc':'asc';}else{modalSort.field=col;modalSort.order=(col==='avg'||col==='score'||col.startsWith('date_'))?'desc':'asc';}renderModalTable();};
                modal.innerHTML='<div style="padding:1rem 1.25rem;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;gap:1rem;"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest shrink-0">\uC804\uCCB4 \uB370\uC774\uD130 \u2014 '+gName+'</h3><div class="flex items-center gap-2 flex-1 max-w-md"><div class="flex-1 relative"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i><input id="modalSearchInput" type="text" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100" placeholder="\uB2C9\uB124\uC784/\uBCF8\uCE90/\uC9C1\uC5C5 \uAC80\uC0C9" oninput="clearTimeout(window._mst);window._mst=setTimeout(function(){window._modalSearchFn(document.getElementById(\'modalSearchInput\').value)},150)"></div><button onclick="document.getElementById(\'tableModal\').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors shrink-0"><i class="fas fa-times"></i></button></div></div><div style="flex:1;overflow:auto;-webkit-overflow-scrolling:touch;" class="no-scrollbar"><table class="w-full text-left text-xs whitespace-nowrap font-bold stick-head"><thead id="modalTableHead" class="text-[10px] text-gray-500 uppercase border-b border-gray-200 bg-gray-50"></thead><tbody id="modalTableBody" class="text-gray-700"></tbody></table></div>';
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                window._modalSearchFn=function(v){modalSearch=v.trim();renderModalTable();};
                renderModalTable();
                var scrollDiv=modal.querySelector('[style*="overflow:auto"]');
                if(scrollDiv) scrollDiv.scrollLeft=scrollDiv.scrollWidth;
            };

            window.expandChart = () => {
                const gName = appState.analysisGuild;
                const guildTargets = appState.members.filter(m => m.guild === gName);
                const recentHeaders = [...appState.suroHeaders];
                const getShortWedStr = (h) => { const m2 = h.match(/(\d+)-(\d+)-(\d+)\(.\)\s*~\s*(\d+)-(\d+)-(\d+)/); return m2 ? m2[4]+'/'+m2[5]+'/'+m2[6] : h; };

                const overlay = document.createElement('div');
                overlay.id = 'chartModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
                overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;padding:1.5rem;width:100%;max-width:900px;max-height:90vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);position:relative;';
                modal.innerHTML = '<div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ì£¼ê°„ ì´ì  ì¶”ì´ â€” ' + gName + '</h3><button onclick="document.getElementById(\'chartModal\').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button></div><div style="height:400px;position:relative;"><canvas id="expandedChart"></canvas></div>';
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                setTimeout(() => {
                    const ctx2 = document.getElementById('expandedChart');
                    if(!ctx2) return;
                    new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: recentHeaders.map(h => getShortWedStr(h)),
                            datasets: [{
                                label: 'ê¸¸ë“œ ì´ì ',
                                data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)),
                                borderColor: '#ec4899', borderWidth: 3, pointRadius: 6, pointBackgroundColor: '#fff',
                                pointBorderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(236, 72, 153, 0.08)'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { backgroundColor: '#1f2937', titleFont: { size: 13, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 10,
                                    callbacks: { label: (c) => 'ì´ì : ' + c.parsed.y.toLocaleString() }
                                }
                            },
                            scales: {
                                y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11, weight: 'bold' }, callback: (v) => v.toLocaleString() } },
                                x: { grid: { display: false }, ticks: { font: { size: 11, weight: 'bold' } } }
                            }
                        }
                    });
                }, 50);
            };
        };
        
        window.setAnalysisSort = (f) => { 
            if(appState.analysisFilters.sortField === f) {
                appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            } else { 
                appState.analysisFilters.sortField = f; 
                appState.analysisFilters.sortOrder = (f==='score'||f==='rank'||f==='avg'||f.startsWith('date_')) ? 'desc' : 'asc'; 
            } 
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        };

        window._jobExpanded = false;
        window.updateJobChart = (target) => {
            const container = document.getElementById('jobChartContainer'); if(!container) return;
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || 'ë¯¸ì„¤ì •'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
            const barColors = ['#F9A8D4','#FCA5A5','#FDBA74','#FDE68A','#A7F3D0','#93C5FD','#C4B5FD','#F0ABFC','#6EE7B7','#7DD3FC','#FDA4AF','#D8B4FE','#A5B4FC','#99F6E4'];
            const list = window._jobExpanded ? sorted : sorted.slice(0, 7);
            container.innerHTML = list.map((item, i) => {
                const pct = Math.round((item[1] / maxCount) * 100);
                const color = barColors[i % barColors.length];
                return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-gray-700">${item[0]}</span><span class="text-sm font-black text-gray-500">${item[1]}</span></div><div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden"><div class="h-full rounded-full transition-all duration-700" style="width:${pct}%;background:${color}"></div></div></div>`;
            }).join('');
            const btn = document.getElementById('jobToggleBtn');
            if(btn) btn.style.display = sorted.length <= 7 ? 'none' : 'flex';
            const icon = document.getElementById('jobToggleIcon');
            const txt = document.getElementById('jobToggleText');
            if(icon) icon.className = window._jobExpanded ? 'fas fa-chevron-up text-[8px]' : 'fas fa-chevron-down text-[8px]';
            if(txt) txt.textContent = window._jobExpanded ? 'ì ‘ê¸°' : 'ë”ë³´ê¸° (' + (sorted.length - 7) + ')';
        };
        window.toggleJobChart = () => {
            window._jobExpanded = !window._jobExpanded;
            const select = document.querySelector('#jobChartContainer')?.closest('.shrink-0')?.querySelector('select');
            window.updateJobChart(select ? select.value : 'all');
        };

        window._memberSearchTimer = null;
        window.handleSearch = (v) => { appState.filters.search = v; appState.pagination.members = 1; if(window._memberSearchTimer) clearTimeout(window._memberSearchTimer); window._memberSearchTimer = setTimeout(() => window.updateMemberTable(), 100); };
        window.filterByGuild = (g) => { appState.filters.guild = g; appState.pagination.members = 1; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } appState.pagination.members = 1; window.updateMemberTable(); };

        window._publicMembers = (container) => {
            container.innerHTML = `
            <div class="flex flex-col gap-3 fade-in h-full">
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col xl:flex-row items-center gap-4 shrink-0">
                    <div class="flex overflow-x-auto no-scrollbar w-full xl:w-auto gap-2 shrink-0">
                        <button onclick="window.filterByGuild('all')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === 'all' ? 'bg-white/20 text-white' : 'bg-gray-200/60 text-gray-400'}">${appState.members.length}</span></button>
                        ${appState.guilds.map(g => { const gc = appState.members.filter(m => m.guild === g.name).length; const gColors = {'ëš ì¹´ë¡±':['bg-pink-500','bg-pink-400/20'],'ëš±ì¹´ë¡±':['bg-rose-600','bg-rose-400/20'],'ë°¤ì¹´ë¡±':['bg-indigo-500','bg-indigo-400/20'],'ë³„ì¹´ë¡±':['bg-amber-500','bg-amber-400/20'],'ë‹¬ì¹´ë¡±':['bg-blue-500','bg-blue-400/20'],'ê¿€ì¹´ë¡±':['bg-orange-500','bg-orange-400/20']}; const [activeBg, activeBadge] = gColors[g.name] || ['bg-pink-500','bg-pink-400/20']; return `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === g.name ? activeBg + ' text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === g.name ? 'bg-white/25 text-white' : 'bg-gray-200/60 text-gray-400'}">${gc}</span></button>`; }).join('')}
                    </div>
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-8 lg:pl-10 pr-3 lg:pr-4 py-2 lg:py-2.5 bg-gray-50 border border-gray-100 rounded-xl outline-none text-[11px] lg:text-xs font-bold shadow-inner focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„/ë³¸ìº/ì§ì—… ê²€ìƒ‰ (ë‹¤ì¤‘ê²€ìƒ‰)">
                    </div>
                </div>
                <div id="memberTableContainer" class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
            </div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            
            const rawSearchTerm = appState.filters.search.trim();
            const searchTokens = rawSearchTerm.length > 0 
                ? rawSearchTerm.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0)
                : [];

            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                if (searchTokens.length === 0) return gMatch;
                const sMatch = searchTokens.some(token => {
                    return m.name.toLowerCase().includes(token) || 
                           (m.class||'').toLowerCase().includes(token) || 
                           (m.role||'').toLowerCase().includes(token) ||
                           (m.mainCharName || '').toLowerCase().includes(token) || 
                           (m.isMain && m.name.toLowerCase().includes(token)); 
                });
                return gMatch && sMatch; 
            });

            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.members > totalPages && totalPages > 0) appState.pagination.members = totalPages;
            if (appState.pagination.members < 1) appState.pagination.members = 1;
            
            const pageData = filtered.slice((appState.pagination.members - 1) * ITEMS_PER_PAGE, appState.pagination.members * ITEMS_PER_PAGE);
            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            
            const isMobile = window.innerWidth < 768;

            let html = '';

            if (isMobile) {
                html = `<div class="flex-1 overflow-y-auto p-3 space-y-2">`;
                pageData.forEach((m, idx) => {
                    const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                    const mainName = m.isMain ? m.name : (m.mainCharName || '-');
                    const mainMem = appState.members.find(x => x.name === mainName);
                    const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                    
                    let roleHtml = formatRoleHtml(m.role);

                    html += `
                    <div class="member-card">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400 font-bold w-6 text-center">${globalIndex}</span>
                                ${window.getNicknameIcon(m.role)}
                                <span class="font-bold text-sm text-gray-800">${m.name}</span>
                                ${m.level > 0 ? '<span class="text-[9px] text-gray-400 font-mono ml-1">Lv.' + m.level + '</span>' : ''}
                            </div>
                            ${roleHtml}
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-gray-500">
                            <span class="bg-gray-50 px-2 py-0.5 rounded-lg">${m.guild}</span>
                            <span class="text-gray-300">|</span>
                            <span>${m.class || '-'}</span>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-400">ë³¸ìº: ${mainName}</span>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html = `<div class="overflow-y-auto flex-1 relative"><table class="w-full text-left min-w-[800px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100 shadow-sm"><tr><th class="py-2 px-2 text-center w-12">No.</th><th class="py-2 px-2 sortable" onclick="window.handleSort('name')">ë‹‰ë„¤ì„${sortIcon('name')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('mainInfo')">ë³¸ìº ì •ë³´${sortIcon('mainInfo')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('role')">ì§ìœ„${sortIcon('role')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('class')">ì§ì—…${sortIcon('class')}</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
                
                pageData.forEach((m, idx) => {
                    const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                    const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                    const mainMem = appState.members.find(x => x.name === mainName);
                    const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                    
                    const targetRole = mainMem ? mainMem.role : (m.isMain ? m.role : '');
                    let rowStyle = "";
                    const hlCfg = ROW_HIGHLIGHT_ROLES[targetRole];
                    const isDarkMode = document.body.classList.contains('dark');
                    const DARK_HIGHLIGHT = {
                        'í¬ë¼ìš´': { background:'#252218', borderLeft:'3px solid #B8962E' },
                        'íŒŒë¥´í˜': { background:'#1a1d2e', borderLeft:'3px solid #6B84D0' },
                        'í‹°ë¼ë¯¸ìŠˆ': { background:'#1a1d2e', borderLeft:'3px solid #7B94D8' },
                        'í¬ë¡œì¹¸ìŠˆ': { background:'#1a2518', borderLeft:'3px solid #6AB030' }
                    };
                    if (hlCfg) {
                        const hl = isDarkMode ? (DARK_HIGHLIGHT[targetRole] || hlCfg) : hlCfg;
                        rowStyle = `background:${hl.background};${hl.borderLeft ? 'border-left:' + hl.borderLeft + ';' : ''}`;
                    }

                    let roleHtml = formatRoleHtml(m.role);

                    html += `<tr class="hover:bg-pink-50/30 group transition-colors" style="${rowStyle}">
                        <td class="py-1.5 px-2 text-center text-gray-400 text-[11px]">${globalIndex}</td>
                        <td class="py-1.5 px-2 font-bold text-gray-800 flex items-center leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span>${m.level > 0 ? '<span class="text-[9px] text-gray-400 font-mono ml-1.5">Lv.' + m.level + '</span>' : ''}</td>
                        <td class="py-1.5 px-2 leading-tight">
                            <span class="block text-[11px] font-bold text-gray-700">${mainName}</span>
                            <span class="text-[9px] font-medium text-gray-400">${mainRankHtml}</span>
                        </td>
                        <td class="py-1.5 px-2">${m.guild}</td>
                        <td class="py-1.5 px-2">${roleHtml}</td>
                        <td class="py-1.5 px-2"><span class="text-[10px] text-gray-400">${m.class||'-'}</span></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            html += `<div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50 relative z-20">
                <button onclick="changePage('members', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-600 hover:border-pink-100 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                <span class="text-xs font-bold text-gray-500">${appState.pagination.members} / ${totalPages || 1}</span>
                <button onclick="changePage('members', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-600 hover:border-pink-100 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
            </div>`;

            container.innerHTML = html;
        };

        window._publicBail = (container) => {
            const adminStats = window.getAdminBailStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 text-gray-400">******</td><td class="p-4 text-blue-500">${h.receiver}</td><td class="p-4 text-right text-pink-500">${h.amount}ê°œ</td></tr>`).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black text-pink-600 text-lg">${count}ê°œ</span></div>`).join('');
            
            container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
                <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">ê°„ë¶€ë³„ ë³´ì„ê¸ˆ ìˆ˜ë ¹ ì´ê³„</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL SUMMARY</p>
                    </div>
                    <div class="grid grid-cols-1 gap-2 flex-1 overflow-y-auto no-scrollbar">
                        ${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center py-4">ë°ì´í„° ì—†ìŒ</p>'}
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë³´ì„ê¸ˆ ë‚´ì—­</h3>
                        <span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="p-5">ë‚©ë¶€ì</th>
                                    <th class="p-5">ìˆ˜ë ¹ì</th>
                                    <th class="p-5 text-right">ìˆ˜ëŸ‰</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${historyRows || '<tr><td colspan="3" class="p-20 text-center text-gray-300 font-bold italic">ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        window._publicPenalty = (container) => {
            const activePenaltyCount = appState._activePenaltyCount || 0;

            const penaltyRows = appState.penaltyHistory.map(h => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <td class="p-4 text-gray-400">******</td>
                    <td class="p-4 text-red-500">${h.points}ì </td>
                    <td class="p-4 text-gray-400 text-[11px]">ë¹„ê³µê°œ</td>
                </tr>
            `).join('');

            container.innerHTML = `
            <div class="flex flex-col gap-6 fade-in h-full">
                <div class="bg-white p-8 rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[120px]">
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">í˜„ì¬ ë²Œì  ê´€ë¦¬ ëŒ€ìƒ</h3>
                        <p class="text-[10px] text-gray-400 mt-1">í˜„ì¬ ë²Œì ì´ ë¶€ì—¬ëœ ì¸ì› ìˆ˜: <span class="text-red-500 font-bold">${activePenaltyCount}ëª…</span></p>
                    </div>
                    <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                        ${activePenaltyCount > 0 
                            ? `<p class="text-xs text-gray-400 font-bold italic">ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ìƒì„¸ ë‚´ì—­ì€ ë¹„ê³µê°œì…ë‹ˆë‹¤.</p>`
                            : '<p class="text-xs text-gray-300 font-bold italic w-full">í˜„ì¬ ë²Œì ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        }
                    </div>
                </div>

                <div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden h-full">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë²Œì  ì´ë ¥</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="p-5">ëŒ€ìƒì</th>
                                    <th class="p-5">ì ìˆ˜</th>
                                    <th class="p-5">ì‚¬ìœ </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${penaltyRows || '<tr><td colspan="3" class="p-20 text-center text-gray-300 font-bold italic">ë²Œì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        window.renderGuide = async (container, section) => {
            const guideTab = section || 'intro';
            
            container.innerHTML = `
            <div class="flex flex-col gap-4 fade-in h-full">
                <div class="flex-1 overflow-y-auto no-scrollbar">
                    <div class="p-4 text-center text-gray-300 font-bold text-xs">ë¡œë”© ì¤‘...</div>
                </div>
            </div>`;

            try {
                const { data, error } = await supaDb.from('guide_pages').select('content').eq('slug', guideTab).maybeSingle();
                if (error) throw error;
                
                let body = data?.content || '<p class="text-gray-400 text-center">ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                
                // Replace dynamic placeholders with actual counts
                body = body.replace(/\{\{ëš ì¹´ë¡±_count\}\}/g, appState.members.filter(m=>m.guild==='ëš ì¹´ë¡±').length);
                body = body.replace(/\{\{ëš±ì¹´ë¡±_count\}\}/g, appState.members.filter(m=>m.guild==='ëš±ì¹´ë¡±').length);
                body = body.replace(/\{\{ë¶€ìº_count\}\}/g, appState.members.filter(m=>['ë°¤ì¹´ë¡±','ë³„ì¹´ë¡±','ë‹¬ì¹´ë¡±','ê¿€ì¹´ë¡±'].includes(m.guild)).length);
                body = body.replace(/\{\{ì „ì²´_count\}\}/g, appState.members.length);
                
                container.innerHTML = `
                <div class="flex flex-col gap-4 fade-in h-full">
                    <div class="flex-1 overflow-y-auto no-scrollbar">${body}</div>
                </div>`;
            } catch(e) {
                console.error(e);
                container.innerHTML = `
                <div class="flex flex-col gap-4 fade-in h-full">
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <p class="text-red-400 text-center font-bold text-xs p-10">ê°€ì´ë“œ ë¡œë”© ì‹¤íŒ¨</p>
                    </div>
                </div>`;
            }
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', () => { initSidebar(); window.fetchMembers(); });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  ê¶Œí•œ ì‹œìŠ¤í…œ & ë¡œê·¸ì¸  â–ˆâ–ˆ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let userRole = 'guest';
        let CURRENT_USER = null;
        window.isAdmin = () => userRole === 'admin';
        window.isLoggedIn = () => userRole !== 'guest';
        
        window.doLogin = async () => {
            try {
                const { error } = await supaDb.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.href.split('?')[0].split('#')[0] }
                });
                if (error) throw error;
            } catch(e) {
                window.showMsg('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };
        
        window.doLogout = async () => {
            await supaDb.auth.signOut();
            userRole = 'guest';
            CURRENT_USER = null;
            window.updateAuthUI();
            window.showMsg('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            router(appState.activeTab);
        };
        
        window.updateAuthUI = () => {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            const adminMenus = document.querySelectorAll('.admin-only');
            
            if (isAdmin() && CURRENT_USER) {
                if (loginBtn) loginBtn.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                if (userName) userName.textContent = CURRENT_USER.name || CURRENT_USER.email;
                adminMenus.forEach(el => el.classList.remove('hidden'));
            } else {
                if (loginBtn) loginBtn.classList.remove('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                adminMenus.forEach(el => el.classList.add('hidden'));
            }
        };
        
        window._checkAuth = async () => {
            const { data: { session } } = await supaDb.auth.getSession();
            if (!session) { userRole = 'guest'; CURRENT_USER = null; window.updateAuthUI(); return; }
            
            const email = session.user.email;
            const name = session.user.user_metadata?.full_name || session.user.user_metadata?.name || email;
            
            // admin_whitelist í…Œì´ë¸” ì²´í¬
            try {
                const { data: wl } = await supaDb.from('admin_whitelist')
                    .select('email, name, role, status')
                    .eq('email', email).maybeSingle();
                
                if (wl && wl.status === 'approved') {
                    userRole = 'admin';
                    CURRENT_USER = { email, name, role: wl.role };
                } else if (wl && wl.status === 'pending') {
                    userRole = 'member';
                    CURRENT_USER = { email, name };
                    window.showMsg('ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.', 'info');
                } else {
                    // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ìŠ¹ì¸ ìš”ì²­ ë“±ë¡
                    await supaDb.from('admin_whitelist').upsert({
                        email, name, role: 'viewer', status: 'pending',
                        requested_at: new Date().toISOString()
                    }, { onConflict: 'email' });
                    userRole = 'member';
                    CURRENT_USER = { email, name };
                    window.showMsg('ê´€ë¦¬ì ìŠ¹ì¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
            } catch(e) {
                // admin_whitelist í…Œì´ë¸” ì—†ìœ¼ë©´ ê¸°ì¡´ admin_authë¡œ í´ë°±
                try {
                    const { data: aa } = await supaDb.from('admin_auth')
                        .select('email').eq('email', email).maybeSingle();
                    if (aa) {
                        userRole = 'admin';
                        CURRENT_USER = { email, name };
                    } else {
                        userRole = 'member';
                        CURRENT_USER = { email, name };
                    }
                } catch(e2) {
                    userRole = 'member';
                    CURRENT_USER = { email, name };
                }
            }
            
            window.updateAuthUI();
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ì²´í¬
        supaDb.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                window._checkAuth().then(() => router(appState.activeTab));
            } else if (event === 'SIGNED_OUT') {
                userRole = 'guest'; CURRENT_USER = null;
                window.updateAuthUI();
                router(appState.activeTab);
            }
        });
        
        // ì´ˆê¸° ì¸ì¦ ì²´í¬
        window._checkAuth().then(async () => {
            if (isAdmin()) {
                // ê´€ë¦¬ìì¼ ë•Œ ì¶”ê°€ ë°ì´í„° ë¡œë“œ
                try {
                    const { data: hist } = await supaDb.from('operation_history').select('*').order('id', { ascending: true });
                    appState.history = (hist || []).map(h => ({ id: h.id, date: h.date, category: h.category, name: h.name, content: h.content }));
                } catch(e) { appState.history = []; }
            }
        });

        // â–ˆâ–ˆ ê¶Œí•œ ë¶„ê¸° ë˜í¼ í•¨ìˆ˜ â–ˆâ–ˆ
        window.renderDashboard = (container) => {
            if (isAdmin()) window._adminDashboard(container);
            else window._publicDashboard(container);
        };
        window.renderMembers = (container) => {
            if (isAdmin()) window._adminMembers(container);
            else window._publicMembers(container);
        };
        window.renderBail = (container) => {
            if (isAdmin()) window._adminBail(container);
            else window._publicBail(container);
        };
        window.renderPenalty = (container) => {
            if (isAdmin()) window._adminPenalty(container);
            else window._publicPenalty(container);
        };


        // â–ˆâ–ˆ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ â–ˆâ–ˆ
        window.showMsg = (msg, type = 'info') => {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-amber-500' };
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-[9999] ${colors[type] || colors.info} text-white px-5 py-3 rounded-2xl text-xs font-bold shadow-2xl transition-all duration-300 opacity-0 translate-y-[-10px]`;
            toast.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'} mr-2"></i>${msg}`;
            document.body.appendChild(toast);
            requestAnimationFrame(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; });
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-10px)'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };

        // â•â•â• sendAction (from admin, lines 982-1345) â•â•â•
        window.sendAction = async (action, data, skipRefresh = false) => {
            if(!skipRefresh) window.showMsg("ë°ì´í„° ì²˜ë¦¬ ì¤‘...", "info");
            try {
                let success = false;
                switch (action) {
                    case 'add': {
                        const { error } = await supaDb.from('members').insert({
                            name: data.name, guild: data.guild, role: data.role,
                            class: data.class || '', is_main: data.isMain !== false,
                            main_char_name: data.mainCharName || '',
                            join_date: data.joinDate || new Date().toISOString().split('T')[0]
                        });
                        if (error) throw error;
                        await supaDb.from('operation_history').insert({ date: new Date().toISOString().split('T')[0], category: 'ì¶”ê°€', name: data.name, content: `${data.guild} ê¸¸ë“œì— ì¶”ê°€ë¨` });
                        success = true; break;
                    }
                    case 'update': {
                        const { error } = await supaDb.from('members').update({
                            guild: data.guild, role: data.role, class: data.class || '',
                            is_main: data.isMain !== false, main_char_name: data.mainCharName || ''
                        }).eq('id', data.id);
                        if (error) throw error;
                        await supaDb.from('operation_history').insert({ date: new Date().toISOString().split('T')[0], category: 'ìˆ˜ì •', name: data.name, content: `ì •ë³´ ìˆ˜ì •ë¨ (${data.guild}/${data.role})` });
                        success = true; break;
                    }
                    case 'save_members': {
                        // ì „ì²´ ë©¤ë²„ ì¡°íšŒ (1000ê±´ ì œí•œ ìš°íšŒ)
                        let current = [], pg = 0;
                        while (true) {
                            const { data: b } = await supaDb.from('members').select('id, name').range(pg * 1000, (pg + 1) * 1000 - 1);
                            current = current.concat(b);
                            if (b.length < 1000) break;
                            pg++;
                        }
                        const currentMap = {};
                        current.forEach(m => { currentMap[m.name] = m.id; });
                        const newNames = new Set(data.members.map(m => m.name));
                        // ì‚­ì œ
                        const deleted = current.filter(m => !newNames.has(m.name));
                        if (deleted.length > 0) {
                            await supaDb.from('members').delete().in('id', deleted.map(m => m.id));
                        }
                        // ì—…ë°ì´íŠ¸ / ì¶”ê°€
                        for (const m of data.members) {
                            if (currentMap[m.name]) {
                                await supaDb.from('members').update({
                                    guild: m.guild, role: m.role, class: m.class || '',
                                    is_main: m.isMain !== false, main_char_name: m.mainCharName || ''
                                }).eq('id', currentMap[m.name]);
                            } else {
                                await supaDb.from('members').insert({
                                    name: m.name, guild: m.guild, role: m.role, class: m.class || '',
                                    is_main: m.isMain !== false, main_char_name: m.mainCharName || '',
                                    join_date: m.joinDate || new Date().toISOString().split('T')[0]
                                });
                            }
                        }
                        success = true; break;
                    }
                    case 'save_bail': {
                        const { error } = await supaDb.from('bail_history').insert({
                            date: data.date || new Date().toISOString().split('T')[0],
                            payer: data.payer, receiver: data.receiver,
                            amount: parseInt(data.amount), memo: data.memo || ''
                        });
                        if (error) throw error;
                        success = true; break;
                    }
                    case 'save_penalty': {
                        const { error } = await supaDb.from('penalty_history').insert({
                            date: data.date, name: data.name,
                            points: parseInt(data.points), reason: data.reason || ''
                        });
                        if (error) throw error;
                        success = true; break;
                    }
                    case 'save_event': {
                        if (data.isNew) {
                            const { error } = await supaDb.from('events').insert({
                                date: data.date, title: data.title, content: data.content || ''
                            });
                            if (error) throw error;
                        } else {
                            const { data: existing } = await supaDb.from('events')
                                .select('id').eq('date', data.date).eq('title', data.originalTitle).single();
                            if (existing) {
                                await supaDb.from('events').update({ title: data.title, content: data.content || '' }).eq('id', existing.id);
                            }
                        }
                        success = true; break;
                    }
                    case 'delete_event': {
                        const { error } = await supaDb.from('events').delete().eq('date', data.date).eq('title', data.title);
                        if (error) throw error;
                        success = true; break;
                    }
                    default: console.warn('Unknown action:', action);
                }
                if (success) {
                    if (!skipRefresh) { window.showMsg("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); await window.fetchMembers(); }
                    return true;
                }
                return false;
            } catch (e) {
                console.error("Supabase Error:", e);
                window.showMsg("ì„œë²„ ì „ì†¡ ì‹¤íŒ¨: " + (e.message || e), "error");
                return false;
            }
        };

        window.router = (tab) => {

        // â˜… ì§ìœ„ ìë™ ë¶€ì—¬ (ëš ì¹´ë¡± ë³¸ìº ì „ìš©, ë§ˆì¹´ë¡±/ë‹¤ì¿ ì•„ì¦ˆ/ë¶€ìº ì œì™¸)
        window.autoAssignRoles = () => {
            const excludeRoles = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
            const targets = appState.members.filter(m => m.guild === 'ëš ì¹´ë¡±' && !excludeRoles.includes(m.role) && m.isMain !== false);
            
            if(targets.length === 0) return window.showMsg("ë¶€ì—¬ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.", "error");
            
            const headers = appState.suroHeaders || [];
            const latestHeader = headers.length > 0 ? headers[headers.length - 1] : null;
            if(!latestHeader) return window.showMsg("ìˆ˜ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
            
            const getRoleByScore = (score) => {
                const rules = SITE_CONFIG?.autoRankRules?.['ëš ì¹´ë¡±'] || [
                    { min: 130000, rank: 'íŒŒë¥´í˜' }, { min: 95000, rank: 'í‹°ë¼ë¯¸ìŠˆ' },
                    { min: 72000, rank: 'í¬ë¡œì¹¸ìŠˆ' }, { min: 50000, rank: 'ë¡¤ì¼€ì´í¬' },
                    { min: 38000, rank: 'íŒ¬ì¼€ì´í¬' }, { min: 0, rank: 'ìŠ¤ì½˜' }
                ];
                const sorted = [...rules].sort((a,b) => b.min - a.min);
                for (const r of sorted) { if (score >= r.min) return r.rank; }
                return sorted.length > 0 ? sorted[sorted.length-1].rank : 'ìŠ¤ì½˜';
            };
            
            const scored = targets.map(m => ({
                ...m,
                latestScore: Math.round(Number(m.suro?.[latestHeader])) || 0
            })).sort((a, b) => b.latestScore - a.latestScore);
            
            const changes = [];
            scored.forEach((m, idx) => {
                let newRole;
                if(idx < 3 && m.latestScore > 0) {
                    newRole = 'í¬ë¼ìš´';
                } else {
                    newRole = getRoleByScore(m.latestScore);
                }
                if(m.role !== newRole) {
                    changes.push({ name: m.name, from: m.role, to: newRole, score: m.latestScore });
                }
            });
            
            if(changes.length === 0) return window.showMsg("ë³€ê²½í•  ì§ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‘ ì´ë¯¸ ì˜¬ë°”ë¥¸ ì§ìœ„ì…ë‹ˆë‹¤.", "info");
            
            // ì˜ˆìœ í™•ì¸ ëª¨ë‹¬
            const existing = document.getElementById('roleConfirmModal'); if(existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'roleConfirmModal';
            overlay.className = 'fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4';
            
            const roleColors = {
                'í¬ë¼ìš´': 'text-amber-500', 'íŒŒë¥´í˜': 'text-pink-500', 'í‹°ë¼ë¯¸ìŠˆ': 'text-orange-500',
                'í¬ë¡œì¹¸ìŠˆ': 'text-yellow-600', 'ë¡¤ì¼€ì´í¬': 'text-rose-400', 'íŒ¬ì¼€ì´í¬': 'text-amber-400',
                'ìŠ¤ì½˜': 'text-gray-500', 'ì™€í”Œ': 'text-purple-400'
            };
            
            const rows = changes.map((c, i) => {
                const fromColor = roleColors[c.from] || 'text-gray-500';
                const toColor = roleColors[c.to] || 'text-gray-500';
                return `<tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="py-2 px-1 text-center"><input type="checkbox" checked data-role-idx="${i}" class="role-chk w-4 h-4 rounded text-amber-500 cursor-pointer" onchange="window._updateRoleCount()"></td>
                    <td class="py-2 px-2 text-xs font-bold text-gray-800">${c.name}</td>
                    <td class="py-2 px-2 text-xs font-bold ${fromColor}">${c.from}</td>
                    <td class="py-2 px-1 text-gray-300 text-xs">â†’</td>
                    <td class="py-2 px-2 text-xs font-black ${toColor}">${c.to}</td>
                    <td class="py-2 px-2 text-xs text-gray-400 text-right font-mono">${c.score.toLocaleString()}</td>
                </tr>`;
            }).join('');
            
            overlay.innerHTML = `<div class="bg-white rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                <div class="p-5 bg-amber-50 border-b border-amber-100 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-sm font-bold text-amber-700 flex items-center gap-2"><i class="fas fa-magic"></i> ì§ìœ„ ìë™ ë¶€ì—¬</h3>
                        <p class="text-[10px] text-amber-500 mt-1">ê¸°ì¤€: ${latestHeader} Â· ë³€ê²½ ëŒ€ìƒ <span class="font-black">${changes.length}ëª…</span></p>
                    </div>
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="w-8 h-8 rounded-full bg-amber-100 hover:bg-amber-200 flex items-center justify-center text-amber-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <table class="w-full">
                        <thead><tr class="text-[9px] text-gray-400 uppercase border-b border-gray-100">
                            <th class="py-2 px-1 text-center"><input type="checkbox" checked onclick="document.querySelectorAll('.role-chk').forEach(c=>c.checked=this.checked);window._updateRoleCount()" class="w-4 h-4 rounded cursor-pointer"></th>
                            <th class="py-2 px-2 text-left">ë‹‰ë„¤ì„</th>
                            <th class="py-2 px-2 text-left">í˜„ì¬</th>
                            <th class="py-2 px-1"></th>
                            <th class="py-2 px-2 text-left">ë³€ê²½</th>
                            <th class="py-2 px-2 text-right">ì ìˆ˜</th>
                        </tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex gap-3 shrink-0">
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="flex-1 py-3 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-all">ì·¨ì†Œ</button>
                    <button id="roleConfirmBtn" onclick="window._executeRoleChanges()" class="flex-1 py-3 rounded-xl text-xs font-bold text-white bg-amber-500 hover:bg-amber-600 transition-all shadow-lg"><i class="fas fa-check mr-1"></i> <span id="roleConfirmCount">${changes.length}</span>ëª… ì§ìœ„ ë³€ê²½</button>
                </div>
            </div>`;
            
            document.body.appendChild(overlay);
            overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
            
            // ì‹¤í–‰ í•¨ìˆ˜ ì €ì¥
            window._pendingRoleChanges = changes;
        };
        
        // â˜… ì§ìœ„ ìë™ ë¶€ì—¬ (ëš±ì¹´ë¡± ë³¸ìº ì „ìš©, ë§ˆì¹´ë¡±/ë‹¤ì¿ ì•„ì¦ˆ/ì•„ì¸ìŠˆí˜ë„ˆ/ë¶€ìº ì œì™¸)
        window.autoAssignRolesDdung = () => {
            const excludeRoles = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ìˆ˜í”Œë ˆ', 'ë°˜ì£½(íœ´ë©´)'];
            const targets = appState.members.filter(m => m.guild === 'ëš±ì¹´ë¡±' && !excludeRoles.includes(m.role) && m.isMain !== false);
            
            if(targets.length === 0) return window.showMsg("ë¶€ì—¬ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.", "error");
            
            const headers = appState.suroHeaders || [];
            const latestHeader = headers.length > 0 ? headers[headers.length - 1] : null;
            if(!latestHeader) return window.showMsg("ìˆ˜ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
            
            const getDdungRole = (score) => {
                const rules = SITE_CONFIG?.autoRankRules?.['ëš±ì¹´ë¡±'] || [
                    { min: 18000, rank: 'ëš ì¼€ì´í¬' }, { min: 5000, rank: 'ëš ë¸Œë ˆë“œ' }, { min: 0, rank: 'ëš ìŠ¤ì½˜' }
                ];
                const sorted = [...rules].sort((a,b) => b.min - a.min);
                for (const r of sorted) { if (score >= r.min) return r.rank; }
                return sorted.length > 0 ? sorted[sorted.length-1].rank : 'ëš ìŠ¤ì½˜';
            };
            
            const scored = targets.map(m => ({
                ...m,
                latestScore: Math.round(Number(m.suro?.[latestHeader])) || 0
            }));
            
            const changes = [];
            scored.forEach(m => {
                const newRole = getDdungRole(m.latestScore);
                if(m.role !== newRole) {
                    changes.push({ name: m.name, from: m.role, to: newRole, score: m.latestScore });
                }
            });
            
            if(changes.length === 0) return window.showMsg("ë³€ê²½í•  ì§ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‘ ì´ë¯¸ ì˜¬ë°”ë¥¸ ì§ìœ„ì…ë‹ˆë‹¤.", "info");
            
            const existing = document.getElementById('roleConfirmModal'); if(existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'roleConfirmModal';
            overlay.className = 'fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4';
            
            const roleColors = {
                'ëš ì¼€ì´í¬': 'text-rose-500', 'ëš ë¸Œë ˆë“œ': 'text-amber-500', 'ìˆ˜í”Œë ˆ': 'text-purple-400',
                'ëš ìŠ¤ì½˜': 'text-gray-500', 'ë°˜ì£½(íœ´ë©´)': 'text-gray-400'
            };
            
            const rows = changes.map((c, i) => {
                const fromColor = roleColors[c.from] || 'text-gray-500';
                const toColor = roleColors[c.to] || 'text-gray-500';
                return `<tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="py-2 px-1 text-center"><input type="checkbox" checked data-role-idx="${i}" class="role-chk w-4 h-4 rounded text-rose-500 cursor-pointer" onchange="window._updateRoleCount()"></td>
                    <td class="py-2 px-2 text-xs font-bold text-gray-800">${c.name}</td>
                    <td class="py-2 px-2 text-xs font-bold ${fromColor}">${c.from}</td>
                    <td class="py-2 px-1 text-gray-300 text-xs">â†’</td>
                    <td class="py-2 px-2 text-xs font-black ${toColor}">${c.to}</td>
                    <td class="py-2 px-2 text-xs text-gray-400 text-right font-mono">${c.score.toLocaleString()}</td>
                </tr>`;
            }).join('');
            
            overlay.innerHTML = `<div class="bg-white rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                <div class="p-5 bg-rose-50 border-b border-rose-100 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-sm font-bold text-rose-700 flex items-center gap-2"><i class="fas fa-magic"></i> ëš±ì¹´ë¡± ì§ìœ„ ìë™ ë¶€ì—¬</h3>
                        <p class="text-[10px] text-rose-500 mt-1">ê¸°ì¤€: ${latestHeader} Â· ë³€ê²½ ëŒ€ìƒ <span class="font-black">${changes.length}ëª…</span></p>
                    </div>
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="w-8 h-8 rounded-full bg-rose-100 hover:bg-rose-200 flex items-center justify-center text-rose-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <table class="w-full">
                        <thead><tr class="text-[9px] text-gray-400 uppercase border-b border-gray-100">
                            <th class="py-2 px-1 text-center"><input type="checkbox" checked onclick="document.querySelectorAll('.role-chk').forEach(c=>c.checked=this.checked);window._updateRoleCount()" class="w-4 h-4 rounded cursor-pointer"></th>
                            <th class="py-2 px-2 text-left">ë‹‰ë„¤ì„</th>
                            <th class="py-2 px-2 text-left">í˜„ì¬</th>
                            <th class="py-2 px-1"></th>
                            <th class="py-2 px-2 text-left">ë³€ê²½</th>
                            <th class="py-2 px-2 text-right">ì ìˆ˜</th>
                        </tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex gap-3 shrink-0">
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="flex-1 py-3 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-all">ì·¨ì†Œ</button>
                    <button id="roleConfirmBtn" onclick="window._executeRoleChanges()" class="flex-1 py-3 rounded-xl text-xs font-bold text-white bg-rose-500 hover:bg-rose-600 transition-all shadow-lg"><i class="fas fa-check mr-1"></i> <span id="roleConfirmCount">${changes.length}</span>ëª… ì§ìœ„ ë³€ê²½</button>
                </div>
            </div>`;
            
            document.body.appendChild(overlay);
            overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
            window._pendingRoleChanges = changes;
        };

        window._updateRoleCount = () => {
            const checked = document.querySelectorAll('.role-chk:checked').length;
            const el = document.getElementById('roleConfirmCount');
            const btn = document.getElementById('roleConfirmBtn');
            if(el) el.textContent = checked;
            if(btn) { btn.disabled = checked === 0; btn.style.opacity = checked === 0 ? '0.4' : '1'; }
        };

        window._executeRoleChanges = async () => {
            const allChanges = window._pendingRoleChanges;
            if(!allChanges) return;
            const checkedIdxs = new Set();
            document.querySelectorAll('.role-chk:checked').forEach(c => checkedIdxs.add(Number(c.dataset.roleIdx)));
            const changes = allChanges.filter((_, i) => checkedIdxs.has(i));
            if(changes.length === 0) return window.showMsg("ì„ íƒëœ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.", "error");
            document.getElementById('roleConfirmModal')?.remove();
            
            window.showLoading(true);
            window.setLoadProgress(10, 'ì§ìœ„ ì—…ë°ì´íŠ¸ ì¤€ë¹„ ì¤‘...');
            
            const allMembers = appState.members.map(m => {
                const change = changes.find(c => c.name === m.name);
                return {
                    name: m.name, guild: m.guild,
                    role: change ? change.to : m.role,
                    class: m.class || '', isMain: m.isMain || false,
                    mainCharName: m.mainCharName || '', joinDate: m.joinDate || ''
                };
            });
            
            window.setLoadProgress(30, 'ì„œë²„ì— ì „ì†¡ ì¤‘...');
            const success = await window.sendAction('save_members', { members: allMembers });
            
            window.setLoadProgress(80, 'ë°ì´í„° ê°±ì‹  ì¤‘...');
            if(success) {
                window.showMsg(changes.length + 'ëª…ì˜ ì§ìœ„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                await window.fetchMembers();
            }
            window.showLoading(false);
            window._pendingRoleChanges = null;
        };
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ê´€ë¦¬', analysis: 'ìˆ˜ë¡œ ë¶„ì„', suro_input: 'ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥', bail: 'ë³´ì„ê¸ˆ ê´€ë¦¬', penalty: 'ë²Œì  ê´€ë¦¬ ì‹œìŠ¤í…œ', sheet: 'DB ì‹œíŠ¸ ë·°ì–´', guide_edit: 'ê°€ì´ë“œ í¸ì§‘', history: 'ìš´ì˜ ì´ë ¥', sync: 'ê¸¸ë“œì› ë™ê¸°í™”', settings: 'ì„¤ì •' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') window.renderDashboard(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'suro_input') window.renderSuroInput(content);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
            else if (tab === 'sheet') window.renderSheet(content);
            else if (tab === 'guide_edit') window.renderGuideEditor(content);
            else if (tab === 'history') window.renderHistory(content);
            else if (tab === 'sync') window.renderSync(content);
            else if (tab === 'settings') { window.renderSettings(content); setTimeout(() => window._loadAdminList(), 100); }
        };

        // --- DASHBOARD ---

        // â•â•â• adminDashboard (from admin, lines 1346-1484) â•â•â•
        window._adminDashboard = (container) => {
            const ddunT = window.calculateTotalSuro('ëš ì¹´ë¡±'); 
            const ddungT = window.calculateTotalSuro('ëš±ì¹´ë¡±');
            
            // ëš ì¹´ë¡± ì§ìœ„ë³„ ì¸ì›ìˆ˜
            const ddunMembers = appState.members.filter(m => m.guild === 'ëš ì¹´ë¡±');
            const roleCounts = {};
            ddunMembers.forEach(m => { const r = m.role || 'ë¯¸ì„¤ì •'; roleCounts[r] = (roleCounts[r] || 0) + 1; });
            const roleOrder = ['ë§ˆì¹´ë¡±','ë‹¤ì¿ ì•„ì¦ˆ','í¬ë¼ìš´','íŒŒë¥´í˜','í‹°ë¼ë¯¸ìŠˆ','í¬ë¡œì¹¸ìŠˆ','ë¡¤ì¼€ì´í¬','íŒ¬ì¼€ì´í¬','ì™€í”Œ','ìŠ¤ì½˜','ë°˜ì£½(íœ´ë©´)'];
            const roleEmoji = {'ë§ˆì¹´ë¡±':'ğŸ‘‘','ë‹¤ì¿ ì•„ì¦ˆ':'ğŸ‘‘','í¬ë¼ìš´':'ğŸ‘‘','íŒŒë¥´í˜':'ğŸ¨','í‹°ë¼ë¯¸ìŠˆ':'ğŸ°','í¬ë¡œì¹¸ìŠˆ':'ğŸ¥','ë¡¤ì¼€ì´í¬':'ğŸ¥','íŒ¬ì¼€ì´í¬':'ğŸ¥','ì™€í”Œ':'ğŸ§‡','ìŠ¤ì½˜':'ğŸª','ë°˜ì£½(íœ´ë©´)':'ğŸ«“'};
            const roleColorClass = {'ë§ˆì¹´ë¡±':'text-blue-600 bg-blue-50 border-blue-100','ë‹¤ì¿ ì•„ì¦ˆ':'text-pink-600 bg-pink-50 border-pink-100','í¬ë¼ìš´':'text-amber-600 bg-amber-50 border-amber-100','íŒŒë¥´í˜':'text-indigo-600 bg-indigo-50 border-indigo-100','í‹°ë¼ë¯¸ìŠˆ':'text-indigo-600 bg-indigo-50 border-indigo-100','í¬ë¡œì¹¸ìŠˆ':'text-green-600 bg-green-50 border-green-100','ë¡¤ì¼€ì´í¬':'text-pink-600 bg-pink-50 border-pink-100','íŒ¬ì¼€ì´í¬':'text-pink-600 bg-pink-50 border-pink-100','ì™€í”Œ':'text-orange-600 bg-orange-50 border-orange-100','ìŠ¤ì½˜':'text-gray-600 bg-gray-50 border-gray-100','ë°˜ì£½(íœ´ë©´)':'text-gray-400 bg-gray-50 border-gray-100'};
            const roleCountHtml = roleOrder.filter(r => roleCounts[r]).map(r => `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border ${roleColorClass[r] || 'bg-gray-50 border-gray-100'}"><span>${roleEmoji[r] || ''} ${r}</span><span class="font-black">${roleCounts[r]}ëª…</span></div>`).join('');

            // ëš±ì¹´ë¡± ì§ìœ„ë³„ ì¸ì›ìˆ˜
            const ddungMembers = appState.members.filter(m => m.guild === 'ëš±ì¹´ë¡±');
            const ddungRoleCounts = {};
            ddungMembers.forEach(m => { const r = m.role || 'ë¯¸ì„¤ì •'; ddungRoleCounts[r] = (ddungRoleCounts[r] || 0) + 1; });
            const ddungRoleOrder = ['ë§ˆì¹´ë¡±','ë‹¤ì¿ ì•„ì¦ˆ','ëš ì¼€ì´í¬','ëš ë¸Œë ˆë“œ','ì•„ì¸ìŠˆí˜ë„ˆ','ë¶€íŒ¬ì¼€ì´í¬','ìˆ˜í”Œë ˆ','ëš ìŠ¤ì½˜','ë¶€ì¼€ì´í¬','ë°˜ì£½(íœ´ë©´)'];
            const ddungRoleEmoji = {'ë§ˆì¹´ë¡±':'ğŸ‘‘','ë‹¤ì¿ ì•„ì¦ˆ':'ğŸ‘‘','ëš ì¼€ì´í¬':'ğŸ‚','ëš ë¸Œë ˆë“œ':'ğŸ','ì•„ì¸ìŠˆí˜ë„ˆ':'â˜•','ë¶€íŒ¬ì¼€ì´í¬':'ğŸ¥','ìˆ˜í”Œë ˆ':'ğŸ®','ëš ìŠ¤ì½˜':'ğŸª','ë¶€ì¼€ì´í¬':'ğŸ°','ë°˜ì£½(íœ´ë©´)':'ğŸ«“'};
            const ddungRoleColor = {'ë§ˆì¹´ë¡±':'text-blue-600 bg-blue-50 border-blue-100','ë‹¤ì¿ ì•„ì¦ˆ':'text-pink-600 bg-pink-50 border-pink-100','ëš ì¼€ì´í¬':'text-rose-600 bg-rose-50 border-rose-100','ëš ë¸Œë ˆë“œ':'text-amber-600 bg-amber-50 border-amber-100','ì•„ì¸ìŠˆí˜ë„ˆ':'text-emerald-600 bg-emerald-50 border-emerald-100','ë¶€íŒ¬ì¼€ì´í¬':'text-green-600 bg-green-50 border-green-100','ìˆ˜í”Œë ˆ':'text-purple-600 bg-purple-50 border-purple-100','ëš ìŠ¤ì½˜':'text-gray-600 bg-gray-50 border-gray-100','ë¶€ì¼€ì´í¬':'text-gray-500 bg-gray-50 border-gray-100','ë°˜ì£½(íœ´ë©´)':'text-gray-400 bg-gray-50 border-gray-100'};
            const ddungRoleCountHtml = ddungRoleOrder.filter(r => ddungRoleCounts[r]).map(r => `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border ${ddungRoleColor[r] || 'bg-gray-50 border-gray-100'}"><span>${ddungRoleEmoji[r] || ''} ${r}</span><span class="font-black">${ddungRoleCounts[r]}ëª…</span></div>`).join('');
            const adminBailStats = window.getAdminBailStats();
            const adminBailHtml = adminBailStats.map(([name, count]) => `<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><span class="text-[11px] font-bold text-gray-600">${name}</span><span class="text-[11px] font-black text-pink-500">${count}ê°œ</span></div>`).join('') || '<p class="text-[10px] text-gray-300 italic text-center py-4">ë³´ì„ê¸ˆ ë‚´ì—­ ì—†ìŒ</p>';
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 lg:gap-8 mb-4 lg:mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-4 lg:gap-6">
                    <div class="grid grid-cols-2 gap-3 lg:gap-6 h-auto lg:h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="bg-gradient-to-br from-pink-500 to-rose-500 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none min-h-[100px]">
                            <div class="absolute top-0 right-0 p-2 lg:p-4 opacity-20 text-3xl lg:text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-[10px] lg:text-sm font-bold opacity-80 uppercase tracking-widest text-center">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-xl lg:text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="bg-white border border-gray-100 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-center relative overflow-hidden min-h-[100px]">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-400 uppercase tracking-widest text-center">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-xl lg:text-3xl font-black tracking-tighter text-pink-500 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 lg:p-8 rounded-2xl lg:rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4 lg:mb-6">
                            <div class="flex items-center gap-2 lg:gap-3">
                                <span class="text-lg lg:text-2xl">ğŸ“…</span>
                                <h3 class="text-[10px] lg:text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-2 lg:gap-4">
                                <div class="flex items-center gap-1 lg:gap-2 bg-gray-50 px-2 lg:px-3 py-1 lg:py-1.5 rounded-xl lg:rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[10px] lg:text-[11px] font-bold text-gray-600 w-14 lg:w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                    <!-- ì§ìœ„ë³„ ì»¤íŠ¸ë¼ì¸ -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-pink-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-crown text-pink-400"></i> ëš ì¹´ë¡± ì§ìœ„ ì»¤íŠ¸ë¼ì¸</h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-100"><span class="text-yellow-700">ğŸ‘‘ í¬ë¼ìš´</span><span class="text-yellow-600">TOP 3</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg" style="background:linear-gradient(to right,#EBF0FF,#E8EDFF);border:1px solid #D6DFFF"><span class="text-blue-700">ğŸ¨ íŒŒë¥´í˜</span><span class="text-blue-600">130,000~</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg" style="background:linear-gradient(to right,#EBF0FF,#E8EDFF);border:1px solid #D6DFFF"><span class="text-blue-700">ğŸ° í‹°ë¼ë¯¸ìŠˆ</span><span class="text-blue-600">95,000 ~ 129,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg" style="background:linear-gradient(to right,#E8FFE8,#E5FAE5);border:1px solid #C8E6C8"><span class="text-green-700">ğŸ¥ í¬ë¡œì¹¸ìŠˆ</span><span class="text-green-600">72,000 ~ 94,999</span></div>
                                <div class="text-[9px] text-blue-500 font-bold pl-2.5 -mt-0.5 mb-1 flex items-center gap-1"><i class="fas fa-angle-double-up text-[8px]"></i> í¬ë¡œì¹¸ìŠˆ ì´ìƒ â€” ë¶€ìº ì „ë¶€ ìˆ˜ë¡œ ë©´ì œ</div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">ğŸ¥ ë¡¤ì¼€ì´í¬</span><span class="text-pink-600">50,000 ~ 71,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">ğŸ¥ íŒ¬ì¼€ì´í¬</span><span class="text-pink-600">38,000 ~ 49,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-orange-50 border border-orange-100"><span class="text-orange-700">ğŸ§‡ ì™€í”Œ</span><span class="text-orange-500">75,000~ <span class="text-[9px] text-gray-400">(ë¶€ìºì „ìš©)</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-600">ğŸª ìŠ¤ì½˜</span><span class="text-gray-500">0 ~ 37,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-400">ğŸ«“ ë°˜ì£½</span><span class="text-gray-400">íœ´ë©´</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-rose-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-heart text-rose-400"></i> ëš±ì¹´ë¡± ì§ìœ„ ì»¤íŠ¸ë¼ì¸</h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">ğŸ‚ ëš ì¼€ì´í¬</span><span class="text-pink-600">18,000~</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">ğŸ ëš ë¸Œë ˆë“œ</span><span class="text-pink-600">5,000 ~ 17,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-amber-50 border border-amber-100"><span class="text-amber-700">â˜• ì•„ì¸ìŠˆí˜ë„ˆ</span><span class="text-amber-500">ë¶€ìº ì§ìœ„ <span class="text-[9px] text-gray-400">ë…¸ë¸”O</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-amber-50 border border-amber-100"><span class="text-amber-700">ğŸ¥ ë¶€íŒ¬ì¼€ì´í¬</span><span class="text-amber-500">ë¶€ìº ì§ìœ„ <span class="text-[9px] text-gray-400">ë…¸ë¸”O</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-orange-50 border border-orange-100"><span class="text-orange-700">ğŸ® ìˆ˜í”Œë ˆ</span><span class="text-orange-500">35,000~ <span class="text-[9px] text-gray-400">(ë¶€ìºì „ìš©)</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-600">ğŸª ëš ìŠ¤ì½˜</span><span class="text-gray-500">0 ~ 4,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-600">ğŸ° ë¶€ì¼€ì´í¬</span><span class="text-gray-400">ë¶€ìº ì§ìœ„ <span class="text-[9px]">ë…¸ë¸”X</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-400">ğŸ«“ ë°˜ì£½</span><span class="text-gray-400">íœ´ë©´</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- ì§ìœ„ë³„ ì¸ì›ìˆ˜ (ëš ì¹´ë¡± + ëš±ì¹´ë¡±) -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-pink-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-users text-pink-400"></i> ëš ì¹´ë¡± ì§ìœ„ë³„ ì¸ì› <span class="text-gray-400 font-bold">(${ddunMembers.length}ëª…)</span></h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${roleCountHtml}</div>
                        </div>
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-rose-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-users text-rose-400"></i> ëš±ì¹´ë¡± ì§ìœ„ë³„ ì¸ì› <span class="text-gray-400 font-bold">(${ddungMembers.length}ëª…)</span></h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${ddungRoleCountHtml}</div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-4 lg:gap-8 h-full">
                    <div class="bg-white p-5 lg:p-10 rounded-2xl lg:rounded-[3rem] shadow-sm border border-gray-100 flex flex-col min-h-[250px] lg:min-h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-3 lg:mb-4 shrink-0">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-chart-bar text-pink-300"></i> ì§ì—… ë¶„í¬ë„</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 border border-gray-100">
                                <option value="all">ì „ì²´ë³´ê¸°</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar relative">
                            <div id="jobChartContainer" class="flex flex-col gap-3 lg:gap-4"></div>
                        </div>
                        <button onclick="window.toggleJobChart()" id="jobToggleBtn" class="mt-3 py-2 text-[10px] font-bold text-gray-400 hover:text-pink-500 transition-all flex items-center justify-center gap-1"><i class="fas fa-chevron-down text-[8px]" id="jobToggleIcon"></i> <span id="jobToggleText">ë”ë³´ê¸°</span></button>
                    </div>
                    <div class="bg-white p-5 lg:p-10 rounded-2xl lg:rounded-[3rem] shadow-sm border border-gray-100 flex flex-col flex-1 min-h-[150px] lg:min-h-[200px] overflow-hidden">
                        <div class="flex items-center justify-between mb-4 lg:mb-6">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-400 uppercase tracking-widest">ê°„ë¶€ì§„ ë³´ì„ê¸ˆ í˜„í™©</h3>
                            <i class="fas fa-gem text-pink-300"></i>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar pr-2">${adminBailHtml}</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3 lg:gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-4 lg:p-8 rounded-2xl lg:rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-3 lg:mb-6"><div class="flex items-center gap-2 lg:gap-3"><div class="w-8 h-8 lg:w-10 lg:h-10 bg-gray-50 rounded-xl lg:rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors text-xs lg:text-base"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-sm lg:text-lg text-gray-800 group-hover:text-pink-500">${g.name}</span><span class="text-[8px] lg:text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1 lg:h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[9px] lg:text-[10px] text-gray-400 font-bold mt-1.5 lg:mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };


        // â•â•â• adminMembers (from admin, lines 2314-2443) â•â•â•
        window._adminMembers = (container) => {
            container.innerHTML = `
            <div class="flex flex-col gap-2 lg:gap-3 fade-in h-full">
                <div class="bg-white p-3 lg:p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-3 shrink-0">
                    <div class="flex overflow-x-auto no-scrollbar w-full gap-1.5 lg:gap-2 shrink-0 pb-0.5">
                        <button onclick="window.filterByGuild('all')" class="shrink-0 px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === 'all' ? 'bg-white/20 text-white' : 'bg-gray-200/60 text-gray-400'}">${appState.members.length}</span></button>
                        ${appState.guilds.map(g => { const gc = appState.members.filter(m => m.guild === g.name).length; const gColors = {'ëš ì¹´ë¡±':['bg-pink-500','bg-pink-400/20'],'ëš±ì¹´ë¡±':['bg-rose-600','bg-rose-400/20'],'ë°¤ì¹´ë¡±':['bg-indigo-500','bg-indigo-400/20'],'ë³„ì¹´ë¡±':['bg-amber-500','bg-amber-400/20'],'ë‹¬ì¹´ë¡±':['bg-blue-500','bg-blue-400/20'],'ê¿€ì¹´ë¡±':['bg-orange-500','bg-orange-400/20']}; const [activeBg, activeBadge] = gColors[g.name] || ['bg-pink-500','bg-pink-400/20']; return `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === g.name ? activeBg + ' text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === g.name ? 'bg-white/25 text-white' : 'bg-gray-200/60 text-gray-400'}">${gc}</span></button>`; }).join('')}
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 lg:left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-8 lg:pl-10 pr-3 lg:pr-4 py-2 lg:py-2.5 bg-gray-50 border border-gray-100 rounded-xl outline-none text-[11px] lg:text-xs font-bold shadow-inner focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰ (ë„ì–´ì“°ê¸°ë¡œ ë‹¤ì¤‘ê²€ìƒ‰)">
                        </div>

                        <div class="flex gap-1.5 lg:gap-2 shrink-0 flex-wrap">
                            <button onclick="window.toggleKickMode()" class="px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all ${appState.isKickMode ? 'bg-red-500 text-white shadow-md animate-pulse' : 'bg-red-50 text-red-500 hover:bg-red-100'}">
                                <i class="fas fa-user-minus mr-1"></i> <span class="hidden sm:inline">ì¼ê´„ ì¶”ë°©</span> ${appState.isKickMode?'ON':'OFF'}
                            </button>
                            ${appState.isKickMode && appState.kickSelection.size > 0 ? `<button onclick="window.openBulkKickModal()" class="px-3 lg:px-4 py-1.5 lg:py-2 bg-red-600 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-md hover:bg-red-700 transition-all">${appState.kickSelection.size}ëª… ì¶”ë°©</button>` : ''}
                            
                            ${!appState.isKickMode ? `
                            <button onclick="window.toggleBatchMode()" class="px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all ${appState.isBatchMode ? 'bg-gray-800 text-white shadow-md' : 'bg-pink-50 text-pink-500 hover:bg-pink-100'}">
                                <i class="fas fa-edit mr-1"></i> <span class="hidden sm:inline">ì¼ê´„ ìˆ˜ì •</span> ${appState.isBatchMode?'OFF':'ON'}
                            </button>
                            ${appState.isBatchMode ? `<button onclick="window.saveBatchUpdates()" class="px-3 lg:px-4 py-1.5 lg:py-2 bg-pink-500 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-md animate-pulse">ì €ì¥</button>` : ''}
                            <button onclick="window.openAddModal()" class="w-8 h-8 lg:w-9 lg:h-9 flex items-center justify-center rounded-xl bg-pink-50 text-pink-500 hover:bg-pink-100 shadow-sm shrink-0"><i class="fas fa-plus text-xs"></i></button>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <div id="memberTableContainer" class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
            </div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            
            const rawSearchTerm = appState.filters.search.trim();
            const searchTokens = rawSearchTerm.length > 0 
                ? rawSearchTerm.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0)
                : [];

            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                if (searchTokens.length === 0) return gMatch;
                const sMatch = searchTokens.some(token => {
                    return m.name.toLowerCase().includes(token) || 
                           (m.class||'').toLowerCase().includes(token) || 
                           (m.role||'').toLowerCase().includes(token) ||
                           (m.mainCharName || '').toLowerCase().includes(token) || 
                           (m.isMain && m.name.toLowerCase().includes(token)); 
                });
                return gMatch && sMatch; 
            });

            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.members > totalPages && totalPages > 0) appState.pagination.members = totalPages;
            if (appState.pagination.members < 1) appState.pagination.members = 1;
            
            const pageData = filtered.slice((appState.pagination.members - 1) * ITEMS_PER_PAGE, appState.pagination.members * ITEMS_PER_PAGE);
            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            
            let html = `<div class="overflow-auto flex-1 relative -webkit-overflow-scrolling-touch"><table class="w-full text-left min-w-[700px] lg:min-w-[900px] text-[10px] lg:text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[9px] lg:text-[10px] font-bold text-gray-500 border-b border-gray-100 shadow-sm"><tr><th class="py-2 px-2 text-center w-8 lg:w-12">${appState.isKickMode ? 'ì„ íƒ' : 'No.'}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('name')">ë‹‰ë„¤ì„${sortIcon('name')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('mainInfo')">ë³¸ìº${sortIcon('mainInfo')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('role')">ì§ìœ„${sortIcon('role')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('class')">ì§ì—…${sortIcon('class')}</th><th class="py-2 px-2 text-right">ê´€ë¦¬</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            
            pageData.forEach((m, idx) => {
                const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                const mainMem = appState.members.find(x => x.name === mainName);
                const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                
                const targetRole = mainMem ? mainMem.role : (m.isMain ? m.role : '');
                
                // í¬ë¡œì¹¸ìŠˆ ì´ìƒë§Œ ì¢Œì¸¡ í…Œë‘ë¦¬ í‘œì‹œ
                let rowStyle = "";
                if (targetRole === 'í¬ë¼ìš´') {
                    rowStyle = "background:linear-gradient(to right,#FFF9E6,#FFF3CC);border-left:3px solid #F0C050;";
                } else if (targetRole === 'íŒŒë¥´í˜') {
                    rowStyle = "background:linear-gradient(to right,#EBF0FF,#E4EAFF);border-left:3px solid #8EA8F0;";
                } else if (targetRole === 'í‹°ë¼ë¯¸ìŠˆ') {
                    rowStyle = "background:linear-gradient(to right,#EBF0FF,#E8EDFF);border-left:3px solid #A0B4E8;";
                } else if (targetRole === 'í¬ë¡œì¹¸ìŠˆ') {
                    rowStyle = "background:linear-gradient(to right,#EEFFEE,#E5FAE5);border-left:3px solid #92D050;";
                }

                const pending = appState.pendingUpdates[m.id];
                const currentGuild = pending && pending.guild ? pending.guild : m.guild;
                const currentRole = pending && pending.role ? pending.role : m.role;
                const currentClass = pending && pending.class ? pending.class : (m.class || '');

                let roleHtml = `<span class="text-[10px]">${m.role}</span>`;
                if (!appState.isBatchMode && m.role === 'ì•„ì¸ìŠˆí˜ë„ˆ') {
                    roleHtml = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold text-white tracking-tight shadow-sm" style="background-color: #FF99FF; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">${m.role}</span>`;
                }

                html += `<tr class="${pending ? 'batch-modified' : ''} hover:bg-pink-50/20 group transition-colors" style="${rowStyle}">
                    <td class="py-1.5 px-2 text-center text-gray-400 text-[11px]">
                        ${appState.isKickMode 
                            ? `<input type="checkbox" class="custom-checkbox" ${appState.kickSelection.has(m.id) ? 'checked' : ''} onchange="window.handleKickSelect('${m.id}')">`
                            : globalIndex}
                    </td>
                    <td class="py-1.5 px-2 font-bold text-gray-800 flex items-center leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td>
                    <td class="py-1.5 px-2 leading-tight">
                        <span class="block text-[11px] font-bold text-gray-700">${mainName}</span>
                        <span class="text-[9px] font-medium text-gray-400">${mainRankHtml}</span>
                    </td>
                    <td class="py-1.5 px-2">${appState.isBatchMode ? `<select onchange="window.stageUpdate('${m.id}', 'guild', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${appState.guilds.map(g=>`<option value="${g.name}" ${currentGuild===g.name?'selected':''}>${g.name}</option>`).join('')}</select>` : m.guild}</td>
                    <td class="py-1.5 px-2">${appState.isBatchMode ? `<select onchange="window.stageUpdate('${m.id}', 'role', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${(appState.guildRanks[currentGuild]||initialGuildRanks[currentGuild]||initialGuildRanks['ëš ì¹´ë¡±']).map(r=>`<option value="${r}" ${currentRole===r?'selected':''}>${r}</option>`).join('')}</select>` : roleHtml}</td>
                    <td class="py-1.5 px-2">${appState.isBatchMode ? `<input type="text" value="${currentClass}" onchange="window.stageUpdate('${m.id}', 'class', this.value)" class="bg-white border rounded px-1 text-[10px] w-24 outline-none">` : `<span class="text-[10px] text-gray-400">${m.class||'-'}</span>`}</td>
                    <td class="py-1.5 px-2 text-right">
                        ${!appState.isBatchMode && !appState.isKickMode ? `<div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="window.openEditModal('${m.id}')" class="w-7 h-7 rounded-lg border border-gray-100 text-blue-500 hover:bg-blue-50 flex items-center justify-center shadow-sm"><i class="fas fa-edit text-[10px]"></i></button><button onclick="window.openDeleteModal('${m.id}')" class="w-7 h-7 rounded-lg border border-gray-100 text-red-500 hover:bg-red-50 flex items-center justify-center shadow-sm"><i class="fas fa-trash text-[10px]"></i></button></div>` : '<span class="text-[9px] text-gray-300">-</span>'}
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            
            html += `<div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50 relative z-20">
                <button onclick="changePage('members', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                <span class="text-xs font-bold text-gray-500">${appState.pagination.members} / ${totalPages || 1}</span>
                <button onclick="changePage('members', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
            </div>`;

            container.innerHTML = html;
        };


        // â•â•â• adminBail (from admin, lines 2444-2538) â•â•â•
        window._adminBail = (container) => {
            const receivers = appState.members.filter(m => m.guild === 'ëš ì¹´ë¡±' && ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'].includes(m.role)).sort((a,b) => smartCompare(a, b, 'name', 'asc'));
            const adminStats = window.getAdminBailStats();
            const totalStats = window.getBailTotalStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => {
                const amt = parseInt(h.amount) || 0;
                const isUse = amt < 0;
                const typeBadge = isUse ? '<span class="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded text-[9px] font-bold">ì‚¬ìš©</span>' : '<span class="bg-pink-100 text-pink-600 px-1.5 py-0.5 rounded text-[9px] font-bold">ë‚©ë¶€</span>';
                const amtColor = isUse ? 'text-blue-500' : 'text-pink-500';
                const amtDisplay = isUse ? `${amt}ê°œ` : `+${amt}ê°œ`;
                const memo = h.memo ? `<span class="text-[10px] text-gray-400 ml-1">(${h.memo})</span>` : '';
                return `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 font-mono text-gray-400 text-[10px]">${h.date}</td><td class="p-4">${typeBadge}</td><td class="p-4 text-gray-700">${h.payer}${memo}</td><td class="p-4 text-blue-500">${h.receiver}</td><td class="p-4 text-right ${amtColor}">${amtDisplay}</td></tr>`;
            }).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black ${count >= 0 ? 'text-pink-500' : 'text-blue-500'} text-lg">${count}ê°œ</span></div>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
                <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">ë³´ì„ê¸ˆ ê´€ë¦¬</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL MANAGEMENT</p>
                    </div>
                    <div class="flex gap-2 mb-6" id="bailTypeToggle">
                        <button onclick="window.setBailType('deposit')" class="bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all bg-pink-500 text-white shadow-md" data-type="deposit">ğŸ’ ë‚©ë¶€</button>
                        <button onclick="window.setBailType('use')" class="bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all bg-gray-100 text-gray-400 hover:bg-gray-200" data-type="use">ğŸ“¦ ì‚¬ìš©</button>
                    </div>
                    <div class="space-y-6 flex-1 overflow-y-auto no-scrollbar pb-6">
                        <div id="bailDepositForm">
                            <div class="space-y-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ë‚©ë¶€ì</label><input type="text" id="bailPayerInput" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" placeholder="ë‹‰ë„¤ì„ ì§ì ‘ ì…ë ¥"></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ìˆ˜ë ¹ì</label><select id="bailReceiver" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer">${receivers.map(r=>`<option value="${r.name}">${r.name} (${r.role})</option>`).join('')}</select></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ìˆ˜ëŸ‰</label><input type="number" id="bailAmount" value="1" min="1" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner"></div>
                                <button onclick="window.submitBail()" id="btnBailSubmit" class="w-full py-6 bg-gray-900 text-white rounded-[2rem] font-bold text-xs shadow-2xl hover:bg-black transition-all active:scale-[0.98]">ğŸ’ ë‚©ë¶€ í™•ì¸ ë° ì €ì¥</button>
                            </div>
                        </div>
                        <div id="bailUseForm" class="hidden">
                            <div class="space-y-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ì‚¬ìš© ì‚¬ìœ </label><input type="text" id="bailUseMemo" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" placeholder="ì˜ˆ: ê¸¸ë“œ ì´ë²¤íŠ¸ ë³´ìƒ"></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ë‹´ë‹¹ì</label><select id="bailUseReceiver" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer">${receivers.map(r=>`<option value="${r.name}">${r.name} (${r.role})</option>`).join('')}</select></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ì‚¬ìš© ìˆ˜ëŸ‰</label><input type="number" id="bailUseAmount" value="1" min="1" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner"></div>
                                <button onclick="window.submitBailUse()" id="btnBailUseSubmit" class="w-full py-6 bg-blue-600 text-white rounded-[2rem] font-bold text-xs shadow-2xl hover:bg-blue-700 transition-all active:scale-[0.98]">ğŸ“¦ ì‚¬ìš© í™•ì¸ ë° ì €ì¥</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t">
                            <div class="bg-pink-50 rounded-xl p-3 text-center"><p class="text-[9px] text-gray-400 font-bold">ì´ ë‚©ë¶€</p><p class="text-sm font-black text-pink-500">+${totalStats.totalIn}</p></div>
                            <div class="bg-blue-50 rounded-xl p-3 text-center"><p class="text-[9px] text-gray-400 font-bold">ì´ ì‚¬ìš©</p><p class="text-sm font-black text-blue-500">-${totalStats.totalOut}</p></div>
                            <div class="bg-gray-50 rounded-xl p-3 text-center"><p class="text-[9px] text-gray-400 font-bold">ì”ì—¬</p><p class="text-sm font-black ${totalStats.net >= 0 ? 'text-green-500' : 'text-red-500'}">${totalStats.net}</p></div>
                        </div>
                        <div class="mt-4 border-t pt-4"><h4 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">ê°„ë¶€ë³„ ìˆ˜ë ¹ ì´ê³„</h4><div class="grid grid-cols-1 gap-2">${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center">ë°ì´í„° ì—†ìŒ</p>'}</div></div>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë³´ì„ê¸ˆ ë‚´ì—­ (yy-mm-dd)</h3>
                        <span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase"><tr><th class="p-5">ë‚ ì§œ</th><th class="p-5">êµ¬ë¶„</th><th class="p-5">ë‚©ë¶€ì/ì‚¬ìœ </th><th class="p-5">ìˆ˜ë ¹ì</th><th class="p-5 text-right">ìˆ˜ëŸ‰</th></tr></thead>
                            <tbody class="divide-y divide-gray-50">${historyRows || '<tr><td colspan="5" class="p-20 text-center text-gray-300 font-bold italic">ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        window.setBailType = (type) => {
            const depForm = document.getElementById('bailDepositForm');
            const useForm = document.getElementById('bailUseForm');
            const btns = document.querySelectorAll('.bail-type-btn');
            btns.forEach(b => {
                if (b.dataset.type === type) { b.className = 'bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all ' + (type === 'deposit' ? 'bg-pink-500 text-white shadow-md' : 'bg-blue-600 text-white shadow-md'); }
                else { b.className = 'bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all bg-gray-100 text-gray-400 hover:bg-gray-200'; }
            });
            if (type === 'deposit') { depForm.classList.remove('hidden'); useForm.classList.add('hidden'); }
            else { depForm.classList.add('hidden'); useForm.classList.remove('hidden'); }
        };

        window.submitBail = async () => {
            const pI = document.getElementById('bailPayerInput'), rI = document.getElementById('bailReceiver'), aI = document.getElementById('bailAmount'), btn = document.getElementById('btnBailSubmit');
            const payer = pI.value.trim(), receiver = rI.value, amount = aI.value; if(!payer || !receiver || !amount) return window.showMsg("í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.", "error");
            if(!confirm(`${payer} ë‹˜ì˜ ë³´ì„ê¸ˆ ${amount}ê°œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            if (btn) { btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘..."; }
            if (await window.sendAction('save_bail', { payer, receiver, amount })) { pI.value = ''; aI.value = '1'; }
            else if (btn) { btn.disabled = false; btn.innerText = "ğŸ’ ë‚©ë¶€ í™•ì¸ ë° ì €ì¥"; }
        };

        window.submitBailUse = async () => {
            const mI = document.getElementById('bailUseMemo'), rI = document.getElementById('bailUseReceiver'), aI = document.getElementById('bailUseAmount'), btn = document.getElementById('btnBailUseSubmit');
            const memo = mI.value.trim(), receiver = rI.value, amount = aI.value; if(!memo || !receiver || !amount) return window.showMsg("í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.", "error");
            const negAmount = '-' + amount;
            if(!confirm(`ë³´ì„ê¸ˆ ${amount}ê°œ ì‚¬ìš© (${memo})ì„ ê¸°ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            if (btn) { btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘..."; }
            if (await window.sendAction('save_bail', { payer: memo, receiver, amount: negAmount, memo })) { mI.value = ''; aI.value = '1'; }
            else if (btn) { btn.disabled = false; btn.innerText = "ğŸ“¦ ì‚¬ìš© í™•ì¸ ë° ì €ì¥"; }
        };


        // â•â•â• adminPenalty (from admin, lines 2539-2656) â•â•â•
        window._adminPenalty = (container) => {
            const memberOptions = appState.members.map(m => `<option value="${m.name}">${m.name} (${m.guild})</option>`).sort();
            
            const penaltyCounts = {};
            appState.penaltyHistory.forEach(h => {
                penaltyCounts[h.name] = (penaltyCounts[h.name] || 0) + Number(h.points);
            });
            const activePenalties = Object.entries(penaltyCounts).filter(([name, pts]) => pts > 0);

            const penaltyRows = [...appState.penaltyHistory].map(h => {
                let displayDate = "-";
                if(h.date) {
                    const datePart = h.date.split(' ')[0];
                    if(datePart.length >= 2) displayDate = datePart.substring(2);
                }
                
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <td class="p-4 font-mono text-gray-400 text-[10px]">${displayDate}</td>
                    <td class="p-4 text-gray-700">${h.name}</td>
                    <td class="p-4 text-red-500">${h.points}ì </td>
                    <td class="p-4 text-gray-500 text-[11px]">${h.reason}</td>
                </tr>
            `}).join('');

            container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-8 fade-in h-full">
                <div class="lg:col-span-1 bg-white p-5 lg:p-10 rounded-2xl lg:rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-4 lg:mb-8">
                        <h3 class="text-base lg:text-xl font-bold text-gray-800 tracking-tight">ë²Œì  ë¶€ì—¬</h3>
                        <p class="text-[10px] lg:text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">PENALTY RECORD</p>
                    </div>
                    <div class="space-y-4 lg:space-y-6 flex-1 overflow-y-auto no-scrollbar pb-4 lg:pb-6">
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">ë¶€ì—¬ ë‚ ì§œ</label>
                            <input type="date" id="penaltyDate" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-inner" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">ëŒ€ìƒì</label>
                            <select id="penaltyTarget" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-sm cursor-pointer">
                                <option value="">ëŒ€ìƒìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                ${memberOptions}
                            </select>
                        </div>
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">ë²Œì  (1~10ì )</label>
                            <select id="penaltyPoints" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-sm cursor-pointer">
                                ${[1,2,3,4,5,6,7,8,9,10].map(i => `<option value="${i}">${i}ì </option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">ë¶€ì—¬ ì‚¬ìœ </label>
                            <textarea id="penaltyReason" rows="3" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-inner resize-none" placeholder="ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        <button onclick="window.submitPenalty()" id="btnPenaltySubmit" class="w-full py-4 lg:py-6 bg-red-600 text-white rounded-xl lg:rounded-[2rem] font-bold text-[10px] lg:text-xs shadow-xl hover:bg-red-700 transition-all active:scale-[0.98] mt-2 lg:mt-4">ë²Œì  ì €ì¥</button>
                    </div>
                </div>

                <div class="lg:col-span-2 flex flex-col gap-4 lg:gap-6 h-full overflow-hidden">
                    <div class="bg-white p-5 lg:p-8 rounded-2xl lg:rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[120px] lg:min-h-[160px]">
                        <div class="mb-3 lg:mb-4">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-800 uppercase tracking-widest">í˜„ì¬ ë²Œì  ê´€ë¦¬ ëŒ€ìƒì</h3>
                        </div>
                        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                            ${activePenalties.length > 0 
                                ? activePenalties.map(([name, pts]) => `
                                    <div class="flex items-center gap-3 bg-red-50 pl-2 pr-5 py-2 rounded-full border border-red-100 shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 font-bold text-xs shadow-sm">${pts}</div>
                                        <span class="text-xs font-bold text-red-600">${name}</span>
                                    </div>
                                  `).join('')
                                : '<p class="text-xs text-gray-300 font-bold italic w-full">í˜„ì¬ ë²Œì ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                            }
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl lg:rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden h-full">
                        <div class="p-4 lg:p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-800 uppercase tracking-widest">ìƒì„¸ ë¶€ì—¬ ì´ë ¥</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar">
                            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                                <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase">
                                    <tr>
                                        <th class="p-5">ë‚ ì§œ</th>
                                        <th class="p-5">ëŒ€ìƒì</th>
                                        <th class="p-5">ì ìˆ˜</th>
                                        <th class="p-5">ë¶€ì—¬ ì‚¬ìœ </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${penaltyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">ë²Œì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        window.submitPenalty = async () => {
            const date = document.getElementById('penaltyDate').value;
            const target = document.getElementById('penaltyTarget').value;
            const points = document.getElementById('penaltyPoints').value;
            const reason = document.getElementById('penaltyReason').value.trim();
            const btn = document.getElementById('btnPenaltySubmit');

            if (!date || !target || !points || !reason) return window.showMsg("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
            if (!confirm(`${target}ë‹˜ì—ê²Œ ${date} ì¼ìë¡œ ë²Œì  ${points}ì ì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            if (btn) { btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘..."; }
            if (await window.sendAction('save_penalty', { date: date, name: target, points: points, reason: reason })) {
                document.getElementById('penaltyReason').value = '';
            } else if (btn) {
                btn.disabled = false; btn.innerText = "ë²Œì  ì €ì¥";
            }
        };


        // â•â•â• sheet (from admin, lines 2657-3180) â•â•â•
        window.renderSheet = (container) => {
            if (!window._sheetState) {
                window._sheetState = { guild: 'ëš ì¹´ë¡±', search: '', mode: 'members', edited: {}, suroEdited: {} };
            }
            const ss = window._sheetState;

            container.innerHTML = `
            <div class="h-full flex flex-col gap-3 fade-in">
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4 lg:p-5 shrink-0">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <h3 class="text-sm lg:text-base font-bold text-gray-800"><i class="fas fa-table mr-2 text-emerald-500"></i>DB ì‹œíŠ¸ ë·°ì–´</h3>
                        <div class="flex gap-1.5 ml-auto">
                            ${['members','bail_history','penalty_history','operation_history','events'].map(t => 
                                `<button onclick="window._sheetState.mode='${t}';window._sheetState.edited={};window._sheetState.suroEdited={};window.renderSheet(document.getElementById('contentArea'))" class="px-2.5 py-1 rounded-lg text-[9px] font-bold transition-all ${ss.mode === t ? 'bg-emerald-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">${({members:'ë©¤ë²„+ìˆ˜ë¡œ',bail_history:'ë³´ì„ê¸ˆ',penalty_history:'ë²Œì ',operation_history:'ìš´ì˜ì´ë ¥',events:'ì¼ì •'})[t]}</button>`
                            ).join('')}
                        </div>
                    </div>
                    ${ss.mode === 'members' ? `
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="flex gap-1">
                            ${appState.guilds.map(g => 
                                `<button onclick="window._sheetState.guild='${g.name}';window.renderSheet(document.getElementById('contentArea'))" class="px-2.5 py-1.5 rounded-lg text-[9px] font-bold transition-all ${ss.guild === g.name ? 'bg-pink-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">${g.name.replace('ì¹´ë¡±','')}</button>`
                            ).join('')}
                        </div>
                        <input type="text" id="sheetSearch" placeholder="ì´ë¦„ ê²€ìƒ‰..." value="${ss.search}" oninput="window._sheetState.search=this.value;window._sheetRender()" class="bg-gray-50 border border-gray-100 rounded-lg px-2.5 py-1.5 text-[10px] font-bold outline-none w-36 shadow-inner">
                        <button onclick="window._sheetSave()" id="sheetSaveBtn" class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-[9px] font-bold shadow hover:bg-emerald-600 transition-all hidden"><i class="fas fa-save mr-1"></i>ì €ì¥</button>
                        <button onclick="window._sheetDiscard()" id="sheetDiscardBtn" class="px-3 py-1.5 bg-gray-400 text-white rounded-lg text-[9px] font-bold shadow hover:bg-gray-500 transition-all hidden"><i class="fas fa-undo mr-1"></i>ì·¨ì†Œ</button>
                        <span id="sheetEditCount" class="text-[9px] font-bold text-orange-500"></span>
                        <span class="text-[9px] text-gray-400 font-bold ml-auto" id="sheetCount"></span>
                    </div>` : `
                    <div class="flex flex-wrap items-center gap-2">
                        <button onclick="window._sheetAddRow()" class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-[9px] font-bold shadow hover:bg-blue-600 transition-all"><i class="fas fa-plus mr-1"></i>í–‰ ì¶”ê°€</button>
                        <button onclick="window._sheetSaveOther()" id="sheetOtherSaveBtn" class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-[9px] font-bold shadow hover:bg-emerald-600 transition-all hidden"><i class="fas fa-save mr-1"></i>ì €ì¥</button>
                        <button onclick="window._sheetDiscardOther()" id="sheetOtherDiscardBtn" class="px-3 py-1.5 bg-gray-400 text-white rounded-lg text-[9px] font-bold shadow hover:bg-gray-500 transition-all hidden"><i class="fas fa-undo mr-1"></i>ì·¨ì†Œ</button>
                        <span id="sheetOtherEditCount" class="text-[9px] font-bold text-orange-500"></span>
                        <span class="text-[9px] text-gray-400 font-bold ml-auto" id="sheetOtherCount"></span>
                    </div>`}
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden">
                    <div class="overflow-auto h-full" id="sheetTableWrap" style="max-height:68vh"></div>
                </div>
            </div>`;

            window._sheetRender();
        };

        window._sheetRender = () => {
            const wrap = document.getElementById('sheetTableWrap');
            if (!wrap) return;
            const ss = window._sheetState;

            if (ss.mode === 'members') {
                window._sheetRenderMembers(wrap);
            } else {
                window._sheetRenderTable(wrap, ss.mode);
            }
        };

        window._sheetUpdateButtons = () => {
            const ss = window._sheetState;
            const editCount = Object.keys(ss.edited).length + Object.keys(ss.suroEdited).length;
            const saveBtn = document.getElementById('sheetSaveBtn');
            const discardBtn = document.getElementById('sheetDiscardBtn');
            const countEl = document.getElementById('sheetEditCount');
            if (saveBtn) saveBtn.classList.toggle('hidden', editCount === 0);
            if (discardBtn) discardBtn.classList.toggle('hidden', editCount === 0);
            if (countEl) countEl.textContent = editCount > 0 ? `${editCount}ê±´ ìˆ˜ì •ë¨` : '';
        };

        // â”€â”€ ë©¤ë²„+ìˆ˜ë¡œ ì‹œíŠ¸ (í¸ì§‘ ê°€ëŠ¥) â”€â”€
        window._sheetRenderMembers = (wrap) => {
            const ss = window._sheetState;
            const headers = appState.suroHeaders || [];
            
            let members = appState.members.filter(m => m.guild === ss.guild);
            if (ss.search.trim()) {
                const q = ss.search.toLowerCase();
                members = members.filter(m => m.name.toLowerCase().includes(q) || (m.mainCharName||'').toLowerCase().includes(q));
            }
            members.sort((a, b) => a.name < b.name ? -1 : a.name > b.name ? 1 : 0);

            const countEl = document.getElementById('sheetCount');
            if (countEl) countEl.textContent = `${members.length}ëª…`;

            const shortHeaders = headers.map(h => {
                const match = h.match(/~ (\d{2}-\d{2}-\d{2}\([^)]+\))/);
                return match ? match[1] : h.substring(0, 15);
            });

            const memberFields = [
                { key: 'role', label: 'ì§ìœ„', w: 60 },
                { key: 'class', label: 'ì§ì—…', w: 55 },
                { key: 'isMain', label: 'ë³¸ìº', w: 40, center: true },
                { key: 'mainCharName', label: 'ë³¸ìºë‹‰', w: 60 }
            ];

            let html = `<table class="w-full text-left border-collapse" style="min-width:${500 + memberFields.length * 60 + headers.length * 85}px">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr class="text-[8px] lg:text-[9px] font-bold text-gray-500 uppercase">
                        <th class="p-1.5 border-b border-r border-gray-100 w-6 text-center sticky left-0 bg-gray-50 z-20">#</th>
                        <th class="p-1.5 border-b border-r border-gray-100 sticky left-6 bg-gray-50 z-20" style="min-width:70px">ë‹‰ë„¤ì„</th>
                        <th class="p-1.5 border-b border-r border-gray-100" style="min-width:50px">ê¸¸ë“œ</th>
                        ${memberFields.map(f => `<th class="p-1.5 border-b border-r border-gray-100 ${f.center?'text-center':''}" style="min-width:${f.w}px">${f.label}</th>`).join('')}
                        ${shortHeaders.map(h => `<th class="p-1.5 border-b border-r border-gray-100 text-center text-emerald-600" style="min-width:80px">${h}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="text-[10px] lg:text-[11px] font-bold">`;

            members.forEach((m, i) => {
                const mid = m.id;
                const mEdits = ss.edited[mid] || {};
                const totalCols = 3 + memberFields.length + headers.length;
                
                if (i > 0 && i % 17 === 0) {
                    html += `<tr><td colspan="${totalCols}" class="p-0"><div class="h-[3px] bg-pink-200"></div></td></tr>`;
                }
                
                html += `<tr class="hover:bg-pink-50/30 transition-colors border-b border-gray-50 ${Object.keys(mEdits).length > 0 ? 'bg-orange-50/50' : ''}">
                    <td class="p-1 text-[9px] text-gray-300 border-r border-gray-50 text-center font-mono sticky left-0 bg-white z-10">${i+1}</td>
                    <td class="p-1 border-r border-gray-50 text-gray-800 sticky left-6 bg-white z-10 whitespace-nowrap">${m.name}</td>
                    <td class="p-1 border-r border-gray-50 text-gray-500">${m.guild}</td>`;
                
                // Editable member fields
                memberFields.forEach(f => {
                    const val = mEdits[f.key] !== undefined ? mEdits[f.key] : (f.key === 'isMain' ? (m.isMain ? 'TRUE' : 'FALSE') : (m[f.key] || ''));
                    const wasEdited = mEdits[f.key] !== undefined;
                    if (f.key === 'class') {
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <select class="w-full px-0.5 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors cursor-pointer"
                                onchange="window._sheetEditMember('${mid}','class',this.value)">
                                <option value="">-</option>
                                ${MAPLE_JOBS.map(j => `<option value="${j}" ${val === j ? 'selected' : ''}>${j}</option>`).join('')}
                            </select>
                        </td>`;
                    } else if (f.key === 'role') {
                        const guildRoles = initialGuildRanks[m.guild] || [];
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <select class="w-full px-0.5 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors cursor-pointer"
                                onchange="window._sheetEditMember('${mid}','role',this.value)">
                                ${guildRoles.map(r => `<option value="${r}" ${val === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                        </td>`;
                    } else if (f.key === 'isMain') {
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <select class="w-full px-0.5 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors text-center cursor-pointer"
                                onchange="window._sheetEditMember('${mid}','isMain',this.value)">
                                <option value="TRUE" ${val === 'TRUE' ? 'selected' : ''}>TRUE</option>
                                <option value="FALSE" ${val === 'FALSE' ? 'selected' : ''}>FALSE</option>
                            </select>
                        </td>`;
                    } else {
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <input type="text" value="${String(val).replace(/"/g, '&quot;')}" 
                                class="w-full px-1 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors ${f.center?'text-center':''}" 
                                onfocus="this.select()"
                                onchange="window._sheetEditMember('${mid}','${f.key}',this.value)">
                        </td>`;
                    }
                });

                // Editable suro scores
                headers.forEach(h => {
                    const suroKey = `${mid}_${h}`;
                    const origScore = m.suro?.[h] || '';
                    const val = ss.suroEdited[suroKey] !== undefined ? ss.suroEdited[suroKey] : origScore;
                    const wasEdited = ss.suroEdited[suroKey] !== undefined;
                    const displayVal = val ? Number(val).toLocaleString() : '';
                    html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                        <input type="text" value="${val}" 
                            class="w-full px-1 py-1 text-[10px] font-mono font-bold outline-none bg-transparent border-0 focus:bg-emerald-50 transition-colors text-right" 
                            onfocus="this.select()"
                            onchange="window._sheetEditSuro('${mid}','${h}',this.value)">
                    </td>`;
                });

                html += `</tr>`;
            });

            html += `</tbody></table>`;
            wrap.innerHTML = html;
            window._sheetUpdateButtons();

            // Tabí‚¤: ê°™ì€ ì—´ ì•„ë˜ë¡œ ì´ë™ (Shift+Tab: ìœ„ë¡œ)
            wrap.addEventListener('keydown', (e) => {
                if (e.key !== 'Tab') return;
                const el = document.activeElement;
                if (!el || !wrap.contains(el)) return;
                const td = el.closest('td');
                const tr = el.closest('tr');
                if (!td || !tr) return;

                e.preventDefault();
                const colIdx = Array.from(tr.children).indexOf(td);
                const nextTr = e.shiftKey ? tr.previousElementSibling : tr.nextElementSibling;
                if (!nextTr) return;

                const targetTd = nextTr.children[colIdx];
                if (!targetTd) return;
                const targetInput = targetTd.querySelector('input, select');
                if (targetInput) { targetInput.focus(); if (targetInput.select) targetInput.select(); }
            });
        };

        // Edit member field
        window._sheetEditMember = (memberId, field, newVal) => {
            const ss = window._sheetState;
            const m = appState.members.find(x => x.id === memberId);
            if (!m) return;
            const origVal = field === 'isMain' ? (m.isMain ? 'TRUE' : 'FALSE') : (m[field] || '');
            if (newVal === origVal) {
                if (ss.edited[memberId]) {
                    delete ss.edited[memberId][field];
                    if (Object.keys(ss.edited[memberId]).length === 0) delete ss.edited[memberId];
                }
            } else {
                if (!ss.edited[memberId]) ss.edited[memberId] = {};
                ss.edited[memberId][field] = newVal;
            }
            window._sheetUpdateButtons();
        };

        // Edit suro score
        window._sheetEditSuro = (memberId, periodLabel, newVal) => {
            const ss = window._sheetState;
            const m = appState.members.find(x => x.id === memberId);
            if (!m) return;
            const origVal = String(m.suro?.[periodLabel] || '');
            const key = `${memberId}_${periodLabel}`;
            if (newVal === origVal) {
                delete ss.suroEdited[key];
            } else {
                ss.suroEdited[key] = newVal;
            }
            window._sheetUpdateButtons();
        };

        // Save all changes
        window._sheetSave = async () => {
            const ss = window._sheetState;
            const btn = document.getElementById('sheetSaveBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì €ì¥ ì¤‘...'; }
            
            try {
                let count = 0;

                // Save member field edits
                for (const [memberId, changes] of Object.entries(ss.edited)) {
                    const dbChanges = {};
                    for (const [k, v] of Object.entries(changes)) {
                        if (k === 'isMain') dbChanges.is_main = v === 'TRUE' || v === 'true';
                        else if (k === 'mainCharName') dbChanges.main_char_name = v;
                        else if (k === 'joinDate') dbChanges.join_date = v;
                        else if (k === 'role') dbChanges.role = v;
                        else if (k === 'class') dbChanges.class = v;
                    }
                    if (Object.keys(dbChanges).length > 0) {
                        const { error } = await supaDb.from('members').update(dbChanges).eq('id', Number(memberId));
                        if (error) throw error;
                        count++;
                    }
                }

                // Save suro score edits
                for (const [key, val] of Object.entries(ss.suroEdited)) {
                    const [memberId, ...periodParts] = key.split('_');
                    const periodLabel = periodParts.join('_');
                    
                    // Get or create period
                    let { data: period } = await supaDb.from('suro_periods').select('id').eq('period_label', periodLabel).maybeSingle();
                    if (!period) {
                        const { data: np } = await supaDb.from('suro_periods').insert({ period_label: periodLabel, start_date: '', end_date: '' }).select().single();
                        period = np;
                    }
                    
                    if (val === '' || val === '0') {
                        await supaDb.from('suro_scores').delete().eq('member_id', Number(memberId)).eq('period_id', period.id);
                    } else {
                        await supaDb.from('suro_scores').upsert({ member_id: Number(memberId), period_id: period.id, score: Number(val) }, { onConflict: 'member_id,period_id' });
                    }
                    count++;
                }

                ss.edited = {};
                ss.suroEdited = {};
                window.showMsg(`${count}ê±´ ì €ì¥ ì™„ë£Œ!`, 'success');
                await window.fetchMembers();
            } catch(e) {
                window.showMsg('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
                console.error(e);
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>ì €ì¥'; }
            }
        };

        // Discard changes
        window._sheetDiscard = () => {
            window._sheetState.edited = {};
            window._sheetState.suroEdited = {};
            window._sheetRender();
        };

        // â”€â”€ ê¸°íƒ€ í…Œì´ë¸” (bail, penalty, history, events) - í¸ì§‘/ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥ â”€â”€
        window._sheetRenderTable = (wrap, tableName) => {
            let data, columns, dbTable;
            if (tableName === 'bail_history') {
                data = appState.bailHistory || [];
                columns = ['date','payer','receiver','amount','memo'];
                dbTable = 'bail_history';
            } else if (tableName === 'penalty_history') {
                data = appState.penaltyHistory || [];
                columns = ['date','name','points','reason'];
                dbTable = 'penalty_history';
            } else if (tableName === 'operation_history') {
                data = [...(appState.history || [])].reverse();
                columns = ['date','category','name','content'];
                dbTable = 'operation_history';
            } else if (tableName === 'events') {
                data = appState.events || [];
                columns = ['date','title','content'];
                dbTable = 'events';
            } else {
                data = []; columns = []; dbTable = '';
            }

            const colLabels = {
                date:'ë‚ ì§œ', payer:'ë‚©ë¶€ì/ì‚¬ìœ ', receiver:'ìˆ˜ë ¹ì', amount:'ìˆ˜ëŸ‰', memo:'ë©”ëª¨',
                name:'ì´ë¦„', points:'ì ìˆ˜', reason:'ì‚¬ìœ ', category:'êµ¬ë¶„', content:'ë‚´ìš©',
                id:'ID', title:'ì œëª©'
            };

            const countEl = document.getElementById('sheetOtherCount');
            if (countEl) countEl.textContent = `${data.length}ê±´`;

            let html = `<table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr class="text-[9px] font-bold text-gray-500 uppercase">
                        <th class="p-2 border-b border-r border-gray-100 w-8 text-center">#</th>
                        ${columns.map(c => `<th class="p-2 border-b border-r border-gray-100">${colLabels[c] || c}</th>`).join('')}
                        <th class="p-2 border-b border-gray-100 w-10 text-center">ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody class="text-[11px] font-bold">`;

            data.forEach((row, i) => {
                const rowId = row.id || '';
                html += `<tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 group" data-table="${dbTable}" data-row-idx="${i}">
                    <td class="p-1.5 text-[9px] text-gray-300 border-r border-gray-50 text-center font-mono">${i+1}</td>
                    ${columns.map(c => {
                        const val = row[c] ?? '';
                        if (c === 'amount' || c === 'points') {
                            return `<td class="p-0 border-r border-gray-50"><input type="number" value="${val}" class="w-full px-1.5 py-1.5 text-[11px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors text-right" data-col="${c}" oninput="window._sheetMarkOtherEdit(this)"></td>`;
                        }
                        return `<td class="p-0 border-r border-gray-50"><input type="text" value="${String(val).replace(/"/g, '&quot;')}" class="w-full px-1.5 py-1.5 text-[11px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors" data-col="${c}" oninput="window._sheetMarkOtherEdit(this)"></td>`;
                    }).join('')}
                    <td class="p-1 border-gray-50 text-center">
                        <button onclick="window._sheetDeleteRow('${dbTable}', ${rowId ? rowId : 'null'}, this)" class="w-6 h-6 rounded-lg text-gray-300 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-trash text-[9px]"></i></button>
                    </td>
                </tr>`;
            });

            if (data.length === 0) {
                html += `<tr><td colspan="${columns.length+2}" class="p-10 text-center text-gray-300 font-bold text-xs">ë°ì´í„° ì—†ìŒ</td></tr>`;
            }

            html += `</tbody></table>`;
            wrap.innerHTML = html;
        };

        // ê¸°íƒ€ í…Œì´ë¸” í–‰ ì¶”ê°€
        window._sheetAddRow = async () => {
            const ss = window._sheetState;
            const tableName = ss.mode;
            let newRow = {};

            if (tableName === 'bail_history') {
                newRow = { date: new Date().toISOString().split('T')[0], payer: '', receiver: '', amount: 0, memo: '' };
            } else if (tableName === 'penalty_history') {
                newRow = { date: new Date().toISOString().split('T')[0], name: '', points: 1, reason: '' };
            } else if (tableName === 'operation_history') {
                newRow = { date: new Date().toISOString().split('T')[0], category: '', name: '', content: '' };
            } else if (tableName === 'events') {
                newRow = { date: new Date().toISOString().split('T')[0], title: '', content: '' };
            } else return;

            try {
                const { data, error } = await supaDb.from(tableName).insert(newRow).select();
                if (error) throw error;
                window.showMsg('í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                await window.fetchMembers();
                window._sheetRender();
            } catch(e) {
                window.showMsg('ì¶”ê°€ ì‹¤íŒ¨: ' + (e.message || e), 'error');
            }
        };

        // ê¸°íƒ€ í…Œì´ë¸” í–‰ ì‚­ì œ
        window._sheetDeleteRow = async (tableName, rowId, btnEl) => {
            if (!rowId) {
                // id ì—†ëŠ” ê²½ìš° (appStateì—ì„œ ì§ì ‘ ê´€ë¦¬í•˜ëŠ” ë°ì´í„°) - ìœ„ì¹˜ ê¸°ë°˜ ì‚­ì œ
                window.showMsg('IDê°€ ì—†ì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (!confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const { error } = await supaDb.from(tableName).delete().eq('id', rowId);
                if (error) throw error;
                // í–‰ ì‹œê°ì ìœ¼ë¡œ ì œê±°
                const tr = btnEl.closest('tr');
                if (tr) { tr.style.opacity = '0.3'; tr.style.pointerEvents = 'none'; }
                window.showMsg('ì‚­ì œ ì™„ë£Œ', 'success');
                await window.fetchMembers();
                window._sheetRender();
            } catch(e) {
                window.showMsg('ì‚­ì œ ì‹¤íŒ¨: ' + (e.message || e), 'error');
            }
        };

        // ê¸°íƒ€ í…Œì´ë¸” ì…€ ìˆ˜ì • ë§ˆí‚¹ (ì €ì¥ ë²„íŠ¼ í‘œì‹œ)
        window._pendingOtherEdits = new Map(); // rowId -> {tableName, rowData}

        window._sheetMarkOtherEdit = (input) => {
            const tr = input.closest('tr');
            const tableName = tr.dataset.table;
            const idx = parseInt(tr.dataset.rowIdx);

            // í•´ë‹¹ í–‰ì˜ ëª¨ë“  ì…ë ¥ê°’ ìˆ˜ì§‘
            const inputs = tr.querySelectorAll('input, select');
            const rowData = {};
            inputs.forEach(inp => {
                const col = inp.dataset.col;
                if (col) {
                    rowData[col] = inp.type === 'number' ? Number(inp.value) : inp.value;
                }
            });

            // DBì—ì„œ í•´ë‹¹ í–‰ì˜ id ì°¾ê¸°
            let sourceData;
            if (tableName === 'bail_history') sourceData = appState.bailHistory;
            else if (tableName === 'penalty_history') sourceData = appState.penaltyHistory;
            else if (tableName === 'operation_history') sourceData = [...(appState.history || [])].reverse();
            else if (tableName === 'events') sourceData = appState.events;

            const row = sourceData?.[idx];
            if (!row || !row.id) {
                input.style.background = '#fef2f2';
                return;
            }

            input.style.background = '#fef9c3';
            tr.style.background = '#fffbeb';
            window._pendingOtherEdits.set(String(row.id), { tableName, rowData });

            // ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
            const saveBtn = document.getElementById('sheetOtherSaveBtn');
            const discardBtn = document.getElementById('sheetOtherDiscardBtn');
            const countEl = document.getElementById('sheetOtherEditCount');
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (discardBtn) discardBtn.classList.remove('hidden');
            if (countEl) countEl.textContent = `${window._pendingOtherEdits.size}ê°œ í–‰ ìˆ˜ì •ë¨`;
        };

        window._sheetSaveOther = async () => {
            const edits = window._pendingOtherEdits;
            if (edits.size === 0) return;

            const btn = document.getElementById('sheetOtherSaveBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì €ì¥ ì¤‘...'; }

            let ok = 0, fail = 0;
            for (const [rowId, { tableName, rowData }] of edits) {
                try {
                    const { error } = await supaDb.from(tableName).update(rowData).eq('id', Number(rowId));
                    if (error) throw error;
                    ok++;
                } catch(e) {
                    console.error('ì €ì¥ ì‹¤íŒ¨:', rowId, e);
                    fail++;
                }
            }

            edits.clear();
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>ì €ì¥'; btn.classList.add('hidden'); }
            document.getElementById('sheetOtherDiscardBtn')?.classList.add('hidden');
            const countEl = document.getElementById('sheetOtherEditCount');
            if (countEl) countEl.textContent = '';

            if (fail === 0) {
                window.showMsg(`${ok}ê±´ ì €ì¥ ì™„ë£Œ!`, 'success');
            } else {
                window.showMsg(`${ok}ê±´ ì €ì¥, ${fail}ê±´ ì‹¤íŒ¨`, 'error');
            }
            await window.fetchMembers();
            window._sheetRender();
        };

        window._sheetDiscardOther = () => {
            window._pendingOtherEdits.clear();
            document.getElementById('sheetOtherSaveBtn')?.classList.add('hidden');
            document.getElementById('sheetOtherDiscardBtn')?.classList.add('hidden');
            const countEl = document.getElementById('sheetOtherEditCount');
            if (countEl) countEl.textContent = '';
            window._sheetRender();
            window.showMsg('ìˆ˜ì • ì·¨ì†Œë¨', 'success');
        };
        // â”€â”€â”€ ê°€ì´ë“œ í¸ì§‘ê¸° (ë¸”ë¡ í…œí”Œë¦¿ ì§€ì›) â”€â”€â”€
        window._guideEditorState = { slug: 'intro', pages: {} };

        // Block templates
        window._guideBlocks = [
            { id: 'card_red', icon: 'â¤ï¸', label: 'ì¹´ë“œ (ë¹¨ê°•)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#fef2f2,#fff1f2);border-bottom:1px solid #fecdd3;display:flex;align-items:center;gap:8px"><span style="font-size:14px">â¤ï¸</span><h4 style="font-size:12px;font-weight:900;color:#dc2626;margin:0">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</p></div></div>` },
            { id: 'card_blue', icon: 'ğŸ’', label: 'ì¹´ë“œ (íŒŒë‘)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#eff6ff,#eef2ff);border-bottom:1px solid #bfdbfe;display:flex;align-items:center;gap:8px"><span style="font-size:14px">ğŸ’</span><h4 style="font-size:12px;font-weight:900;color:#2563eb;margin:0">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</p></div></div>` },
            { id: 'card_amber', icon: 'ğŸ“', label: 'ì¹´ë“œ (ì£¼í™©)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#fffbeb,#fff7ed);border-bottom:1px solid #fde68a;display:flex;align-items:center;gap:8px"><span style="font-size:14px">ğŸ“</span><h4 style="font-size:12px;font-weight:900;color:#b45309;margin:0">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</p></div></div>` },
            { id: 'card_green', icon: 'â˜•', label: 'ì¹´ë“œ (ì´ˆë¡)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#f0fdf4,#ecfdf5);border-bottom:1px solid #bbf7d0;display:flex;align-items:center;gap:8px"><span style="font-size:14px">â˜•</span><h4 style="font-size:12px;font-weight:900;color:#15803d;margin:0">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</p></div></div>` },
            { id: 'highlight_pink', icon: 'ğŸŒ¸', label: 'ê°•ì¡° ë°•ìŠ¤ (í•‘í¬)', html: `<div style="background:linear-gradient(135deg,#fdf2f8,#fff1f2);padding:24px;border-radius:16px;border:1px solid #fbcfe8;margin-bottom:12px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><span style="font-size:28px">ğŸ“</span><div><h3 style="font-size:18px;font-weight:900;color:#1f2937;margin:0">ì œëª©</h3><p style="font-size:12px;color:#ec4899;font-weight:700;margin:4px 0 0 0">ë¶€ì œëª©</p></div></div><p style="font-size:13px;color:#6b7280">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</p></div>` },
            { id: 'count_grid', icon: 'ğŸ“Š', label: 'ì¸ì›ìˆ˜ ì¹´ë“œ (4ì¹¸)', html: `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px"><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#ec4899;margin:0">{{ëš ì¹´ë¡±_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">ğŸ“ ëš ì¹´ë¡± (1ê¸°)</p></div><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#f43f5e;margin:0">{{ëš±ì¹´ë¡±_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">ğŸ° ëš±ì¹´ë¡± (2ê¸°)</p></div><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#6366f1;margin:0">{{ë¶€ìº_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">ğŸŒ™ ë¶€ìº ê¸¸ë“œ í•©ì‚°</p></div><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#374151;margin:0">{{ì „ì²´_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">ğŸ‘¥ ì „ì²´ ì¸ì›</p></div></div>` },
            { id: 'table_simple', icon: 'ğŸ“‹', label: 'í‘œ (4ì—´)', html: `<div style="background:white;border-radius:16px;border:1px solid #f3f4f6;overflow:hidden;margin-bottom:12px"><table style="width:100%;font-size:12px;border-collapse:collapse"><thead><tr style="font-size:10px;color:#9ca3af;border-bottom:1px solid #f3f4f6"><th style="padding:10px;text-align:left">í•­ëª©1</th><th style="padding:10px;text-align:left">í•­ëª©2</th><th style="padding:10px;text-align:center">í•­ëª©3</th><th style="padding:10px;text-align:left">í•­ëª©4</th></tr></thead><tbody style="font-weight:700;color:#374151"><tr style="background:rgba(254,249,195,0.3);border-bottom:1px solid #fafafa"><td style="padding:10px">ë°ì´í„°1</td><td style="padding:10px">ë°ì´í„°2</td><td style="padding:10px;text-align:center;color:#22c55e">O</td><td style="padding:10px;font-size:11px">ë°ì´í„°4</td></tr><tr style="border-bottom:1px solid #fafafa"><td style="padding:10px">ë°ì´í„°1</td><td style="padding:10px">ë°ì´í„°2</td><td style="padding:10px;text-align:center;color:#ef4444">X</td><td style="padding:10px;font-size:11px">ë°ì´í„°4</td></tr></tbody></table></div>` },
            { id: 'link_card', icon: 'ğŸ”—', label: 'ë§í¬ ì¹´ë“œ', html: `<a href="https://example.com" target="_blank" style="display:block;background:white;border-radius:16px;border:1px solid #f3f4f6;padding:16px;margin-bottom:12px;text-decoration:none;color:inherit"><div style="display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;background:#fdf2f8;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0"><i class="fas fa-link" style="color:#ec4899"></i></div><div><p style="font-weight:700;font-size:14px;color:#1f2937;margin:0">ğŸ”— ë§í¬ ì œëª©</p><p style="font-size:10px;color:#9ca3af;margin:4px 0 0 0">ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”</p></div><i class="fas fa-external-link-alt" style="color:#d1d5db;margin-left:auto"></i></div></a>` },
            { id: 'notice_box', icon: 'âš ï¸', label: 'ê²½ê³ /ì•ˆë‚´ ë°•ìŠ¤', html: `<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:12px 16px;margin-bottom:12px;font-size:11px;color:#dc2626;font-weight:700">âš  ì•ˆë‚´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</div>` },
            { id: 'info_box', icon: 'ğŸ’¡', label: 'íŒ ë°•ìŠ¤', html: `<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:12px 16px;margin-bottom:12px;font-size:11px;color:#2563eb;font-weight:700">ğŸ’¡ íŒ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</div>` },
            { id: 'color_badge', icon: 'ğŸ·ï¸', label: 'ë±ƒì§€ ê·¸ë£¹', html: `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px"><span style="background:#f0fdf4;color:#16a34a;padding:4px 12px;border-radius:8px;font-weight:700;font-size:12px">ë±ƒì§€1 â†’ ì„¤ëª…</span><span style="background:#fef2f2;color:#ef4444;padding:4px 12px;border-radius:8px;font-weight:700;font-size:12px">ë±ƒì§€2 â†’ ì„¤ëª…</span><span style="background:#ecfdf5;color:#059669;padding:4px 12px;border-radius:8px;font-weight:700;font-size:12px">ë±ƒì§€3 â†’ ì„¤ëª…</span></div>` },
            { id: 'guild_info', icon: 'ğŸ®', label: 'ê¸¸ë“œ ì •ë³´ ì¹´ë“œ', html: `<div style="background:white;border-radius:16px;border:1px solid #f3f4f6;padding:16px;margin-bottom:12px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">ğŸ°</span><h4 style="font-weight:900;color:#1f2937;font-size:14px;margin:0">ê¸¸ë“œëª…</h4><span style="font-size:10px;background:#fef2f2;color:#ef4444;padding:2px 8px;border-radius:999px;font-weight:700">ì„¤ëª…</span></div><span style="font-size:12px;font-weight:700;color:#9ca3af">49p</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px"><div style="background:#f9fafb;padding:8px 12px;border-radius:8px"><span style="color:#9ca3af">ë…¸ë¸” ì¡°ê±´:</span> <b>ìˆ˜ë¡œ í•„ì°¸</b></div><div style="background:#f9fafb;padding:8px 12px;border-radius:8px"><span style="color:#9ca3af">ìºë¦­ ì œí•œ:</span> <b>ì—†ìŒ</b></div></div></div>` },
            { id: 'spacer', icon: 'â–', label: 'ì—¬ë°±', html: `<div style="height:16px"></div>` },
        ];


        // â•â•â• guideEditor (from admin, lines 3181-3351) â•â•â•
        window.renderGuideEditor = async (container) => {
            const gs = window._guideEditorState;
            
            try {
                const { data } = await supaDb.from('guide_pages').select('*').order('id');
                if (data) data.forEach(p => gs.pages[p.slug] = p);
            } catch(e) { console.error(e); }

            const slugs = [
                { slug: 'intro', label: 'ê¸¸ë“œ ì†Œê°œ', icon: 'fa-heart' },
                { slug: 'ranks', label: 'ì§ìœ„ & ë¶€ìº', icon: 'fa-medal' },
                { slug: 'links', label: 'ë§í¬ ëª¨ìŒ', icon: 'fa-link' }
            ];

            container.innerHTML = `
            <div class="h-full flex flex-col gap-3 fade-in">
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4 shrink-0">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <h3 class="text-sm font-bold text-gray-800"><i class="fas fa-edit mr-2 text-pink-500"></i>ê°€ì´ë“œ í˜ì´ì§€ í¸ì§‘</h3>
                        <div class="flex gap-1.5 ml-2">
                            ${slugs.map(s => `<button onclick="window._guideSelectPage('${s.slug}')" class="guide-slug-btn px-3 py-1.5 rounded-xl text-[10px] font-bold transition-all ${gs.slug === s.slug ? 'bg-pink-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}"><i class="fas ${s.icon} mr-1"></i>${s.label}</button>`).join('')}
                        </div>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="window._guideSave()" id="guideSaveBtn" class="px-4 py-1.5 bg-emerald-500 text-white rounded-xl text-[10px] font-bold shadow hover:bg-emerald-600 transition-all"><i class="fas fa-save mr-1"></i>ì €ì¥</button>
                            <button onclick="window._guidePreview()" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-all"><i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°</button>
                        </div>
                    </div>
                    <!-- Toolbar Row 1: Text formatting -->
                    <div class="flex flex-wrap gap-1 p-2 bg-gray-50 rounded-xl border border-gray-100 mb-1" id="guideToolbar">
                        <button onclick="document.execCommand('bold')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-black text-gray-600 transition-all" title="êµµê²Œ"><b>B</b></button>
                        <button onclick="document.execCommand('italic')" class="w-7 h-7 rounded-lg hover:bg-white text-xs italic text-gray-600 transition-all" title="ê¸°ìš¸ì„"><i>I</i></button>
                        <button onclick="document.execCommand('underline')" class="w-7 h-7 rounded-lg hover:bg-white text-xs underline text-gray-600 transition-all" title="ë°‘ì¤„"><u>U</u></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('foreColor',false,'#ec4899')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-pink-500 transition-all" title="í•‘í¬">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#ef4444')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-red-500 transition-all" title="ë¹¨ê°•">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#3b82f6')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-blue-500 transition-all" title="íŒŒë‘">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#10b981')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-emerald-500 transition-all" title="ì´ˆë¡">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#374151')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-gray-700 transition-all" title="ê²€ì •">A</button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('fontSize',false,'2')" class="w-7 h-7 rounded-lg hover:bg-white text-[9px] text-gray-600 transition-all" title="ì‘ê²Œ">S</button>
                        <button onclick="document.execCommand('fontSize',false,'4')" class="w-7 h-7 rounded-lg hover:bg-white text-sm text-gray-600 transition-all" title="í¬ê²Œ">L</button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('insertUnorderedList')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="ëª©ë¡"><i class="fas fa-list-ul"></i></button>
                        <button onclick="document.execCommand('insertOrderedList')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="ë²ˆí˜¸ëª©ë¡"><i class="fas fa-list-ol"></i></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="window._guideInsertLink()" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="ë§í¬"><i class="fas fa-link"></i></button>
                        <button onclick="document.execCommand('removeFormat')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-400 transition-all" title="ì„œì‹ì œê±°"><i class="fas fa-eraser"></i></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('justifyLeft')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="ì™¼ìª½"><i class="fas fa-align-left"></i></button>
                        <button onclick="document.execCommand('justifyCenter')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="ê°€ìš´ë°"><i class="fas fa-align-center"></i></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="window._guideToggleSource()" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-orange-500 transition-all" title="HTML ì†ŒìŠ¤"><i class="fas fa-code"></i></button>
                        <button onclick="document.getElementById('guideHelpPanel').classList.toggle('hidden')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-blue-500 transition-all" title="ë„ì›€ë§"><i class="fas fa-question-circle"></i></button>
                    </div>
                    <!-- Toolbar Row 2: Block templates -->
                    <div class="relative">
                        <button onclick="document.getElementById('guideBlockMenu').classList.toggle('hidden')" class="flex items-center gap-2 px-3 py-1.5 bg-purple-50 text-purple-600 rounded-xl text-[10px] font-bold hover:bg-purple-100 transition-all border border-purple-100">
                            <i class="fas fa-puzzle-piece"></i>ë¸”ë¡ ì‚½ì… â–¾
                        </button>
                        <div id="guideBlockMenu" class="hidden absolute left-0 top-full mt-1 bg-white border border-gray-200 rounded-2xl shadow-2xl p-2 z-[100] w-80 max-h-[50vh] overflow-y-auto">
                            <div class="text-[9px] text-gray-400 font-bold px-3 py-1.5 uppercase">í´ë¦­í•˜ë©´ ì—ë””í„°ì— ì‚½ì…ë©ë‹ˆë‹¤</div>
                            ${window._guideBlocks.map(b => `<button onclick="window._guideInsertBlock('${b.id}')" class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-50 text-xs font-bold text-gray-700 flex items-center gap-2 transition-all"><span>${b.icon}</span><span>${b.label}</span></button>`).join('')}
                        </div>
                    </div>
                    <div id="guideHelpPanel" class="hidden bg-blue-50 border border-blue-100 rounded-xl p-3 mt-2 text-[10px] text-blue-700 leading-relaxed">
                        <p class="font-bold text-[11px] mb-1.5"><i class="fas fa-info-circle mr-1"></i> ìë™ ë³€í™˜ ë³€ìˆ˜ (í¼ë¸”ë¦­ ë·°ì—ì„œ ì‹¤ì œ ìˆ«ìë¡œ ë°”ë€œ)</p>
                        <div class="grid grid-cols-2 gap-1.5">
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-pink-500 select-all">{{ëš ì¹´ë¡±_count}}</span> â†’ ëš ì¹´ë¡± ì¸ì›ìˆ˜</div>
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-rose-500 select-all">{{ëš±ì¹´ë¡±_count}}</span> â†’ ëš±ì¹´ë¡± ì¸ì›ìˆ˜</div>
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-indigo-500 select-all">{{ë¶€ìº_count}}</span> â†’ ë¶€ìºê¸¸ë“œ í•©ì‚°</div>
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-gray-600 select-all">{{ì „ì²´_count}}</span> â†’ ì „ì²´ ì¸ì›ìˆ˜</div>
                        </div>
                        <p class="mt-1.5 text-[9px] text-blue-500">ğŸ’¡ ìœ„ í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•´ì„œ ë³µì‚¬ í›„ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden flex flex-col min-h-0">
                    <div id="guideEditor" contenteditable="true" class="flex-1 p-5 outline-none text-sm text-gray-700 leading-relaxed overflow-y-auto" style="min-height:300px;max-height:60vh">${gs.pages[gs.slug]?.content || '<p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</p>'}</div>
                    <textarea id="guideSourceEditor" class="flex-1 p-5 outline-none text-xs font-mono text-gray-700 hidden overflow-y-auto resize-none border-t border-gray-100" style="min-height:300px;max-height:60vh"></textarea>
                </div>
                <div id="guidePreviewModal" class="hidden fixed inset-0 bg-black/30 z-[2000] flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-sm text-gray-800"><i class="fas fa-eye mr-2 text-pink-500"></i>ë¯¸ë¦¬ë³´ê¸°</h3>
                            <button onclick="document.getElementById('guidePreviewModal').classList.add('hidden')" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="guidePreviewContent" class="p-5 overflow-y-auto flex-1 text-sm text-gray-700 leading-relaxed"></div>
                    </div>
                </div>
            </div>`;

            // Close block menu when clicking outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('guideBlockMenu');
                if (menu && !menu.parentElement.contains(e.target)) menu.classList.add('hidden');
            }, { once: false });
        };

        window._guideInsertBlock = (blockId) => {
            const block = window._guideBlocks.find(b => b.id === blockId);
            if (!block) return;
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            if (source && !source.classList.contains('hidden')) {
                // Source mode: append HTML
                source.value += '\n' + block.html;
            } else if (editor) {
                // Rich mode: insert at cursor or append
                editor.focus();
                const sel = window.getSelection();
                if (sel.rangeCount > 0 && editor.contains(sel.anchorNode)) {
                    document.execCommand('insertHTML', false, block.html);
                } else {
                    editor.innerHTML += block.html;
                }
            }
            document.getElementById('guideBlockMenu')?.classList.add('hidden');
        };

        window._guideSelectPage = (slug) => {
            window._guideEditorState.slug = slug;
            window.renderGuideEditor(document.getElementById('contentArea'));
        };

        window._guideInsertLink = () => {
            const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (url) document.execCommand('createLink', false, url);
        };

        window._guideToggleSource = () => {
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            if (source.classList.contains('hidden')) {
                source.value = editor.innerHTML;
                editor.classList.add('hidden');
                source.classList.remove('hidden');
                source.focus();
            } else {
                editor.innerHTML = source.value;
                source.classList.add('hidden');
                editor.classList.remove('hidden');
            }
        };

        window._guidePreview = () => {
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            const html = source.classList.contains('hidden') ? editor.innerHTML : source.value;
            document.getElementById('guidePreviewContent').innerHTML = html;
            document.getElementById('guidePreviewModal').classList.remove('hidden');
        };

        window._guideSave = async () => {
            const gs = window._guideEditorState;
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            const html = source.classList.contains('hidden') ? editor.innerHTML : source.value;
            const btn = document.getElementById('guideSaveBtn');
            
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì €ì¥ ì¤‘...'; }
            try {
                const { error } = await supaDb.from('guide_pages').update({ content: html, updated_at: new Date().toISOString() }).eq('slug', gs.slug);
                if (error) throw error;
                gs.pages[gs.slug] = { ...gs.pages[gs.slug], content: html };
                window.showMsg('ê°€ì´ë“œ ì €ì¥ ì™„ë£Œ!', 'success');
            } catch(e) {
                window.showMsg('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>ì €ì¥'; }
            }
        };


        // â•â•â• history (from admin, lines 3352-3352) â•â•â•
        window.renderHistory = (container) => { container.innerHTML = `<div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm overflow-hidden h-full flex flex-col"><div class="p-8 border-b font-bold text-gray-800 shrink-0 relative z-20 bg-white">ìš´ì˜ ì´ë ¥</div><div class="flex-1 overflow-y-auto no-scrollbar"><table class="w-full text-left text-xs whitespace-nowrap stick-head"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase"><tr><th class="p-6">DATE</th><th class="p-6">TYPE</th><th class="p-6">NAME</th><th class="p-6">CONTENT</th></tr></thead><tbody class="divide-y divide-gray-100">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">ê¸°ë¡ ì—†ìŒ</td></tr>` : [...appState.history].reverse().map(l => `<tr class="hover:bg-gray-50 transition-colors h-12 leading-none font-bold"><td class="p-6 text-gray-400 font-mono text-[10px]">${l.date}</td><td class="p-6"><span class="px-2 py-1 rounded-lg bg-gray-100 text-[9px] font-bold">${l.category}</span></td><td class="p-6 text-gray-700">${l.name}</td><td class="p-6 text-gray-500">${l.content}</td></tr>`).join('')}</tbody></table></div></div>`; };

        // â•â•â• settings (from admin, lines 3353-4065) â•â•â•
        window.renderSettings = (container) => {
            const cfg = SITE_CONFIG || {};
            const guilds = cfg.guilds || appState.guilds;
            const roleDisplay = cfg.roleDisplay || {};
            const cutoffs = cfg.cutoffs || {};
            const suroExempt = cfg.suroExempt || [];
            const suroExemptLabel = cfg.suroExemptLabel || 'ì•„ì¸ìŠˆí˜ë„ˆ';
            const suroExemptNote = cfg.suroExemptNote || '';
            const autoRankRules = cfg.autoRankRules || {};
            const guildStartDate = cfg.guildStartDate || '2020-03-17';
            const badgeStyles = cfg.guildBadgeStyles || {};
            const rowHighlight = cfg.rowHighlightRoles || {};
            const ranks = cfg.ranks || initialGuildRanks;
            const rolePriority = cfg.rolePriority || ROLE_PRIORITY;
            const iconOptions = ['fa-crown','fa-heart','fa-moon','fa-star','fa-sun','fa-cube','fa-gem','fa-fire','fa-bolt','fa-shield-alt','fa-dragon','fa-feather','fa-leaf','fa-snowflake'];

            // ê¸¸ë“œ ì •ë³´ ì¹´ë“œ HTML
            const guildsHtml = guilds.map((g, gi) => `
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 space-y-3" data-guild-idx="${gi}">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-xl flex items-center justify-center text-white text-sm" style="background:${g.color}"><i class="fas ${g.icon}"></i></div>
                        <span class="font-bold text-gray-800 text-sm">${g.name}</span>
                        <button onclick="window._cfgRemoveGuild(${gi})" class="ml-auto text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[9px] text-gray-400 block mb-1">ê¸¸ë“œ ì´ë¦„</label><input class="cfg-guild-name w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${g.name}" data-idx="${gi}"></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">íƒ€ì…</label><input class="cfg-guild-type w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${g.type}" data-idx="${gi}"></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">ëŒ€í‘œìƒ‰</label><div class="flex items-center gap-2"><input type="color" class="cfg-guild-color w-8 h-8 rounded-lg border-0 cursor-pointer" value="${g.color}" data-idx="${gi}"><span class="text-[10px] text-gray-400 font-mono">${g.color}</span></div></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">ì•„ì´ì½˜</label><select class="cfg-guild-icon w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" data-idx="${gi}">${iconOptions.map(ic => `<option value="${ic}" ${g.icon===ic?'selected':''}>${ic.replace('fa-','')}</option>`).join('')}</select></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">ìµœëŒ€ ì¸ì›</label><input type="number" class="cfg-guild-max w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${g.max}" data-idx="${gi}"></div>
                    </div>
                </div>`).join('');

            // ì§ìœ„/ì´ëª¨ì§€ í¸ì§‘ HTML
            const allRoleNames = [...new Set(Object.values(ranks).flat())];
            const rolesHtml = allRoleNames.map((rName, ri) => {
                const rd = roleDisplay[rName] || {};
                const pri = rolePriority[rName] !== undefined ? rolePriority[rName] : 99;
                return `<div class="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100">
                    <input class="cfg-role-emoji w-10 text-center bg-white border border-gray-200 rounded-lg px-1 py-1 text-sm outline-none" value="${rd.emoji || ''}" data-role="${rName}">
                    <span class="text-xs font-bold text-gray-700 flex-1">${rName}</span>
                    <select class="cfg-role-color bg-white border border-gray-200 rounded-lg px-2 py-1 text-[10px] font-bold outline-none" data-role="${rName}">
                        <option value="text-amber-600" ${rd.color==='text-amber-600'?'selected':''}>amber</option>
                        <option value="text-blue-600" ${rd.color==='text-blue-600'?'selected':''}>blue</option>
                        <option value="text-pink-600" ${rd.color==='text-pink-600'?'selected':''}>pink-600</option>
                        <option value="text-pink-500" ${rd.color==='text-pink-500'?'selected':''}>pink-500</option>
                        <option value="text-green-600" ${rd.color==='text-green-600'?'selected':''}>green</option>
                        <option value="text-orange-500" ${rd.color==='text-orange-500'?'selected':''}>orange</option>
                        <option value="text-gray-500" ${rd.color==='text-gray-500'?'selected':''}>gray-500</option>
                        <option value="text-gray-400" ${rd.color==='text-gray-400'?'selected':''}>gray-400</option>
                        <option value="text-red-600" ${rd.color==='text-red-600'?'selected':''}>red</option>
                        <option value="text-purple-600" ${rd.color==='text-purple-600'?'selected':''}>purple</option>
                    </select>
                    <input type="number" class="cfg-role-priority w-12 text-center bg-white border border-gray-200 rounded-lg px-1 py-1 text-[10px] font-bold outline-none" value="${pri}" data-role="${rName}" title="ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ë†’ì€ ì§ìœ„)">
                </div>`;
            }).join('');

            // ì»¤íŠ¸ë¼ì¸ í¸ì§‘ HTML
            const cutoffGuildNames = Object.keys(cutoffs);
            const cutoffsTabsHtml = cutoffGuildNames.map((gn, gi) => `<button onclick="window._cfgShowCutoff('${gn}')" class="cfg-cutoff-tab px-4 py-2 rounded-xl text-xs font-bold transition-all ${gi===0?'bg-pink-500 text-white':'bg-gray-100 text-gray-500'}" data-guild="${gn}">${gn}</button>`).join('');
            const cutoffSections = cutoffGuildNames.map((gn, gi) => {
                const items = cutoffs[gn] || [];
                return `<div class="cfg-cutoff-section ${gi>0?'hidden':''}" data-guild="${gn}">
                    <div class="space-y-2" id="cutoffList_${gn.replace(/[^a-zA-Zê°€-í£]/g,'')}">${items.map((c, ci) => `
                        <div class="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100">
                            <span class="text-sm w-8 text-center">${(roleDisplay[c.rank]||{}).emoji||''}</span>
                            <input class="cfg-cutoff-rank flex-1 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none" value="${c.rank}" data-guild="${gn}" data-ci="${ci}" placeholder="ì§ìœ„ëª…">
                            <input type="number" class="cfg-cutoff-min w-20 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none text-right" value="${c.min !== undefined ? c.min : ''}" data-guild="${gn}" data-ci="${ci}" placeholder="ìµœì†Œ">
                            <span class="text-gray-300 text-xs">~</span>
                            <input type="number" class="cfg-cutoff-max w-20 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none text-right" value="${c.max !== undefined ? c.max : ''}" data-guild="${gn}" data-ci="${ci}" placeholder="ìµœëŒ€">
                            <input class="cfg-cutoff-label flex-1 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none" value="${c.label||''}" data-guild="${gn}" data-ci="${ci}" placeholder="í‘œì‹œ ë¼ë²¨">
                            <input class="cfg-cutoff-note w-16 bg-white border border-gray-200 rounded-lg px-2 py-1 text-[10px] outline-none" value="${c.note||''}" data-guild="${gn}" data-ci="${ci}" placeholder="ë¹„ê³ ">
                            <button onclick="window._cfgRemoveCutoff('${gn}',${ci})" class="text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>
                        </div>`).join('')}</div>
                    <button onclick="window._cfgAddCutoff('${gn}')" class="mt-2 text-[10px] text-pink-500 hover:text-pink-700 font-bold"><i class="fas fa-plus mr-1"></i>ì»¤íŠ¸ë¼ì¸ ì¶”ê°€</button>
                </div>`;
            }).join('');

            // ìˆ˜ë¡œ ë©´ì œ ì§ìœ„ HTML
            const exemptHtml = allRoleNames.map(rn => `<label class="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100 cursor-pointer hover:bg-pink-50">
                <input type="checkbox" class="cfg-exempt-check custom-checkbox" value="${rn}" ${suroExempt.includes(rn)?'checked':''}>
                <span class="text-xs font-bold">${(roleDisplay[rn]||{}).emoji||''} ${rn}</span>
            </label>`).join('');

            // ìë™ ì§ìœ„ ë°°ì • ê·œì¹™ HTML
            const autoRankGuilds = Object.keys(autoRankRules);
            const autoRankHtml = autoRankGuilds.map(gn => {
                const rules = autoRankRules[gn] || [];
                return `<div class="space-y-2 mb-4">
                    <h4 class="text-xs font-bold text-gray-600">${gn}</h4>
                    <div class="space-y-1" id="autoRankList_${gn.replace(/[^a-zA-Zê°€-í£]/g,'')}">${rules.map((r, ri) => `
                        <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-1.5 border border-gray-100">
                            <input type="number" class="cfg-autorule-min w-24 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none text-right" value="${r.min}" data-guild="${gn}" data-ri="${ri}" placeholder="ìµœì†Œ ì ìˆ˜">
                            <span class="text-gray-300 text-xs">ì´ìƒ â†’</span>
                            <input class="cfg-autorule-rank flex-1 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none" value="${r.rank}" data-guild="${gn}" data-ri="${ri}" placeholder="ì§ìœ„ëª…">
                            <button onclick="window._cfgRemoveAutoRule('${gn}',${ri})" class="text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>
                        </div>`).join('')}</div>
                    <button onclick="window._cfgAddAutoRule('${gn}')" class="text-[10px] text-pink-500 hover:text-pink-700 font-bold"><i class="fas fa-plus mr-1"></i>ê·œì¹™ ì¶”ê°€</button>
                </div>`;
            }).join('');

            // ê¸¸ë“œ ë°°ì§€ ìƒ‰ìƒ HTML
            const badgeHtml = guilds.map(g => {
                const b = badgeStyles[g.name] || { bg: '#f3f4f6', text: '#666666', border: '#e5e7eb' };
                return `<div class="flex items-center gap-3 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100">
                    <span class="text-xs font-bold text-gray-700 w-16">${g.name}</span>
                    <div class="flex items-center gap-1"><label class="text-[8px] text-gray-400">ë°°ê²½</label><input type="color" class="cfg-badge-bg w-6 h-6 rounded border-0 cursor-pointer" value="${b.bg}" data-guild="${g.name}"></div>
                    <div class="flex items-center gap-1"><label class="text-[8px] text-gray-400">ê¸€ì</label><input type="color" class="cfg-badge-text w-6 h-6 rounded border-0 cursor-pointer" value="${b.text}" data-guild="${g.name}"></div>
                    <div class="flex items-center gap-1"><label class="text-[8px] text-gray-400">í…Œë‘ë¦¬</label><input type="color" class="cfg-badge-border w-6 h-6 rounded border-0 cursor-pointer" value="${b.border}" data-guild="${g.name}"></div>
                    <div class="ml-2 px-3 py-1 rounded-lg text-[10px] font-bold border" style="background:${b.bg};color:${b.text};border-color:${b.border}">${g.name} ë¯¸ë¦¬ë³´ê¸°</div>
                </div>`;
            }).join('');

            container.innerHTML = `
            <div class="max-w-4xl fade-in space-y-6">
                <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
                <div class="bg-white p-8 lg:p-12 rounded-[3rem] border border-gray-100 shadow-sm font-bold">
                    <h3 class="text-xl mb-8 text-gray-800">ì‹œìŠ¤í…œ ì„¤ì •</h3>
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Supabase Project URL</label>
                            <input type="text" value="${SUPABASE_URL}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-mono outline-none shadow-inner" readonly>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Database Status</label>
                            <div class="w-full bg-green-50 border border-green-100 rounded-2xl p-5 text-xs font-bold text-green-600"><i class="fas fa-check-circle mr-2"></i>Supabase Connected (Seoul Region)</div>
                        </div>
                    </div>
                </div>

                <!-- â˜… ë””ìì¸ ì„¤ì • â˜… -->
                <div class="bg-white p-8 lg:p-12 rounded-[3rem] border border-pink-100 shadow-sm font-bold">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-pink-100 rounded-2xl flex items-center justify-center"><i class="fas fa-palette text-pink-500"></i></div>
                        <div><h3 class="text-xl text-gray-800">ë””ìì¸ ì„¤ì •</h3><p class="text-[10px] text-gray-400">í¼ë¸”ë¦­ í˜ì´ì§€ì— í‘œì‹œë˜ëŠ” ë””ìì¸ ìš”ì†Œë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤</p></div>
                    </div>
                    <p class="text-[10px] text-pink-400 mb-8"><i class="fas fa-info-circle mr-1"></i>ë³€ê²½ í›„ í•˜ë‹¨ì˜ [ë””ìì¸ ì„¤ì • ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤</p>

                    <!-- ê¸°ë³¸ ì„¤ì • -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-calendar text-pink-400 text-xs"></i> ê¸°ë³¸ ì •ë³´</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[9px] text-gray-400 block mb-1">ê¸¸ë“œ ì‹œì‘ì¼</label><input type="date" id="cfgStartDate" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${guildStartDate}"></div>
                            <div><label class="text-[9px] text-gray-400 block mb-1">ìˆ˜ë¡œ ë©´ì œ ë¼ë²¨</label><input id="cfgExemptLabel" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${suroExemptLabel}"></div>
                            <div class="col-span-2"><label class="text-[9px] text-gray-400 block mb-1">ìˆ˜ë¡œ ë©´ì œ ì•ˆë‚´ ë¬¸êµ¬</label><input id="cfgExemptNote" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${suroExemptNote}" placeholder="ì˜ˆ: í¬ë¡œì¹¸ìŠˆ ì´ìƒ â€” ë¶€ìº ì „ë¶€ ìˆ˜ë¡œ ë©´ì œ"></div>
                        </div>
                    </div>

                    <!-- ê¸¸ë“œ ì •ë³´ -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-users text-pink-400 text-xs"></i> ê¸¸ë“œ ì •ë³´</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3" id="cfgGuildList">${guildsHtml}</div>
                        <button onclick="window._cfgAddGuild()" class="mt-3 text-[10px] text-pink-500 hover:text-pink-700 font-bold"><i class="fas fa-plus mr-1"></i>ê¸¸ë“œ ì¶”ê°€</button>
                    </div>

                    <!-- ê¸¸ë“œ ë°°ì§€ ìƒ‰ìƒ -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-tag text-pink-400 text-xs"></i> ê¸¸ë“œ ë°°ì§€ ìƒ‰ìƒ</h4>
                        <div class="space-y-2" id="cfgBadgeList">${badgeHtml}</div>
                    </div>

                    <!-- ì§ìœ„ ì´ëª¨ì§€/ìƒ‰ìƒ -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-medal text-pink-400 text-xs"></i> ì§ìœ„ ì´ëª¨ì§€ / ìƒ‰ìƒ / ìš°ì„ ìˆœìœ„</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">${rolesHtml}</div>
                    </div>

                    <!-- ì»¤íŠ¸ë¼ì¸ -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-chart-bar text-pink-400 text-xs"></i> ì§ìœ„ ì»¤íŠ¸ë¼ì¸</h4>
                        <div class="flex gap-2 mb-3">${cutoffsTabsHtml}</div>
                        ${cutoffSections}
                    </div>

                    <!-- ìˆ˜ë¡œ ë©´ì œ ì§ìœ„ -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-shield-alt text-pink-400 text-xs"></i> ìˆ˜ë¡œ ë©´ì œ ì§ìœ„</h4>
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">${exemptHtml}</div>
                    </div>

                    <!-- ìë™ ì§ìœ„ ë°°ì • ê·œì¹™ -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-magic text-pink-400 text-xs"></i> ìë™ ì§ìœ„ ë°°ì • ê·œì¹™</h4>
                        ${autoRankHtml}
                    </div>

                    <!-- ì €ì¥ ë²„íŠ¼ -->
                    <div class="flex gap-3 pt-4 border-t border-gray-100">
                        <button onclick="window._cfgSave()" id="cfgSaveBtn" class="px-8 py-4 bg-pink-500 text-white rounded-2xl font-bold text-sm shadow-lg hover:bg-pink-600 transition-all"><i class="fas fa-save mr-2"></i>ë””ìì¸ ì„¤ì • ì €ì¥</button>
                        <button onclick="window._cfgReset()" class="px-6 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-xs hover:bg-gray-200 transition-all"><i class="fas fa-undo mr-2"></i>ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <!-- â˜… ê´€ë¦¬ì ê³„ì • ê´€ë¦¬ â˜… -->
                <div class="bg-white p-8 lg:p-12 rounded-[3rem] border border-blue-100 shadow-sm font-bold">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-blue-100 rounded-2xl flex items-center justify-center"><i class="fas fa-user-shield text-blue-500"></i></div>
                        <div><h3 class="text-xl text-gray-800">ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h3><p class="text-[10px] text-gray-400">Google ë¡œê·¸ì¸ í›„ ìŠ¹ì¸ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p></div>
                    </div>
                    ${CURRENT_USER ? `<p class="text-[10px] text-blue-400 mb-6"><i class="fas fa-user mr-1"></i>í˜„ì¬ ë¡œê·¸ì¸: <strong>${CURRENT_USER.email}</strong> (${CURRENT_USER.role})</p>` : ''}
                    
                    <div id="adminListContainer" class="space-y-6">
                        <div class="text-center py-4 text-gray-300"><i class="fas fa-spinner fa-spin mr-1"></i> ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <!-- ë°ì´í„° ë°±ì—… -->
                <div class="bg-white p-8 lg:p-12 rounded-[3rem] border border-gray-100 shadow-sm font-bold">
                    <h3 class="text-xl mb-3 text-gray-800"><i class="fas fa-download mr-3 text-emerald-500"></i>ë°ì´í„° ë°±ì—…</h3>
                    <p class="text-xs text-gray-400 mb-8">ì „ì²´ DBë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. í…Œì´ë¸”ë³„ ê°œë³„ íŒŒì¼ì´ ZIPìœ¼ë¡œ ë¬¶ì—¬ ì €ì¥ë©ë‹ˆë‹¤.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-pink-100 rounded-xl flex items-center justify-center"><i class="fas fa-users text-pink-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">members</span></div>
                            <p class="text-[10px] text-gray-400">${appState.members.length}ê±´</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-emerald-100 rounded-xl flex items-center justify-center"><i class="fas fa-chart-line text-emerald-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">suro_scores</span></div>
                            <p class="text-[10px] text-gray-400">${appState.suroHeaders.length}ê°œ ì£¼ì°¨</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-blue-100 rounded-xl flex items-center justify-center"><i class="fas fa-gem text-blue-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">bail_history</span></div>
                            <p class="text-[10px] text-gray-400">${(appState.bailHistory||[]).length}ê±´</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center"><i class="fas fa-exclamation-triangle text-red-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">penalty + history</span></div>
                            <p class="text-[10px] text-gray-400">${(appState.penaltyHistory||[]).length} + ${(appState.history||[]).length}ê±´</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="window._backupAll()" id="backupAllBtn" class="px-8 py-4 bg-emerald-500 text-white rounded-2xl font-bold text-xs shadow-lg hover:bg-emerald-600 transition-all"><i class="fas fa-file-archive mr-2"></i>ì „ì²´ ë°±ì—… (ZIP)</button>
                        <button onclick="window._backupJSON()" class="px-6 py-4 bg-gray-100 text-gray-600 rounded-2xl font-bold text-xs hover:bg-gray-200 transition-all"><i class="fas fa-file-code mr-2"></i>ë‹¨ì¼ JSON</button>
                    </div>
                </div>
            </div>`;
        };

        // â”€â”€â”€ ë””ìì¸ ì„¤ì • í—¬í¼ í•¨ìˆ˜ë“¤ â”€â”€â”€
        window._cfgShowCutoff = (gName) => {
            document.querySelectorAll('.cfg-cutoff-tab').forEach(t => t.classList.toggle('bg-pink-500', t.dataset.guild === gName));
            document.querySelectorAll('.cfg-cutoff-tab').forEach(t => t.classList.toggle('text-white', t.dataset.guild === gName));
            document.querySelectorAll('.cfg-cutoff-tab').forEach(t => { if(t.dataset.guild !== gName) { t.classList.add('bg-gray-100','text-gray-500'); t.classList.remove('bg-pink-500','text-white'); }});
            document.querySelectorAll('.cfg-cutoff-section').forEach(s => s.classList.toggle('hidden', s.dataset.guild !== gName));
        };

        window._cfgAddGuild = () => {
            window.showMsg('ê¸¸ë“œ ì¶”ê°€: ì €ì¥ í›„ ë°˜ì˜ë©ë‹ˆë‹¤');
            const cfg = SITE_CONFIG || {};
            if (!cfg.guilds) cfg.guilds = [...appState.guilds];
            cfg.guilds.push({ id: 'new_' + Date.now(), name: 'ìƒˆê¸¸ë“œ', type: 'ì‹ ê·œ', color: '#9ca3af', icon: 'fa-star', max: 200 });
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgRemoveGuild = (idx) => {
            if (!confirm('ì´ ê¸¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const cfg = SITE_CONFIG || {};
            if (!cfg.guilds) cfg.guilds = [...appState.guilds];
            cfg.guilds.splice(idx, 1);
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgAddCutoff = (gName) => {
            const cfg = SITE_CONFIG || {};
            if (!cfg.cutoffs) cfg.cutoffs = {};
            if (!cfg.cutoffs[gName]) cfg.cutoffs[gName] = [];
            cfg.cutoffs[gName].push({ rank: '', min: 0, label: '', cssBg: 'bg-gray-50', cssBorder: 'border-gray-100', cssText: 'text-gray-600', cssValue: 'text-gray-500' });
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgRemoveCutoff = (gName, ci) => {
            const cfg = SITE_CONFIG || {};
            if (cfg.cutoffs?.[gName]) {
                cfg.cutoffs[gName].splice(ci, 1);
                SITE_CONFIG = cfg;
                window.renderSettings(document.getElementById('contentArea'));
            }
        };

        window._cfgAddAutoRule = (gName) => {
            const cfg = SITE_CONFIG || {};
            if (!cfg.autoRankRules) cfg.autoRankRules = {};
            if (!cfg.autoRankRules[gName]) cfg.autoRankRules[gName] = [];
            cfg.autoRankRules[gName].push({ min: 0, rank: '' });
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgRemoveAutoRule = (gName, ri) => {
            const cfg = SITE_CONFIG || {};
            if (cfg.autoRankRules?.[gName]) {
                cfg.autoRankRules[gName].splice(ri, 1);
                SITE_CONFIG = cfg;
                window.renderSettings(document.getElementById('contentArea'));
            }
        };

        window._cfgCollectAll = () => {
            const cfg = JSON.parse(JSON.stringify(SITE_CONFIG || {}));

            // ê¸°ë³¸ ì •ë³´
            cfg.guildStartDate = document.getElementById('cfgStartDate')?.value || '2020-03-17';
            cfg.suroExemptLabel = document.getElementById('cfgExemptLabel')?.value || '';
            cfg.suroExemptNote = document.getElementById('cfgExemptNote')?.value || '';

            // ê¸¸ë“œ ì •ë³´
            const guildCards = document.querySelectorAll('[data-guild-idx]');
            if (guildCards.length > 0) {
                cfg.guilds = [];
                guildCards.forEach(card => {
                    const idx = card.dataset.guildIdx;
                    cfg.guilds.push({
                        id: (SITE_CONFIG?.guilds?.[idx]?.id) || 'g_' + idx,
                        name: card.querySelector('.cfg-guild-name')?.value || '',
                        type: card.querySelector('.cfg-guild-type')?.value || '',
                        color: card.querySelector('.cfg-guild-color')?.value || '#9ca3af',
                        icon: card.querySelector('.cfg-guild-icon')?.value || 'fa-star',
                        max: parseInt(card.querySelector('.cfg-guild-max')?.value) || 200
                    });
                });
            }

            // ì§ìœ„ ì´ëª¨ì§€/ìƒ‰ìƒ/ìš°ì„ ìˆœìœ„
            cfg.roleDisplay = cfg.roleDisplay || {};
            cfg.rolePriority = cfg.rolePriority || {};
            document.querySelectorAll('.cfg-role-emoji').forEach(el => {
                const rName = el.dataset.role;
                if (!cfg.roleDisplay[rName]) cfg.roleDisplay[rName] = {};
                cfg.roleDisplay[rName].emoji = el.value;
            });
            document.querySelectorAll('.cfg-role-color').forEach(el => {
                const rName = el.dataset.role;
                if (!cfg.roleDisplay[rName]) cfg.roleDisplay[rName] = {};
                cfg.roleDisplay[rName].color = el.value;
            });
            document.querySelectorAll('.cfg-role-priority').forEach(el => {
                const rName = el.dataset.role;
                cfg.rolePriority[rName] = parseInt(el.value) || 99;
            });

            // ì»¤íŠ¸ë¼ì¸
            cfg.cutoffs = cfg.cutoffs || {};
            document.querySelectorAll('.cfg-cutoff-section').forEach(sec => {
                const gn = sec.dataset.guild;
                const items = [];
                sec.querySelectorAll('.cfg-cutoff-rank').forEach(el => {
                    const ci = parseInt(el.dataset.ci);
                    const existing = cfg.cutoffs[gn]?.[ci] || {};
                    items.push({
                        ...existing,
                        rank: el.value,
                        min: (() => { const v = sec.querySelector(`.cfg-cutoff-min[data-ci="${ci}"]`)?.value; return v !== '' ? parseInt(v) : undefined; })(),
                        max: (() => { const v = sec.querySelector(`.cfg-cutoff-max[data-ci="${ci}"]`)?.value; return v !== '' ? parseInt(v) : undefined; })(),
                        label: sec.querySelector(`.cfg-cutoff-label[data-ci="${ci}"]`)?.value || '',
                        note: sec.querySelector(`.cfg-cutoff-note[data-ci="${ci}"]`)?.value || ''
                    });
                });
                cfg.cutoffs[gn] = items;
            });

            // ìˆ˜ë¡œ ë©´ì œ
            cfg.suroExempt = [];
            document.querySelectorAll('.cfg-exempt-check:checked').forEach(el => cfg.suroExempt.push(el.value));

            // ìë™ ì§ìœ„ ë°°ì •
            cfg.autoRankRules = cfg.autoRankRules || {};
            document.querySelectorAll('.cfg-autorule-min').forEach(el => {
                const gn = el.dataset.guild;
                const ri = parseInt(el.dataset.ri);
                if (!cfg.autoRankRules[gn]) cfg.autoRankRules[gn] = [];
                if (!cfg.autoRankRules[gn][ri]) cfg.autoRankRules[gn][ri] = {};
                cfg.autoRankRules[gn][ri].min = parseInt(el.value) || 0;
            });
            document.querySelectorAll('.cfg-autorule-rank').forEach(el => {
                const gn = el.dataset.guild;
                const ri = parseInt(el.dataset.ri);
                if (!cfg.autoRankRules[gn]) cfg.autoRankRules[gn] = [];
                if (!cfg.autoRankRules[gn][ri]) cfg.autoRankRules[gn][ri] = {};
                cfg.autoRankRules[gn][ri].rank = el.value;
            });

            // ë°°ì§€ ìƒ‰ìƒ
            cfg.guildBadgeStyles = cfg.guildBadgeStyles || {};
            document.querySelectorAll('.cfg-badge-bg').forEach(el => {
                const gn = el.dataset.guild;
                if (!cfg.guildBadgeStyles[gn]) cfg.guildBadgeStyles[gn] = {};
                cfg.guildBadgeStyles[gn].bg = el.value;
            });
            document.querySelectorAll('.cfg-badge-text').forEach(el => {
                const gn = el.dataset.guild;
                if (!cfg.guildBadgeStyles[gn]) cfg.guildBadgeStyles[gn] = {};
                cfg.guildBadgeStyles[gn].text = el.value;
            });
            document.querySelectorAll('.cfg-badge-border').forEach(el => {
                const gn = el.dataset.guild;
                if (!cfg.guildBadgeStyles[gn]) cfg.guildBadgeStyles[gn] = {};
                cfg.guildBadgeStyles[gn].border = el.value;
            });

            // undefined ì œê±°
            Object.keys(cfg.cutoffs || {}).forEach(gn => {
                cfg.cutoffs[gn] = cfg.cutoffs[gn].map(c => {
                    const clean = { ...c };
                    if (clean.min === undefined) delete clean.min;
                    if (clean.max === undefined) delete clean.max;
                    if (!clean.note) delete clean.note;
                    return clean;
                });
            });

            return cfg;
        };

        window._cfgSave = async () => {
            const btn = document.getElementById('cfgSaveBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...'; }
            try {
                const newConfig = window._cfgCollectAll();
                const { error } = await supaDb.from('site_config').upsert({ id: 1, config: newConfig, updated_at: new Date().toISOString() });
                if (error) throw error;
                SITE_CONFIG = newConfig;

                // appStateì—ë„ ë°˜ì˜
                if (newConfig.guilds) appState.guilds = newConfig.guilds;
                if (newConfig.ranks) { initialGuildRanks = newConfig.ranks; appState.guildRanks = newConfig.ranks; }
                if (newConfig.rolePriority) ROLE_PRIORITY = newConfig.rolePriority;
                if (newConfig.guildStartDate) GUILD_START_DATE = new Date(newConfig.guildStartDate);

                // ìš´ì˜ ì´ë ¥ ê¸°ë¡
                try {
                    await supaDb.from('operation_history').insert({ date: new Date().toISOString().split('T')[0], category: 'ì„¤ì •', name: 'ë””ìì¸ ì„¤ì •', content: 'ë””ìì¸ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
                } catch(e) {}

                window.showMsg('ë””ìì¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                window.renderSettings(document.getElementById('contentArea'));
            } catch(e) {
                window.showMsg('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-2"></i>ë””ìì¸ ì„¤ì • ì €ì¥'; }
            }
        };

        window._cfgReset = async () => {
            if (!confirm('ë””ìì¸ ì„¤ì •ì„ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ì €ì¥ëœ ì„¤ì •ì´ ì‚­ì œë©ë‹ˆë‹¤)')) return;
            try {
                await supaDb.from('site_config').delete().eq('id', 1);
                SITE_CONFIG = null;
                window.showMsg('ì´ˆê¸°í™” ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•˜ë©´ ê¸°ë³¸ê°’ì´ ì ìš©ë©ë‹ˆë‹¤.', 'success');
                window.renderSettings(document.getElementById('contentArea'));
            } catch(e) {
                window.showMsg('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        window.saveSettings = () => { window.showMsg("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); };

        // â”€â”€â”€ ë°±ì—… ê¸°ëŠ¥ â”€â”€â”€
        window._backupFetchAll = async () => {
            const btn = document.getElementById('backupAllBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë°±ì—… ì¤‘...'; }

            async function fetchAll(table, orderCol) {
                const pageSize = 1000;
                let all = [], from = 0;
                while (true) {
                    const { data, error } = await supaDb.from(table).select('*').order(orderCol, { ascending: true }).range(from, from + pageSize - 1);
                    if (error) throw error;
                    all = all.concat(data || []);
                    if (!data || data.length < pageSize) break;
                    from += pageSize;
                }
                return all;
            }

            const backup = {
                _meta: {
                    exported_at: new Date().toISOString(),
                    source: SUPABASE_URL,
                    version: '9.1'
                },
                members: await fetchAll('members', 'name'),
                suro_periods: await fetchAll('suro_periods', 'id'),
                suro_scores: await fetchAll('suro_scores', 'id'),
                bail_history: await fetchAll('bail_history', 'id'),
                penalty_history: await fetchAll('penalty_history', 'id'),
                operation_history: await fetchAll('operation_history', 'id'),
                events: await fetchAll('events', 'id'),
                guide_pages: await fetchAll('guide_pages', 'id')
            };

            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-archive mr-2"></i>ì „ì²´ ë°±ì—… (ZIP)'; }
            return backup;
        };

        window._backupJSON = async () => {
            try {
                const backup = await window._backupFetchAll();
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                a.href = url;
                a.download = `maplestory_guild_backup_${dateStr}.json`;
                a.click();
                URL.revokeObjectURL(url);
                window.showMsg('JSON ë°±ì—… ì™„ë£Œ!', 'success');
            } catch(e) {
                window.showMsg('ë°±ì—… ì‹¤íŒ¨: ' + (e.message || e), 'error');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  ê´€ë¦¬ì í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬  â–ˆâ–ˆ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        window._loadAdminList = async () => {
            const container = document.getElementById('adminListContainer');
            if (!container) return;
            try {
                const { data, error } = await supaDb.from('admin_whitelist').select('*').order('created_at');
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">ë“±ë¡ëœ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                const pending = data.filter(a => a.status === 'pending');
                const approved = data.filter(a => a.status === 'approved');
                const rejected = data.filter(a => a.status === 'rejected');
                
                let html = '';
                
                // ìŠ¹ì¸ ëŒ€ê¸° ì„¹ì…˜
                if (pending.length > 0) {
                    html += `<div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>
                            <span class="text-xs font-bold text-amber-600">ìŠ¹ì¸ ëŒ€ê¸° (${pending.length}ëª…)</span>
                        </div>
                        <div class="space-y-2">${pending.map(a => `
                            <div class="flex items-center gap-3 bg-amber-50 rounded-xl px-4 py-3 border border-amber-200">
                                <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 text-[10px] font-bold shrink-0">${(a.name || a.email)[0].toUpperCase()}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-gray-700 truncate">${a.name || '-'}</p>
                                    <p class="text-[9px] text-gray-400 truncate">${a.email}</p>
                                    <p class="text-[8px] text-amber-400">${a.requested_at ? new Date(a.requested_at).toLocaleString('ko-KR') + ' ìš”ì²­' : ''}</p>
                                </div>
                                <div class="flex gap-1.5 shrink-0">
                                    <button onclick="window._approveAdmin(${a.id}, '${a.email}')" class="px-3 py-1.5 bg-green-500 text-white rounded-lg text-[10px] font-bold hover:bg-green-600 transition-all"><i class="fas fa-check mr-1"></i>ìŠ¹ì¸</button>
                                    <button onclick="window._rejectAdmin(${a.id}, '${a.email}')" class="px-3 py-1.5 bg-red-400 text-white rounded-lg text-[10px] font-bold hover:bg-red-500 transition-all"><i class="fas fa-times mr-1"></i>ê±°ì ˆ</button>
                                </div>
                            </div>
                        `).join('')}</div>
                    </div>`;
                }
                
                // ìŠ¹ì¸ëœ ê´€ë¦¬ì ì„¹ì…˜
                if (approved.length > 0) {
                    html += `<div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                            <span class="text-xs font-bold text-green-600">ìŠ¹ì¸ë¨ (${approved.length}ëª…)</span>
                        </div>
                        <div class="space-y-2">${approved.map(a => `
                            <div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3 border border-gray-100 group hover:border-blue-200 transition-all">
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 text-[10px] font-bold shrink-0">${(a.name || a.email)[0].toUpperCase()}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-gray-700 truncate">${a.name || '-'}</p>
                                    <p class="text-[9px] text-gray-400 truncate">${a.email}</p>
                                </div>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full ${a.role === 'ë§ˆìŠ¤í„°' ? 'bg-pink-100 text-pink-600' : a.role === 'ë¶€ë§ˆìŠ¤í„°' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-500'}">${a.role || 'ê´€ë¦¬ì'}</span>
                                ${CURRENT_USER && CURRENT_USER.email !== a.email ? `<button onclick="window._removeAdmin(${a.id}, '${a.email}')" class="w-7 h-7 rounded-lg bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-600 text-[10px] transition-all opacity-0 group-hover:opacity-100 shrink-0"><i class="fas fa-times"></i></button>` : '<span class="text-[8px] text-green-500 font-bold">ë‚˜</span>'}
                            </div>
                        `).join('')}</div>
                    </div>`;
                }
                
                // ê±°ì ˆëœ ì‚¬ìš©ì ì„¹ì…˜
                if (rejected.length > 0) {
                    html += `<div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-2 h-2 bg-red-400 rounded-full"></span>
                            <span class="text-xs font-bold text-red-400">ê±°ì ˆë¨ (${rejected.length}ëª…)</span>
                        </div>
                        <div class="space-y-2">${rejected.map(a => `
                            <div class="flex items-center gap-3 bg-red-50/50 rounded-xl px-4 py-3 border border-red-100 group">
                                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-400 text-[10px] font-bold shrink-0">${(a.name || a.email)[0].toUpperCase()}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-gray-500 truncate">${a.name || '-'}</p>
                                    <p class="text-[9px] text-gray-400 truncate">${a.email}</p>
                                </div>
                                <div class="flex gap-1.5 shrink-0">
                                    <button onclick="window._approveAdmin(${a.id}, '${a.email}')" class="px-2.5 py-1 bg-green-100 text-green-600 rounded-lg text-[9px] font-bold hover:bg-green-200 transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-check mr-1"></i>ìŠ¹ì¸</button>
                                    <button onclick="window._removeAdmin(${a.id}, '${a.email}')" class="w-7 h-7 rounded-lg bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-600 text-[10px] transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}</div>
                    </div>`;
                }
                
                container.innerHTML = html || '<p class="text-xs text-gray-400 text-center py-4">ë“±ë¡ëœ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } catch (e) {
                container.innerHTML = `<p class="text-xs text-red-400 text-center py-4">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
            }
        };

        window._approveAdmin = async (id, email) => {
            try {
                const { error } = await supaDb.from('admin_whitelist').update({ 
                    status: 'approved', 
                    approved_at: new Date().toISOString() 
                }).eq('id', id);
                if (error) throw error;
                window.showMsg(`${email} ìŠ¹ì¸ ì™„ë£Œ!`, 'success');
                await window._loadAdminList();
            } catch (e) {
                window.showMsg('ìŠ¹ì¸ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        window._rejectAdmin = async (id, email) => {
            if (!confirm(`"${email}" ì ‘ê·¼ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const { error } = await supaDb.from('admin_whitelist').update({ status: 'rejected' }).eq('id', id);
                if (error) throw error;
                window.showMsg(`${email} ê±°ì ˆë¨`, 'success');
                await window._loadAdminList();
            } catch (e) {
                window.showMsg('ê±°ì ˆ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        window._addAdmin = async () => { /* ë¯¸ì‚¬ìš© - ìë™ ìš”ì²­ ë°©ì‹ */ };

        window._removeAdmin = async (id, email, role) => {
            if (role === 'ë§ˆìŠ¤í„°') { window.showMsg('ë§ˆìŠ¤í„° ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
            if (!confirm(`"${email}"ì„(ë¥¼) ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ì‹œ ë¡œê·¸ì¸í•˜ë©´ ìƒˆë¡œ ìŠ¹ì¸ ìš”ì²­ë©ë‹ˆë‹¤.`)) return;
            try {
                const { error } = await supaDb.from('admin_whitelist').delete().eq('id', id);
                if (error) throw error;
                window.showMsg(`${email} ì‚­ì œ ì™„ë£Œ`, 'success');
                await window._loadAdminList();
            } catch (e) {
                window.showMsg('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        window._backupAll = async () => {
            try {
                const backup = await window._backupFetchAll();
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const folderName = `guild_backup_${dateStr}`;

                // JSZip CDN ë¡œë“œ
                if (!window.JSZip) {
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                        s.onload = resolve;
                        s.onerror = reject;
                        document.head.appendChild(s);
                    });
                }

                const zip = new JSZip();
                const folder = zip.folder(folderName);

                // ë©”íƒ€ ì •ë³´
                folder.file('_meta.json', JSON.stringify(backup._meta, null, 2));

                // ê° í…Œì´ë¸”ë³„ íŒŒì¼
                const tables = ['members','suro_periods','suro_scores','bail_history','penalty_history','operation_history','events','guide_pages'];
                tables.forEach(t => {
                    folder.file(`${t}.json`, JSON.stringify(backup[t], null, 2));
                });

                // ì „ì²´ í†µí•© íŒŒì¼ë„ í¬í•¨
                folder.file('_full_backup.json', JSON.stringify(backup, null, 2));

                // CSV í˜•íƒœë¡œ membersë„ ì¶”ê°€
                if (backup.members.length > 0) {
                    const csvCols = Object.keys(backup.members[0]);
                    const csvRows = [csvCols.join(',')];
                    backup.members.forEach(m => {
                        csvRows.push(csvCols.map(c => {
                            const v = String(m[c] ?? '').replace(/"/g, '""');
                            return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v}"` : v;
                        }).join(','));
                    });
                    folder.file('members.csv', '\uFEFF' + csvRows.join('\n'));
                }

                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${folderName}.zip`;
                a.click();
                URL.revokeObjectURL(url);
                window.showMsg(`ë°±ì—… ì™„ë£Œ! (${tables.length}ê°œ í…Œì´ë¸”)`, 'success');
            } catch(e) {
                console.error('ë°±ì—… ì—ëŸ¬:', e);
                window.showMsg('ë°±ì—… ì‹¤íŒ¨: ' + (e.message || e), 'error');
            }
        };

        window._memberSearchTimer = null;
        window.handleSearch = (v) => { appState.filters.search = v; appState.pagination.members = 1; if(window._memberSearchTimer) clearTimeout(window._memberSearchTimer); window._memberSearchTimer = setTimeout(() => window.updateMemberTable(), 100); };
        window.filterByGuild = (g) => { appState.filters.guild = g; appState.pagination.members = 1; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } appState.pagination.members = 1; window.updateMemberTable(); };

        // â•â•â• memberCRUD (from admin, lines 4067-4298) â•â•â•
        
        window.openEditModal = (id) => { 
            const m = appState.members.find(x => x.id == id); if(!m) return;
            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì •ë³´ ìˆ˜ì •'; document.getElementById('editMemberId').value = m.id; document.getElementById('inputName').value = m.name; document.getElementById('inputName').disabled = true;
            document.getElementById('inputClass').innerHTML = MAPLE_JOBS.map(j=>`<option value="${j}">${j}</option>`).join(''); document.getElementById('inputClass').value = m.class || '';
            document.getElementById('inputGuild').innerHTML = appState.guilds.map(g=>`<option value="${g.name}">${g.name}</option>`).join(''); document.getElementById('inputGuild').value = m.guild;
            onGuildSelectChange(m.guild); setTimeout(() => { document.getElementById('inputRole').value = m.role; }, 100);
            document.getElementById('inputIsMain').checked = m.isMain; document.getElementById('inputMainCharName').value = m.mainCharName || ''; toggleMainCharInput(); document.getElementById('memberModal').classList.remove('hidden');
        };
        window.openAddModal = () => {
            // ì¼ê´„ ë“±ë¡ ëª¨ë‹¬ ì˜¤í”ˆ
            document.getElementById('bulkAddBody').innerHTML = '';
            window._bulkAddRows(3); // ì´ˆê¸° 3í–‰
            document.getElementById('bulkAddModal').classList.remove('hidden');
            window._bulkUpdateCount();
        };

        window._bulkRowId = 0;
        window._bulkAddRow = () => {
            const idx = ++window._bulkRowId;
            const tbody = document.getElementById('bulkAddBody');
            const guilds = appState.guilds.map(g => g.name);
            const defaultGuild = guilds[0];
            const defaultRoles = initialGuildRanks[defaultGuild] || [];

            const tr = document.createElement('tr');
            tr.id = `bulkRow_${idx}`;
            tr.className = 'border-b border-gray-50 hover:bg-pink-50/20 transition-colors';
            tr.innerHTML = `
                <td class="p-1 text-center text-gray-300 text-[10px] font-mono bulk-row-num"></td>
                <td class="p-1"><input type="text" class="bulk-name w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100 focus:border-pink-200" placeholder="ìºë¦­í„°ëª…"></td>
                <td class="p-1">
                    <select class="bulk-guild w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" onchange="window._bulkGuildChange(this, ${idx})">
                        ${guilds.map(g => `<option value="${g}">${g}</option>`).join('')}
                    </select>
                </td>
                <td class="p-1">
                    <select class="bulk-role w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" id="bulkRole_${idx}">
                        ${defaultRoles.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                </td>
                <td class="p-1">
                    <select class="bulk-class w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer">
                        <option value="">-</option>
                        ${MAPLE_JOBS.map(j => `<option value="${j}">${j}</option>`).join('')}
                    </select>
                </td>
                <td class="p-1 text-center">
                    <input type="checkbox" class="bulk-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" checked onchange="window._bulkMainToggle(this, ${idx})">
                </td>
                <td class="p-1">
                    <input type="text" class="bulk-mainChar w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none hidden" id="bulkMainChar_${idx}" placeholder="ë³¸ìºë‹‰">
                </td>
                <td class="p-1 text-center">
                    <button onclick="document.getElementById('bulkRow_${idx}').remove();window._bulkUpdateCount()" class="w-6 h-6 rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-400 transition-all text-[10px]"><i class="fas fa-times"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
            window._bulkUpdateCount();
            // Focus the name input of new row
            tr.querySelector('.bulk-name').focus();
        };

        window._bulkAddRows = (n) => { for(let i=0; i<n; i++) window._bulkAddRow(); };

        window._bulkGuildChange = (sel, idx) => {
            const roles = initialGuildRanks[sel.value] || [];
            const roleEl = document.getElementById(`bulkRole_${idx}`);
            if(roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };

        window._bulkMainToggle = (cb, idx) => {
            const el = document.getElementById(`bulkMainChar_${idx}`);
            if(el) { cb.checked ? el.classList.add('hidden') : el.classList.remove('hidden'); }
        };

        window._bulkUpdateCount = () => {
            const rows = document.querySelectorAll('#bulkAddBody tr');
            rows.forEach((tr, i) => { const num = tr.querySelector('.bulk-row-num'); if(num) num.textContent = i+1; });
            const filled = [...rows].filter(tr => tr.querySelector('.bulk-name')?.value.trim()).length;
            document.getElementById('bulkAddCount').textContent = `${rows.length}í–‰ (ì…ë ¥ ${filled}ëª…)`;
        };

        window._bulkAddSave = async () => {
            const rows = document.querySelectorAll('#bulkAddBody tr');
            const members = [];
            const existingNames = new Set(appState.members.map(m => m.name));
            const newNames = new Set();
            const errors = [];

            rows.forEach((tr, i) => {
                const name = tr.querySelector('.bulk-name')?.value.trim();
                if (!name) return; // ë¹ˆ í–‰ ìŠ¤í‚µ
                if (existingNames.has(name)) { errors.push(`${i+1}í–‰: "${name}" ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„`); return; }
                if (newNames.has(name)) { errors.push(`${i+1}í–‰: "${name}" ì¤‘ë³µ ì…ë ¥`); return; }
                newNames.add(name);

                members.push({
                    name: name,
                    guild: tr.querySelector('.bulk-guild')?.value || 'ëš ì¹´ë¡±',
                    role: tr.querySelector('.bulk-role')?.value || 'íŒ¬ì¼€ì´í¬',
                    class: tr.querySelector('.bulk-class')?.value || '',
                    is_main: tr.querySelector('.bulk-isMain')?.checked !== false,
                    main_char_name: tr.querySelector('.bulk-mainChar')?.value.trim() || '',
                    join_date: new Date().toISOString().split('T')[0]
                });
            });

            if (errors.length > 0) { window.showMsg(errors.join('\n'), 'error'); return; }
            if (members.length === 0) { window.showMsg('ì…ë ¥ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
            if (!confirm(`${members.length}ëª…ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const btn = document.getElementById('bulkAddSaveBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì €ì¥ ì¤‘...';

            try {
                const { error } = await supaDb.from('members').insert(members);
                if (error) throw error;

                // ìš´ì˜ì´ë ¥
                const historyRows = members.map(m => ({
                    date: new Date().toISOString().split('T')[0],
                    category: 'ì¶”ê°€', name: m.name, content: `${m.guild} ê¸¸ë“œì— ì¶”ê°€ë¨`
                }));
                await supaDb.from('operation_history').insert(historyRows);

                window.showMsg(`${members.length}ëª… ì¼ê´„ ë“±ë¡ ì™„ë£Œ!`, 'success');
                window.closeModal('bulkAddModal');
                await window.fetchMembers();
            } catch(e) {
                console.error('ì¼ê´„ ë“±ë¡ ì—ëŸ¬:', e);
                window.showMsg('ë“±ë¡ ì‹¤íŒ¨: ' + (e.message || e), 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>ì¼ê´„ ì €ì¥';
            }
        };
        window.openDeleteModal = (id) => { appState.memberToDelete = appState.members.find(x => x.id == id); document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteModal').classList.remove('hidden'); };
        window.setDeleteType = (t) => { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all'; document.getElementById('btnKick').className = t === 'kick' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-red-600 text-white shadow-sm transition-all' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all'; };
        
        window.confirmDelete = async () => { 
            const reason = document.getElementById('deleteReason').value;
            
            if (appState.isKickMode && appState.kickSelection.size > 0) {
                const ids = Array.from(appState.kickSelection);
                const kickedNames = appState.members.filter(m => ids.includes(m.id)).map(m => m.name);
                
                if (!confirm(`${kickedNames.length}ëª…ì„ ì •ë§ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n${kickedNames.join(', ')}`)) return;
                
                window.showLoading(true);
                window.setLoadProgress(10, 'ì¶”ë°© ì²˜ë¦¬ ì¤‘...');
                
                try {
                    // ê´€ë ¨ ìˆ˜ë¡œ ì ìˆ˜ ë¨¼ì € ì‚­ì œ
                    window.setLoadProgress(20, 'ìˆ˜ë¡œ ë°ì´í„° ì •ë¦¬ ì¤‘...');
                    const { error: suroErr } = await supaDb.from('suro_scores').delete().in('member_id', ids);
                    if (suroErr) console.error('suro delete error:', suroErr);
                    
                    // ë©¤ë²„ ì‚­ì œ
                    window.setLoadProgress(50, 'ë©¤ë²„ ì‚­ì œ ì¤‘...');
                    const { error: memErr } = await supaDb.from('members').delete().in('id', ids);
                    if (memErr) throw memErr;
                    
                    // ìš´ì˜ì´ë ¥ ì €ì¥
                    if (reason) {
                        window.setLoadProgress(70, 'ì´ë ¥ ì €ì¥ ì¤‘...');
                        const historyRows = kickedNames.map(name => ({
                            date: new Date().toISOString().split('T')[0],
                            category: 'ì¶”ë°©', name: name, content: reason
                        }));
                        await supaDb.from('operation_history').insert(historyRows);
                    }
                    
                    window.setLoadProgress(90, 'ë°ì´í„° ê°±ì‹  ì¤‘...');
                    window.showMsg(`${kickedNames.length}ëª… ì¶”ë°© ì™„ë£Œ.`, "success");
                } catch(e) {
                    console.error('ì¶”ë°© ì—ëŸ¬:', e);
                    window.showMsg("ì¶”ë°© ì²˜ë¦¬ ì‹¤íŒ¨: " + (e.message || e), "error");
                }
                
                window.showLoading(false);
                window.closeModal('deleteModal');
                appState.isKickMode = false;
                appState.kickSelection.clear();
                await window.fetchMembers();
                return;
            }

            // Single member delete
            if (appState.memberToDelete) {
                window.showLoading(true);
                const delId = appState.memberToDelete.id;
                const delName = appState.memberToDelete.name;
                
                try {
                    // ê´€ë ¨ ìˆ˜ë¡œ ì ìˆ˜ ë¨¼ì € ì‚­ì œ
                    await supaDb.from('suro_scores').delete().eq('member_id', delId);
                    
                    // ë©¤ë²„ ì‚­ì œ
                    const { error } = await supaDb.from('members').delete().eq('id', delId);
                    if (error) throw error;
                    
                    // ìš´ì˜ì´ë ¥ ì €ì¥
                    if (reason) {
                        await supaDb.from('operation_history').insert({
                            date: new Date().toISOString().split('T')[0],
                            category: appState.deleteType === 'kick' ? 'ì¶”ë°©' : 'ìì§„íƒˆí‡´',
                            name: delName, content: reason
                        });
                    }
                    
                    window.showMsg(`${delName} ì œê±° ì™„ë£Œ.`, "success");
                    await window.fetchMembers();
                } catch(e) {
                    console.error('ì‚­ì œ ì—ëŸ¬:', e);
                    window.showMsg("ì œê±° ì‹¤íŒ¨: " + (e.message || e), "error");
                }
                
                window.showLoading(false);
                window.closeModal('deleteModal');
            }
        };

        function onGuildSelectChange(v) { document.getElementById('inputRole').innerHTML = (appState.guildRanks[v] || initialGuildRanks[v] || initialGuildRanks['ëš ì¹´ë¡±']).map(r => `<option value="${r}">${r}</option>`).join(''); }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }
        
        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('editMemberId').value;
            const data = { name: document.getElementById('inputName').value.trim(), guild: document.getElementById('inputGuild').value, role: document.getElementById('inputRole').value, class: document.getElementById('inputClass').value, isMain: document.getElementById('inputIsMain').checked, mainCharName: document.getElementById('inputMainCharName').value.trim(), joinDate: new Date().toISOString().split('T')[0] };
            if(await window.sendAction(id ? 'update' : 'add', id ? { ...data, id } : data)) window.closeModal('memberModal');
        };

        // â”€â”€â”€ ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥ ê¸°ëŠ¥ â”€â”€â”€

        // â•â•â• suroInput (from admin, lines 4299-4637) â•â•â•
        window.renderSuroInput = (container) => {
            const currentHeader = window.getSuroPeriodHeader();
            const allHeaders = [...appState.suroHeaders];
            const headerOptions = allHeaders.includes(currentHeader) ? allHeaders : [...allHeaders, currentHeader];

            container.innerHTML = `
            <div class="flex flex-col gap-3 lg:gap-4 fade-in h-full">
                <div class="bg-white p-3 lg:p-5 rounded-2xl border border-gray-100 shadow-sm shrink-0">
                    <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ìˆ˜ë¡œ ì£¼ì°¨ ì„ íƒ</label>
                            <select id="suroInputPeriod" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-2.5 lg:p-3 text-xs font-bold outline-none shadow-inner" onchange="window._suroInputState.page=1;window.loadSuroInputTable()">
                                ${headerOptions.map(h => `<option value="${h}" ${h === currentHeader ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ê¸¸ë“œ í•„í„°</label>
                            <select id="suroInputGuild" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-2.5 lg:p-3 text-xs font-bold outline-none shadow-inner" onchange="window._suroInputState.page=1;window.loadSuroInputTable()">
                                ${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="window.openSuroPasteModal()" class="px-4 lg:px-5 py-2.5 lg:py-3 bg-indigo-500 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-lg hover:bg-indigo-600 transition-all">
                                <i class="fas fa-paste mr-1"></i> ë¶™ì—¬ë„£ê¸°
                            </button>
                            <button onclick="window.saveSuroScores()" class="px-5 lg:px-6 py-2.5 lg:py-3 bg-pink-500 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-lg hover:bg-pink-600 transition-all">
                                <i class="fas fa-save mr-1"></i> ì ìˆ˜ ì €ì¥
                            </button>
                            <button onclick="window.clearSuroInputs()" class="px-3 lg:px-4 py-2.5 lg:py-3 bg-gray-100 text-gray-500 rounded-xl text-[10px] lg:text-xs font-bold hover:bg-gray-200 transition-all">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden flex flex-col min-h-0">
                    <div id="suroInputTableContainer" class="flex-1 overflow-auto"></div>
                </div>
            </div>`;
            window.loadSuroInputTable();
        };

        window._suroInputState = { page: 1, perPage: 9999 };

        window.loadSuroInputTable = () => {
            const container = document.getElementById('suroInputTableContainer');
            if (!container) return;
            const guild = document.getElementById('suroInputGuild').value;
            const period = document.getElementById('suroInputPeriod').value;
            const allMembers = appState.members
                .filter(m => m.guild === guild)
                .sort((a, b) => a.name < b.name ? -1 : a.name > b.name ? 1 : 0);

            const st = window._suroInputState;
            const totalPages = Math.max(1, Math.ceil(allMembers.length / st.perPage));
            if (st.page > totalPages) st.page = totalPages;
            const startIdx = (st.page - 1) * st.perPage;
            const pageMembers = allMembers.slice(startIdx, startIdx + st.perPage);

            container.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-100 shrink-0">
                <span class="text-[9px] font-bold text-gray-500"><i class="fas fa-users mr-1 text-pink-400"></i>${allMembers.length}ëª…</span>
                <span class="text-[9px] font-bold text-pink-400">17ëª…ë§ˆë‹¤ í˜ì´ì§€ êµ¬ë¶„ì„  í‘œì‹œ</span>
            </div>
            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase border-b border-gray-200">
                    <tr>
                        <th class="p-2 lg:p-3 w-10 text-center">#</th>
                        <th class="p-2 lg:p-3">ë‹‰ë„¤ì„</th>
                        <th class="p-2 lg:p-3 hidden sm:table-cell">ì§ìœ„</th>
                        <th class="p-2 lg:p-3 w-24 text-center">í˜„ì¬ ì ìˆ˜</th>
                        <th class="p-2 lg:p-3 w-32 lg:w-40">ì ìˆ˜ ì…ë ¥</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 font-bold">
                    ${pageMembers.map((m, i) => {
                        const currentScore = Math.round(Number(m.suro?.[period])) || 0;
                        const globalIdx = startIdx + i;
                        const isPageBoundary = globalIdx > 0 && globalIdx % 17 === 0;
                        const pageNum = Math.floor(globalIdx / 17) + 1;
                        let row = '';
                        if (isPageBoundary) {
                            row += `<tr><td colspan="5" class="p-0"><div class="flex items-center gap-2 py-1 px-3 bg-pink-50 border-y-2 border-pink-200"><span class="text-[9px] font-black text-pink-400 tracking-widest uppercase">â”€â”€ PAGE ${pageNum} â”€â”€</span><span class="text-[9px] text-pink-300">(${globalIdx + 1}~${Math.min(globalIdx + 17, allMembers.length)}ë²ˆì§¸)</span></div></td></tr>`;
                        }
                        row += `
                        <tr class="hover:bg-pink-50/20 transition-colors">
                            <td class="p-2 lg:p-3 text-center text-gray-400 text-[10px]">${globalIdx + 1}</td>
                            <td class="p-2 lg:p-3 text-gray-800">
                                <div class="flex items-center">${window.getNicknameIcon(m.role)}<span class="text-[11px] lg:text-xs">${m.name}</span></div>
                            </td>
                            <td class="p-2 lg:p-3 text-gray-500 text-[10px] hidden sm:table-cell">${m.role}</td>
                            <td class="p-2 lg:p-3 text-center ${currentScore === 0 ? 'text-red-400' : 'text-gray-700'} text-[10px] lg:text-xs">${currentScore.toLocaleString()}</td>
                            <td class="p-2 lg:p-3">
                                <input type="number" 
                                    class="suro-score-input w-full bg-gray-50 border border-gray-100 rounded-lg px-2 lg:px-3 py-1.5 lg:py-2 text-[10px] lg:text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100 focus:border-pink-200 transition-all text-right" 
                                    data-member-id="${m.id}" 
                                    value="${currentScore || ''}" 
                                    placeholder="0" 
                                    min="0" step="1000">
                            </td>
                        </tr>`;
                        return row;
                    }).join('')}
                </tbody>
            </table>`;

            // Tabí‚¤: ì•„ë˜ë¡œ ì´ë™
            container.addEventListener('keydown', (e) => {
                if (e.key !== 'Tab') return;
                const el = document.activeElement;
                if (!el || !el.classList.contains('suro-score-input')) return;
                e.preventDefault();
                const tr = el.closest('tr');
                const nextTr = e.shiftKey ? tr?.previousElementSibling : tr?.nextElementSibling;
                if (nextTr) {
                    const nextInput = nextTr.querySelector('.suro-score-input');
                    if (nextInput) { nextInput.focus(); nextInput.select(); }
                }
            });
        };

        window._suroInputPage = (delta) => {
            window._suroInputState.page += delta;
            window.loadSuroInputTable();
        };

        window.clearSuroInputs = () => {
            document.querySelectorAll('.suro-score-input').forEach(input => { input.value = ''; });
            window.showMsg("ì…ë ¥ê°’ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
        };

        // â”€â”€â”€ ìˆ˜ë¡œ ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ â”€â”€â”€
        window.openSuroPasteModal = () => {
            const currentHeader = document.getElementById('suroInputPeriod')?.value || '';
            const allHeaders = [...appState.suroHeaders];
            const headerOptions = allHeaders.includes(currentHeader) ? allHeaders : [...allHeaders, currentHeader];

            document.getElementById('suroPasteModal')?.remove();
            const modal = document.createElement('div');
            modal.id = 'suroPasteModal';
            modal.className = 'fixed inset-0 z-[2000] flex items-center justify-center bg-black/30 backdrop-blur-sm fade-in font-bold p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden border border-gray-100 max-h-[90vh] flex flex-col">
                    <div class="p-5 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center shrink-0">
                        <div><h3 class="text-base font-bold text-indigo-700 tracking-tight"><i class="fas fa-paste mr-2"></i>ìˆ˜ë¡œ ì ìˆ˜ ë¶™ì—¬ë„£ê¸°</h3>
                        <p class="text-[10px] text-indigo-400 mt-1">ë‹‰ë„¤ì„(íƒ­)ì ìˆ˜ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ê´„í˜¸ ì•ˆ ë‚´ìš©ì€ ë¬´ì‹œë©ë‹ˆë‹¤.</p></div>
                        <button onclick="document.getElementById('suroPasteModal').remove()"><i class="fas fa-times text-gray-400 text-lg"></i></button>
                    </div>
                    <div class="p-5 space-y-4 overflow-y-auto flex-1">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì €ì¥í•  ì£¼ì°¨</label>
                            <select id="suroPastePeriod" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-xs font-bold outline-none shadow-inner">
                                ${headerOptions.map(h => `<option value="${h}" ${h === currentHeader ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë°ì´í„° ë¶™ì—¬ë„£ê¸°</label>
                            <textarea id="suroPasteText" rows="10" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-xs font-mono outline-none shadow-inner resize-none focus:ring-2 focus:ring-indigo-100" placeholder="ë‹‰ë„¤ì„\tì ìˆ˜\nì˜ˆ: ë„ê·œ\t253438\nSumireUesaka\t168137"></textarea>
                        </div>
                        <button onclick="window.parseSuroPaste()" class="w-full py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs hover:bg-indigo-600 transition-all shadow-lg"><i class="fas fa-search mr-1"></i> ë°ì´í„° ë¶„ì„</button>
                        <div id="suroPastePreview"></div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        };

        window.parseSuroPaste = () => {
            const raw = document.getElementById('suroPasteText').value.trim();
            if (!raw) { window.showMsg('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

            const lines = raw.split('\n').filter(l => l.trim());
            const parsed = [];
            const skipped = [];

            lines.forEach((line, i) => {
                // íƒ­ ë˜ëŠ” ì—¬ëŸ¬ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬
                const parts = line.split(/\t+/);
                if (parts.length < 2) {
                    // ê³µë°±ìœ¼ë¡œë„ ì‹œë„ (ë§ˆì§€ë§‰ ìˆ«ì ë¶€ë¶„ ë¶„ë¦¬)
                    const spaceMatch = line.match(/^(.+?)\s+([\d,]+)\s*$/);
                    if (spaceMatch) {
                        parts[0] = spaceMatch[1];
                        parts[1] = spaceMatch[2];
                    } else {
                        skipped.push({ line: i + 1, text: line, reason: 'í˜•ì‹ ì˜¤ë¥˜' });
                        return;
                    }
                }

                // ë‹‰ë„¤ì„: ê´„í˜¸ ì•ˆ ë‚´ìš© ì œê±°
                let name = parts[0].replace(/\([^)]*\)/g, '').trim();
                // ì ìˆ˜: ì½¤ë§ˆ ì œê±° í›„ ìˆ«ì ë³€í™˜
                let scoreStr = parts[1].replace(/,/g, '').trim();
                let score = parseInt(scoreStr);

                if (!name) { skipped.push({ line: i + 1, text: line, reason: 'ë‹‰ë„¤ì„ ì—†ìŒ' }); return; }
                if (isNaN(score)) { skipped.push({ line: i + 1, text: line, reason: 'ì ìˆ˜ ì˜¤ë¥˜' }); return; }

                // DB ë©¤ë²„ ë§¤ì¹­
                const member = appState.members.find(m => m.name === name);
                parsed.push({ name, score, member, originalLine: line });
            });

            const matched = parsed.filter(p => p.member);
            const unmatched = parsed.filter(p => !p.member);
            const period = document.getElementById('suroPastePeriod').value;

            const preview = document.getElementById('suroPastePreview');
            preview.innerHTML = `
                <div class="space-y-3">
                    <div class="flex gap-2 flex-wrap text-[10px]">
                        <span class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-lg border border-emerald-100"><i class="fas fa-check mr-1"></i>ë§¤ì¹­ ${matched.length}ëª…</span>
                        <span class="px-3 py-1 bg-red-50 text-red-500 rounded-lg border border-red-100"><i class="fas fa-times mr-1"></i>ë¯¸ë§¤ì¹­ ${unmatched.length}ëª…</span>
                        ${skipped.length > 0 ? `<span class="px-3 py-1 bg-gray-50 text-gray-400 rounded-lg border border-gray-100"><i class="fas fa-forward mr-1"></i>ê±´ë„ˆëœ€ ${skipped.length}ê±´</span>` : ''}
                    </div>
                    ${matched.length > 0 ? `
                    <div class="bg-gray-50 rounded-xl border border-gray-100 overflow-hidden">
                        <div class="max-h-[200px] overflow-y-auto">
                            <table class="w-full text-[10px]">
                                <thead class="bg-gray-100 sticky top-0"><tr>
                                    <th class="p-2 text-left text-gray-400">ë‹‰ë„¤ì„</th>
                                    <th class="p-2 text-left text-gray-400">ì†Œì†</th>
                                    <th class="p-2 text-right text-gray-400">ì ìˆ˜</th>
                                </tr></thead>
                                <tbody>${matched.map(p => `<tr class="border-t border-gray-100"><td class="p-2 text-gray-700">${p.name}</td><td class="p-2 text-gray-400">${p.member.guild}</td><td class="p-2 text-right text-emerald-600 font-mono">${p.score.toLocaleString()}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>` : ''}
                    ${unmatched.length > 0 ? `
                    <div class="bg-red-50 rounded-xl p-3 border border-red-100 text-[10px] text-red-500">
                        <p class="font-bold mb-1"><i class="fas fa-exclamation-triangle mr-1"></i>DBì— ì—†ëŠ” ë‹‰ë„¤ì„ (ì €ì¥ ì•ˆ ë¨)</p>
                        <p class="text-red-400">${unmatched.map(p => p.name).join(', ')}</p>
                    </div>` : ''}
                    ${skipped.length > 0 ? `
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 text-[10px] text-gray-400">
                        <p class="font-bold mb-1">ê±´ë„ˆë›´ ì¤„</p>
                        ${skipped.map(s => `<p>ì¤„ ${s.line}: ${s.reason} - <span class="font-mono">${s.text.substring(0, 40)}</span></p>`).join('')}
                    </div>` : ''}
                    ${matched.length > 0 ? `
                    <button onclick="window.saveSuroPaste()" class="w-full py-3.5 bg-emerald-500 text-white rounded-xl font-bold text-xs hover:bg-emerald-600 transition-all shadow-lg">
                        <i class="fas fa-save mr-1"></i> "${period}" ì£¼ì°¨ì— ${matched.length}ëª… ì ìˆ˜ ì €ì¥
                    </button>` : ''}
                </div>`;

            // íŒŒì‹± ê²°ê³¼ ì„ì‹œ ì €ì¥
            window._suroParsed = matched;
        };

        window.saveSuroPaste = async () => {
            const matched = window._suroParsed;
            if (!matched || matched.length === 0) return;

            const periodLabel = document.getElementById('suroPastePeriod').value;
            if (!confirm(`"${periodLabel}" ì£¼ì°¨ì— ${matched.length}ëª…ì˜ ì ìˆ˜ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            window.showLoading(true);
            window.setLoadProgress(10, 'ì£¼ì°¨ í™•ì¸ ì¤‘...');
            try {
                // ì£¼ì°¨ í™•ì¸/ìƒì„±
                let { data: period } = await supaDb.from('suro_periods').select('id').eq('period_label', periodLabel).maybeSingle();
                if (!period) {
                    const match = periodLabel.match(/(\d{2})-(\d{2})-(\d{2})\(.\)\s*~\s*(\d{2})-(\d{2})-(\d{2})/);
                    const startDate = match ? `20${match[1]}-${match[2]}-${match[3]}` : new Date().toISOString().split('T')[0];
                    const endDate = match ? `20${match[4]}-${match[5]}-${match[6]}` : new Date().toISOString().split('T')[0];
                    const { data: newPeriod, error: pErr } = await supaDb.from('suro_periods')
                        .insert({ period_label: periodLabel, start_date: startDate, end_date: endDate }).select().single();
                    if (pErr) throw pErr;
                    period = newPeriod;
                }

                window.setLoadProgress(30, 'ì ìˆ˜ ì €ì¥ ì¤‘...');
                const upsertRows = matched.map(p => ({
                    member_id: p.member.id,
                    period_id: period.id,
                    score: p.score
                }));

                const { error: uErr } = await supaDb.from('suro_scores')
                    .upsert(upsertRows, { onConflict: 'member_id,period_id' });
                if (uErr) throw uErr;

                window.setLoadProgress(80, 'ë°ì´í„° ê°±ì‹  ì¤‘...');
                window.showLoading(false);
                window.showMsg(`${matched.length}ëª…ì˜ ìˆ˜ë¡œ ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                document.getElementById('suroPasteModal')?.remove();
                await window.fetchMembers();
                window.loadSuroInputTable();
            } catch(e) {
                window.showLoading(false);
                window.showMsg('ì €ì¥ ì‹¤íŒ¨: ' + (e.message || e), 'error');
            }
        };

        window.saveSuroScores = async () => {
            const periodLabel = document.getElementById('suroInputPeriod').value;
            const inputs = document.querySelectorAll('.suro-score-input');
            if (!confirm(`"${periodLabel}" ì£¼ì°¨ì˜ ${inputs.length}ëª… ì ìˆ˜ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            window.showLoading(true);
            window.setLoadProgress(10, 'ìˆ˜ë¡œ ì ìˆ˜ ì €ì¥ ì¤€ë¹„...');
            try {
                // í•´ë‹¹ ì£¼ì°¨ê°€ DBì— ìˆëŠ”ì§€ í™•ì¸, ì—†ìœ¼ë©´ ìƒì„±
                let { data: period } = await supaDb.from('suro_periods').select('id').eq('period_label', periodLabel).maybeSingle();
                if (!period) {
                    const match = periodLabel.match(/(\d{2})-(\d{2})-(\d{2})\(.\)\s*~\s*(\d{2})-(\d{2})-(\d{2})/);
                    const startDate = match ? `20${match[1]}-${match[2]}-${match[3]}` : new Date().toISOString().split('T')[0];
                    const endDate = match ? `20${match[4]}-${match[5]}-${match[6]}` : new Date().toISOString().split('T')[0];
                    const { data: newPeriod, error: pErr } = await supaDb.from('suro_periods')
                        .insert({ period_label: periodLabel, start_date: startDate, end_date: endDate }).select().single();
                    if (pErr) throw pErr;
                    period = newPeriod;
                }

                window.setLoadProgress(30, 'ì ìˆ˜ ë°ì´í„° ì „ì†¡ ì¤‘...');
                const upsertRows = [];
                inputs.forEach(input => {
                    const memberId = parseInt(input.dataset.memberId);
                    const score = parseInt(input.value) || 0;
                    upsertRows.push({ member_id: memberId, period_id: period.id, score: score });
                });

                const { error: uErr } = await supaDb.from('suro_scores')
                    .upsert(upsertRows, { onConflict: 'member_id,period_id' });
                if (uErr) throw uErr;

                window.setLoadProgress(80, 'ë°ì´í„° ê°±ì‹  ì¤‘...');
                window.showLoading(false);
                window.showMsg(`${upsertRows.length}ëª…ì˜ ìˆ˜ë¡œ ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                await window.fetchMembers();
            } catch (e) {
                console.error('ìˆ˜ë¡œ ì ìˆ˜ ì €ì¥ ì—ëŸ¬:', e);
                window.showLoading(false);
                window.showMsg('ì €ì¥ ì‹¤íŒ¨: ' + (e.message || e), 'error');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  ê¸¸ë“œì› ë™ê¸°í™” (Nexon Open API)  â–ˆâ–ˆ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â• nexonAPI (from admin, lines 4638-5284) â•â•â•

        const NEXON_API_BASE = 'https://open.api.nexon.com';
        const MAPLE_WORLDS = ['ìŠ¤ì¹´ë‹ˆì•„','ë² ë¼','ë£¨ë‚˜','ì œë‹ˆìŠ¤','í¬ë¡œì•„','ìœ ë‹ˆì˜¨','ì—˜ë¦¬ì‹œì›€','ì´ë…¸ì‹œìŠ¤','ë ˆë“œ','ì˜¤ë¡œë¼','ì•„ì¼€ì¸','ë…¸ë°”','ë¦¬ë¶€íŠ¸','ë¦¬ë¶€íŠ¸2'];

        window._getNexonApiKey = () => localStorage.getItem('nexon_api_key') || '';
        window._setNexonApiKey = (key) => localStorage.setItem('nexon_api_key', key.trim());
        window._getSyncWorld = () => localStorage.getItem('sync_world') || 'ë£¨ë‚˜';
        window._setSyncWorld = (w) => localStorage.setItem('sync_world', w);

        // Nexon API í˜¸ì¶œ í—¬í¼
        window._nexonFetch = async (endpoint, params = {}) => {
            const apiKey = window._getNexonApiKey();
            if (!apiKey) throw new Error('Nexon API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            const qs = new URLSearchParams(params).toString();
            const url = `${NEXON_API_BASE}${endpoint}${qs ? '?' + qs : ''}`;
            const res = await fetch(url, { headers: { 'x-nxopen-api-key': apiKey } });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error?.message || `API ì˜¤ë¥˜ (${res.status})`);
            }
            return res.json();
        };

        // ê¸¸ë“œ oguild_id ì¡°íšŒ
        window._getGuildId = async (guildName, worldName) => {
            const data = await window._nexonFetch('/maplestory/v1/guild/id', {
                guild_name: guildName, world_name: worldName
            });
            return data.oguild_id;
        };

        // ê¸¸ë“œ ê¸°ë³¸ ì •ë³´ (ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ í¬í•¨) ì¡°íšŒ
        window._getGuildBasic = async (oguildId) => {
            const data = await window._nexonFetch('/maplestory/v1/guild/basic', {
                oguild_id: oguildId
            });
            return data;
        };

        // ìºë¦­í„° OCID ì¡°íšŒ
        window._getCharOcid = async (characterName) => {
            const data = await window._nexonFetch('/maplestory/v1/id', {
                character_name: characterName
            });
            return data.ocid;
        };

        // ìºë¦­í„° ê¸°ë³¸ ì •ë³´ (ì§ì—…, ë ˆë²¨ ë“±) ì¡°íšŒ
        window._getCharBasic = async (ocid) => {
            const data = await window._nexonFetch('/maplestory/v1/character/basic', {
                ocid: ocid
            });
            return data;
        };

        // ë‹‰ë„¤ì„ìœ¼ë¡œ ì§ì—…/ë ˆë²¨ í•œë²ˆì— ì¡°íšŒ
        window._getCharInfo = async (characterName) => {
            try {
                const ocid = await window._getCharOcid(characterName);
                const basic = await window._getCharBasic(ocid);
                return {
                    name: basic.character_name || characterName,
                    class: basic.character_class || '',
                    level: basic.character_level || 0,
                    guild: basic.character_guild_name || '',
                    world: basic.world_name || '',
                    image: basic.character_image || ''
                };
            } catch (e) {
                return null;
            }
        };

        // ë™ê¸°í™” ë©”ì¸ ë¡œì§
        window._runSync = async () => {
            const apiKey = window._getNexonApiKey();
            if (!apiKey) { window.showMsg('Nexon API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            
            const worldName = window._getSyncWorld();
            const resultDiv = document.getElementById('syncResult');
            const btn = document.getElementById('syncRunBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë™ê¸°í™” ì¤‘...'; }
            resultDiv.innerHTML = '<div class="text-center py-12 text-gray-400 font-bold"><i class="fas fa-spinner fa-spin text-2xl mb-3"></i><p class="text-xs">Nexon APIì—ì„œ ê¸¸ë“œì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

            try {
                const allApiMembers = {}; // { guildName: [memberName, ...] }
                const errors = [];

                for (const g of appState.guilds) {
                    try {
                        const oguildId = await window._getGuildId(g.name, worldName);
                        const basic = await window._getGuildBasic(oguildId);
                        allApiMembers[g.name] = basic.guild_member || [];
                    } catch (e) {
                        errors.push(`${g.name}: ${e.message}`);
                        allApiMembers[g.name] = null; // ì¡°íšŒ ì‹¤íŒ¨
                    }
                }

                // DB ë©¤ë²„ì™€ ë¹„êµ
                const dbMembers = appState.members; // [{name, guild, ...}]
                const dbNameSet = new Set(dbMembers.map(m => m.name));
                const dbByGuild = {};
                dbMembers.forEach(m => {
                    if (!dbByGuild[m.guild]) dbByGuild[m.guild] = new Set();
                    dbByGuild[m.guild].add(m.name);
                });

                // ëª¨ë“  API ë©¤ë²„ë¥¼ í•˜ë‚˜ì˜ Setìœ¼ë¡œ
                const allApiNameSet = new Set();
                Object.values(allApiMembers).forEach(arr => {
                    if (arr) arr.forEach(name => allApiNameSet.add(name));
                });

                // ì‹ ê·œ ë©¤ë²„: APIì— ìˆê³  DBì— ì—†ëŠ” ì‚¬ëŒ
                const newMembers = []; // [{name, guild}]
                for (const [gName, members] of Object.entries(allApiMembers)) {
                    if (!members) continue;
                    members.forEach(name => {
                        if (!dbNameSet.has(name)) {
                            newMembers.push({ name, guild: gName });
                        }
                    });
                }

                // íƒˆí‡´ ì˜ì‹¬ ë©¤ë²„: DBì— ìˆê³  ì–´ë–¤ API ê¸¸ë“œì—ë„ ì—†ëŠ” ì‚¬ëŒ
                const goneMembers = []; // [{name, guild, id}]
                dbMembers.forEach(m => {
                    // í•´ë‹¹ ê¸¸ë“œì˜ API ì¡°íšŒê°€ ì„±ê³µí–ˆëŠ”ë° ê·¸ ê¸¸ë“œ ë©¤ë²„ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°
                    const apiList = allApiMembers[m.guild];
                    if (apiList && !apiList.includes(m.name)) {
                        // ë‹¤ë¥¸ ê¸¸ë“œì—ë„ ì—†ëŠ”ì§€ í™•ì¸
                        if (!allApiNameSet.has(m.name)) {
                            goneMembers.push({ name: m.name, guild: m.guild, id: m.id });
                        }
                    }
                });

                // ê¸¸ë“œ ì´ë™ ë©¤ë²„: DBì—ì„œ Aê¸¸ë“œì¸ë° APIì—ì„œ Bê¸¸ë“œì— ìˆëŠ” ê²½ìš°
                const movedMembers = [];
                dbMembers.forEach(m => {
                    for (const [gName, members] of Object.entries(allApiMembers)) {
                        if (!members) continue;
                        if (gName !== m.guild && members.includes(m.name)) {
                            movedMembers.push({ name: m.name, fromGuild: m.guild, toGuild: gName, id: m.id });
                        }
                    }
                });

                // ë‹‰ë³€ ì˜ì‹¬ ê°ì§€: íƒˆí‡´ ë©¤ë²„ + ì‹ ê·œ ë©¤ë²„ë¥¼ API ì§ì—…/ê¸¸ë“œë¡œ ë§¤ì¹­
                const nickChangeSuspects = []; // [{oldName, newName, guild, id, class}]
                if (goneMembers.length > 0 && newMembers.length > 0) {
                    // ì‹ ê·œ ë©¤ë²„ ì§ì—…/ë ˆë²¨ì„ APIì—ì„œ ì¡°íšŒ
                    const newMemberInfos = [];
                    for (const nm of newMembers) {
                        try {
                            const info = await window._getCharInfo(nm.name);
                            newMemberInfos.push({ ...nm, apiClass: info?.class || '', apiLevel: info?.level || 0 });
                        } catch(e) {
                            newMemberInfos.push({ ...nm, apiClass: '', apiLevel: 0 });
                        }
                        await new Promise(r => setTimeout(r, 80));
                    }
                    // íƒˆí‡´ ë©¤ë²„ì˜ DB ì§ì—…ê³¼ ì‹ ê·œ ë©¤ë²„ API ì§ì—… ë§¤ì¹­
                    const usedGone = new Set();
                    const usedNew = new Set();
                    for (const gm of goneMembers) {
                        const dbInfo = dbMembers.find(d => d.id === gm.id);
                        if (!dbInfo || !dbInfo.class) continue;
                        for (let ni = 0; ni < newMemberInfos.length; ni++) {
                            if (usedNew.has(ni)) continue;
                            const nm = newMemberInfos[ni];
                            // ê°™ì€ ê¸¸ë“œ + ê°™ì€ ì§ì—… â†’ ë‹‰ë³€ ì˜ì‹¬
                            if (nm.guild === gm.guild && nm.apiClass && nm.apiClass === dbInfo.class) {
                                nickChangeSuspects.push({
                                    oldName: gm.name, newName: nm.name, guild: gm.guild,
                                    id: gm.id, class: dbInfo.class, level: nm.apiLevel
                                });
                                usedGone.add(gm.id);
                                usedNew.add(ni);
                                break;
                            }
                        }
                    }
                    // ë‹‰ë³€ í™•ì •ëœ í•­ëª©ì€ ì‹ ê·œ/íƒˆí‡´ ëª©ë¡ì—ì„œ ì œê±°
                    if (nickChangeSuspects.length > 0) {
                        const goneIds = new Set(nickChangeSuspects.map(s => s.id));
                        const newNames = new Set(nickChangeSuspects.map(s => s.newName));
                        goneMembers.splice(0, goneMembers.length, ...goneMembers.filter(g => !goneIds.has(g.id)));
                        newMembers.splice(0, newMembers.length, ...newMembers.filter(n => !newNames.has(n.name)));
                    }
                }

                // ê²°ê³¼ ë Œë”ë§
                let html = '';

                // ì—ëŸ¬ í‘œì‹œ
                if (errors.length > 0) {
                    html += `<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-4">
                        <p class="text-xs font-bold text-amber-600 mb-2"><i class="fas fa-exclamation-triangle mr-1"></i>ì¼ë¶€ ê¸¸ë“œ ì¡°íšŒ ì‹¤íŒ¨</p>
                        ${errors.map(e => `<p class="text-[10px] text-amber-500">${e}</p>`).join('')}
                    </div>`;
                }

                // ìš”ì•½
                const successGuilds = Object.entries(allApiMembers).filter(([,v]) => v !== null);
                const totalApiCount = successGuilds.reduce((sum, [,arr]) => sum + arr.length, 0);
                html += `<div class="bg-white rounded-2xl border border-gray-100 p-5 mb-4 shadow-sm">
                    <h4 class="text-sm font-bold text-gray-700 mb-3"><i class="fas fa-chart-pie text-pink-400 mr-2"></i>ë™ê¸°í™” ìš”ì•½</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 text-center">
                        <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                            <p class="text-lg font-bold text-blue-600">${totalApiCount}</p>
                            <p class="text-[9px] text-blue-400 font-bold">API ê¸¸ë“œì› ìˆ˜</p>
                        </div>
                        <div class="bg-green-50 rounded-xl p-3 border border-green-100">
                            <p class="text-lg font-bold text-green-600">${newMembers.length}</p>
                            <p class="text-[9px] text-green-400 font-bold">ì‹ ê·œ ë©¤ë²„</p>
                        </div>
                        <div class="bg-red-50 rounded-xl p-3 border border-red-100">
                            <p class="text-lg font-bold text-red-600">${goneMembers.length}</p>
                            <p class="text-[9px] text-red-400 font-bold">íƒˆí‡´ ì˜ì‹¬</p>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-3 border border-purple-100">
                            <p class="text-lg font-bold text-purple-600">${movedMembers.length}</p>
                            <p class="text-[9px] text-purple-400 font-bold">ê¸¸ë“œ ì´ë™</p>
                        </div>
                        <div class="bg-cyan-50 rounded-xl p-3 border border-cyan-100">
                            <p class="text-lg font-bold text-cyan-600">${nickChangeSuspects.length}</p>
                            <p class="text-[9px] text-cyan-400 font-bold">ë‹‰ë³€ ì˜ì‹¬</p>
                        </div>
                    </div>
                </div>`;

                // ê¸¸ë“œë³„ API ë©¤ë²„ ìˆ˜
                html += `<div class="bg-white rounded-2xl border border-gray-100 p-5 mb-4 shadow-sm">
                    <h4 class="text-sm font-bold text-gray-700 mb-3"><i class="fas fa-users text-pink-400 mr-2"></i>ê¸¸ë“œë³„ í˜„í™©</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                        ${successGuilds.map(([gn, arr]) => {
                            const dbCount = (dbByGuild[gn] || new Set()).size;
                            return `<div class="bg-gray-50 rounded-xl px-3 py-2 border border-gray-100 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-700">${gn}</span>
                                <span class="text-[10px] font-bold text-gray-400">API ${arr.length}ëª… / DB ${dbCount}ëª…</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;

                // ë‹‰ë³€ ì˜ì‹¬ ì„¹ì…˜
                if (nickChangeSuspects.length > 0) {
                    html += `<div class="bg-white rounded-2xl border border-cyan-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-cyan-600 mb-1"><i class="fas fa-user-edit mr-2"></i>ë‹‰ë„¤ì„ ë³€ê²½ ì˜ì‹¬ (${nickChangeSuspects.length}ëª…)</h4>
                        <p class="text-[10px] text-gray-400 mb-4">íƒˆí‡´ ë©¤ë²„ì™€ ì‹ ê·œ ë©¤ë²„ì˜ ì§ì—…Â·ê¸¸ë“œê°€ ì¼ì¹˜í•˜ì—¬ ë‹‰ë³€ìœ¼ë¡œ ì¶”ì •ë©ë‹ˆë‹¤. í™•ì¸ í›„ ë‹‰ë„¤ì„ì„ ë³€ê²½í•˜ë©´ ìˆ˜ë¡œ ë°ì´í„°ê°€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                        <th class="p-2 w-8 text-center"><input type="checkbox" checked onchange="document.querySelectorAll('.nc-check').forEach(c=>c.checked=this.checked)"></th>
                                        <th class="p-2 text-left">ê¸°ì¡´ ë‹‰ë„¤ì„</th>
                                        <th class="p-2 text-center">â†’</th>
                                        <th class="p-2 text-left">ìƒˆ ë‹‰ë„¤ì„</th>
                                        <th class="p-2 text-left">ì†Œì†</th>
                                        <th class="p-2 text-left">ì§ì—…</th>
                                        <th class="p-2 text-center">ë ˆë²¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${nickChangeSuspects.map((s, i) => `<tr class="border-b border-gray-50 hover:bg-cyan-50/30 transition-colors">
                                        <td class="p-1.5 text-center"><input type="checkbox" class="nc-check w-4 h-4" data-idx="${i}" checked></td>
                                        <td class="p-1.5"><span class="text-red-500 line-through font-bold">${s.oldName}</span></td>
                                        <td class="p-1.5 text-center text-gray-300"><i class="fas fa-arrow-right"></i></td>
                                        <td class="p-1.5"><span class="text-cyan-600 font-bold">${s.newName}</span></td>
                                        <td class="p-1.5 text-gray-500">${s.guild}</td>
                                        <td class="p-1.5 text-gray-500">${s.class}</td>
                                        <td class="p-1.5 text-center text-gray-500">${s.level || '-'}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="window._applyNickChanges()" id="ncApplyBtn" class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-cyan-600 transition-all">
                                <i class="fas fa-user-edit mr-2"></i>ì„ íƒí•œ ë‹‰ë„¤ì„ ë³€ê²½ ì ìš©
                            </button>
                        </div>
                    </div>`;
                    window._nickChangeSuspects = nickChangeSuspects;
                }

                // ì‹ ê·œ ë©¤ë²„ ì¶”ê°€ ì„¹ì…˜ - ìƒì„¸ ì •ë³´ ì…ë ¥ í…Œì´ë¸”
                if (newMembers.length > 0) {
                    const guilds = appState.guilds.map(g => g.name);
                    html += `<div class="bg-white rounded-2xl border border-green-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-green-600 mb-1"><i class="fas fa-user-plus mr-2"></i>ì‹ ê·œ ë©¤ë²„ ë°œê²¬ (${newMembers.length}ëª…)</h4>
                        <p class="text-[10px] text-gray-400 mb-2">APIì— ì¡´ì¬í•˜ì§€ë§Œ DBì— ë“±ë¡ë˜ì§€ ì•Šì€ ë©¤ë²„ì…ë‹ˆë‹¤. ì •ë³´ë¥¼ ì…ë ¥ í›„ ì¼ê´„ ì¶”ê°€í•˜ì„¸ìš”.</p>
                        <div class="mb-3">
                            <button onclick="window._syncFetchAllCharInfo()" id="syncFetchInfoBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-bold text-[10px] shadow-sm hover:bg-indigo-600 transition-all">
                                <i class="fas fa-download mr-1"></i>APIì—ì„œ ì§ì—…/ë ˆë²¨ ì¼ê´„ ì¡°íšŒ
                            </button>
                            <span id="syncFetchProgress" class="text-[10px] text-gray-400 ml-2"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs" id="syncNewTable">
                                <thead>
                                    <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                        <th class="p-2 w-8 text-center"><input type="checkbox" id="syncNewSelectAll" class="custom-checkbox" checked onchange="document.querySelectorAll('.sync-new-check').forEach(c=>c.checked=this.checked)"></th>
                                        <th class="p-2 text-left" style="min-width:100px">ë‹‰ë„¤ì„</th>
                                        <th class="p-2 text-left" style="min-width:90px">ì†Œì†</th>
                                        <th class="p-2 text-left" style="min-width:90px">ì§ìœ„</th>
                                        <th class="p-2 text-left" style="min-width:100px">ì§ì—…</th>
                                        <th class="p-2 text-center" style="min-width:60px">ë ˆë²¨</th>
                                        <th class="p-2 text-center" style="min-width:50px">ë³¸ìº</th>
                                        <th class="p-2 text-left" style="min-width:100px">ë³¸ìºë‹‰</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${newMembers.map((m, i) => {
                                        const guildRoles = initialGuildRanks[m.guild] || initialGuildRanks[guilds[0]] || [];
                                        return `<tr class="border-b border-gray-50 hover:bg-green-50/30 transition-colors" id="syncNewRow_${i}">
                                            <td class="p-1 text-center"><input type="checkbox" class="sync-new-check custom-checkbox" data-idx="${i}" checked></td>
                                            <td class="p-1"><div class="bg-green-50 border border-green-200 rounded-lg px-2 py-1.5 text-xs font-bold text-green-700">${m.name}</div></td>
                                            <td class="p-1">
                                                <select class="sync-new-guild w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" data-idx="${i}" onchange="window._syncNewGuildChange(this)">
                                                    ${guilds.map(g => `<option value="${g}" ${g === m.guild ? 'selected' : ''}>${g}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="sync-new-role w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" id="syncNewRole_${i}">
                                                    ${guildRoles.map(r => `<option value="${r}">${r}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="sync-new-class w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" id="syncNewClass_${i}">
                                                    <option value="">-</option>
                                                    ${MAPLE_JOBS.map(j => `<option value="${j}">${j}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <input type="number" class="sync-new-level w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none text-center" id="syncNewLevel_${i}" value="0" min="0" max="300">
                                            </td>
                                            <td class="p-1 text-center">
                                                <input type="checkbox" class="sync-new-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" checked onchange="window._syncNewMainToggle(${i}, this.checked)">
                                            </td>
                                            <td class="p-1">
                                                <input type="text" class="sync-new-mainChar w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none hidden" id="syncNewMainChar_${i}" placeholder="ë³¸ìºë‹‰">
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="window._syncAddNew()" id="syncAddBtn" class="px-6 py-3 bg-green-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-user-plus mr-2"></i>ì„ íƒí•œ ë©¤ë²„ DBì— ì¶”ê°€
                            </button>
                        </div>
                    </div>`;
                    window._syncNewMembers = newMembers;
                }

                // íƒˆí‡´ ì˜ì‹¬ ë©¤ë²„ ì‚­ì œ ì„¹ì…˜ - ìƒì„¸ ì •ë³´ í‘œì‹œ
                if (goneMembers.length > 0) {
                    html += `<div class="bg-white rounded-2xl border border-red-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-red-600 mb-1"><i class="fas fa-user-minus mr-2"></i>íƒˆí‡´ ì˜ì‹¬ ë©¤ë²„ (${goneMembers.length}ëª…)</h4>
                        <p class="text-[10px] text-gray-400 mb-4">DBì— ë“±ë¡ë˜ì–´ ìˆì§€ë§Œ ì–´ë–¤ ê¸¸ë“œì—ì„œë„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ë©¤ë²„ì…ë‹ˆë‹¤. í™•ì¸ í›„ ì‚­ì œí•˜ì„¸ìš”.</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="syncGoneSelectAll" class="custom-checkbox" checked onchange="document.querySelectorAll('.sync-gone-check').forEach(c=>c.checked=this.checked)">
                            <label for="syncGoneSelectAll" class="text-[10px] font-bold text-gray-500 cursor-pointer">ì „ì²´ ì„ íƒ</label>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                        <th class="p-2 w-8 text-center">âœ“</th>
                                        <th class="p-2 text-left">ë‹‰ë„¤ì„</th>
                                        <th class="p-2 text-left">ì†Œì†</th>
                                        <th class="p-2 text-left">ì§ìœ„</th>
                                        <th class="p-2 text-left">ì§ì—…</th>
                                        <th class="p-2 text-center">ë³¸ìº</th>
                                        <th class="p-2 text-left">ë³¸ìºë‹‰</th>
                                        <th class="p-2 text-left">ê°€ì…ì¼</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${goneMembers.map((m, i) => {
                                        const dbInfo = dbMembers.find(d => d.id === m.id) || {};
                                        return `<tr class="border-b border-gray-50 hover:bg-red-50/30 transition-colors">
                                            <td class="p-1 text-center"><input type="checkbox" class="sync-gone-check custom-checkbox" data-idx="${i}" checked></td>
                                            <td class="p-1"><span class="text-xs font-bold text-red-600">${m.name}</span></td>
                                            <td class="p-1"><span class="text-[10px] font-bold text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">${m.guild}</span></td>
                                            <td class="p-1"><span class="text-[10px] font-bold text-gray-500">${dbInfo.role || '-'}</span></td>
                                            <td class="p-1"><span class="text-[10px] font-bold text-gray-500">${dbInfo.class || '-'}</span></td>
                                            <td class="p-1 text-center"><span class="text-[10px] text-gray-400">${dbInfo.isMain !== false ? 'âœ…' : 'âŒ'}</span></td>
                                            <td class="p-1"><span class="text-[10px] text-gray-400">${dbInfo.mainCharName || '-'}</span></td>
                                            <td class="p-1"><span class="text-[10px] text-gray-400">${dbInfo.joinDate || '-'}</span></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="window._syncRemoveGone()" id="syncRemoveBtn" class="px-6 py-3 bg-red-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-red-600 transition-all">
                                <i class="fas fa-user-minus mr-2"></i>ì„ íƒí•œ ë©¤ë²„ DBì—ì„œ ì‚­ì œ
                            </button>
                        </div>
                    </div>`;
                    window._syncGoneMembers = goneMembers;
                }

                // ê¸¸ë“œ ì´ë™ ë©¤ë²„
                if (movedMembers.length > 0) {
                    html += `<div class="bg-white rounded-2xl border border-purple-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-purple-600 mb-1"><i class="fas fa-exchange-alt mr-2"></i>ê¸¸ë“œ ì´ë™ ê°ì§€ (${movedMembers.length}ëª…)</h4>
                        <p class="text-[10px] text-gray-400 mb-4">DBì˜ ì†Œì† ê¸¸ë“œì™€ APIì˜ ì‹¤ì œ ê¸¸ë“œê°€ ë‹¤ë¥¸ ë©¤ë²„ì…ë‹ˆë‹¤.</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="syncMovedSelectAll" class="custom-checkbox" onchange="document.querySelectorAll('.sync-moved-check').forEach(c=>c.checked=this.checked)">
                            <label for="syncMovedSelectAll" class="text-[10px] font-bold text-gray-500 cursor-pointer">ì „ì²´ ì„ íƒ</label>
                        </div>
                        <div class="max-h-64 overflow-y-auto space-y-1 mb-4 no-scrollbar">
                            ${movedMembers.map((m, i) => `<label class="flex items-center gap-3 bg-purple-50/50 hover:bg-purple-50 rounded-xl px-3 py-2 border border-purple-100/50 cursor-pointer transition-all">
                                <input type="checkbox" class="sync-moved-check custom-checkbox" data-idx="${i}" checked>
                                <span class="text-xs font-bold text-gray-700 flex-1">${m.name}</span>
                                <span class="text-[9px] font-bold text-gray-400">${m.fromGuild}</span>
                                <i class="fas fa-arrow-right text-[8px] text-purple-400"></i>
                                <span class="text-[9px] font-bold text-purple-600">${m.toGuild}</span>
                            </label>`).join('')}
                        </div>
                        <button onclick="window._syncUpdateMoved()" id="syncMoveBtn" class="w-full py-3 bg-purple-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-purple-600 transition-all">
                            <i class="fas fa-exchange-alt mr-2"></i>ì„ íƒí•œ ë©¤ë²„ ì†Œì† ë³€ê²½
                        </button>
                    </div>`;
                    window._syncMovedMembers = movedMembers;
                }

                // ëª¨ë‘ ì¼ì¹˜
                if (newMembers.length === 0 && goneMembers.length === 0 && movedMembers.length === 0 && errors.length === 0) {
                    html += `<div class="bg-green-50 border border-green-200 rounded-2xl p-8 text-center">
                        <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-check text-green-500 text-xl"></i></div>
                        <p class="text-sm font-bold text-green-600">ëª¨ë“  ê¸¸ë“œì›ì´ DBì™€ ì¼ì¹˜í•©ë‹ˆë‹¤!</p>
                        <p class="text-[10px] text-green-400 mt-1">ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>`;
                }

                resultDiv.innerHTML = html;

            } catch (e) {
                resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                    <div class="w-14 h-14 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-times text-red-500 text-xl"></i></div>
                    <p class="text-sm font-bold text-red-600 mb-2">ë™ê¸°í™” ì‹¤íŒ¨</p>
                    <p class="text-xs text-red-400">${e.message}</p>
                </div>`;
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync mr-2"></i>ë™ê¸°í™” ì‹¤í–‰'; }
            }
        };

        // ì‹ ê·œ ë©¤ë²„ í…Œì´ë¸” í—¬í¼
        window._syncNewGuildChange = (sel) => {
            const idx = sel.dataset.idx;
            const roles = initialGuildRanks[sel.value] || [];
            const roleEl = document.getElementById(`syncNewRole_${idx}`);
            if (roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };
        window._syncNewMainToggle = (idx, isMain) => {
            const el = document.getElementById(`syncNewMainChar_${idx}`);
            if (el) { isMain ? el.classList.add('hidden') : el.classList.remove('hidden'); }
        };

        // ë‹‰ë³€ ì ìš©
        window._applyNickChanges = async () => {
            const checks = document.querySelectorAll('.nc-check:checked');
            if (checks.length === 0) { window.showMsg('ì ìš©í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            const selected = [];
            checks.forEach(c => selected.push(window._nickChangeSuspects[parseInt(c.dataset.idx)]));
            const lines = selected.map(s => `â€¢ ${s.oldName} â†’ ${s.newName} (${s.guild}/${s.class})`);
            if (!confirm(`ë‹‰ë„¤ì„ ë³€ê²½ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ìˆ˜ë¡œ ë°ì´í„°ê°€ ëª¨ë‘ ìœ ì§€ë©ë‹ˆë‹¤.\n\n${lines.join('\n')}`)) return;
            const btn = document.getElementById('ncApplyBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì ìš© ì¤‘...';
            try {
                let ok = 0;
                for (const s of selected) {
                    const updateObj = { name: s.newName };
                    if (s.level) updateObj.level = s.level;
                    const { error } = await supaDb.from('members').update(updateObj).eq('id', s.id);
                    if (!error) {
                        ok++;
                        await supaDb.from('operation_history').insert({
                            date: new Date().toISOString().split('T')[0], category: 'ë‹‰ë³€',
                            name: s.newName, content: `ë‹‰ë„¤ì„ ë³€ê²½: ${s.oldName} â†’ ${s.newName} (${s.guild}/${s.class}) â€” ë™ê¸°í™” ê°ì§€`
                        });
                    }
                }
                window.showMsg(`${ok}ëª…ì˜ ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch(e) {
                window.showMsg('ë‹‰ë³€ ì ìš© ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-edit mr-2"></i>ì„ íƒí•œ ë‹‰ë„¤ì„ ë³€ê²½ ì ìš©';
            }
        };

        // ì‹ ê·œ ë©¤ë²„ APIì—ì„œ ì§ì—…/ë ˆë²¨ ì¼ê´„ ì¡°íšŒ
        window._syncFetchAllCharInfo = async () => {
            const btn = document.getElementById('syncFetchInfoBtn');
            const prog = document.getElementById('syncFetchProgress');
            if (!window._syncNewMembers || window._syncNewMembers.length === 0) return;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì¡°íšŒ ì¤‘...';
            const total = window._syncNewMembers.length;
            let done = 0, fail = 0;
            for (let i = 0; i < total; i++) {
                const m = window._syncNewMembers[i];
                prog.textContent = `${i+1}/${total} ì¡°íšŒ ì¤‘...`;
                try {
                    const info = await window._getCharInfo(m.name);
                    if (info) {
                        const clsSel = document.getElementById(`syncNewClass_${i}`);
                        const lvlInput = document.getElementById(`syncNewLevel_${i}`);
                        if (clsSel && info.class) {
                            let found = false;
                            for (const opt of clsSel.options) { if (opt.value === info.class) { opt.selected = true; found = true; break; } }
                            if (!found) { const newOpt = document.createElement('option'); newOpt.value = info.class; newOpt.textContent = info.class; newOpt.selected = true; clsSel.appendChild(newOpt); }
                        }
                        if (lvlInput && info.level) lvlInput.value = info.level;
                        const row = document.getElementById(`syncNewRow_${i}`);
                        if (row) row.classList.add('bg-green-50/50');
                    } else { fail++; }
                } catch(e) { fail++; }
                // Rate limit ë°©ì§€: 100ms ë”œë ˆì´
                if (i < total - 1) await new Promise(r => setTimeout(r, 100));
            }
            done = total - fail;
            prog.textContent = `ì™„ë£Œ! ${done}ëª… ì„±ê³µ, ${fail}ëª… ì‹¤íŒ¨`;
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-download mr-1"></i>APIì—ì„œ ì§ì—…/ë ˆë²¨ ì¼ê´„ ì¡°íšŒ';
        };

        // ì‹ ê·œ ë©¤ë²„ ì¶”ê°€ (ìƒì„¸ ì •ë³´ í¬í•¨)
        window._syncAddNew = async () => {
            const rows = document.querySelectorAll('#syncNewTable tbody tr');
            const toAdd = [];
            rows.forEach(row => {
                const check = row.querySelector('.sync-new-check');
                if (!check || !check.checked) return;
                const idx = parseInt(check.dataset.idx);
                const m = window._syncNewMembers[idx];
                const guild = row.querySelector('.sync-new-guild')?.value || m.guild;
                const role = row.querySelector('.sync-new-role')?.value || 'ê¸¸ë“œì›';
                const cls = row.querySelector('.sync-new-class')?.value || '';
                const lvl = parseInt(row.querySelector('.sync-new-level')?.value) || 0;
                const isMain = row.querySelector('.sync-new-isMain')?.checked !== false;
                const mainChar = row.querySelector('.sync-new-mainChar')?.value || '';
                toAdd.push({ name: m.name, guild, role, class: cls, level: lvl, is_main: isMain, main_char_name: mainChar, join_date: new Date().toISOString().split('T')[0] });
            });

            if (toAdd.length === 0) { window.showMsg('ì¶”ê°€í•  ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            const btn = document.getElementById('syncAddBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì¶”ê°€ ì¤‘...';
            
            try {
                const { error } = await supaDb.from('members').insert(toAdd);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    toAdd.map(m => ({ date: new Date().toISOString().split('T')[0], category: 'ë™ê¸°í™”-ì¶”ê°€', name: m.name, content: `${m.guild} ê¸¸ë“œì— ì¶”ê°€ë¨ (${m.role}/${m.class || 'ë¯¸ì„¤ì •'}) â€” API ë™ê¸°í™”` }))
                );

                window.showMsg(`${toAdd.length}ëª…ì´ DBì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch (e) {
                window.showMsg('ì¶”ê°€ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>ì„ íƒí•œ ë©¤ë²„ DBì— ì¶”ê°€';
            }
        };

        // íƒˆí‡´ ë©¤ë²„ ì‚­ì œ (ìƒì„¸ ì •ë³´ í™•ì¸)
        window._syncRemoveGone = async () => {
            const checks = document.querySelectorAll('.sync-gone-check:checked');
            if (checks.length === 0) { window.showMsg('ì‚­ì œí•  ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            
            const selected = [];
            checks.forEach(c => selected.push(window._syncGoneMembers[parseInt(c.dataset.idx)]));
            const detailLines = selected.map(m => {
                const dbInfo = appState.members.find(d => d.id === m.id) || {};
                return `â€¢ ${m.name} (${m.guild} / ${dbInfo.role || '-'} / ${dbInfo.class || '-'})`;
            });
            
            if (!confirm(`ì •ë§ ${selected.length}ëª…ì„ DBì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${detailLines.join('\n')}`)) return;

            const btn = document.getElementById('syncRemoveBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì‚­ì œ ì¤‘...';
            
            try {
                const ids = selected.map(m => m.id);
                const { error } = await supaDb.from('members').delete().in('id', ids);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    selected.map(m => {
                        const dbInfo = appState.members.find(d => d.id === m.id) || {};
                        return { date: new Date().toISOString().split('T')[0], category: 'ë™ê¸°í™”-ì‚­ì œ', name: m.name, content: `${m.guild}/${dbInfo.role || '-'}/${dbInfo.class || '-'} â€” APIì—ì„œ ë¯¸ë°œê²¬ (ì‚­ì œ)` };
                    })
                );

                window.showMsg(`${selected.length}ëª…ì´ DBì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch (e) {
                window.showMsg('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-minus mr-2"></i>ì„ íƒí•œ ë©¤ë²„ DBì—ì„œ ì‚­ì œ';
            }
        };

        // ê¸¸ë“œ ì´ë™ ë©¤ë²„ ì†Œì† ë³€ê²½
        window._syncUpdateMoved = async () => {
            const checks = document.querySelectorAll('.sync-moved-check:checked');
            if (checks.length === 0) { window.showMsg('ë³€ê²½í•  ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            
            const btn = document.getElementById('syncMoveBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë³€ê²½ ì¤‘...';
            
            try {
                for (const c of checks) {
                    const m = window._syncMovedMembers[parseInt(c.dataset.idx)];
                    const { error } = await supaDb.from('members').update({ guild: m.toGuild }).eq('id', m.id);
                    if (error) throw error;
                }

                const count = checks.length;
                await supaDb.from('operation_history').insert(
                    [...checks].map(c => {
                        const m = window._syncMovedMembers[parseInt(c.dataset.idx)];
                        return { date: new Date().toISOString().split('T')[0], category: 'ë™ê¸°í™”-ì´ë™', name: m.name, content: `${m.fromGuild} â†’ ${m.toGuild} ì†Œì† ë³€ê²½ (API ë™ê¸°í™”)` };
                    })
                );

                window.showMsg(`${count}ëª…ì˜ ì†Œì†ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch (e) {
                window.showMsg('ë³€ê²½ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-exchange-alt mr-2"></i>ì„ íƒí•œ ë©¤ë²„ ì†Œì† ë³€ê²½';
            }
        };

        // ë™ê¸°í™” íƒ­ ë Œë”ë§

        // â•â•â• syncUI (from admin, lines 5285-6070) â•â•â•
        window.renderSync = (container) => {
            const savedKey = window._getNexonApiKey();
            const savedWorld = window._getSyncWorld();
            const maskedKey = savedKey ? savedKey.slice(0, 8) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + savedKey.slice(-4) : '';

            container.innerHTML = `
            <div class="max-w-4xl fade-in space-y-6">
                <!-- API í‚¤ ì„¤ì • -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-gray-100 shadow-sm font-bold">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-tr from-blue-400 to-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-key"></i></div>
                        <div>
                            <h3 class="text-lg text-gray-800">Nexon Open API ì„¤ì •</h3>
                            <p class="text-[10px] text-gray-400">ê¸¸ë“œì› ë™ê¸°í™”ë¥¼ ìœ„í•´ Nexon Open API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">API Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="syncApiKeyInput" class="flex-1 border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-mono outline-none focus:ring-4 focus:ring-blue-50 shadow-inner" 
                                    placeholder="${maskedKey || 'Nexon Open API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”'}" value="${savedKey}">
                                <button onclick="window._setNexonApiKey(document.getElementById('syncApiKeyInput').value); window.showMsg('API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!','success')" 
                                    class="px-5 bg-gray-900 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest hover:bg-black transition-all shadow-lg shrink-0">ì €ì¥</button>
                            </div>
                            <p class="text-[9px] text-gray-300 ml-1 mt-1"><i class="fas fa-lock mr-1"></i>KeyëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ Â· <a href="https://openapi.nexon.com/ko/my-application/" target="_blank" class="text-blue-400 hover:underline">API Key ë°œê¸‰ë°›ê¸° â†’</a></p>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì„œë²„ (ì›”ë“œ)</label>
                            <select id="syncWorldSelect" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner cursor-pointer"
                                onchange="window._setSyncWorld(this.value)">
                                ${MAPLE_WORLDS.map(w => `<option value="${w}" ${w === savedWorld ? 'selected' : ''}>${w}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ë™ê¸°í™” ì‹¤í–‰ -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-pink-100 shadow-sm font-bold">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-tr from-pink-400 to-rose-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-sync"></i></div>
                            <div>
                                <h3 class="text-lg text-gray-800">ê¸¸ë“œì› ë™ê¸°í™”</h3>
                                <p class="text-[10px] text-gray-400">Nexon APIì˜ ì‹¤ì œ ê¸¸ë“œì› ëª©ë¡ê³¼ DBë¥¼ ë¹„êµí•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <button onclick="window._runSync()" id="syncRunBtn" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transition-all">
                            <i class="fas fa-sync mr-2"></i>ë™ê¸°í™” ì‹¤í–‰
                        </button>
                    </div>

                    <div class="bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-100">
                        <p class="text-[10px] text-gray-500 leading-relaxed">
                            <i class="fas fa-info-circle text-pink-400 mr-1"></i>
                            ë“±ë¡ëœ ëª¨ë“  ê¸¸ë“œ(${appState.guilds.map(g => g.name).join(', ')})ë¥¼ <strong>${savedWorld || 'ë£¨ë‚˜'}</strong> ì„œë²„ì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤.<br>
                            <i class="fas fa-arrow-right text-gray-300 mr-1 ml-3"></i> <span class="text-green-500">ì‹ ê·œ ë©¤ë²„</span>: APIì— ìˆì§€ë§Œ DBì— ì—†ëŠ” ë©¤ë²„ â†’ ì¶”ê°€ ê°€ëŠ¥<br>
                            <i class="fas fa-arrow-right text-gray-300 mr-1 ml-3"></i> <span class="text-red-500">íƒˆí‡´ ì˜ì‹¬</span>: DBì— ìˆì§€ë§Œ APIì— ì—†ëŠ” ë©¤ë²„ â†’ ì‚­ì œ ê°€ëŠ¥<br>
                            <i class="fas fa-arrow-right text-gray-300 mr-1 ml-3"></i> <span class="text-purple-500">ê¸¸ë“œ ì´ë™</span>: DBì™€ APIì˜ ì†Œì† ê¸¸ë“œê°€ ë‹¤ë¥¸ ë©¤ë²„ â†’ ì†Œì† ë³€ê²½ ê°€ëŠ¥
                        </p>
                    </div>

                    <div id="syncResult">
                        <div class="text-center py-12 text-gray-300">
                            <i class="fas fa-cloud-download-alt text-4xl mb-3"></i>
                            <p class="text-xs font-bold">ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë™ê¸°í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>

                <!-- ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬ -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-amber-100 shadow-sm font-bold">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-tr from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-clone"></i></div>
                            <div>
                                <h3 class="text-lg text-gray-800">ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬</h3>
                                <p class="text-[10px] text-gray-400">DBì— ë™ì¼í•œ ë‹‰ë„¤ì„ìœ¼ë¡œ ë“±ë¡ëœ ì¤‘ë³µ ë°ì´í„°ë¥¼ ì°¾ì•„ ì •ë¦¬í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <button onclick="window._runDupCheck()" id="dupCheckBtn" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transition-all">
                            <i class="fas fa-search mr-2"></i>ì¤‘ë³µ ê²€ì‚¬
                        </button>
                    </div>
                    <div id="dupResult">
                        <div class="text-center py-12 text-gray-300">
                            <i class="fas fa-copy text-4xl mb-3"></i>
                            <p class="text-xs font-bold">ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¤‘ë³µ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>

                <!-- DB ë©¤ë²„ ê²€ìƒ‰/í¸ì§‘ -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-blue-100 shadow-sm font-bold">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-tr from-blue-400 to-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-pen-square"></i></div>
                        <div>
                            <h3 class="text-lg text-gray-800">DB ë©¤ë²„ í¸ì§‘</h3>
                            <p class="text-[10px] text-gray-400">ë‹‰ë„¤ì„ ê²€ìƒ‰ìœ¼ë¡œ ë©¤ë²„ë¥¼ ì°¾ì•„ ì •ë³´ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="dbEditSearch" class="flex-1 border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none focus:ring-4 focus:ring-blue-50 shadow-inner" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰ (2ê¸€ì ì´ìƒ ì…ë ¥)" oninput="window._dbEditSearch(this.value)">
                        <button onclick="window._dbEditLoadAll()" class="px-4 bg-gray-100 text-gray-600 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-all shrink-0">ì „ì²´ ë³´ê¸°</button>
                    </div>
                    <div id="dbEditResult">
                        <div class="text-center py-8 text-gray-300">
                            <i class="fas fa-search text-3xl mb-3"></i>
                            <p class="text-xs font-bold">ë‹‰ë„¤ì„ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì „ì²´ ë³´ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  DB ë©¤ë²„ ê²€ìƒ‰/í¸ì§‘  â–ˆâ–ˆ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        window._dbEditSearchTimer = null;
        window._dbEditSearch = (query) => {
            clearTimeout(window._dbEditSearchTimer);
            if (query.length < 2) {
                document.getElementById('dbEditResult').innerHTML = '<div class="text-center py-8 text-gray-300"><i class="fas fa-search text-3xl mb-3"></i><p class="text-xs font-bold">2ê¸€ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”</p></div>';
                return;
            }
            window._dbEditSearchTimer = setTimeout(() => {
                const q = query.toLowerCase();
                const matches = appState.members.filter(m => m.name.toLowerCase().includes(q));
                window._renderDbEditTable(matches, `"${query}" ê²€ìƒ‰ ê²°ê³¼: ${matches.length}ëª…`);
            }, 300);
        };

        window._dbEditLoadAll = () => {
            window._renderDbEditTable([...appState.members].sort((a,b) => a.name.localeCompare(b.name)), `ì „ì²´ ë©¤ë²„: ${appState.members.length}ëª…`);
        };

        window._renderDbEditTable = (members, title) => {
            const resultDiv = document.getElementById('dbEditResult');
            if (members.length === 0) {
                resultDiv.innerHTML = '<div class="text-center py-8 text-gray-300"><i class="fas fa-user-slash text-2xl mb-2"></i><p class="text-xs font-bold">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            const guilds = appState.guilds.map(g => g.name);
            const pageSize = 50;
            const totalPages = Math.ceil(members.length / pageSize);
            window._dbEditMembers = members;

            window._dbEditRenderPage = (page) => {
                const start = (page - 1) * pageSize;
                const slice = members.slice(start, start + pageSize);

                let html = `<div class="flex items-center justify-between mb-3">
                    <p class="text-[10px] font-bold text-gray-400">${title}</p>
                    ${totalPages > 1 ? `<div class="flex items-center gap-1">
                        <button onclick="window._dbEditRenderPage(${Math.max(1, page-1)})" class="w-7 h-7 rounded-lg bg-gray-100 text-gray-500 text-[10px] hover:bg-gray-200 ${page<=1?'opacity-30':''}"><i class="fas fa-chevron-left"></i></button>
                        <span class="text-[10px] text-gray-400 px-2">${page}/${totalPages}</span>
                        <button onclick="window._dbEditRenderPage(${Math.min(totalPages, page+1)})" class="w-7 h-7 rounded-lg bg-gray-100 text-gray-500 text-[10px] hover:bg-gray-200 ${page>=totalPages?'opacity-30':''}"><i class="fas fa-chevron-right"></i></button>
                    </div>` : ''}
                </div>
                <div class="overflow-x-auto max-h-[60vh] overflow-y-auto no-scrollbar">
                    <table class="w-full text-xs" id="dbEditTable">
                        <thead class="sticky top-0 bg-white z-10">
                            <tr class="text-[8px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                <th class="p-1.5 text-left">ID</th>
                                <th class="p-1.5 text-left" style="min-width:100px">ë‹‰ë„¤ì„</th>
                                <th class="p-1.5 text-left">ì†Œì†</th>
                                <th class="p-1.5 text-left">ì§ìœ„</th>
                                <th class="p-1.5 text-left">ì§ì—…</th>
                                <th class="p-1.5 text-center">ë³¸ìº</th>
                                <th class="p-1.5 text-left">ë³¸ìºë‹‰</th>
                                <th class="p-1.5 w-16 text-center">ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${slice.map((m, si) => {
                                const ri = start + si;
                                const guildRoles = initialGuildRanks[m.guild] || initialGuildRanks[guilds[0]] || [];
                                return `<tr class="border-b border-gray-50 hover:bg-blue-50/30 transition-colors" data-id="${m.id}" id="dbEditRow_${ri}">
                                    <td class="p-1"><span class="text-[9px] text-gray-300 font-mono">#${m.id}</span></td>
                                    <td class="p-1"><input type="text" class="dbe-name w-full bg-blue-50 border border-blue-200 rounded-lg px-2 py-1 text-[10px] font-bold outline-none focus:ring-2 focus:ring-blue-200" value="${m.name}"></td>
                                    <td class="p-1">
                                        <select class="dbe-guild bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer" onchange="window._dbeGuildChange(this, ${ri})">
                                            ${guilds.map(g => `<option value="${g}" ${g === m.guild ? 'selected' : ''}>${g}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="p-1">
                                        <select class="dbe-role bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer" id="dbeRole_${ri}">
                                            ${guildRoles.map(r => `<option value="${r}" ${r === m.role ? 'selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="p-1">
                                        <select class="dbe-class bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer">
                                            <option value="">-</option>
                                            ${MAPLE_JOBS.map(j => `<option value="${j}" ${j === (m.class||'') ? 'selected' : ''}>${j}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="p-1 text-center"><input type="checkbox" class="dbe-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" ${m.isMain !== false ? 'checked' : ''}></td>
                                    <td class="p-1"><input type="text" class="dbe-mainChar bg-gray-50 border border-gray-100 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-full" value="${m.mainCharName || ''}" placeholder="-"></td>
                                    <td class="p-1 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button onclick="window._dbeSaveRow(${ri})" class="w-6 h-6 rounded-md bg-blue-100 text-blue-500 hover:bg-blue-200 text-[9px] transition-all" title="ì €ì¥"><i class="fas fa-save"></i></button>
                                            <button onclick="window._dbeDeleteRow(${ri})" class="w-6 h-6 rounded-md bg-red-100 text-red-500 hover:bg-red-200 text-[9px] transition-all" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
                resultDiv.innerHTML = html;
            };
            window._dbEditRenderPage(1);
        };

        window._dbeGuildChange = (sel, idx) => {
            const roles = initialGuildRanks[sel.value] || [];
            const roleEl = document.getElementById(`dbeRole_${idx}`);
            if (roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };

        window._dbeSaveRow = async (idx) => {
            const m = window._dbEditMembers[idx];
            if (!m) return;
            const row = document.getElementById(`dbEditRow_${idx}`);
            if (!row) return;

            const newName = row.querySelector('.dbe-name')?.value?.trim();
            const newGuild = row.querySelector('.dbe-guild')?.value;
            const newRole = row.querySelector('.dbe-role')?.value;
            const newClass = row.querySelector('.dbe-class')?.value || '';
            const newIsMain = row.querySelector('.dbe-isMain')?.checked !== false;
            const newMainChar = row.querySelector('.dbe-mainChar')?.value || '';

            if (!newName) { window.showMsg('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

            const changes = {};
            if (newName !== m.name) changes.name = newName;
            if (newGuild !== m.guild) changes.guild = newGuild;
            if (newRole !== m.role) changes.role = newRole;
            if (newClass !== (m.class || '')) changes.class = newClass;
            if (newIsMain !== (m.isMain !== false)) changes.is_main = newIsMain;
            if (newMainChar !== (m.mainCharName || '')) changes.main_char_name = newMainChar;

            if (Object.keys(changes).length === 0) { window.showMsg('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return; }

            try {
                const { error } = await supaDb.from('members').update(changes).eq('id', m.id);
                if (error) throw error;

                const changeDesc = Object.entries(changes).map(([k,v]) => `${k}: ${v}`).join(', ');
                await supaDb.from('operation_history').insert({
                    date: new Date().toISOString().split('T')[0], category: 'ìˆ˜ì •',
                    name: newName, content: `DB í¸ì§‘ (#${m.id}) ${changeDesc}`
                });

                row.classList.add('bg-green-50');
                setTimeout(() => row.classList.remove('bg-green-50'), 1500);
                window.showMsg(`"${newName}" ìˆ˜ì • ì™„ë£Œ!`, 'success');
                await window.fetchMembers();
            } catch (e) {
                window.showMsg('ìˆ˜ì • ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        window._dbeDeleteRow = async (idx) => {
            const m = window._dbEditMembers[idx];
            if (!m) return;
            if (!confirm(`"${m.name}" (#${m.id}, ${m.guild}/${m.role || '-'}/${m.class || '-'})\n\nì´ ë©¤ë²„ë¥¼ DBì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const { error } = await supaDb.from('members').delete().eq('id', m.id);
                if (error) throw error;

                await supaDb.from('operation_history').insert({
                    date: new Date().toISOString().split('T')[0], category: 'ì‚­ì œ',
                    name: m.name, content: `DB í¸ì§‘ì—ì„œ ì‚­ì œ (#${m.id}, ${m.guild}/${m.role || '-'})`
                });

                const row = document.getElementById(`dbEditRow_${idx}`);
                if (row) { row.classList.add('bg-red-50', 'opacity-50', 'line-through'); row.style.pointerEvents = 'none'; }
                window.showMsg(`"${m.name}" ì‚­ì œ ì™„ë£Œ`, 'success');
                await window.fetchMembers();
            } catch (e) {
                window.showMsg('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        window._runDupCheck = async () => {
            const resultDiv = document.getElementById('dupResult');
            const btn = document.getElementById('dupCheckBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ê²€ì‚¬ ì¤‘...'; }
            resultDiv.innerHTML = '<div class="text-center py-8 text-gray-400 font-bold"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-xs">ì¤‘ë³µ ë‹‰ë„¤ì„ ê²€ì‚¬ ì¤‘...</p></div>';

            try {
                // 1000ê±´ ì œí•œ ìš°íšŒ: í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ì „ì²´ ì¡°íšŒ
                let allMembers = [], page = 0, pageSize = 1000;
                while (true) {
                    const { data: batch, error: bErr } = await supaDb.from('members').select('*').order('id').range(page * pageSize, (page + 1) * pageSize - 1);
                    if (bErr) throw bErr;
                    allMembers = allMembers.concat(batch);
                    if (batch.length < pageSize) break;
                    page++;
                }

                const nameMap = {};
                allMembers.forEach(m => {
                    if (!nameMap[m.name]) nameMap[m.name] = [];
                    nameMap[m.name].push(m);
                });

                const duplicates = Object.entries(nameMap).filter(([, arr]) => arr.length > 1);

                if (duplicates.length === 0) {
                    resultDiv.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-2xl p-8 text-center">
                        <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-check text-green-500 text-xl"></i></div>
                        <p class="text-sm font-bold text-green-600">ì¤‘ë³µ ë‹‰ë„¤ì„ì´ ì—†ìŠµë‹ˆë‹¤!</p>
                        <p class="text-[10px] text-green-400 mt-1">ì´ ${allMembers.length}ëª… (${page+1}í˜ì´ì§€ ì¡°íšŒ) ëª¨ë‘ ê³ ìœ í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.</p>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center gap-2 flex-wrap mb-3">
                            <select id="mismatchGuild" class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-xs font-bold outline-none">
                                ${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                            <button onclick="window._runMismatchCheck()" id="mismatchCheckBtn" class="px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-search-plus mr-1"></i>ì§ì—…/ë ˆë²¨ ì¡°íšŒ
                            </button>
                            <span id="mismatchProg" class="text-[10px] text-gray-400"></span>
                        </div>
                        <div id="mismatchResult"></div>
                    </div>`;
                } else {
                    const guilds = appState.guilds.map(g => g.name);
                    let html = `<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-4">
                        <p class="text-xs font-bold text-amber-600"><i class="fas fa-exclamation-triangle mr-1"></i>${duplicates.length}ê°œì˜ ì¤‘ë³µ ë‹‰ë„¤ì„ ë°œê²¬ (ì´ ${duplicates.reduce((s,[,a]) => s+a.length, 0)}ê±´)</p>
                        <p class="text-[10px] text-amber-500 mt-1">ë‹‰ë„¤ì„ì´ í‹€ë¦° ê²½ìš° <strong class="text-blue-500">ì§ì ‘ ìˆ˜ì •</strong> ê°€ëŠ¥í•©ë‹ˆë‹¤. ìœ ì§€í•  ë°ì´í„°ë¥¼ ë¼ë””ì˜¤ ë²„íŠ¼ìœ¼ë¡œ ì„ íƒ í›„ ë‚˜ë¨¸ì§€ë¥¼ ì‚­ì œí•˜ì„¸ìš”.</p>
                    </div>`;

                    window._dupGroups = duplicates;

                    duplicates.forEach(([name, members], gi) => {
                        html += `<div class="bg-white border border-amber-200 rounded-2xl p-4 mb-3 shadow-sm" id="dupGroup_${gi}">
                            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full">${name}</span>
                                    <span class="text-[9px] text-gray-400">${members.length}ê±´ ì¤‘ë³µ</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="window._dupSaveEdits(${gi})" class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-[10px] font-bold hover:bg-blue-600 transition-all shadow-sm">
                                        <i class="fas fa-save mr-1"></i>ìˆ˜ì • ì €ì¥
                                    </button>
                                    <button onclick="window._dupDeleteUnchecked(${gi})" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-[10px] font-bold hover:bg-red-600 transition-all shadow-sm">
                                        <i class="fas fa-trash mr-1"></i>ë¯¸ì²´í¬ ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs">
                                    <thead>
                                        <tr class="text-[8px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                            <th class="p-1.5 w-8 text-center">ìœ ì§€</th>
                                            <th class="p-1.5 text-left">ID</th>
                                            <th class="p-1.5 text-left" style="min-width:100px">ë‹‰ë„¤ì„</th>
                                            <th class="p-1.5 text-left">ì†Œì†</th>
                                            <th class="p-1.5 text-left">ì§ìœ„</th>
                                            <th class="p-1.5 text-left">ì§ì—…</th>
                                            <th class="p-1.5 text-center">ë³¸ìº</th>
                                            <th class="p-1.5 text-left">ë³¸ìºë‹‰</th>
                                            <th class="p-1.5 text-left">ê°€ì…ì¼</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${members.map((m, mi) => {
                                            const guildRoles = initialGuildRanks[m.guild] || initialGuildRanks[guilds[0]] || [];
                                            return `<tr class="border-b border-gray-50 hover:bg-amber-50/30 transition-colors" data-id="${m.id}">
                                            <td class="p-1 text-center">
                                                <input type="radio" name="dupKeep_${gi}" class="dup-keep-radio w-4 h-4 text-green-500 cursor-pointer" data-gi="${gi}" data-mi="${mi}" ${mi === 0 ? 'checked' : ''}>
                                            </td>
                                            <td class="p-1"><span class="text-[9px] text-gray-300 font-mono">#${m.id}</span></td>
                                            <td class="p-1"><input type="text" class="dup-edit-name w-full bg-amber-50 border border-amber-200 rounded-lg px-2 py-1 text-[10px] font-bold outline-none focus:ring-2 focus:ring-amber-200 focus:border-amber-300" value="${m.name}" data-original="${m.name}"></td>
                                            <td class="p-1">
                                                <select class="dup-edit-guild bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer" onchange="window._dupGuildChange(this)">
                                                    ${guilds.map(g => `<option value="${g}" ${g === m.guild ? 'selected' : ''}>${g}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="dup-edit-role bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer">
                                                    ${guildRoles.map(r => `<option value="${r}" ${r === m.role ? 'selected' : ''}>${r}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="dup-edit-class bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer">
                                                    <option value="">-</option>
                                                    ${MAPLE_JOBS.map(j => `<option value="${j}" ${j === m.class ? 'selected' : ''}>${j}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1 text-center"><input type="checkbox" class="dup-edit-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" ${m.is_main !== false ? 'checked' : ''}></td>
                                            <td class="p-1"><input type="text" class="dup-edit-mainChar bg-gray-50 border border-gray-100 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-full" value="${m.main_char_name || ''}" placeholder="-"></td>
                                            <td class="p-1"><span class="text-[10px] text-gray-400">${m.join_date || '-'}</span></td>
                                        </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    });

                    html += `<div class="flex justify-end gap-2 mt-4">
                        <button onclick="window._dupSaveAllEdits()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-blue-600 transition-all">
                            <i class="fas fa-save mr-2"></i>ì „ì²´ ìˆ˜ì • ì €ì¥
                        </button>
                        <button onclick="window._dupDeleteAllUnchecked()" class="px-6 py-3 bg-red-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-red-600 transition-all">
                            <i class="fas fa-trash mr-2"></i>ì „ì²´ ì¤‘ë³µ ì¼ê´„ ì •ë¦¬
                        </button>
                    </div>`;

                    resultDiv.innerHTML = html;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                    <p class="text-sm font-bold text-red-600">ê²€ì‚¬ ì‹¤íŒ¨</p>
                    <p class="text-xs text-red-400 mt-1">${e.message}</p>
                </div>`;
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-search mr-2"></i>ì¤‘ë³µ ê²€ì‚¬'; }
            }
        };

        // â–ˆâ–ˆ ë ˆë²¨/ì§ì—… ë¶ˆì¼ì¹˜ ê²€ì‚¬ (API ì¡°íšŒ) â–ˆâ–ˆ
        window._runMismatchCheck = async () => {
            const resultDiv = document.getElementById('mismatchResult');
            const btn = document.getElementById('mismatchCheckBtn');
            const prog = document.getElementById('mismatchProg');
            const guildName = document.getElementById('mismatchGuild')?.value;
            if (!resultDiv || !guildName) return;
            const apiKey = window._getNexonApiKey();
            if (!apiKey) { window.showMsg('Nexon API Keyë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš” (ê¸¸ë“œì› ë™ê¸°í™” íƒ­).', 'error'); return; }
            
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì¡°íšŒ ì¤‘...';
            resultDiv.innerHTML = '';
            
            const members = appState.members.filter(m => m.guild === guildName);
            const results = []; // {member, apiClass, apiLevel, classDiff, levelDiff}
            
            for (let i = 0; i < members.length; i++) {
                const m = members[i];
                if (prog) prog.textContent = `${i+1}/${members.length} (${m.name})`;
                try {
                    const info = await window._getCharInfo(m.name);
                    if (info) {
                        results.push({
                            member: m, 
                            apiClass: info.class || '', apiLevel: info.level || 0,
                            classDiff: info.class && m.class !== info.class,
                            levelDiff: info.level && (m.level || 0) !== info.level
                        });
                    } else {
                        results.push({ member: m, apiClass: '', apiLevel: 0, classDiff: false, levelDiff: false });
                    }
                } catch(e) {
                    results.push({ member: m, apiClass: '', apiLevel: 0, classDiff: false, levelDiff: false });
                }
                if (i < members.length - 1) await new Promise(r => setTimeout(r, 80));
            }
            if (prog) prog.textContent = `ì™„ë£Œ! ${members.length}ëª… ì¡°íšŒ`;
            
            window._mmResults = results;
            const diffCount = results.filter(r => r.classDiff || r.levelDiff).length;
            
            let html = `<div class="bg-indigo-50 border border-indigo-200 rounded-xl p-3 mb-3">
                <p class="text-[10px] font-bold text-indigo-600"><i class="fas fa-info-circle mr-1"></i>${guildName} ${members.length}ëª… ì¡°íšŒ ì™„ë£Œ Â· ë¶ˆì¼ì¹˜ ${diffCount}ëª… Â· ë³€ê²½í•  í•­ëª©ì„ ì§ì ‘ ìˆ˜ì • í›„ ì¼ê´„ ì €ì¥í•˜ì„¸ìš”</p>
            </div>`;
            html += `<div class="overflow-x-auto max-h-[400px] overflow-y-auto"><table class="w-full text-xs"><thead class="sticky top-0 bg-white z-10">
                <tr class="text-[8px] font-bold text-gray-400 uppercase border-b border-gray-200">
                    <th class="p-1.5 w-8 text-center"><input type="checkbox" onchange="document.querySelectorAll('.mm-save').forEach(c=>c.checked=this.checked)" checked></th>
                    <th class="p-1.5 text-left">ë‹‰ë„¤ì„</th>
                    <th class="p-1.5 text-left">DB ì§ì—…</th>
                    <th class="p-1.5 text-left">API ì§ì—…</th>
                    <th class="p-1.5 text-center">DB Lv</th>
                    <th class="p-1.5 text-center">API Lv</th>
                </tr></thead><tbody>`;
            
            results.forEach((r, i) => {
                const cDiff = r.classDiff;
                const lDiff = r.levelDiff;
                const rowCls = (cDiff || lDiff) ? 'bg-amber-50/50' : '';
                html += `<tr class="border-b border-gray-50 ${rowCls}" data-idx="${i}">
                    <td class="p-1 text-center">${(cDiff||lDiff) ? '<input type="checkbox" class="mm-save w-4 h-4" data-idx="'+i+'" checked>' : '<span class="text-gray-300 text-[9px]">âœ“</span>'}</td>
                    <td class="p-1.5 font-bold">${r.member.name}${r.member.level>0?'<span class="text-[8px] text-gray-400 ml-1">Lv.'+r.member.level+'</span>':''}</td>
                    <td class="p-1.5 ${cDiff?'text-red-500':'text-gray-400'}">${r.member.class||'(ë¯¸ì„¤ì •)'}</td>
                    <td class="p-1.5"><select class="mm-class bg-gray-50 border ${cDiff?'border-amber-300 bg-amber-50':'border-gray-100'} rounded px-1 py-0.5 text-[10px] font-bold outline-none" data-idx="${i}">
                        <option value="">-</option>
                        ${MAPLE_JOBS.map(j => `<option value="${j}" ${j===(r.apiClass||r.member.class)?'selected':''}>${j}</option>`).join('')}
                        ${r.apiClass && !MAPLE_JOBS.includes(r.apiClass) ? `<option value="${r.apiClass}" selected>${r.apiClass}</option>` : ''}
                    </select></td>
                    <td class="p-1.5 text-center ${lDiff?'text-red-500':'text-gray-400'}">${r.member.level||0}</td>
                    <td class="p-1.5 text-center"><input type="number" class="mm-level bg-gray-50 border ${lDiff?'border-amber-300 bg-amber-50':'border-gray-100'} rounded px-1 py-0.5 text-[10px] font-bold outline-none w-16 text-center" data-idx="${i}" value="${r.apiLevel||r.member.level||0}" min="0" max="300"></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            html += `<div class="mt-3 flex justify-between items-center">
                <p class="text-[9px] text-gray-400">ì²´í¬ëœ ë¶ˆì¼ì¹˜ í•­ëª© + ìˆ˜ë™ ìˆ˜ì • ëª¨ë‘ ì €ì¥ë©ë‹ˆë‹¤</p>
                <button onclick="window._applyMismatchFixes()" id="mmApplyBtn" class="px-5 py-2.5 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-indigo-600 transition-all">
                    <i class="fas fa-save mr-1"></i>ë³€ê²½ì‚¬í•­ ì¼ê´„ ì €ì¥
                </button>
            </div>`;
            resultDiv.innerHTML = html;
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-search-plus mr-1"></i>ì§ì—…/ë ˆë²¨ ì¡°íšŒ';
        };

        // ë¶ˆì¼ì¹˜ ì¼ê´„ ì €ì¥
        window._applyMismatchFixes = async () => {
            const btn = document.getElementById('mmApplyBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì €ì¥ ì¤‘...';
            try {
                let updated = 0;
                const rows = document.querySelectorAll('.mm-save:checked');
                // ì²´í¬ëœ ë¶ˆì¼ì¹˜ í•­ëª©
                for (const chk of rows) {
                    const idx = parseInt(chk.dataset.idx);
                    const r = window._mmResults[idx];
                    if (!r) continue;
                    const clsSel = document.querySelector(`.mm-class[data-idx="${idx}"]`);
                    const lvlInput = document.querySelector(`.mm-level[data-idx="${idx}"]`);
                    const newClass = clsSel?.value || r.member.class || '';
                    const newLevel = parseInt(lvlInput?.value) || 0;
                    const updateObj = {};
                    if (newClass !== (r.member.class || '')) updateObj.class = newClass;
                    if (newLevel !== (r.member.level || 0)) updateObj.level = newLevel;
                    if (Object.keys(updateObj).length > 0) {
                        const { error } = await supaDb.from('members').update(updateObj).eq('id', r.member.id);
                        if (!error) updated++;
                    }
                }
                // ì²´í¬ ì•ˆ ëì–´ë„ ìˆ˜ë™ìœ¼ë¡œ ê°’ì„ ë°”ê¾¼ í–‰ë„ ì €ì¥
                document.querySelectorAll('.mm-level').forEach(async (inp) => {
                    const idx = parseInt(inp.dataset.idx);
                    const r = window._mmResults[idx];
                    if (!r) return;
                    const chk = document.querySelector(`.mm-save[data-idx="${idx}"]`);
                    if (chk && chk.checked) return; // ì´ë¯¸ ì²˜ë¦¬ë¨
                    const clsSel = document.querySelector(`.mm-class[data-idx="${idx}"]`);
                    const newClass = clsSel?.value || '';
                    const newLevel = parseInt(inp.value) || 0;
                    const updateObj = {};
                    if (newClass && newClass !== (r.member.class || '')) updateObj.class = newClass;
                    if (newLevel !== (r.member.level || 0)) updateObj.level = newLevel;
                    if (Object.keys(updateObj).length > 0) {
                        await supaDb.from('members').update(updateObj).eq('id', r.member.id);
                        updated++;
                    }
                });
                window.showMsg(updated + 'ëª… ì—…ë°ì´íŠ¸ ì™„ë£Œ!', 'success');
                await window.fetchMembers();
            } catch(e) {
                window.showMsg('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>ë³€ê²½ì‚¬í•­ ì¼ê´„ ì €ì¥';
            }
        };

        // ì¤‘ë³µ í…Œì´ë¸” ê¸¸ë“œ ë³€ê²½ ì‹œ ì§ìœ„ ê°±ì‹ 
        window._dupGuildChange = (sel) => {
            const tr = sel.closest('tr');
            const roleEl = tr.querySelector('.dup-edit-role');
            const roles = initialGuildRanks[sel.value] || [];
            if (roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };

        // ì¤‘ë³µ ê·¸ë£¹ ë‚´ ìˆ˜ì •ì‚¬í•­ ì €ì¥
        window._dupSaveEdits = async (gi) => {
            const group = window._dupGroups[gi];
            if (!group) return;
            const [, members] = group;
            const groupEl = document.getElementById(`dupGroup_${gi}`);
            if (!groupEl) return;

            const rows = groupEl.querySelectorAll('tbody tr');
            let updated = 0;
            try {
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const m = members[i];
                    const newName = row.querySelector('.dup-edit-name')?.value?.trim();
                    const newGuild = row.querySelector('.dup-edit-guild')?.value;
                    const newRole = row.querySelector('.dup-edit-role')?.value;
                    const newClass = row.querySelector('.dup-edit-class')?.value || '';
                    const newIsMain = row.querySelector('.dup-edit-isMain')?.checked !== false;
                    const newMainChar = row.querySelector('.dup-edit-mainChar')?.value || '';

                    if (!newName) continue;

                    const changes = {};
                    if (newName !== m.name) changes.name = newName;
                    if (newGuild !== m.guild) changes.guild = newGuild;
                    if (newRole !== m.role) changes.role = newRole;
                    if (newClass !== (m.class || '')) changes.class = newClass;
                    if (newIsMain !== (m.is_main !== false)) changes.is_main = newIsMain;
                    if (newMainChar !== (m.main_char_name || '')) changes.main_char_name = newMainChar;

                    if (Object.keys(changes).length > 0) {
                        const { error } = await supaDb.from('members').update(changes).eq('id', m.id);
                        if (error) throw error;
                        
                        const changeDesc = Object.entries(changes).map(([k,v]) => `${k}: ${v}`).join(', ');
                        await supaDb.from('operation_history').insert({
                            date: new Date().toISOString().split('T')[0], category: 'ìˆ˜ì •',
                            name: newName, content: `DB í¸ì§‘ (#${m.id}) ${changeDesc}`
                        });
                        updated++;
                    }
                }
                if (updated > 0) {
                    window.showMsg(`${updated}ê±´ ìˆ˜ì • ì™„ë£Œ!`, 'success');
                    await window.fetchMembers();
                    window._runDupCheck();
                } else {
                    window.showMsg('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
                }
            } catch (e) {
                window.showMsg('ìˆ˜ì • ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        // ì „ì²´ ê·¸ë£¹ ìˆ˜ì •ì‚¬í•­ ì €ì¥
        window._dupSaveAllEdits = async () => {
            if (!window._dupGroups) return;
            let totalUpdated = 0;
            try {
                for (let gi = 0; gi < window._dupGroups.length; gi++) {
                    const [, members] = window._dupGroups[gi];
                    const groupEl = document.getElementById(`dupGroup_${gi}`);
                    if (!groupEl) continue;
                    const rows = groupEl.querySelectorAll('tbody tr');

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const m = members[i];
                        const newName = row.querySelector('.dup-edit-name')?.value?.trim();
                        const newGuild = row.querySelector('.dup-edit-guild')?.value;
                        const newRole = row.querySelector('.dup-edit-role')?.value;
                        const newClass = row.querySelector('.dup-edit-class')?.value || '';
                        const newIsMain = row.querySelector('.dup-edit-isMain')?.checked !== false;
                        const newMainChar = row.querySelector('.dup-edit-mainChar')?.value || '';

                        if (!newName) continue;
                        const changes = {};
                        if (newName !== m.name) changes.name = newName;
                        if (newGuild !== m.guild) changes.guild = newGuild;
                        if (newRole !== m.role) changes.role = newRole;
                        if (newClass !== (m.class || '')) changes.class = newClass;
                        if (newIsMain !== (m.is_main !== false)) changes.is_main = newIsMain;
                        if (newMainChar !== (m.main_char_name || '')) changes.main_char_name = newMainChar;

                        if (Object.keys(changes).length > 0) {
                            const { error } = await supaDb.from('members').update(changes).eq('id', m.id);
                            if (error) throw error;
                            await supaDb.from('operation_history').insert({
                                date: new Date().toISOString().split('T')[0], category: 'ìˆ˜ì •',
                                name: newName, content: `ì¼ê´„ DB í¸ì§‘ (#${m.id}) ${Object.entries(changes).map(([k,v])=>`${k}:${v}`).join(', ')}`
                            });
                            totalUpdated++;
                        }
                    }
                }
                if (totalUpdated > 0) {
                    window.showMsg(`ì´ ${totalUpdated}ê±´ ìˆ˜ì • ì™„ë£Œ!`, 'success');
                    await window.fetchMembers();
                    window._runDupCheck();
                } else {
                    window.showMsg('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
                }
            } catch (e) {
                window.showMsg('ì¼ê´„ ìˆ˜ì • ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        // ê°œë³„ ê·¸ë£¹ì˜ ë¯¸ì²´í¬ í•­ëª© ì‚­ì œ
        window._dupDeleteUnchecked = async (gi) => {
            const group = window._dupGroups[gi];
            if (!group) return;
            const [name, members] = group;

            // ì„ íƒëœ radio ì°¾ê¸°
            const keepRadio = document.querySelector(`input[name="dupKeep_${gi}"]:checked`);
            if (!keepRadio) { window.showMsg('ìœ ì§€í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            const keepIdx = parseInt(keepRadio.dataset.mi);
            const keepMember = members[keepIdx];

            const toDelete = members.filter((_, i) => i !== keepIdx);
            if (toDelete.length === 0) return;

            const detail = toDelete.map(m => `  #${m.id} (${m.guild}/${m.role || '-'}/${m.class || '-'})`).join('\n');
            if (!confirm(`"${name}" ì¤‘ë³µ ì •ë¦¬\n\nâœ… ìœ ì§€: #${keepMember.id} (${keepMember.guild}/${keepMember.role || '-'})\n\nğŸ—‘ï¸ ì‚­ì œ (${toDelete.length}ê±´):\n${detail}`)) return;

            try {
                const ids = toDelete.map(m => m.id);
                const { error } = await supaDb.from('members').delete().in('id', ids);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    toDelete.map(m => ({ date: new Date().toISOString().split('T')[0], category: 'ì¤‘ë³µì‚­ì œ', name: m.name, content: `ì¤‘ë³µ ì œê±° (#${m.id}, ${m.guild}/${m.role || '-'}) â€” ìœ ì§€: #${keepMember.id}` }))
                );

                window.showMsg(`"${name}" ì¤‘ë³µ ${toDelete.length}ê±´ ì‚­ì œ ì™„ë£Œ!`, 'success');
                
                // UIì—ì„œ í•´ë‹¹ ê·¸ë£¹ ì™„ë£Œ í‘œì‹œ
                const groupEl = document.getElementById(`dupGroup_${gi}`);
                if (groupEl) {
                    groupEl.innerHTML = `<div class="flex items-center gap-3 py-2">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"><i class="fas fa-check text-green-500 text-xs"></i></div>
                        <span class="text-xs font-bold text-green-600">"${name}" ì •ë¦¬ ì™„ë£Œ â€” #${keepMember.id} ìœ ì§€</span>
                    </div>`;
                }
                await window.fetchMembers();
            } catch (e) {
                window.showMsg('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        // ì „ì²´ ì¤‘ë³µ ì¼ê´„ ì •ë¦¬
        window._dupDeleteAllUnchecked = async () => {
            if (!window._dupGroups || window._dupGroups.length === 0) return;

            let totalDelete = 0;
            const allToDelete = [];

            window._dupGroups.forEach(([name, members], gi) => {
                const keepRadio = document.querySelector(`input[name="dupKeep_${gi}"]:checked`);
                if (!keepRadio) return;
                const keepIdx = parseInt(keepRadio.dataset.mi);
                members.forEach((m, i) => {
                    if (i !== keepIdx) { allToDelete.push({ ...m, keepId: members[keepIdx].id }); totalDelete++; }
                });
            });

            if (totalDelete === 0) { window.showMsg('ì‚­ì œí•  ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
            if (!confirm(`ì´ ${totalDelete}ê±´ì˜ ì¤‘ë³µ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê° ê·¸ë£¹ì—ì„œ ë¼ë””ì˜¤ ë²„íŠ¼ìœ¼ë¡œ ì„ íƒí•œ ë°ì´í„°ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.`)) return;

            try {
                const ids = allToDelete.map(m => m.id);
                const { error } = await supaDb.from('members').delete().in('id', ids);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    allToDelete.map(m => ({ date: new Date().toISOString().split('T')[0], category: 'ì¤‘ë³µì‚­ì œ', name: m.name, content: `ì¼ê´„ ì¤‘ë³µ ì œê±° (#${m.id}, ${m.guild}/${m.role || '-'}) â€” ìœ ì§€: #${m.keepId}` }))
                );

                window.showMsg(`ì´ ${totalDelete}ê±´ì˜ ì¤‘ë³µ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                await window.fetchMembers();
                window._runDupCheck(); // ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                window.showMsg('ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initSidebar();
            const authed = await window._authCheck();
            if (authed) {
                // ì‚¬ì´ë“œë°” í•˜ë‹¨ì— ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                const sidebarFooter = document.querySelector('#sidebar > div:last-child');
                if (sidebarFooter && CURRENT_USER) {
                    sidebarFooter.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            ${CURRENT_USER.avatar ? `<img src="${CURRENT_USER.avatar}" class="w-7 h-7 rounded-full border border-pink-200">` : `<div class="w-7 h-7 rounded-full bg-pink-100 flex items-center justify-center text-pink-500 text-[10px] font-bold">${(CURRENT_USER.name||'?')[0]}</div>`}
                            <div class="min-w-0">
                                <p class="text-[10px] font-bold text-gray-700 truncate">${CURRENT_USER.name}</p>
                                <p class="text-[8px] text-gray-400 truncate">${CURRENT_USER.role}</p>
                            </div>
                        </div>
                        <button onclick="window._authLogout()" class="w-full py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-[9px] font-bold text-gray-500 transition-all"><i class="fas fa-sign-out-alt mr-1"></i>ë¡œê·¸ì•„ì›ƒ</button>
                    `;
                }
                window.fetchMembers();
            }
        });

    </script>
    <div id="memberModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold p-4"><div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100"><div class="p-5 lg:p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center"><div><h3 id="modalTitle" class="text-base lg:text-lg font-bold text-pink-700 tracking-tight">ë©¤ë²„ ì •ë³´ ì…ë ¥</h3></div><button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button></div><form id="memberForm" class="p-6 lg:p-8 space-y-4 lg:space-y-5"><input type="hidden" id="editMemberId"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë‹‰ë„¤ì„</label><input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="ì •í™•í•œ ìºë¦­í„°ëª…"></div><div class="grid grid-cols-2 gap-3 lg:gap-4"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì†Œì†</label><select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ìœ„</label><select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none"></select></div></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ì—…</label><select id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none shadow-inner cursor-pointer"><option value="">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option></select></div><div class="flex items-center gap-3 py-1"><input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()"><label for="inputIsMain" class="text-[10px] lg:text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">ë³¸ìºë¦­í„°ì…ë‹ˆê¹Œ?</label></div><div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë³¸ìº ë‹‰ë„¤ì„</label><input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none shadow-inner" placeholder="ë³¸ìºë¦­ëª… ì…ë ¥"></div><button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-3.5 lg:py-4 rounded-xl lg:rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</button></form></div></div>

</body>
</html>
