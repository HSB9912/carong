<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뚠카롱 길드 관리 시스템 (v9.1 Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .batch-modified { background-color: #fff7ed !important; } 
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; aspect-ratio: 1/1; cursor: pointer; border: 1px solid transparent; }
        @media (min-width: 1024px) { .calendar-day { min-height: 56px; } }
        .calendar-day:hover { background-color: #f9fafb; border-color: #fbcfe8; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-day.not-current { opacity: 0.2; pointer-events: none; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
        .event-dot { width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.today .event-dot { background-color: white; }
        
        .event-snippet { 
            font-size: 10px; 
            color: #1f2937; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
            margin-top: 3px; 
            line-height: 1.2; 
            font-weight: 800; 
            background-color: rgba(236, 72, 153, 0.18); 
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (min-width: 1024px) { .event-snippet { font-size: 11px; } }
        .calendar-day.today .event-snippet { color: white; background-color: rgba(255, 255, 255, 0.2); }
        .calendar-day.thursday .event-snippet { color: #be123c; background-color: rgba(159, 18, 57, 0.13); }

        .score-zero { background-color: #fee2e2 !important; color: #ef4444 !important; }
        .score-cell { transition: background 0.2s; }
        .score-cell:hover { background-color: #f8fafb; }
        
        /* Custom Checkbox Style */
        .custom-checkbox { width: 1.25rem; height: 1.25rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; appearance: none; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox:checked { background-color: #ef4444; border-color: #ef4444; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); }

        /* Event List Styles */
        .event-item-active { background-color: #fdf2f8; border-color: #f472b6; color: #db2777; }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        
        /* Touch targets - minimum 44px for mobile */
        @media (max-width: 768px) {
            .nav-item { min-height: 44px; }
            button, select, input[type="checkbox"] { min-height: 36px; }
        }
        
        /* Mobile scrollbar hide for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Safe area for notch devices */
        @supports (padding-top: env(safe-area-inset-top)) {
            body { 
                padding-top: env(safe-area-inset-top); 
                padding-bottom: env(safe-area-inset-bottom); 
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
        
        /* Mobile dashboard cards */
        @media (max-width: 640px) {
            .calendar-grid { gap: 0.125rem; font-size: 0.65rem; }
            .calendar-day { min-height: 38px; padding: 0.125rem; }
            .calendar-head { font-size: 0.6rem; padding-bottom: 4px; }
            .event-snippet { font-size: 8px; padding: 0px 1px; }
            
            /* Compact mobile message box */
            #msgBox { 
                left: 1rem; right: 1rem; 
                transform: translateX(0) translateY(100px) !important; 
                width: auto; 
                padding: 0.75rem 1rem;
                bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            }
            #msgBox.show { transform: translateX(0) translateY(0) !important; }
        }
        
        /* Prevent horizontal overflow on mobile */
        @media (max-width: 1024px) {
            .overflow-x-guard { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
        
        /* Mobile table improvements */
        @media (max-width: 768px) {
            table { font-size: 0.65rem; }
            table th, table td { padding: 0.5rem 0.375rem !important; }
            table th { font-size: 9px; }
        }
        
        /* Smooth touch scrolling */
        .overflow-y-auto, .overflow-x-auto { -webkit-overflow-scrolling: touch; }
        
        /* Prevent text selection on mobile interactive elements */
        .nav-item, button { -webkit-tap-highlight-color: transparent; }
        
        /* Mobile modal improvements */
        @media (max-width: 640px) {
            #memberModal > div > div,
            #deleteModal > div > div,
            #eventDetailModal > div > div { 
                max-height: 90vh; 
                overflow-y: auto;
                border-radius: 1.5rem;
            }
        }

        /* Sticky columns for analysis table



        thead th { position: sticky; top: 0; z-index: 20; background: inherit; }



        /* Sticky table header */
        .stick-head { border-collapse: separate; border-spacing: 0; }
        .stick-head thead th { position: sticky; top: 0; z-index: 10; background: #f9fafb; }

        /* 모바일 수로 분석 최적화 */
        @media (max-width: 640px) {
            .analysis-summary-grid { grid-template-columns: 1fr !important; }
            .analysis-mvp-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .analysis-table-wrap table { font-size: 0.6rem; }
            .analysis-table-wrap table th, .analysis-table-wrap table td { padding: 0.375rem 0.25rem !important; }
        }

        /* ===== DARK MODE ===== */
        body.dark { background-color: #0f1117; color: #c9cdd4; }
        body.dark .bg-gray-50, body.dark main { background-color: #0f1117 !important; }
        body.dark .bg-white { background-color: #1c1f2b !important; color: #c9cdd4; border-color: #2a2d3a !important; }
        body.dark aside { background-color: #14161e !important; border-color: #2a2d3a !important; }
        body.dark header { background-color: #14161e !important; border-color: #2a2d3a !important; }
        body.dark .border-gray-100, body.dark .border-gray-200, body.dark .border-gray-50 { border-color: #2a2d3a !important; }
        body.dark .text-gray-800, body.dark .text-slate-800 { color: #e0e3ea !important; }
        body.dark .text-gray-700 { color: #b8bcc6 !important; }
        body.dark .text-gray-600 { color: #8b90a0 !important; }
        body.dark .text-gray-500 { color: #6b7080 !important; }
        body.dark .text-gray-400 { color: #555a6a !important; }
        body.dark .text-gray-300 { color: #444a5a !important; }
        body.dark .bg-gray-100 { background-color: #22252f !important; }
        body.dark .bg-gray-50 { background-color: #1a1d27 !important; }
        body.dark input, body.dark select, body.dark textarea { background-color: #22252f !important; color: #c9cdd4 !important; border-color: #333848 !important; }
        body.dark input::placeholder, body.dark textarea::placeholder { color: #555a6a !important; }
        body.dark table thead { background-color: #14161e !important; }
        body.dark table thead th { background-color: #14161e !important; color: #6b7080 !important; border-color: #2a2d3a !important; }
        body.dark table tbody td { background-color: #1a1d27 !important; border-color: #22252f !important; }
        body.dark table tbody tr:hover td { background-color: #22252f !important; }
        body.dark .stick-head thead th { background: #14161e !important; }
        body.dark .nav-item:hover { background-color: #22252f !important; }
        body.dark .nav-item.active { background-color: #1e1a2e !important; color: #c084fc !important; box-shadow: inset 4px 0 0 #a855f7 !important; }
        body.dark .shadow-sm, body.dark .shadow-lg, body.dark .shadow-md, body.dark .shadow-2xl { box-shadow: none !important; }
        body.dark #loadingOverlay { background: #0f1117 !important; }
        body.dark .bg-pink-50, body.dark .bg-pink-50\/30 { background-color: rgba(168,85,247,0.08) !important; }
        body.dark .text-pink-600, body.dark .text-pink-500, body.dark .text-pink-400 { color: #a78bfa !important; }
        body.dark .border-pink-100, body.dark .border-pink-50 { border-color: #2a2540 !important; }
        body.dark .bg-red-50, body.dark .bg-red-50\/20 { background-color: rgba(239,68,68,0.08) !important; }
        body.dark .text-red-500, body.dark .text-red-600, body.dark .text-red-400 { color: #f87171 !important; }
        body.dark .text-blue-500, body.dark .text-blue-600, body.dark .text-blue-400 { color: #93c5fd !important; }
        body.dark .text-green-500, body.dark .text-green-600, body.dark .text-green-400 { color: #86efac !important; }
        body.dark .text-amber-500, body.dark .text-amber-600 { color: #fbbf24 !important; }
        body.dark .text-orange-500 { color: #fb923c !important; }
        body.dark .text-purple-600, body.dark .text-purple-500 { color: #c084fc !important; }
        body.dark .bg-pink-500 { background-color: #7c3aed !important; }
        body.dark .bg-gradient-to-br, body.dark .bg-gradient-to-tr, body.dark .bg-gradient-to-r { background: #1a1d27 !important; }
        body.dark [class*="from-pink"], body.dark [class*="from-rose"], body.dark [class*="from-blue"],
        body.dark [class*="from-emerald"], body.dark [class*="from-purple"], body.dark [class*="from-yellow"],
        body.dark [class*="from-amber"], body.dark [class*="from-green"], body.dark [class*="from-red"],
        body.dark [class*="from-indigo"], body.dark [class*="from-orange"], body.dark [class*="from-cyan"] { background: #1a1d27 !important; }
        body.dark [class*="border-pink-100"], body.dark [class*="border-rose-100"], body.dark [class*="border-blue-100"],
        body.dark [class*="border-emerald-100"], body.dark [class*="border-purple-100"], body.dark [class*="border-orange-100"],
        body.dark [class*="border-amber-100"], body.dark [class*="border-green-100"], body.dark [class*="border-red-100"] { border-color: #2a2d3a !important; }
        body.dark .bg-white\/40 { background-color: rgba(255,255,255,0.05) !important; }
        body.dark .hover\:bg-pink-50\/30:hover, body.dark .hover\:bg-gray-50:hover { background-color: #22252f !important; }
        body.dark .hover\:bg-pink-100:hover, body.dark .hover\:bg-gray-100:hover { background-color: #22252f !important; }
        body.dark th.sortable:hover { background-color: #22252f !important; color: #a78bfa !important; }
        body.dark .batch-modified { background-color: rgba(251,146,60,0.1) !important; }
        body.dark .calendar-day { color: #8b90a0; }
        body.dark .calendar-day:hover { background-color: #22252f; border-color: #333848; }
        body.dark .calendar-day.today { background-color: #7c3aed; color: white; }
        body.dark .calendar-day.thursday { background-color: rgba(124,58,237,0.15); color: #c084fc; border-color: rgba(124,58,237,0.3); }
        body.dark .event-snippet { background-color: rgba(124,58,237,0.15); color: #c9cdd4; }
        body.dark .calendar-day.today .event-snippet { background-color: rgba(255,255,255,0.15); color: white; }
        body.dark .bg-green-50 { background-color: rgba(34,197,94,0.08) !important; }
        body.dark .bg-amber-50 { background-color: rgba(245,158,11,0.08) !important; }
        body.dark .bg-blue-50 { background-color: rgba(59,130,246,0.08) !important; }
        body.dark .bg-emerald-50 { background-color: rgba(16,185,129,0.08) !important; }
        body.dark .bg-purple-50 { background-color: rgba(168,85,247,0.08) !important; }
        body.dark [style*="background:#fdf2f8"], body.dark [style*="background:#fff1f2"],
        body.dark [style*="background:#eef2ff"], body.dark [style*="background:#fefce8"],
        body.dark [style*="background:#eff6ff"], body.dark [style*="background:#fffbeb"] {
            background: #22252f !important; border-color: #333848 !important;
        }
        body.dark ::-webkit-scrollbar-track { background: #14161e; }
        body.dark ::-webkit-scrollbar-thumb { background: #333848; }
        body.dark ::-webkit-scrollbar-thumb:hover { background: #444a5a; }
        body.dark #authOverlay { background: #0f1117 !important; }
        body.dark .bg-gradient-to-br.from-pink-50 { background: #0f1117 !important; }
        body.dark .score-zero { background-color: rgba(239,68,68,0.08) !important; color: #f87171 !important; }
        body.dark .analysis-table-wrap table tbody tr td:nth-child(1),
        body.dark .analysis-table-wrap table tbody tr td:nth-child(2) { background: #1a1d27 !important; }
        body.dark .analysis-table-wrap table tbody tr:hover td:nth-child(1),
        body.dark .analysis-table-wrap table tbody tr:hover td:nth-child(2) { background: #22252f !important; }
        body.dark .analysis-table-wrap table thead th:nth-child(1),
        body.dark .analysis-table-wrap table thead th:nth-child(2) { background: #14161e !important; }
        /* 모바일 하단 탭바 */
        .mobile-tab { color: #9ca3af; transition: all 0.15s; }
        .mobile-tab.active { color: #ec4899; }
        .mobile-tab:active { transform: scale(0.92); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 0); }
        @media (max-width: 1023px) {
            #contentArea { padding-bottom: 60px !important; }
        }
        body.dark #mobileTabBar { background: #14161e !important; border-color: #2a2d3a !important; }
        body.dark .mobile-tab { color: #6b7280; }
        body.dark .mobile-tab.active { color: #f472b6; }
        /* 홈 guide 콘텐츠 border 강제 제거 */
        .home-guide-content .border,
        .home-guide-content .border-gray-100,
        .home-guide-content .border-gray-200,
        .home-guide-content .border-pink-100,
        .home-guide-content .border-pink-200,
        .home-guide-content .border-red-100,
        .home-guide-content .border-blue-100,
        .home-guide-content [class*="border-"] {
            border-color: #f3f4f6 !important;
        }
        body.dark .home-guide-content .border,
        body.dark .home-guide-content [class*="border-"] {
            border-color: #374151 !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <!-- ★ 로그인 화면 ★ -->
    <div id="authOverlay" class="fixed inset-0 z-[20000] bg-gradient-to-br from-pink-50 via-white to-rose-50 flex items-center justify-center hidden">
        <div class="text-center w-80 p-8">
            <div class="w-20 h-20 rounded-3xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-200 text-3xl mx-auto mb-6">뚠</div>
            <h1 class="text-2xl font-black text-gray-800 tracking-tight mb-2">뚠카롱 길드 관리</h1>
            <p class="text-xs text-gray-400 font-bold mb-8">관리자 전용 페이지입니다</p>
            
            <div id="authLoginSection">
                <button onclick="window._authGoogleLogin()" id="googleLoginBtn" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 rounded-2xl px-6 py-4 font-bold text-sm text-gray-700 hover:border-pink-300 hover:shadow-lg transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Google 계정으로 로그인
                </button>
                <p class="text-[10px] text-gray-300 mt-4">허가된 Google 계정만 접근 가능합니다</p>
            </div>

            <div id="authCheckingSection" class="hidden">
                <div class="flex items-center justify-center gap-2 text-gray-400">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span class="text-xs font-bold">인증 확인 중...</span>
                </div>
            </div>

            <div id="authDeniedSection" class="hidden">
                <div class="bg-red-50 border border-red-200 rounded-2xl p-5 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-ban text-red-500 text-xl"></i></div>
                    <p class="text-sm font-bold text-red-600 mb-1">접근 권한이 없습니다</p>
                    <p id="authDeniedEmail" class="text-[10px] text-red-400"></p>
                </div>
                <button onclick="window._authLogout()" class="w-full py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-xs hover:bg-gray-200 transition-all">다른 계정으로 로그인</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="text-center w-72">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-200 text-2xl mx-auto mb-6">뚠</div>
            <p class="text-gray-800 font-black text-lg tracking-tight mb-1">뚠카롱 길드 관리</p>
            <p id="loadingStatus" class="text-gray-400 font-bold text-xs mb-6">서버 연결 중...</p>
            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden mb-3">
                <div id="loadingBar" class="h-full bg-gradient-to-r from-pink-400 to-rose-400 rounded-full transition-all duration-500 ease-out" style="width:5%"></div>
            </div>
            <p id="loadingPct" class="text-[10px] text-gray-300 font-bold">0%</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-4 right-4 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 z-[200] bg-slate-900 text-white px-5 lg:px-8 py-3 lg:py-4 rounded-xl lg:rounded-2xl shadow-2xl flex items-center gap-3 lg:gap-4 border border-white/10 max-w-md mx-auto sm:mx-0">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-[1000] w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">뚠</div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">뚠카롱 길드 현황</h1><p id="publicViewLabel" class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">PUBLIC VIEW</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-1 flex-1 overflow-y-auto no-scrollbar">
            <p class="px-4 pt-2 pb-2 text-[9px] font-bold text-gray-300 uppercase tracking-widest">메뉴</p>
            <button onclick="router('home')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="home"><i class="fas fa-home w-5 text-center text-xs"></i><span>홈</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="members"><i class="fas fa-users w-5 text-center text-xs"></i><span>길드원</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="analysis"><i class="fas fa-chart-line w-5 text-center text-xs"></i><span>수로 분석</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="bail"><i class="fas fa-gem w-5 text-center text-xs"></i><span>보석금</span></button>
            <button onclick="router('penalty')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="penalty"><i class="fas fa-exclamation-triangle w-5 text-center text-xs"></i><span>벌점</span></button>
            <p class="admin-only hidden px-4 pt-4 pb-2 text-[9px] font-bold text-gray-300 uppercase tracking-widest">관리자</p>
            <button onclick="router('suro_input')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="suro_input"><i class="fas fa-keyboard w-5 text-center text-xs"></i><span>수로 입력</span></button>
            <button onclick="router('role_assign')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="role_assign"><i class="fas fa-medal w-5 text-center text-xs"></i><span>직위 반영</span></button>
            <button onclick="router('guide_edit')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_edit"><i class="fas fa-edit w-5 text-center text-xs"></i><span>가이드 편집</span></button>
            <button onclick="router('sync')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="sync"><i class="fas fa-sync w-5 text-center text-xs"></i><span>동기화</span></button>
            <button onclick="router('sheet')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="sheet"><i class="fas fa-database w-5 text-center text-xs"></i><span>DB 시트</span></button>
            <button onclick="router('history')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="history"><i class="fas fa-history w-5 text-center text-xs"></i><span>운영 이력</span></button>
            <button onclick="router('settings')" class="admin-only hidden nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="settings"><i class="fas fa-cog w-5 text-center text-xs"></i><span>설정</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> Supabase Connected</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-[990] hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative z-0">
        <header class="h-14 lg:h-16 bg-white border-b border-gray-200 flex items-center justify-between px-3 lg:px-8 shrink-0 z-10 shadow-sm relative">
            <div class="flex items-center gap-2 lg:gap-4 min-w-0"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600 shrink-0"><i class="fas fa-bars text-lg"></i></button><h2 id="pageTitle" class="text-base lg:text-xl font-bold text-gray-800 tracking-tight truncate">대시보드</h2></div>
            <div class="flex items-center gap-2 lg:gap-4 shrink-0">
                <div class="px-2 lg:px-4 py-1 lg:py-1.5 bg-pink-50 text-pink-600 rounded-full text-[9px] lg:text-[11px] font-bold border border-pink-100 shadow-sm hidden md:block">
                    ✨ <span id="anniversaryLabel">로딩 중...</span>
                </div>
                <div class="flex items-center gap-1 lg:gap-1.5" id="totalMembersCount"></div>
                <button id="darkToggle" onclick="window.toggleDark()" class="w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm shrink-0" title="다크모드"><i class="fas fa-adjust text-xs lg:text-base"></i></button>
                <button id="refreshBtn" onclick="fetchMembers()" class="w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm shrink-0"><i class="fas fa-sync-alt text-xs lg:text-base"></i></button>
                <button id="headerLoginBtn" onclick="window._authGoogleLogin()" class="px-3 py-1.5 bg-pink-500 text-white rounded-xl text-[10px] font-bold hover:bg-pink-600 transition-all shadow-sm"><i class="fas fa-lock mr-1"></i>관리자</button>
                <button id="adminRequestBtn" onclick="window._requestAdminAccess()" class="hidden px-3 py-1.5 bg-amber-500 text-white rounded-xl text-[10px] font-bold hover:bg-amber-600 transition-all shadow-sm animate-pulse"><i class="fas fa-hand-paper mr-1"></i>관리자 요청</button>
                <div id="adminRequestStatus" class="hidden text-[9px] font-bold flex items-center"></div>
                <div id="headerUserInfo" class="hidden flex items-center gap-2">
                    <span id="headerUserName" class="text-[10px] font-bold text-gray-500 hidden lg:inline"></span>
                    <button onclick="window._authLogout()" class="w-8 h-8 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm" title="로그아웃"><i class="fas fa-sign-out-alt text-xs"></i></button>
                </div>
            </div>
        </header>
        <div id="contentArea" class="flex-1 overflow-y-auto p-2 sm:p-3 lg:p-6 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <!-- 모바일 하단 탭바 -->
    <nav id="mobileTabBar" class="lg:hidden fixed bottom-0 left-0 right-0 z-[999] bg-white border-t border-gray-200 shadow-[0_-2px_10px_rgba(0,0,0,0.06)] safe-bottom">
        <div class="flex items-center justify-around h-14 px-1">
            <button onclick="window._mobileTab('home')" class="mobile-tab flex flex-col items-center justify-center gap-0.5 flex-1 h-full" data-tab="home">
                <i class="fas fa-home text-sm"></i>
                <span class="text-[9px] font-bold">홈</span>
            </button>
            <button onclick="window._mobileTab('members')" class="mobile-tab flex flex-col items-center justify-center gap-0.5 flex-1 h-full" data-tab="members">
                <i class="fas fa-users text-sm"></i>
                <span class="text-[9px] font-bold">길드원</span>
            </button>
            <button onclick="window._mobileTab('analysis')" class="mobile-tab flex flex-col items-center justify-center gap-0.5 flex-1 h-full" data-tab="analysis">
                <i class="fas fa-chart-line text-sm"></i>
                <span class="text-[9px] font-bold">수로</span>
            </button>
            <button onclick="window._mobileTab('bail')" class="mobile-tab flex flex-col items-center justify-center gap-0.5 flex-1 h-full" data-tab="bail">
                <i class="fas fa-gem text-sm"></i>
                <span class="text-[9px] font-bold">보석금</span>
            </button>
            <button onclick="window._mobileOpenMore()" class="mobile-tab flex flex-col items-center justify-center gap-0.5 flex-1 h-full" data-tab="more">
                <i class="fas fa-bars text-sm"></i>
                <span class="text-[9px] font-bold">더보기</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="memberModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold p-4"><div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100"><div class="p-5 lg:p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center"><div><h3 id="modalTitle" class="text-base lg:text-lg font-bold text-pink-700 tracking-tight">멤버 정보 입력</h3></div><button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button></div><form id="memberForm" class="p-6 lg:p-8 space-y-4 lg:space-y-5"><input type="hidden" id="editMemberId"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">닉네임</label><input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="정확한 캐릭터명"></div><div class="grid grid-cols-2 gap-3 lg:gap-4"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">소속</label><select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">직위</label><select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none"></select></div></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">직업</label><select id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none shadow-inner cursor-pointer"><option value="">직업을 선택하세요</option></select></div><div class="flex items-center gap-3 py-1"><input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()"><label for="inputIsMain" class="text-[10px] lg:text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">본캐릭터입니까?</label></div><div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">본캐 닉네임</label><input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-xl lg:rounded-2xl p-3 lg:p-3.5 text-xs lg:text-sm font-bold outline-none shadow-inner" placeholder="본캐릭명 입력"></div><button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-3.5 lg:py-4 rounded-xl lg:rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">데이터베이스에 저장</button></form></div></div>
    
    <div id="deleteModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold p-4"><div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 lg:p-10 text-center border border-gray-50"><div class="w-14 h-14 lg:w-16 lg:h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-xl lg:text-2xl mx-auto mb-4 lg:mb-5 shadow-inner"><i class="fas fa-user-minus"></i></div><p class="text-gray-800 font-bold text-base lg:text-lg mb-5 lg:mb-6 leading-tight"><span id="deleteTargetName" class="text-red-500"></span> 제거 확정</p><div class="space-y-3 lg:space-y-4 text-left mb-6 lg:mb-8"><div class="flex gap-2"><button onclick="setDeleteType('leave')" id="btnLeave" class="flex-1 py-2.5 lg:py-3 rounded-xl font-bold text-[10px] lg:text-xs bg-gray-800 text-white shadow-sm transition-all">자진탈퇴</button><button onclick="setDeleteType('kick')" id="btnKick" class="flex-1 py-2.5 lg:py-3 rounded-xl font-bold text-[10px] lg:text-xs bg-gray-100 text-gray-400 transition-all">추방</button></div><input type="text" id="deleteReason" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-[10px] lg:text-xs font-bold outline-none shadow-inner" placeholder="사유를 입력하세요 (이력용)"></div><div class="grid grid-cols-2 gap-3 lg:gap-4"><button onclick="closeModal('deleteModal')" class="py-3.5 lg:py-4 bg-gray-50 rounded-xl lg:rounded-2xl font-bold text-[10px] lg:text-xs text-gray-500 hover:bg-gray-100 transition-all">취소</button><button onclick="confirmDelete()" class="py-3.5 lg:py-4 bg-red-500 text-white rounded-xl lg:rounded-2xl font-bold text-[10px] lg:text-xs shadow-xl hover:bg-red-600 transition-all">삭제 확정</button></div></div></div>

    <!-- 일괄 등록 모달 -->
    <div id="bulkAddModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden border border-gray-100 flex flex-col">
            <div class="p-4 lg:p-5 bg-pink-50 border-b border-pink-100 flex justify-between items-center shrink-0">
                <div>
                    <h3 class="text-sm lg:text-base font-bold text-pink-700">멤버 일괄 등록</h3>
                    <p class="text-[9px] text-pink-400 mt-0.5">가로로 입력 후 행 추가로 여러 명을 한번에 등록하세요</p>
                </div>
                <button onclick="closeModal('bulkAddModal')" class="w-8 h-8 rounded-lg hover:bg-pink-100 text-pink-400 transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-4">
                <div class="overflow-x-auto">
                    <table class="w-full text-xs" id="bulkAddTable">
                        <thead>
                            <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                <th class="p-2 w-8 text-center">#</th>
                                <th class="p-2 text-left" style="min-width:120px">닉네임 *</th>
                                <th class="p-2 text-left" style="min-width:100px">소속 *</th>
                                <th class="p-2 text-left" style="min-width:100px">직위</th>
                                <th class="p-2 text-left" style="min-width:120px">직업</th>
                                <th class="p-2 text-center" style="min-width:60px">본캐</th>
                                <th class="p-2 text-left" style="min-width:120px">본캐닉</th>
                                <th class="p-2 w-8"></th>
                            </tr>
                        </thead>
                        <tbody id="bulkAddBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex items-center justify-between shrink-0 bg-gray-50">
                <div class="flex gap-2">
                    <button onclick="window._bulkAddRow()" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-[10px] font-bold text-gray-600 hover:bg-gray-50 transition-all"><i class="fas fa-plus mr-1"></i>행 추가</button>
                    <button onclick="window._bulkAddRows(5)" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-[10px] font-bold text-gray-400 hover:bg-gray-50 transition-all">+5행</button>
                </div>
                <div class="flex gap-2 items-center">
                    <span id="bulkAddCount" class="text-[10px] text-gray-400"></span>
                    <button onclick="window._bulkAddSave()" id="bulkAddSaveBtn" class="px-6 py-2.5 bg-pink-500 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-pink-600 transition-all"><i class="fas fa-save mr-1"></i>일괄 저장</button>
                </div>
            </div>
        </div>
    </div>

    <div id="eventDetailModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 lg:p-10 border border-gray-50 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-5 lg:mb-6 shrink-0">
                <h3 id="eventDetailDate" class="text-xl lg:text-2xl font-black text-slate-800 tracking-tighter">Date</h3>
                <button onclick="closeModal('eventDetailModal')" class="text-gray-400 hover:text-gray-600 text-lg lg:text-xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="eventListForDate" class="flex flex-col gap-2 mb-5 lg:mb-6 overflow-y-auto no-scrollbar shrink-0 max-h-[120px] lg:max-h-[150px]">
            </div>

            <div class="space-y-5 lg:space-y-6 flex-1 overflow-y-auto no-scrollbar">
                <div class="flex justify-between items-end">
                    <span class="text-[9px] lg:text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">일정 내용</span>
                    <button onclick="window.resetEventForm()" class="text-[9px] lg:text-[10px] bg-pink-50 text-pink-500 px-2 lg:px-3 py-1 rounded-lg font-bold hover:bg-pink-100 transition-colors">+ 새 일정</button>
                </div>
                
                <div class="space-y-2">
                    <input type="text" id="eventTitleInput" class="w-full border border-gray-100 bg-gray-50/50 rounded-xl lg:rounded-2xl p-3.5 lg:p-4 outline-none focus:ring-4 focus:ring-pink-50 text-xs lg:text-sm font-bold shadow-inner placeholder:text-gray-300" placeholder="제목 (예: 수로 정산)">
                </div>
                
                <div class="space-y-2">
                    <textarea id="eventContentInput" rows="3" class="w-full border border-gray-100 bg-gray-50/50 rounded-xl lg:rounded-2xl p-3.5 lg:p-4 outline-none focus:ring-4 focus:ring-pink-50 text-xs lg:text-sm font-bold shadow-inner resize-none placeholder:text-gray-300" placeholder="상세 내용을 입력하세요."></textarea>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 lg:gap-4 mt-6 lg:mt-8 shrink-0">
                <button onclick="deleteEvent()" id="btnDeleteEvent" class="py-3.5 lg:py-4 bg-rose-50 text-rose-500 rounded-xl lg:rounded-[1.5rem] font-bold text-[10px] lg:text-sm hover:bg-rose-100 transition-all hidden">삭제</button>
                <button onclick="saveEvent()" id="btnSaveEvent" class="col-span-2 py-3.5 lg:py-4 bg-[#1e232d] text-white rounded-xl lg:rounded-[1.5rem] font-bold text-[10px] lg:text-sm shadow-xl hover:bg-black transition-all">저장</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://luglshrfkkeacmefnvlm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1Z2xzaHJma2tlYWNtZWZudmxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjE0NTIsImV4cCI6MjA4NzYzNzQ1Mn0.LrJ-ejXJGqVGzrJyL5nFW45J92-MxrcKuEpE2EGNsIo';
        const supaDb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ═══════════════════════════════════════════════════════════════
        // ██  Google 로그인 인증 시스템  ██
        // ═══════════════════════════════════════════════════════════════
        
        let CURRENT_USER = null; // { email, name, avatar }
        let userRole = 'guest'; // guest, member, admin
        window.isAdmin = () => userRole === 'admin';
        window.isLoggedIn = () => userRole !== 'guest';
        
        window._authGoogleLogin = async () => {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>로그인 중...';
            try {
                const { error } = await supaDb.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.href.split('?')[0].split('#')[0] }
                });
                if (error) throw error;
            } catch (e) {
                btn.disabled = false;
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google 계정으로 로그인';
                alert('로그인 실패: ' + e.message);
            }
        };
        
        window._authLogout = async () => {
            await supaDb.auth.signOut();
            userRole = 'guest';
            CURRENT_USER = null;
            window._updateAuthUI();
            window.showMsg('로그아웃 되었습니다.', 'success');
            window.fetchMembers();
        };
        
        window._authCheck = async () => {
            const authOverlay = document.getElementById('authOverlay');
            
            const { data: { session } } = await supaDb.auth.getSession();
            
            if (!session) {
                // 비로그인 → guest 모드 (퍼블릭 뷰)
                userRole = 'guest';
                CURRENT_USER = null;
                if (authOverlay) authOverlay.classList.add('hidden');
                window._updateAuthUI();
                return false;
            }
            
            const userEmail = session.user.email;
            const userName = session.user.user_metadata?.full_name || session.user.user_metadata?.name || userEmail;
            const userAvatar = session.user.user_metadata?.avatar_url || '';
            CURRENT_USER = { email: userEmail, name: userName, avatar: userAvatar };
            
            // admin_whitelist 체크
            let foundAdmin = false;
            try {
                const { data: wl, error: wlErr } = await supaDb.from('admin_whitelist')
                    .select('email, name, role, status')
                    .eq('email', userEmail).maybeSingle();
                
                if (!wlErr && wl && wl.status === 'approved') {
                    userRole = 'admin';
                    CURRENT_USER.role = wl.role || '관리자';
                    foundAdmin = true;
                }
            } catch(e) {}
            
            // admin_auth 폴백
            if (!foundAdmin) {
                try {
                    const { data: aa, error: aaErr } = await supaDb.from('admin_auth')
                        .select('email').eq('email', userEmail).maybeSingle();
                    if (!aaErr && aa) {
                        userRole = 'admin';
                        CURRENT_USER.role = '관리자';
                        foundAdmin = true;
                    }
                } catch(e2) {}
            }
            
            if (!foundAdmin) userRole = 'member';
            
            if (authOverlay) authOverlay.classList.add('hidden');
            window._updateAuthUI();
            console.log('[Auth]', userEmail, '→', userRole);
            return userRole === 'admin';
        };
        

        window._updateAuthUI = () => {
            const loginBtn = document.getElementById('headerLoginBtn');
            const userInfo = document.getElementById('headerUserInfo');
            const userNameEl = document.getElementById('headerUserName');
            const adminMenus = document.querySelectorAll('.admin-only');
            const publicLabel = document.getElementById('publicViewLabel');
            
            if (isAdmin() && CURRENT_USER) {
                if (loginBtn) loginBtn.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                if (userNameEl) userNameEl.textContent = CURRENT_USER.name || CURRENT_USER.email;
                adminMenus.forEach(el => el.classList.remove('hidden'));
                if (publicLabel) publicLabel.textContent = 'ADMIN';
                // 요청 버튼 숨김
                document.getElementById('adminRequestBtn')?.classList.add('hidden');
                document.getElementById('adminRequestStatus')?.classList.add('hidden');
            } else if (CURRENT_USER) {
                // 로그인 했지만 admin 아님
                if (loginBtn) loginBtn.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                if (userNameEl) userNameEl.textContent = CURRENT_USER.name || CURRENT_USER.email;
                adminMenus.forEach(el => el.classList.add('hidden'));
                if (publicLabel) publicLabel.textContent = 'PUBLIC VIEW';
                // 관리자 요청 상태 확인
                window._checkAdminRequestStatus();
            } else {
                // guest
                if (loginBtn) loginBtn.classList.remove('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                adminMenus.forEach(el => el.classList.add('hidden'));
                if (publicLabel) publicLabel.textContent = 'PUBLIC VIEW';
                document.getElementById('adminRequestBtn')?.classList.add('hidden');
                document.getElementById('adminRequestStatus')?.classList.add('hidden');
            }
        };

        // 관리자 요청 상태 확인
        window._checkAdminRequestStatus = async () => {
            if (!CURRENT_USER) return;
            const reqBtn = document.getElementById('adminRequestBtn');
            const reqStatus = document.getElementById('adminRequestStatus');
            if (!reqBtn || !reqStatus) return;

            try {
                const { data: wl } = await supaDb.from('admin_whitelist')
                    .select('status').eq('email', CURRENT_USER.email).maybeSingle();

                if (!wl) {
                    // 요청 이력 없음 → 요청 버튼 표시
                    reqBtn.classList.remove('hidden');
                    reqStatus.classList.add('hidden');
                } else if (wl.status === 'pending') {
                    // 대기 중
                    reqBtn.classList.add('hidden');
                    reqStatus.classList.remove('hidden');
                    reqStatus.innerHTML = '<i class="fas fa-clock text-amber-400 mr-1"></i><span class="text-amber-500">승인 대기 중</span>';
                    window._startAdminPoll();
                } else if (wl.status === 'rejected') {
                    // 거절됨
                    reqBtn.classList.add('hidden');
                    reqStatus.classList.remove('hidden');
                    reqStatus.innerHTML = '<i class="fas fa-times-circle text-red-400 mr-1"></i><span class="text-red-400">요청 거절됨</span>';
                } else if (wl.status === 'approved') {
                    // 승인됨 → 관리자로 전환 (새로고침 없이)
                    userRole = 'admin';
                    CURRENT_USER.role = wl.role || '관리자';
                    reqBtn.classList.add('hidden');
                    reqStatus.classList.add('hidden');
                    if (window._adminPollTimer) { clearInterval(window._adminPollTimer); window._adminPollTimer = null; }
                    window.showMsg('🎉 관리자 권한이 승인되었습니다! 관리자 메뉴가 활성화됩니다.', 'success');
                    window._updateAuthUI();
                    // 현재 페이지 재렌더
                    router(appState.activeTab);
                }
            } catch(e) {
                console.error('Admin request check error:', e);
            }
        };

        // 관리자 권한 요청
        window._requestAdminAccess = async () => {
            if (!CURRENT_USER) return;
            if (!confirm('관리자 권한을 요청하시겠습니까?\n기존 관리자가 승인하면 관리자 기능을 사용할 수 있습니다.')) return;

            try {
                const { error } = await supaDb.from('admin_whitelist').insert({
                    email: CURRENT_USER.email,
                    name: CURRENT_USER.name || '',
                    status: 'pending',
                    role: '관리자',
                    requested_at: new Date().toISOString()
                });
                if (error) {
                    if (error.code === '23505') {
                        window.showMsg('이미 요청한 이력이 있습니다.', 'error');
                    } else throw error;
                } else {
                    window.showMsg('관리자 권한 요청이 전송되었습니다! 기존 관리자의 승인을 기다려주세요.', 'success');
                }
                window._checkAdminRequestStatus();
                // 승인 대기 폴링 시작
                window._startAdminPoll();
            } catch(e) {
                window.showMsg('요청 실패: ' + e.message, 'error');
            }
        };

        // 비관리자 승인 대기 시 30초마다 폴링
        window._adminPollTimer = null;
        window._startAdminPoll = () => {
            if (window._adminPollTimer) return;
            window._adminPollTimer = setInterval(async () => {
                if (isAdmin() || !CURRENT_USER) {
                    clearInterval(window._adminPollTimer);
                    window._adminPollTimer = null;
                    return;
                }
                await window._checkAdminRequestStatus();
            }, 15000); // 15초마다 체크
        };

        let GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["히어로","팔라딘","다크나이트","아크메이지(불,독)","아크메이지(썬,콜)","비숍","보우마스터","신궁","패스파인더","나이트로드","섀도어","듀얼블레이드","바이퍼","캡틴","캐논마스터","미하일","소울마스터","플레임위자드","윈드브레이커","나이트워커","스트라이커","아란","에반","루미너스","메르세데스","팬텀","은월","데몬슬레이어","데몬어벤져","블래스터","배틀메이지","와일드헌터","메카닉","제논","카이저","카인","카데나","엔젤릭버스터","라라","호영","아델","일리움","아크","칼리","제로","키네시스","렌"];
        const baseRanks = ['마카롱', '다쿠아즈'];
        let initialGuildRanks = {
            '뚠카롱': [...baseRanks, '크라운', '파르페', '티라미슈', '크로칸슈', '롤케이크', '팬케이크', '와플', '스콘', '반죽(휴면)'],
            '뚱카롱': [...baseRanks, '뚠케이크', '뚠브레드', '아인슈페너', '부팬케이크', '수플레', '뚠스콘', '부케이크', '반죽(휴면)'],
            '밤카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너', '반죽(휴면)'],
            '별카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너', '반죽(휴면)'],
            '달카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너', '반죽(휴면)'],
            '꿀카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너', '반죽(휴면)']
        };
        let SITE_CONFIG = null;
        const ITEMS_PER_PAGE = 17;

        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'home',
            guilds: [
                { id: 'ddun', name: '뚠카롱', type: '메인 1기', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: '뚱카롱', type: '메인 2기', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: '밤카롱', type: '부캐 1기', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: '별카롱', type: '부캐 2기', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: '달카롱', type: '부캐 3기', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: '꿀카롱', type: '부캐 4기', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            events: [],
            penaltyHistory: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'avg', sortOrder: 'desc', search: '' },
            analysisGuild: '뚠카롱',
            isBatchMode: false, pendingUpdates: {},
            isKickMode: false, kickSelection: new Set(),
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            guildRanks: initialGuildRanks,
            currentSelectedDate: null,
            currentEditingEvent: null,
            pagination: { members: 1, analysis: 1 } 
        };

        // ===== 다크모드 =====
        window.toggleDark = () => {
            document.documentElement.classList.toggle('dark');
            document.body.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('adminDarkMode', isDark ? '1' : '0');
            const icon = document.querySelector('#darkToggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun text-xs lg:text-base text-amber-400' : 'fas fa-adjust text-xs lg:text-base';
            // 길드원 테이블 행 색상 재적용
            if (appState.activeTab === 'members') window.updateMemberTable();
        };
        if (localStorage.getItem('adminDarkMode') === '1') {
            document.documentElement.classList.add('dark');
            document.body.classList.add('dark');
            setTimeout(() => {
                const icon = document.querySelector('#darkToggle i');
                if (icon) icon.className = 'fas fa-sun text-xs lg:text-base text-amber-400';
            }, 100);
        }

        // ===== 개인 수로 데이터 모달 =====
        window.showPersonalSuro = (memberName) => {
            var member = appState.members.find(function(m){ return m.name === memberName; });
            if (!member) return;
            var headers = [].concat(appState.suroHeaders);
            var scores = headers.map(function(h){ return Math.round(Number(member.suro && member.suro[h])) || 0; });
            var validScores = scores.filter(function(s){ return s > 0; });
            var avg = validScores.length > 0 ? Math.round(validScores.reduce(function(a,b){return a+b;},0) / validScores.length) : 0;
            var mx = validScores.length > 0 ? Math.max.apply(null, validScores) : 0;
            var mn = validScores.length > 0 ? Math.min.apply(null, validScores) : 0;
            var participation = scores.length > 0 ? Math.round((validScores.length / scores.length) * 100) : 0;
            var getWedStr = function(h){ var p=h.split('~'); return p.length>1?p[1].replace('수로 점수','').trim():h.trim(); };
            var recentScores = scores.slice(-4);
            var recentHeaders = headers.slice(-4);
            var maxBarVal = Math.max.apply(null, recentScores.concat([1]));
            var dk = document.body.classList.contains('dark');
            var trendHtml = '';
            recentHeaders.forEach(function(h, i) {
                var s = recentScores[i], pct = Math.round((s / maxBarVal) * 100);
                var prev = i > 0 ? recentScores[i-1] : 0, diffHtml = '';
                if (prev > 0 && s > 0) { var dp = ((s-prev)/prev*100); if(s>prev) diffHtml='<span class="text-red-500 text-[9px] ml-1">\u25B2'+dp.toFixed(1)+'%</span>'; else if(s<prev) diffHtml='<span class="text-blue-500 text-[9px] ml-1">\u25BC'+Math.abs(dp).toFixed(1)+'%</span>'; }
                trendHtml += '<div><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold '+(dk?'text-gray-400':'text-gray-600')+'">'+getWedStr(h)+'</span><span class="text-xs font-black '+(s===0?'text-red-400':dk?'text-gray-200':'text-gray-700')+'">'+(s>0?s.toLocaleString():'0')+diffHtml+'</span></div><div class="w-full '+(dk?'bg-gray-700':'bg-gray-100')+' rounded-full h-2.5 overflow-hidden"><div class="h-full rounded-full transition-all duration-700 '+(s===0?'bg-red-300':'bg-gradient-to-r from-pink-400 to-rose-400')+'" style="width:'+pct+'%"></div></div></div>';
            });
            var allHtml = '';
            var revHeaders = [].concat(headers).reverse();
            revHeaders.forEach(function(h, i) {
                var idx2 = headers.length - 1 - i, s = scores[idx2];
                var cls = s===0?(dk?'bg-red-900/20 text-red-400':'bg-red-50 text-red-400'):(i%2===0?(dk?'bg-gray-800':'bg-gray-50'):'');
                allHtml += '<div class="flex justify-between items-center py-1.5 px-2 rounded-lg text-[11px] font-bold '+cls+'"><span class="'+(dk?'text-gray-400':'text-gray-500')+'">'+getWedStr(h)+'</span><span class="'+(s===0?'text-red-400':dk?'text-gray-200':'text-gray-700')+'">'+(s>0?s.toLocaleString():'0')+'</span></div>';
            });
            var overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
            overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };
            function statCard(label,value,colorName){ return '<div class="text-center p-3 rounded-xl '+(dk?'bg-'+colorName+'-900/30 border border-'+colorName+'-800/30':'bg-'+colorName+'-50 border border-'+colorName+'-100')+'"><p class="text-[8px] '+(dk?'text-'+colorName+'-300':'text-'+colorName+'-500')+' font-bold uppercase">'+label+'</p><p class="text-lg font-black '+(dk?'text-'+colorName+'-300':'text-'+colorName+'-600')+'">'+value+'</p></div>'; }
            overlay.innerHTML = '<div style="background:'+(dk?'#1a1d27':'white')+';border-radius:1.5rem;width:100%;max-width:500px;max-height:85vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;">'+'<div class="p-5 border-b '+(dk?'border-gray-700':'border-gray-100')+' flex justify-between items-center shrink-0"><div class="flex items-center gap-3">'+window.getNicknameIcon(member.role)+'<div><h3 class="text-lg font-bold '+(dk?'text-gray-100':'text-gray-800')+'">'+member.name+'</h3><p class="text-[10px] '+(dk?'text-gray-400':'text-gray-500')+'">'+member.guild+' \xB7 '+(member.class||'-')+' \xB7 '+(member.role||'-')+'</p></div></div><button onclick="this.closest(\'[style*=position\\:fixed]\')" class="w-8 h-8 rounded-full '+(dk?'bg-gray-700 hover:bg-gray-600 text-gray-300':'bg-gray-100 hover:bg-gray-200 text-gray-500')+' flex items-center justify-center transition-colors" id="pSuroClose"><i class="fas fa-times"></i></button></div>'+'<div class="p-5 flex-1 overflow-y-auto">'+'<div class="grid grid-cols-4 gap-2 mb-5">'+statCard('\uD3C9\uADE0',avg.toLocaleString(),'pink')+statCard('\uCD5C\uACE0',mx.toLocaleString(),'blue')+statCard('\uCD5C\uC800',mn.toLocaleString(),'amber')+statCard('\uCC38\uC5EC\uC728',participation+'%','green')+'</div>'+'<div class="mb-5"><p class="text-[10px] '+(dk?'text-gray-400':'text-gray-500')+' font-bold uppercase tracking-widest mb-3">\uCD5C\uADFC \uCD94\uC138</p><div class="space-y-2">'+trendHtml+'</div></div>'+'<div><p class="text-[10px] '+(dk?'text-gray-400':'text-gray-500')+' font-bold uppercase tracking-widest mb-3">\uC804\uCCB4 \uAE30\uB85D ('+headers.length+'\uC8FC\uCC28)</p><div class="max-h-[200px] overflow-y-auto space-y-1">'+allHtml+'</div></div>'+'</div></div>';
            document.body.appendChild(overlay);
            document.getElementById('pSuroClose').onclick = function(){ overlay.remove(); };
        };

        window.showMsg = (text, type = 'info') => {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        };
        window.showLoading = (show) => { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); };
        window.setLoadProgress = (pct, status) => {
            const bar = document.getElementById('loadingBar');
            const pctEl = document.getElementById('loadingPct');
            const statusEl = document.getElementById('loadingStatus');
            if(bar) bar.style.width = pct + '%';
            if(pctEl) pctEl.textContent = pct + '%';
            if(status && statusEl) statusEl.textContent = status;
        };
        
        window.getAnniversaryInfo = () => {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years, remainingDays };
        };
        
        window.updateAnniversaryLabel = () => {
            const anniv = window.getAnniversaryInfo();
            const el = document.getElementById('anniversaryLabel');
            if (el) el.innerText = `뚠카롱이 생성된 지 ${anniv.totalDays}일 (${anniv.years}년 ${anniv.remainingDays}일)`;
        };

        window.calculateTotalSuro = (guildName) => {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members
                .filter(m => (m.guild || '').trim() === guildName.trim())
                .reduce((s, m) => s + (Math.round(Number(m.suro?.[lastHeader])) || 0), 0);
        };

        window.getAdminBailStats = () => {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        };
        window.getBailTotalStats = () => {
            let totalIn = 0, totalOut = 0;
            appState.bailHistory.forEach(h => { const a = parseInt(h.amount) || 0; if(a > 0) totalIn += a; else totalOut += Math.abs(a); });
            return { totalIn, totalOut, net: totalIn - totalOut };
        };

        let ROLE_PRIORITY = {'마카롱':0,'다쿠아즈':1,'크라운':2,'파르페':3,'티라미슈':4,'크로칸슈':5,'롤케이크':6,'팬케이크':7,'와플':8,'스콘':9,'반죽(휴면)':10,'뚠케이크':2,'뚠브레드':3,'아인슈페너':4,'부팬케이크':5,'수플레':6,'뚠스콘':7,'부케이크':8};

        function smartCompare(a, b, field, order) {
            let valA = a[field]; let valB = b[field];
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }
            if (field === 'role') {
                const pA = ROLE_PRIORITY[valA] !== undefined ? ROLE_PRIORITY[valA] : 99;
                const pB = ROLE_PRIORITY[valB] !== undefined ? ROLE_PRIORITY[valB] : 99;
                if (pA !== pB) return order === 'asc' ? pA - pB : pB - pA;
                return 0;
            }
            if (valA === valB) return 0;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const strA = String(valA || ""); const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        window.getNicknameIcon = (role) => {
            if (role === '마카롱') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === '다쿠아즈') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        };

        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const special = ['크라운', '파르페', '티라미슈', '크로칸슈'];
            if (special.includes(rank)) return `${rank} <span class="text-[8.5px] text-blue-500 font-bold tracking-tighter">(아인슈페너)</span>`;
            return rank;
        }

        window.getSuroPeriodHeader = (dateObj) => { 
            const now = dateObj || new Date(); 
            const day = now.getDay(); 
            let daysSinceWed = day - 3; 
            if (daysSinceWed < 0) daysSinceWed += 7; 
            const endDate = new Date(now); 
            endDate.setDate(now.getDate() - daysSinceWed); 
            const startDate = new Date(endDate); 
            startDate.setDate(endDate.getDate() - 6); 
            const f = (d) => { 
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(목) ~ ${f(endDate)}(수) 수로 점수`; 
        };

        window.toggleBatchMode = () => { 
            appState.isBatchMode = !appState.isBatchMode; 
            if(appState.isBatchMode) {
                appState.isKickMode = false;
                appState.kickSelection.clear();
            }
            appState.pendingUpdates = {}; 
            window.renderMembers(document.getElementById('contentArea')); 
        };

        window.stageUpdate = (id, field, val) => { 
            if(!appState.pendingUpdates[id]) appState.pendingUpdates[id] = { id }; 
            appState.pendingUpdates[id][field] = val; 
            window.updateMemberTable(); 
        };

        window.saveBatchUpdates = async () => { 
            const updates = Object.values(appState.pendingUpdates); 
            if(updates.length === 0) return window.showMsg("수정된 내용이 없습니다.", "error"); 
            
            if(confirm(`${updates.length}명의 정보를 업데이트하시겠습니까?`)) { 
                window.showLoading(true); 
                window.setLoadProgress(10, '일괄 수정 준비 중...');
                
                const allMembers = appState.members.map(m => {
                    const upd = appState.pendingUpdates[m.id];
                    return {
                        name: m.name, guild: upd?.guild !== undefined ? upd.guild : m.guild,
                        role: upd?.role !== undefined ? upd.role : m.role,
                        class: upd?.class !== undefined ? upd.class : (m.class || ''),
                        isMain: m.isMain || false,
                        mainCharName: m.mainCharName || '', joinDate: m.joinDate || ''
                    };
                });
                
                window.setLoadProgress(30, '서버에 전송 중...');
                const success = await window.sendAction('save_members', { members: allMembers });
                
                window.setLoadProgress(80, '데이터 갱신 중...');
                if(success) {
                    window.showMsg(`${updates.length}명의 정보가 저장되었습니다.`, "success");
                    appState.isBatchMode = false; 
                    appState.pendingUpdates = {};
                    await window.fetchMembers();
                }
                window.showLoading(false);
            } 
        };

        window.toggleKickMode = () => {
            appState.isKickMode = !appState.isKickMode;
            if(appState.isKickMode) {
                appState.isBatchMode = false;
                appState.pendingUpdates = {};
            }
            appState.kickSelection.clear();
            window.renderMembers(document.getElementById('contentArea'));
        };

        window.handleKickSelect = (id) => {
            if(appState.kickSelection.has(id)) appState.kickSelection.delete(id);
            else appState.kickSelection.add(id);
            window.renderMembers(document.getElementById('contentArea'));
        };

        window.openBulkKickModal = () => {
            if(appState.kickSelection.size === 0) return window.showMsg("선택된 인원이 없습니다.", "error");
            appState.deleteType = 'kick'; 
            document.getElementById('deleteTargetName').innerText = `'${appState.kickSelection.size}명'`;
            document.getElementById('btnLeave').classList.add('hidden');
            document.getElementById('btnKick').classList.add('hidden');
            document.getElementById('deleteReason').value = '';
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        window.fetchMembers = async () => {
            window.showLoading(true);
            window.setLoadProgress(5, '서버 연결 중...');
            try {
                let fakePct = 5;
                const fakeTimer = setInterval(() => {
                    if(fakePct < 70) { fakePct += Math.random() * 8 + 2; window.setLoadProgress(Math.min(Math.round(fakePct), 70), '데이터 수신 중...'); }
                }, 400);

                // 헬퍼: 1000행 제한 우회 (전체 행 가져오기)
                async function fetchAll(table, orderCol, ascending = true) {
                    const pageSize = 1000;
                    let allData = [], from = 0;
                    while (true) {
                        const { data, error } = await supaDb.from(table).select('*').order(orderCol, { ascending }).range(from, from + pageSize - 1);
                        if (error) throw error;
                        allData = allData.concat(data || []);
                        if (!data || data.length < pageSize) break;
                        from += pageSize;
                    }
                    return allData;
                }

                // 0) site_config 로드 (디자인 설정)
                try {
                    const { data: cfgRow } = await supaDb.from('site_config').select('config').eq('id', 1).maybeSingle();
                    if (cfgRow && cfgRow.config) {
                        const cfg = cfgRow.config;
                        SITE_CONFIG = cfg;
                        if (cfg.guilds) appState.guilds = cfg.guilds;
                        if (cfg.ranks) {
                            initialGuildRanks = cfg.ranks;
                            appState.guildRanks = cfg.ranks;
                        }
                        if (cfg.rolePriority) ROLE_PRIORITY = cfg.rolePriority;
                        if (cfg.guildStartDate) GUILD_START_DATE = new Date(cfg.guildStartDate);
                    }
                } catch(e) { console.warn('site_config 로드 실패, 기본값 사용:', e); }

                // 1) 멤버 조회
                const members = await fetchAll('members', 'name');

                // 2) 수로 기간 조회
                const periods = await fetchAll('suro_periods', 'period_label');

                // 3) 수로 점수 조회
                const scores = await fetchAll('suro_scores', 'id');

                // 4) 보석금 조회
                const bail = isAdmin() ? await fetchAll('bail_history', 'date') : await fetchAll('bail_history', 'date');

                // 5) 벌점 조회
                const penalties = await fetchAll('penalty_history', 'date');

                // 6) 일정 조회
                const events = await fetchAll('events', 'date');

                // 7) 운영이력 조회
                const history = await fetchAll('operation_history', 'date');

                clearInterval(fakeTimer);
                window.setLoadProgress(80, '데이터 파싱 중...');

                // 수로 헤더 목록
                const suroHeaders = periods.map(p => p.period_label);

                // 점수를 멤버별로 매핑
                const scoreMap = {};
                scores.forEach(s => {
                    if (!scoreMap[s.member_id]) scoreMap[s.member_id] = {};
                    const period = periods.find(p => p.id === s.period_id);
                    if (period) scoreMap[s.member_id][period.period_label] = s.score;
                });

                window.setLoadProgress(85, '길드원 정보 처리 중...');

                appState.members = members.map(m => ({
                    id: String(m.id),
                    name: m.name,
                    guild: m.guild,
                    role: m.role,
                    class: m.class || '',
                    level: m.level || 0,
                    isMain: m.is_main,
                    mainCharName: m.main_char_name || '',
                    joinDate: m.join_date || '',
                    suro: scoreMap[m.id] || {}
                }));

                appState.suroHeaders = suroHeaders;

                if (isAdmin()) {
                    appState.bailHistory = bail.map(b => ({
                        id: b.id, date: b.date, payer: b.payer, receiver: b.receiver,
                        amount: b.amount, memo: b.memo || ''
                    }));
                } else {
                    appState.bailHistory = bail.map(b => ({
                        receiver: b.receiver, amount: b.amount
                    }));
                }

                if (isAdmin()) {
                    appState.penaltyHistory = penalties.map(p => ({
                        id: p.id, date: p.date, name: p.name, points: p.points, reason: p.reason || ''
                    }));
                } else {
                    appState.penaltyHistory = penalties.map((p, idx) => ({
                        name: '비공개', points: p.points, reason: '비공개', date: '-', _uid: idx
                    }));
                }

                appState.events = events.map(e => ({
                    id: String(e.id),
                    date: (e.date || '').split('T')[0].trim(),
                    title: e.title,
                    content: e.content || ''
                }));

                appState.history = history.map(h => ({
                    id: h.id, date: h.date, category: h.category, name: h.name, content: h.content || ''
                }));

                window.setLoadProgress(92, '화면 구성 중...');

                const countEl = document.getElementById('totalMembersCount');
                if (countEl) {
                    const counts = {};
                    appState.guilds.forEach(g => counts[g.name] = 0);
                    appState.members.forEach(m => {
                        if (counts[m.guild] !== undefined) counts[m.guild]++;
                    });
                    const aliases = { '뚠카롱': '뚠', '뚱카롱': '뚱', '밤카롱': '밤', '별카롱': '별', '달카롱': '달', '꿀카롱': '꿀' };
                    const guildBadgeStyles = {
                        '뚠카롱': 'background:#fdf2f8;color:#db2777;border-color:#fbcfe8',
                        '뚱카롱': 'background:#fff1f2;color:#e11d48;border-color:#fecdd3',
                        '밤카롱': 'background:#eef2ff;color:#4f46e5;border-color:#c7d2fe',
                        '별카롱': 'background:#fefce8;color:#ca8a04;border-color:#fef08a',
                        '달카롱': 'background:#eff6ff;color:#2563eb;border-color:#bfdbfe',
                        '꿀카롱': 'background:#fffbeb;color:#d97706;border-color:#fde68a'
                    };
                    countEl.innerHTML = appState.guilds.map(g => {
                        const name = aliases[g.name] || g.name.substring(0, 1);
                        const s = guildBadgeStyles[g.name] || 'background:#f3f4f6;color:#666';
                        return `<span style="${s};border:1px solid;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:900">${name} ${counts[g.name]}</span>`;
                    }).join('');
                }
                window.updateAnniversaryLabel();

                // ── 수로 주차: 미래 주차 자동 생성 안 함 ──
                // getSuroPeriodHeader()는 현재 진행중인 주차를 반환하는데,
                // 수요일이 지나기 전까지는 새 주차를 만들지 않음
                // (수로 점수 입력 탭에서 저장 시에만 필요한 주차를 생성)
            } catch (e) { 
                console.error("Fetch Error:", e); 
                alert("🚨 Supabase 연결 실패\n\n" + (e.message || JSON.stringify(e)));
            } finally {
                window.setLoadProgress(100, '완료!');
                setTimeout(() => window.showLoading(false), 300);
                window.router(appState.activeTab);
            }
        };

        window.sendAction = async (action, data, skipRefresh = false) => {
            if(!skipRefresh) window.showMsg("데이터 처리 중...", "info");
            try {
                let success = false;
                switch (action) {
                    case 'add': {
                        const { error } = await supaDb.from('members').insert({
                            name: data.name, guild: data.guild, role: data.role,
                            class: data.class || '', is_main: data.isMain !== false,
                            main_char_name: data.mainCharName || '',
                            join_date: data.joinDate || new Date().toISOString().split('T')[0]
                        });
                        if (error) throw error;
                        await supaDb.from('operation_history').insert({ date: new Date().toISOString().split('T')[0], category: '추가', name: data.name, content: `${data.guild} 길드에 추가됨` });
                        success = true; break;
                    }
                    case 'update': {
                        const { error } = await supaDb.from('members').update({
                            guild: data.guild, role: data.role, class: data.class || '',
                            is_main: data.isMain !== false, main_char_name: data.mainCharName || ''
                        }).eq('id', data.id);
                        if (error) throw error;
                        await supaDb.from('operation_history').insert({ date: new Date().toISOString().split('T')[0], category: '수정', name: data.name, content: `정보 수정됨 (${data.guild}/${data.role})` });
                        success = true; break;
                    }
                    case 'save_members': {
                        // 전체 멤버 조회 (1000건 제한 우회)
                        let current = [], pg = 0;
                        while (true) {
                            const { data: b } = await supaDb.from('members').select('id, name').range(pg * 1000, (pg + 1) * 1000 - 1);
                            current = current.concat(b);
                            if (b.length < 1000) break;
                            pg++;
                        }
                        const currentMap = {};
                        current.forEach(m => { currentMap[m.name] = m.id; });
                        const newNames = new Set(data.members.map(m => m.name));
                        // 삭제
                        const deleted = current.filter(m => !newNames.has(m.name));
                        if (deleted.length > 0) {
                            await supaDb.from('members').delete().in('id', deleted.map(m => m.id));
                        }
                        // 업데이트 / 추가
                        for (const m of data.members) {
                            if (currentMap[m.name]) {
                                await supaDb.from('members').update({
                                    guild: m.guild, role: m.role, class: m.class || '',
                                    is_main: m.isMain !== false, main_char_name: m.mainCharName || ''
                                }).eq('id', currentMap[m.name]);
                            } else {
                                await supaDb.from('members').insert({
                                    name: m.name, guild: m.guild, role: m.role, class: m.class || '',
                                    is_main: m.isMain !== false, main_char_name: m.mainCharName || '',
                                    join_date: m.joinDate || new Date().toISOString().split('T')[0]
                                });
                            }
                        }
                        success = true; break;
                    }
                    case 'save_bail': {
                        const { error } = await supaDb.from('bail_history').insert({
                            date: data.date || new Date().toISOString().split('T')[0],
                            payer: data.payer, receiver: data.receiver,
                            amount: parseInt(data.amount), memo: data.memo || ''
                        });
                        if (error) throw error;
                        success = true; break;
                    }
                    case 'save_penalty': {
                        const { error } = await supaDb.from('penalty_history').insert({
                            date: data.date, name: data.name,
                            points: parseInt(data.points), reason: data.reason || ''
                        });
                        if (error) throw error;
                        success = true; break;
                    }
                    case 'save_event': {
                        if (data.isNew) {
                            const { error } = await supaDb.from('events').insert({
                                date: data.date, title: data.title, content: data.content || ''
                            });
                            if (error) throw error;
                        } else {
                            const { data: existing } = await supaDb.from('events')
                                .select('id').eq('date', data.date).eq('title', data.originalTitle).single();
                            if (existing) {
                                await supaDb.from('events').update({ title: data.title, content: data.content || '' }).eq('id', existing.id);
                            }
                        }
                        success = true; break;
                    }
                    case 'delete_event': {
                        const { error } = await supaDb.from('events').delete().eq('date', data.date).eq('title', data.title);
                        if (error) throw error;
                        success = true; break;
                    }
                    default: console.warn('Unknown action:', action);
                }
                if (success) {
                    if (!skipRefresh) { window.showMsg("완료되었습니다.", "success"); await window.fetchMembers(); }
                    return true;
                }
                return false;
            } catch (e) {
                console.error("Supabase Error:", e);
                window.showMsg("서버 전송 실패: " + (e.message || e), "error");
                return false;
            }
        };

        window.router = (tab) => {

        // ★ 직위 자동 부여 (뚠카롱 본캐 전용, 마카롱/다쿠아즈/부캐 제외)
        window.autoAssignRoles = () => {
            const excludeRoles = ['마카롱', '다쿠아즈'];
            const targets = appState.members.filter(m => m.guild === '뚠카롱' && !excludeRoles.includes(m.role) && m.isMain !== false);
            
            if(targets.length === 0) return window.showMsg("부여 대상이 없습니다.", "error");
            
            const headers = appState.suroHeaders || [];
            const latestHeader = headers.length > 0 ? headers[headers.length - 1] : null;
            if(!latestHeader) return window.showMsg("수로 데이터가 없습니다.", "error");
            
            const getRoleByScore = (score) => {
                const rules = SITE_CONFIG?.autoRankRules?.['뚠카롱'] || [
                    { min: 130000, rank: '파르페' }, { min: 95000, rank: '티라미슈' },
                    { min: 72000, rank: '크로칸슈' }, { min: 50000, rank: '롤케이크' },
                    { min: 38000, rank: '팬케이크' }, { min: 0, rank: '스콘' }
                ];
                const sorted = [...rules].sort((a,b) => b.min - a.min);
                for (const r of sorted) { if (score >= r.min) return r.rank; }
                return sorted.length > 0 ? sorted[sorted.length-1].rank : '스콘';
            };
            
            const scored = targets.map(m => ({
                ...m,
                latestScore: Math.round(Number(m.suro?.[latestHeader])) || 0
            })).sort((a, b) => b.latestScore - a.latestScore);
            
            const changes = [];
            scored.forEach((m, idx) => {
                let newRole;
                if(idx < 3 && m.latestScore > 0) {
                    newRole = '크라운';
                } else {
                    newRole = getRoleByScore(m.latestScore);
                }
                if(m.role !== newRole) {
                    changes.push({ name: m.name, from: m.role, to: newRole, score: m.latestScore });
                }
            });
            
            if(changes.length === 0) return window.showMsg("변경할 직위가 없습니다. 모두 이미 올바른 직위입니다.", "info");
            
            // 예쁜 확인 모달
            const existing = document.getElementById('roleConfirmModal'); if(existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'roleConfirmModal';
            overlay.className = 'fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4';
            
            const roleColors = {
                '크라운': 'text-amber-500', '파르페': 'text-pink-500', '티라미슈': 'text-orange-500',
                '크로칸슈': 'text-yellow-600', '롤케이크': 'text-rose-400', '팬케이크': 'text-amber-400',
                '스콘': 'text-gray-500', '와플': 'text-purple-400'
            };
            
            const rows = changes.map((c, i) => {
                const fromColor = roleColors[c.from] || 'text-gray-500';
                const toColor = roleColors[c.to] || 'text-gray-500';
                return `<tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="py-2 px-1 text-center"><input type="checkbox" checked data-role-idx="${i}" class="role-chk w-4 h-4 rounded text-amber-500 cursor-pointer" onchange="window._updateRoleCount()"></td>
                    <td class="py-2 px-2 text-xs font-bold text-gray-800">${c.name}</td>
                    <td class="py-2 px-2 text-xs font-bold ${fromColor}">${c.from}</td>
                    <td class="py-2 px-1 text-gray-300 text-xs">→</td>
                    <td class="py-2 px-2 text-xs font-black ${toColor}">${c.to}</td>
                    <td class="py-2 px-2 text-xs text-gray-400 text-right font-mono">${c.score.toLocaleString()}</td>
                </tr>`;
            }).join('');
            
            overlay.innerHTML = `<div class="bg-white rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                <div class="p-5 bg-amber-50 border-b border-amber-100 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-sm font-bold text-amber-700 flex items-center gap-2"><i class="fas fa-magic"></i> 직위 자동 부여</h3>
                        <p class="text-[10px] text-amber-500 mt-1">기준: ${latestHeader} · 변경 대상 <span class="font-black">${changes.length}명</span></p>
                    </div>
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="w-8 h-8 rounded-full bg-amber-100 hover:bg-amber-200 flex items-center justify-center text-amber-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <table class="w-full">
                        <thead><tr class="text-[9px] text-gray-400 uppercase border-b border-gray-100">
                            <th class="py-2 px-1 text-center"><input type="checkbox" checked onclick="document.querySelectorAll('.role-chk').forEach(c=>c.checked=this.checked);window._updateRoleCount()" class="w-4 h-4 rounded cursor-pointer"></th>
                            <th class="py-2 px-2 text-left">닉네임</th>
                            <th class="py-2 px-2 text-left">현재</th>
                            <th class="py-2 px-1"></th>
                            <th class="py-2 px-2 text-left">변경</th>
                            <th class="py-2 px-2 text-right">점수</th>
                        </tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex gap-3 shrink-0">
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="flex-1 py-3 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-all">취소</button>
                    <button id="roleConfirmBtn" onclick="window._executeRoleChanges()" class="flex-1 py-3 rounded-xl text-xs font-bold text-white bg-amber-500 hover:bg-amber-600 transition-all shadow-lg"><i class="fas fa-check mr-1"></i> <span id="roleConfirmCount">${changes.length}</span>명 직위 변경</button>
                </div>
            </div>`;
            
            document.body.appendChild(overlay);
            overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
            
            // 실행 함수 저장
            window._pendingRoleChanges = changes;
        };
        
        // ★ 직위 자동 부여 (뚱카롱 본캐 전용, 마카롱/다쿠아즈/아인슈페너/부캐 제외)
        window.autoAssignRolesDdung = () => {
            const excludeRoles = ['마카롱', '다쿠아즈', '아인슈페너', '부팬케이크', '부케이크', '수플레', '반죽(휴면)'];
            const targets = appState.members.filter(m => m.guild === '뚱카롱' && !excludeRoles.includes(m.role) && m.isMain !== false);
            
            if(targets.length === 0) return window.showMsg("부여 대상이 없습니다.", "error");
            
            const headers = appState.suroHeaders || [];
            const latestHeader = headers.length > 0 ? headers[headers.length - 1] : null;
            if(!latestHeader) return window.showMsg("수로 데이터가 없습니다.", "error");
            
            const getDdungRole = (score) => {
                const rules = SITE_CONFIG?.autoRankRules?.['뚱카롱'] || [
                    { min: 18000, rank: '뚠케이크' }, { min: 5000, rank: '뚠브레드' }, { min: 0, rank: '뚠스콘' }
                ];
                const sorted = [...rules].sort((a,b) => b.min - a.min);
                for (const r of sorted) { if (score >= r.min) return r.rank; }
                return sorted.length > 0 ? sorted[sorted.length-1].rank : '뚠스콘';
            };
            
            const scored = targets.map(m => ({
                ...m,
                latestScore: Math.round(Number(m.suro?.[latestHeader])) || 0
            }));
            
            const changes = [];
            scored.forEach(m => {
                const newRole = getDdungRole(m.latestScore);
                if(m.role !== newRole) {
                    changes.push({ name: m.name, from: m.role, to: newRole, score: m.latestScore });
                }
            });
            
            if(changes.length === 0) return window.showMsg("변경할 직위가 없습니다. 모두 이미 올바른 직위입니다.", "info");
            
            const existing = document.getElementById('roleConfirmModal'); if(existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'roleConfirmModal';
            overlay.className = 'fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4';
            
            const roleColors = {
                '뚠케이크': 'text-rose-500', '뚠브레드': 'text-amber-500', '수플레': 'text-purple-400',
                '뚠스콘': 'text-gray-500', '반죽(휴면)': 'text-gray-400'
            };
            
            const rows = changes.map((c, i) => {
                const fromColor = roleColors[c.from] || 'text-gray-500';
                const toColor = roleColors[c.to] || 'text-gray-500';
                return `<tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="py-2 px-1 text-center"><input type="checkbox" checked data-role-idx="${i}" class="role-chk w-4 h-4 rounded text-rose-500 cursor-pointer" onchange="window._updateRoleCount()"></td>
                    <td class="py-2 px-2 text-xs font-bold text-gray-800">${c.name}</td>
                    <td class="py-2 px-2 text-xs font-bold ${fromColor}">${c.from}</td>
                    <td class="py-2 px-1 text-gray-300 text-xs">→</td>
                    <td class="py-2 px-2 text-xs font-black ${toColor}">${c.to}</td>
                    <td class="py-2 px-2 text-xs text-gray-400 text-right font-mono">${c.score.toLocaleString()}</td>
                </tr>`;
            }).join('');
            
            overlay.innerHTML = `<div class="bg-white rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                <div class="p-5 bg-rose-50 border-b border-rose-100 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-sm font-bold text-rose-700 flex items-center gap-2"><i class="fas fa-magic"></i> 뚱카롱 직위 자동 부여</h3>
                        <p class="text-[10px] text-rose-500 mt-1">기준: ${latestHeader} · 변경 대상 <span class="font-black">${changes.length}명</span></p>
                    </div>
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="w-8 h-8 rounded-full bg-rose-100 hover:bg-rose-200 flex items-center justify-center text-rose-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <table class="w-full">
                        <thead><tr class="text-[9px] text-gray-400 uppercase border-b border-gray-100">
                            <th class="py-2 px-1 text-center"><input type="checkbox" checked onclick="document.querySelectorAll('.role-chk').forEach(c=>c.checked=this.checked);window._updateRoleCount()" class="w-4 h-4 rounded cursor-pointer"></th>
                            <th class="py-2 px-2 text-left">닉네임</th>
                            <th class="py-2 px-2 text-left">현재</th>
                            <th class="py-2 px-1"></th>
                            <th class="py-2 px-2 text-left">변경</th>
                            <th class="py-2 px-2 text-right">점수</th>
                        </tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex gap-3 shrink-0">
                    <button onclick="document.getElementById('roleConfirmModal').remove()" class="flex-1 py-3 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-all">취소</button>
                    <button id="roleConfirmBtn" onclick="window._executeRoleChanges()" class="flex-1 py-3 rounded-xl text-xs font-bold text-white bg-rose-500 hover:bg-rose-600 transition-all shadow-lg"><i class="fas fa-check mr-1"></i> <span id="roleConfirmCount">${changes.length}</span>명 직위 변경</button>
                </div>
            </div>`;
            
            document.body.appendChild(overlay);
            overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
            window._pendingRoleChanges = changes;
        };

        window._updateRoleCount = () => {
            const checked = document.querySelectorAll('.role-chk:checked').length;
            const el = document.getElementById('roleConfirmCount');
            const btn = document.getElementById('roleConfirmBtn');
            if(el) el.textContent = checked;
            if(btn) { btn.disabled = checked === 0; btn.style.opacity = checked === 0 ? '0.4' : '1'; }
        };

        window._executeRoleChanges = async () => {
            const allChanges = window._pendingRoleChanges;
            if(!allChanges) return;
            const checkedIdxs = new Set();
            document.querySelectorAll('.role-chk:checked').forEach(c => checkedIdxs.add(Number(c.dataset.roleIdx)));
            const changes = allChanges.filter((_, i) => checkedIdxs.has(i));
            if(changes.length === 0) return window.showMsg("선택된 변경사항이 없습니다.", "error");
            document.getElementById('roleConfirmModal')?.remove();
            
            window.showLoading(true);
            window.setLoadProgress(10, '직위 업데이트 준비 중...');
            
            try {
                let done = 0;
                const historyEntries = [];
                for (const change of changes) {
                    const member = appState.members.find(m => m.name === change.name);
                    if (!member) continue;
                    const { error } = await supaDb.from('members').update({ role: change.to }).eq('id', member.id);
                    if (error) throw error;
                    done++;
                    window.setLoadProgress(10 + Math.round(70 * done / changes.length), `${done}/${changes.length} 직위 변경 중...`);
                    historyEntries.push({
                        date: new Date().toISOString().split('T')[0],
                        category: '직위변경',
                        name: change.name,
                        content: `${change.from} → ${change.to} (${member.guild})`
                    });
                }
                // 운영 이력 일괄 등록
                if (historyEntries.length > 0) {
                    await supaDb.from('operation_history').insert(historyEntries);
                }
                window.setLoadProgress(90, '데이터 갱신 중...');
                window.showMsg(changes.length + '명의 직위가 업데이트되었습니다!', 'success');
                await window.fetchMembers();
            } catch(e) {
                window.showMsg('직위 변경 실패: ' + (e.message || e), 'error');
            }
            window.showLoading(false);
            window._pendingRoleChanges = null;
        };
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { home: '홈', members: '길드원', analysis: '수로 분석', suro_input: '수로 입력', bail: '보석금', penalty: '벌점', sheet: 'DB 시트', guide_edit: '가이드 편집', history: '운영 이력', sync: '동기화', settings: '설정', role_assign: '직위 반영' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'home') window.renderHome(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'suro_input' && isAdmin()) window.renderSuroInput(content);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
            else if (tab === 'sheet' && isAdmin()) window.renderSheet(content);
            else if (tab === 'guide_edit' && isAdmin()) window.renderGuideEditor(content);
            else if (tab === 'history' && isAdmin()) window.renderHistory(content);
            else if (tab === 'sync' && isAdmin()) window.renderSync(content);
            else if (tab === 'settings' && isAdmin()) { window.renderSettings(content); setTimeout(() => window._loadAdminList(), 100); }
            else if (tab === 'role_assign' && isAdmin()) window.renderRoleAssign(content);
            // 모바일: 사이드바 닫기 + 탭바 업데이트
            const _sb = document.getElementById('sidebar'), _ov = document.getElementById('sidebarOverlay');
            if (window.innerWidth < 1024 && _sb) { _sb.classList.add('-translate-x-full'); _ov?.classList.add('hidden'); }
            if (window._updateMobileTab) window._updateMobileTab(tab);
        };

        // --- DASHBOARD ---
        window.renderDashboard = (container) => {
            const ddunT = window.calculateTotalSuro('뚠카롱'); 
            const ddungT = window.calculateTotalSuro('뚱카롱');
            
            // 뚠카롱 직위별 인원수
            const ddunMembers = appState.members.filter(m => m.guild === '뚠카롱');
            const roleCounts = {};
            ddunMembers.forEach(m => { const r = m.role || '미설정'; roleCounts[r] = (roleCounts[r] || 0) + 1; });
            const roleOrder = ['마카롱','다쿠아즈','크라운','파르페','티라미슈','크로칸슈','롤케이크','팬케이크','와플','스콘','반죽(휴면)'];
            const roleEmoji = {'마카롱':'👑','다쿠아즈':'👑','크라운':'👑','파르페':'🍨','티라미슈':'🍰','크로칸슈':'🥐','롤케이크':'🍥','팬케이크':'🥞','와플':'🧇','스콘':'🍪','반죽(휴면)':'🫓'};
            const roleColorClass = {'마카롱':'text-blue-600 bg-blue-50 border-blue-100','다쿠아즈':'text-pink-600 bg-pink-50 border-pink-100','크라운':'text-amber-600 bg-amber-50 border-amber-100','파르페':'text-indigo-600 bg-indigo-50 border-indigo-100','티라미슈':'text-indigo-600 bg-indigo-50 border-indigo-100','크로칸슈':'text-green-600 bg-green-50 border-green-100','롤케이크':'text-pink-600 bg-pink-50 border-pink-100','팬케이크':'text-pink-600 bg-pink-50 border-pink-100','와플':'text-orange-600 bg-orange-50 border-orange-100','스콘':'text-gray-600 bg-gray-50 border-gray-100','반죽(휴면)':'text-gray-400 bg-gray-50 border-gray-100'};
            const roleCountHtml = roleOrder.filter(r => roleCounts[r]).map(r => `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border ${roleColorClass[r] || 'bg-gray-50 border-gray-100'}"><span>${roleEmoji[r] || ''} ${r}</span><span class="font-black">${roleCounts[r]}명</span></div>`).join('');

            // 뚱카롱 직위별 인원수
            const ddungMembers = appState.members.filter(m => m.guild === '뚱카롱');
            const ddungRoleCounts = {};
            ddungMembers.forEach(m => { const r = m.role || '미설정'; ddungRoleCounts[r] = (ddungRoleCounts[r] || 0) + 1; });
            const ddungRoleOrder = ['마카롱','다쿠아즈','뚠케이크','뚠브레드','아인슈페너','부팬케이크','수플레','뚠스콘','부케이크','반죽(휴면)'];
            const ddungRoleEmoji = {'마카롱':'👑','다쿠아즈':'👑','뚠케이크':'🎂','뚠브레드':'🍞','아인슈페너':'☕','부팬케이크':'🥞','수플레':'🍮','뚠스콘':'🍪','부케이크':'🍰','반죽(휴면)':'🫓'};
            const ddungRoleColor = {'마카롱':'text-blue-600 bg-blue-50 border-blue-100','다쿠아즈':'text-pink-600 bg-pink-50 border-pink-100','뚠케이크':'text-rose-600 bg-rose-50 border-rose-100','뚠브레드':'text-amber-600 bg-amber-50 border-amber-100','아인슈페너':'text-emerald-600 bg-emerald-50 border-emerald-100','부팬케이크':'text-green-600 bg-green-50 border-green-100','수플레':'text-purple-600 bg-purple-50 border-purple-100','뚠스콘':'text-gray-600 bg-gray-50 border-gray-100','부케이크':'text-gray-500 bg-gray-50 border-gray-100','반죽(휴면)':'text-gray-400 bg-gray-50 border-gray-100'};
            const ddungRoleCountHtml = ddungRoleOrder.filter(r => ddungRoleCounts[r]).map(r => `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border ${ddungRoleColor[r] || 'bg-gray-50 border-gray-100'}"><span>${ddungRoleEmoji[r] || ''} ${r}</span><span class="font-black">${ddungRoleCounts[r]}명</span></div>`).join('');
            const adminBailStats = window.getAdminBailStats();
            const adminBailHtml = adminBailStats.map(([name, count]) => `<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><span class="text-[11px] font-bold text-gray-600">${name}</span><span class="text-[11px] font-black text-pink-500">${count}개</span></div>`).join('') || '<p class="text-[10px] text-gray-300 italic text-center py-4">보석금 내역 없음</p>';
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 lg:gap-8 mb-4 lg:mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-4 lg:gap-6">
                    <div class="grid grid-cols-2 gap-3 lg:gap-6 h-auto lg:h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), '뚠카롱')" class="bg-gradient-to-br from-pink-500 to-rose-500 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none min-h-[100px]">
                            <div class="absolute top-0 right-0 p-2 lg:p-4 opacity-20 text-3xl lg:text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-[10px] lg:text-sm font-bold opacity-80 uppercase tracking-widest text-center">뚠카롱 수로 총점</h3>
                            <p class="text-xl lg:text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), '뚱카롱')" class="bg-white border border-gray-100 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-center relative overflow-hidden min-h-[100px]">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-400 uppercase tracking-widest text-center">뚱카롱 수로 총점</h3>
                            <p class="text-xl lg:text-3xl font-black tracking-tighter text-pink-500 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 lg:p-8 rounded-2xl lg:rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4 lg:mb-6">
                            <div class="flex items-center gap-2 lg:gap-3">
                                <span class="text-lg lg:text-2xl">📅</span>
                                <h3 class="text-[10px] lg:text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-2 lg:gap-4">
                                <div class="flex items-center gap-1 lg:gap-2 bg-gray-50 px-2 lg:px-3 py-1 lg:py-1.5 rounded-xl lg:rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[10px] lg:text-[11px] font-bold text-gray-600 w-14 lg:w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                    <!-- 직위별 커트라인 -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-pink-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-crown text-pink-400"></i> 뚠카롱 직위 커트라인</h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-100"><span class="text-yellow-700">👑 크라운</span><span class="text-yellow-600">TOP 3</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg" style="background:linear-gradient(to right,#EBF0FF,#E8EDFF);border:1px solid #D6DFFF"><span class="text-blue-700">🍨 파르페</span><span class="text-blue-600">130,000~</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg" style="background:linear-gradient(to right,#EBF0FF,#E8EDFF);border:1px solid #D6DFFF"><span class="text-blue-700">🍰 티라미슈</span><span class="text-blue-600">95,000 ~ 129,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg" style="background:linear-gradient(to right,#E8FFE8,#E5FAE5);border:1px solid #C8E6C8"><span class="text-green-700">🥐 크로칸슈</span><span class="text-green-600">72,000 ~ 94,999</span></div>
                                <div class="text-[9px] text-blue-500 font-bold pl-2.5 -mt-0.5 mb-1 flex items-center gap-1"><i class="fas fa-angle-double-up text-[8px]"></i> 크로칸슈 이상 — 부캐 전부 수로 면제</div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">🍥 롤케이크</span><span class="text-pink-600">50,000 ~ 71,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">🥞 팬케이크</span><span class="text-pink-600">38,000 ~ 49,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-orange-50 border border-orange-100"><span class="text-orange-700">🧇 와플</span><span class="text-orange-500">75,000~ <span class="text-[9px] text-gray-400">(부캐전용)</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-600">🍪 스콘</span><span class="text-gray-500">0 ~ 37,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-400">🫓 반죽</span><span class="text-gray-400">휴면</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-rose-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-heart text-rose-400"></i> 뚱카롱 직위 커트라인</h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">🎂 뚠케이크</span><span class="text-pink-600">18,000~</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-pink-50 border border-pink-100"><span class="text-pink-700">🍞 뚠브레드</span><span class="text-pink-600">5,000 ~ 17,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-amber-50 border border-amber-100"><span class="text-amber-700">☕ 아인슈페너</span><span class="text-amber-500">부캐 직위 <span class="text-[9px] text-gray-400">노블O</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-amber-50 border border-amber-100"><span class="text-amber-700">🥞 부팬케이크</span><span class="text-amber-500">부캐 직위 <span class="text-[9px] text-gray-400">노블O</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-orange-50 border border-orange-100"><span class="text-orange-700">🍮 수플레</span><span class="text-orange-500">35,000~ <span class="text-[9px] text-gray-400">(부캐전용)</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-600">🍪 뚠스콘</span><span class="text-gray-500">0 ~ 4,999</span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-600">🍰 부케이크</span><span class="text-gray-400">부캐 직위 <span class="text-[9px]">노블X</span></span></div>
                                <div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg bg-gray-50 border border-gray-100"><span class="text-gray-400">🫓 반죽</span><span class="text-gray-400">휴면</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- 직위별 인원수 (뚠카롱 + 뚱카롱) -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-pink-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-users text-pink-400"></i> 뚠카롱 직위별 인원 <span class="text-gray-400 font-bold">(${ddunMembers.length}명)</span></h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${roleCountHtml}</div>
                        </div>
                        <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                            <h3 class="text-[10px] lg:text-xs font-bold text-rose-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-users text-rose-400"></i> 뚱카롱 직위별 인원 <span class="text-gray-400 font-bold">(${ddungMembers.length}명)</span></h3>
                            <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${ddungRoleCountHtml}</div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-4 lg:gap-8 h-full">
                    <div class="bg-white p-5 lg:p-10 rounded-2xl lg:rounded-[3rem] shadow-sm border border-gray-100 flex flex-col min-h-[250px] lg:min-h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-3 lg:mb-4 shrink-0">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-chart-bar text-pink-300"></i> 직업 분포도</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 border border-gray-100">
                                <option value="all">전체보기</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar relative">
                            <div id="jobChartContainer" class="flex flex-col gap-3 lg:gap-4"></div>
                        </div>
                        <button onclick="window.toggleJobChart()" id="jobToggleBtn" class="mt-3 py-2 text-[10px] font-bold text-gray-400 hover:text-pink-500 transition-all flex items-center justify-center gap-1"><i class="fas fa-chevron-down text-[8px]" id="jobToggleIcon"></i> <span id="jobToggleText">더보기</span></button>
                    </div>
                    <div class="bg-white p-5 lg:p-10 rounded-2xl lg:rounded-[3rem] shadow-sm border border-gray-100 flex flex-col flex-1 min-h-[150px] lg:min-h-[200px] overflow-hidden">
                        <div class="flex items-center justify-between mb-4 lg:mb-6">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-400 uppercase tracking-widest">간부진 보석금 현황</h3>
                            <i class="fas fa-gem text-pink-300"></i>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar pr-2">${adminBailHtml}</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3 lg:gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-4 lg:p-8 rounded-2xl lg:rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-3 lg:mb-6"><div class="flex items-center gap-2 lg:gap-3"><div class="w-8 h-8 lg:w-10 lg:h-10 bg-gray-50 rounded-xl lg:rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors text-xs lg:text-base"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-sm lg:text-lg text-gray-800 group-hover:text-pink-500">${g.name}</span><span class="text-[8px] lg:text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1 lg:h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[9px] lg:text-[10px] text-gray-400 font-bold mt-1.5 lg:mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };

        window.renderCalendar = () => { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month + 1, 0).getDate(); 
            const prevLast = new Date(year, month, 0).getDate();
            const today = new Date();
            
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">일</div><div class="calendar-head">월</div><div class="calendar-head">화</div><div class="calendar-head">수</div><div class="calendar-head text-pink-500">목</div><div class="calendar-head">금</div><div class="calendar-head text-blue-400">토</div>`; 
            
            for(let i=first; i>0; i--) {
                html += `<div class="calendar-day not-current"><span>${prevLast - i + 1}</span></div>`;
            }

            for(let d=1; d<=last; d++) { 
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEvents = appState.events.filter(e => {
                    const eDate = (e.date || '').split('T')[0].trim();
                    return eDate === dateStr;
                });
                
                const isToday = today.getFullYear()===year && today.getMonth()===month && today.getDate()===d;
                const isThursday = new Date(year, month, d).getDay() === 4;

                let cls = "calendar-day text-gray-600";
                if(isThursday) cls += " thursday";
                if(isToday) cls += " today";
                
                let eventHtml = '';
                if(dayEvents.length > 0) {
                    eventHtml += `<div class="event-dot"></div>`;
                    dayEvents.slice(0, 2).forEach(e => {
                        eventHtml += `<div class="event-snippet" title="${e.title}">${e.title}</div>`;
                    });
                    if (dayEvents.length > 2) eventHtml += `<div class="text-[9px] text-pink-400 mt-0.5 leading-none font-bold">+${dayEvents.length - 2}</div>`;
                }
                html += `<div class="${cls}" onclick="window.showEventDetail('${dateStr}')"><span>${d}</span>${eventHtml}</div>`; 
            } 
            
            const totalCells = first + last;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for(let i=1; i<=extraCells; i++) {
                html += `<div class="calendar-day not-current"><span>${i}</span></div>`;
            }

            return html + `</div>`; 
        };

        window.showEventDetail = (dateStr) => {
            appState.currentSelectedDate = dateStr;
            appState.currentEditingEvent = null;

            const modal = document.getElementById('eventDetailModal');
            document.getElementById('eventDetailDate').innerText = dateStr;
            
            const dayEvents = appState.events.filter(e => e.date === dateStr);
            const listContainer = document.getElementById('eventListForDate');
            listContainer.innerHTML = '';
            
            if (dayEvents.length > 0) {
                dayEvents.forEach((e, idx) => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-50 border border-gray-100 rounded-xl cursor-pointer hover:bg-pink-50 hover:border-pink-200 transition-all flex justify-between items-center text-xs font-bold text-gray-600';
                    item.innerHTML = `<span>${e.title}</span><i class="fas fa-chevron-right text-gray-300"></i>`;
                    item.onclick = () => window.selectEventForEdit(e);
                    listContainer.appendChild(item);
                });
                window.selectEventForEdit(dayEvents[0]);
            } else {
                listContainer.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">등록된 일정이 없습니다.</p>`;
                window.resetEventForm();
            }

            modal.classList.remove('hidden');
        };

        window.selectEventForEdit = (eventObj) => {
            appState.currentEditingEvent = eventObj;
            const listContainer = document.getElementById('eventListForDate');
            Array.from(listContainer.children).forEach(child => {
                child.classList.remove('event-item-active');
                if (child.innerText.includes(eventObj.title)) child.classList.add('event-item-active');
            });

            document.getElementById('eventTitleInput').value = eventObj.title || "";
            document.getElementById('eventContentInput').value = eventObj.content || "";
            document.getElementById('btnDeleteEvent').classList.remove('hidden');
            document.getElementById('btnSaveEvent').classList.remove('col-span-2');
        };

        window.resetEventForm = () => {
            appState.currentEditingEvent = null;
            document.getElementById('eventTitleInput').value = "";
            document.getElementById('eventContentInput').value = "";
            document.getElementById('btnDeleteEvent').classList.add('hidden'); 
            document.getElementById('btnSaveEvent').classList.add('col-span-2');
            
            const listContainer = document.getElementById('eventListForDate');
            Array.from(listContainer.children).forEach(child => child.classList.remove('event-item-active'));
        };
        
        window.saveEvent = async () => {
            const title = document.getElementById('eventTitleInput').value.trim();
            const content = document.getElementById('eventContentInput').value.trim();
            const date = appState.currentSelectedDate;
            const original = appState.currentEditingEvent;

            if (!title) { window.showMsg("제목을 입력해주세요.", "error"); return; }
            
            const payload = {
                date: date,
                title: title,
                content: content,
                isNew: original ? false : true,
                originalTitle: original ? original.title : null
            };
            
            const success = await window.sendAction('save_event', payload);
            if (success) window.closeModal('eventDetailModal');
        };
        
        window.deleteEvent = async () => {
            if (!confirm("이 일정을 삭제하시겠습니까?")) return;
            const target = appState.currentEditingEvent;
            if (!target) return;

            const payload = { date: target.date, title: target.title, content: target.content };
            const success = await window.sendAction('delete_event', payload);
            if (success) window.closeModal('eventDetailModal');
        };

        window.changePage = (type, delta) => {
            appState.pagination[type] += delta;
            if (type === 'members') window.updateMemberTable();
        };

        window._analysisSearchTimer = null;
        window.setAnalysisSearch = (val) => {
            appState.analysisFilters.search = val;
            if (window._analysisSearchTimer) clearTimeout(window._analysisSearchTimer);
            window._analysisSearchTimer = setTimeout(() => {
                window.updateAnalysisTable();
            }, 200);
        };

        window.updateAnalysisTable = () => {
            const tbody = document.getElementById('analysisTableBody');
            if (!tbody) return;
            
            const gName = appState.analysisGuild;
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const rawSearch = (appState.analysisFilters.search || '').trim();
            const searchTokens = rawSearch.length > 0 
                ? rawSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) 
                : [];
            
            const displayTargets = searchTokens.length > 0 
                ? guildTargets.filter(m => {
                    const mainName = m.isMain ? m.name : (m.mainCharName || '');
                    return searchTokens.some(token => 
                        m.name.toLowerCase().includes(token) || 
                        mainName.toLowerCase().includes(token) ||
                        (m.mainCharName || '').toLowerCase().includes(token) ||
                        (m.class || '').toLowerCase().includes(token)
                    );
                }) 
                : guildTargets;
            
            const recentHeaders = [...appState.suroHeaders];
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;
            
            const processedList = displayTargets.map(m => {
                const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0);
                const validScores = scores.filter(s => s > 0);
                const avg = validScores.length > 0 ? Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length) : 0;
                return { ...m, avg: avg, recentScores: scores };
            });

            const f = appState.analysisFilters.sortField;
            const o = appState.analysisFilters.sortOrder;
            processedList.sort((a, b) => {
                if (f.startsWith('date_')) {
                    const targetHeader = f.replace('date_', '');
                    const headerIdx = recentHeaders.indexOf(targetHeader);
                    const prevHeader = headerIdx > 0 ? recentHeaders[headerIdx - 1] : null;
                    const getIncRate = (m) => {
                        const curr = Math.round(Number(m.suro?.[targetHeader])) || 0;
                        if (!prevHeader) return curr > 0 ? -500 : -1000;
                        const prev = Math.round(Number(m.suro?.[prevHeader])) || 0;
                        if (curr === 0 && prev === 0) return -1000; 
                        if (prev === 0 && curr > 0) return -500; 
                        return ((curr - prev) / prev) * 100;
                    };
                    const rateA = getIncRate(a); const rateB = getIncRate(b);
                    if (rateA === rateB) {
                        const currA = Math.round(Number(a.suro?.[targetHeader])) || 0;
                        const currB = Math.round(Number(b.suro?.[targetHeader])) || 0;
                        return o === 'asc' ? currA - currB : currB - currA;
                    }
                    return o === 'asc' ? rateA - rateB : rateB - rateA;
                }
                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Math.round(Number(a.suro?.[currentHeader])) || 0;
                    const vB = Math.round(Number(b.suro?.[currentHeader])) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            tbody.innerHTML = processedList.map((m, i) => {
                const globalIndex = i + 1;
                return `<tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50 cursor-pointer" onclick="window.showPersonalSuro(this.dataset.name)" data-name="${m.name}">
                    <td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50 bg-white group-hover:bg-gray-50">${globalIndex}</td>
                    <td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50 bg-white group-hover:bg-gray-50">
                        <div class="flex items-center leading-none overflow-hidden text-ellipsis">
                            ${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}${m.level>0?'<span class="text-[8px] text-gray-400 font-mono ml-1">Lv.'+m.level+'</span>':''}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div>
                        </div>
                    </td>
                    <td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>
                    ${m.recentScores.map((s, scoreIdx) => {
                        let diffHtml = '';
                        let prevScore = scoreIdx > 0 ? m.recentScores[scoreIdx - 1] : 0;
                        if (s > 0 || (s === 0 && prevScore > 0)) {
                            if (prevScore > 0) {
                                const diffPct = ((s - prevScore) / prevScore * 100);
                                if (s > prevScore) diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">▲ ${diffPct.toFixed(1)}%</span>`;
                                else if (s < prevScore) diffHtml = `<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">▼ ${Math.abs(diffPct).toFixed(1)}%</span>`;
                                else diffHtml = `<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;
                            } else if (s > 0) diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">▲ NEW</span>`;
                        }
                        return `<td class="p-3 min-w-[100px] text-right font-mono align-middle ${s === 0 ? 'bg-red-50/20 text-red-400 group-hover:bg-red-50/50' : 'bg-white text-gray-700 group-hover:bg-gray-50'}">
                            <div class="flex flex-col justify-center items-end leading-tight min-h-[28px]">
                                <span class="${s > 0 ? 'text-xs' : 'text-gray-400'}">${s > 0 ? s.toLocaleString() : '0'}</span>
                                ${diffHtml}
                            </div>
                        </td>`;
                    }).join('')}
                </tr>`;
            }).join('');
        };

        // --- ANALYSIS ---
        window.renderAnalysis = (container, gName) => {
            appState.analysisGuild = gName;
            
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const rawSearch = (appState.analysisFilters.search || '').trim();
            const searchTokens = rawSearch.length > 0 
                ? rawSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) 
                : [];
            
            const displayTargets = searchTokens.length > 0 
                ? guildTargets.filter(m => {
                    const mainName = m.isMain ? m.name : (m.mainCharName || '');
                    return searchTokens.some(token => 
                        m.name.toLowerCase().includes(token) || 
                        mainName.toLowerCase().includes(token) ||
                        (m.mainCharName || '').toLowerCase().includes(token) ||
                        (m.class || '').toLowerCase().includes(token)
                    );
                }) 
                : guildTargets;
            
            const getWedStr = (h) => {
                if (!h) return '';
                const p = h.split('~');
                return p.length > 1 ? p[1].replace('수로 점수', '').trim() : h.trim();
            };
            const getShortWedStr = (h) => {
                const str = getWedStr(h);
                const p = str.split('-');
                return p.length >= 3 ? p[1] + '-' + p[2].substring(0,2) : str;
            };

            const recentHeaders = [...appState.suroHeaders]; 
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;

            const displayTotal = currentHeader ? guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[currentHeader])) || 0), 0) : 0;
            const zeroPointMembers = currentHeader ? guildTargets.filter(m => (Math.round(Number(m.suro?.[currentHeader])) || 0) === 0) : [];
            
            const processedList = displayTargets.map(m => {
                const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0);
                const validScores = scores.filter(s => s > 0);
                const avg = validScores.length > 0 ? Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length) : 0;
                return { ...m, avg: avg, recentScores: scores };
            });

            // ★ 4가지 MVP 항목 계산 (이번주 최고 득점자 추가)
            let topScores = [];
            let scoreIncreases = [];
            let pctIncreases = [];
            let avgIncreases = [];

            if (recentHeaders.length >= 2 && currentHeader) {
                const prevHeader = recentHeaders[recentHeaders.length - 2];
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    const prevScore = Math.round(Number(m.suro?.[prevHeader])) || 0;
                    
                    const pastScores = recentHeaders.slice(0, -1).map(h => Math.round(Number(m.suro?.[h])) || 0).filter(s => s > 0);
                    const pastAvg = pastScores.length > 0 ? Math.round(pastScores.reduce((a,b)=>a+b,0) / pastScores.length) : 0;

                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }

                    if (prevScore > 0 && currScore > prevScore) {
                        const increase = currScore - prevScore;
                        const increasePct = (increase / prevScore) * 100;
                        scoreIncreases.push({ name: m.name, val: increase, role: m.role });
                        pctIncreases.push({ name: m.name, val: increasePct, role: m.role });
                    }
                    
                    if (pastAvg > 0 && currScore > pastAvg) {
                        const aboveAvg = currScore - pastAvg;
                        avgIncreases.push({ name: m.name, val: aboveAvg, role: m.role });
                    }
                });
            } else if (currentHeader) { // 과거 데이터가 없어도 고득점자는 계산
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }
                });
            }

            topScores.sort((a,b) => b.val - a.val);
            scoreIncreases.sort((a,b) => b.val - a.val);
            pctIncreases.sort((a,b) => b.val - a.val);
            avgIncreases.sort((a,b) => b.val - a.val);

            const topScoreHighMVP = topScores.slice(0, 5);
            const topScoreMVP = scoreIncreases.slice(0, 5);
            const topPctMVP = pctIncreases.slice(0, 5);
            const topAvgMVP = avgIncreases.slice(0, 5);

            window._mvpFullData = {
                high: topScores,
                score: scoreIncreases,
                pct: pctIncreases,
                avg: avgIncreases
            };

            processedList.sort((a, b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                
                if (f.startsWith('date_')) {
                    const targetHeader = f.replace('date_', '');
                    const headerIdx = recentHeaders.indexOf(targetHeader);
                    const prevHeader = headerIdx > 0 ? recentHeaders[headerIdx - 1] : null;

                    const getIncRate = (m) => {
                        const curr = Math.round(Number(m.suro?.[targetHeader])) || 0;
                        if (!prevHeader) return curr > 0 ? -500 : -1000;
                        const prev = Math.round(Number(m.suro?.[prevHeader])) || 0;
                        if (curr === 0 && prev === 0) return -1000; 
                        if (prev === 0 && curr > 0) return -500; 
                        return ((curr - prev) / prev) * 100;
                    };

                    const rateA = getIncRate(a);
                    const rateB = getIncRate(b);
                    
                    if (rateA === rateB) {
                        const currA = Math.round(Number(a.suro?.[targetHeader])) || 0;
                        const currB = Math.round(Number(b.suro?.[targetHeader])) || 0;
                        return o === 'asc' ? currA - currB : currB - currA;
                    }
                    return o === 'asc' ? rateA - rateB : rateB - rateA;
                }

                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Math.round(Number(a.suro?.[currentHeader])) || 0;
                    const vB = Math.round(Number(b.suro?.[currentHeader])) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            const analysisGuildsOptions = ['뚠카롱', '뚱카롱'];
            
            // ★ 타입별로 텍스트 포맷팅을 다르게 해주는 렌더러
            const renderMvpList = (list, type) => {
                if(list.length === 0) return `<div class="flex items-center justify-center h-full pb-2"><span class="text-[10px] text-gray-400 font-bold">데이터 부족</span></div>`;
                
                let colorBase = '';
                if(type === 'high') colorBase = 'blue';
                else if(type === 'score') colorBase = 'orange';
                else if(type === 'pct') colorBase = 'emerald';
                else if(type === 'avg') colorBase = 'purple';

                return `<div class="flex flex-col gap-1.5 z-10 w-full mt-2">
                    ${list.map((m, idx) => {
                        let displayVal = '';
                        if(type === 'high') displayVal = Math.round(m.val).toLocaleString();
                        else if(type === 'score') displayVal = '+' + Math.round(m.val).toLocaleString();
                        else if(type === 'pct') displayVal = '▲' + m.val.toFixed(1) + '%';
                        else if(type === 'avg') displayVal = '+' + Math.round(m.val).toLocaleString();

                        return `<div class="flex justify-between items-center text-[10px] leading-none bg-white/40 rounded px-1.5 py-1">
                            <div class="flex items-center gap-1.5 overflow-hidden">
                                <span class="font-black text-${colorBase}-500 inline-block w-2.5 text-center">${idx+1}</span>
                                <span class="font-bold text-gray-800 truncate" style="max-width: 60px;" title="${m.name}">${m.name}</span>
                            </div>
                            <span class="font-black text-${colorBase}-600 shrink-0">${displayVal}</span>
                        </div>`;
                    }).join('')}
                </div>`;
            };

            container.innerHTML = `
            <div class="flex flex-col fade-in h-full">
                <!-- 상단 컨트롤 (고정) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 shrink-0 pb-3 bg-gray-50 z-20">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0 w-full sm:w-auto items-center">
                        ${analysisGuildsOptions.map(gNameOption => `<button onclick="window.renderAnalysis(document.getElementById('contentArea'), '${gNameOption}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all shrink-0 ${gNameOption === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-100'}">${gNameOption}</button>`).join('')}
                        ${isAdmin() && gName === '뚠카롱' ? '<button onclick="window.autoAssignRoles()" class="px-4 py-2.5 rounded-xl text-[10px] font-bold bg-amber-50 text-amber-600 border border-amber-200 hover:bg-amber-100 transition-all shrink-0 flex items-center gap-1.5"><i class="fas fa-magic"></i> 직위 자동부여</button>' : ''}
                        ${isAdmin() && gName === '뚱카롱' ? '<button onclick="window.autoAssignRolesDdung()" class="px-4 py-2.5 rounded-xl text-[10px] font-bold bg-rose-50 text-rose-600 border border-rose-200 hover:bg-rose-100 transition-all shrink-0 flex items-center gap-1.5"><i class="fas fa-magic"></i> 직위 자동부여</button>' : ''}
                    </div>
                    <div class="relative w-full sm:w-64 shrink-0">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.setAnalysisSearch(this.value)" value="${appState.analysisFilters.search || ''}" class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-100 rounded-xl outline-none text-xs font-bold shadow-sm focus:ring-2 focus:ring-pink-50 transition-all" placeholder="닉네임/본캐/직업 검색 (다중검색)">
                    </div>
                </div>

                <!-- 스크롤 영역 (요약+MVP+차트+테이블) -->
                <div class="flex-1 overflow-y-auto min-h-0 flex flex-col gap-3">

                <!-- ★ 상단 요약 한 줄 -->
                <div class="grid grid-cols-1 sm:grid-cols-3 analysis-summary-grid gap-2 shrink-0 font-bold">
                    <div class="bg-white py-2.5 px-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center gap-3">
                        <span class="text-[8px] text-gray-400 uppercase tracking-widest">전체 총점</span>
                        <span class="text-base font-black text-gray-800 tracking-tighter">${displayTotal.toLocaleString()}</span>
                    </div>
                    <div class="bg-red-50 py-2.5 px-4 rounded-xl border border-red-100 shadow-sm flex items-center justify-center gap-3">
                        <span class="text-[8px] text-red-500 uppercase tracking-widest">🚨 미참여</span>
                        <span class="text-base font-black text-red-600">${zeroPointMembers.length}명</span>
                    </div>
                    <div class="bg-white py-2.5 px-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center gap-3 cursor-pointer group" onclick="window.expandChart()">
                        <span class="text-[8px] text-gray-400 uppercase tracking-widest">최근 주차</span>
                        <span class="text-sm font-bold text-gray-700">${currentHeader ? getWedStr(currentHeader) : '없음'}</span>
                        <span class="text-[8px] text-gray-300 group-hover:text-pink-400"><i class="fas fa-chart-line"></i></span>
                    </div>
                </div>
                <canvas id="analysisChart" style="display:none;"></canvas>

                <!-- ★ MVP 4개 한 줄 -->
                <div class="grid grid-cols-2 lg:grid-cols-4 analysis-mvp-grid gap-2 font-bold shrink-0">
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-blue-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('high')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-blue-500"><i class="fas fa-crown"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-blue-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-star"></i> <span class="hidden sm:inline">이번 주</span> 고득점</p><span class="text-[8px] text-blue-300 group-hover/mvp:text-blue-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topScoreHighMVP, 'high')}
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-orange-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('score')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-orange-500"><i class="fas fa-trophy"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-orange-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-arrow-trend-up"></i> 점수 떡상</p><span class="text-[8px] text-orange-300 group-hover/mvp:text-orange-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topScoreMVP, 'score')}
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-emerald-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('pct')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-emerald-500"><i class="fas fa-chart-line"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-emerald-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-percent"></i> 상승률</p><span class="text-[8px] text-emerald-300 group-hover/mvp:text-emerald-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topPctMVP, 'pct')}
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-fuchsia-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-purple-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('avg')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-purple-500"><i class="fas fa-bolt"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-purple-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-balance-scale"></i> 평균대비 떡상</p><span class="text-[8px] text-purple-300 group-hover/mvp:text-purple-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topAvgMVP, 'avg')}
                        </div>
                </div>

                <!-- ★ 전체 데이터 테이블 (전체 너비, 남은 공간 모두 사용) -->
                <div class="min-h-[80vh]">
                    <div class="bg-white rounded-xl lg:rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden h-full relative">
                        <div class="p-3 lg:p-4 border-b border-gray-50 flex justify-between items-center shrink-0 bg-white relative z-40">
                            <h3 class="text-[10px] lg:text-xs font-bold text-gray-800 uppercase tracking-widest">전체 데이터 (누적)</h3>
                            <button onclick="window.expandTable()" class="text-[9px] text-gray-300 hover:text-pink-400 transition-colors flex items-center gap-1 font-bold"><i class="fas fa-expand-alt"></i> 확대</button>
                        </div>
                        <div id="analysisTableWrapper" class="flex-1 overflow-auto bg-white scroll-smooth relative">
                            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                                <thead class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="p-3 text-center min-w-[50px] bg-gray-50">RANK</th>
                                        <th class="p-3 sortable cursor-pointer hover:bg-gray-200 min-w-[140px] bg-gray-50" onclick="window.setAnalysisSort('name')">캐릭터명${sortIcon('name')}</th>
                                        <th class="p-3 text-center sortable bg-pink-50 text-pink-600 cursor-pointer min-w-[110px]" onclick="window.setAnalysisSort('avg')">평균 (참여)${sortIcon('avg')}</th>
                                        ${recentHeaders.map((h, idx) => {
                                            const displayStr = getWedStr(h);
                                            return `<th class="p-3 min-w-[100px] text-right font-medium cursor-pointer hover:bg-gray-200 transition-colors select-none" onclick="window.setAnalysisSort('date_${h}')" title="클릭하여 상승률 순으로 정렬">${displayStr}${sortIcon('date_'+h)}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody id="analysisTableBody" class="font-bold text-gray-700">
                                    ${processedList.map((m, i) => {
                                        const globalIndex = i + 1;
                                        return `
                                        <tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50 cursor-pointer" onclick="window.showPersonalSuro(this.dataset.name)" data-name="${m.name}">
                                            <td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50 bg-white group-hover:bg-gray-50">${globalIndex}</td>
                                            <td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50 bg-white group-hover:bg-gray-50">
                                                <div class="flex items-center leading-none overflow-hidden text-ellipsis">
                                                    ${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}${m.level>0?'<span class="text-[8px] text-gray-400 font-mono ml-1">Lv.'+m.level+'</span>':''}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div>
                                                </div>
                                            </td>
                                            <td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>
                                            ${m.recentScores.map((s, scoreIdx) => {
                                                let diffHtml = '';
                                                let prevScore = 0;
                                                
                                                if (scoreIdx > 0) {
                                                    prevScore = m.recentScores[scoreIdx - 1];
                                                }

                                                if (s > 0 || (s === 0 && prevScore > 0)) {
                                                    if (prevScore > 0) {
                                                        const diffPct = ((s - prevScore) / prevScore * 100);
                                                        if (s > prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">▲ ${diffPct.toFixed(1)}%</span>`;
                                                        } else if (s < prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">▼ ${Math.abs(diffPct).toFixed(1)}%</span>`;
                                                        } else {
                                                            diffHtml = `<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;
                                                        }
                                                    } else if (s > 0) {
                                                        diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">▲ NEW</span>`;
                                                    }
                                                }

                                                return `
                                                <td class="p-3 min-w-[100px] text-right font-mono align-middle ${s === 0 ? 'bg-red-50/20 text-red-400 group-hover:bg-red-50/50' : 'bg-white text-gray-700 group-hover:bg-gray-50'}">
                                                    <div class="flex flex-col justify-center items-end leading-tight min-h-[28px]">
                                                        <span class="${s > 0 ? 'text-xs' : 'text-gray-400'}">${s > 0 ? s.toLocaleString() : '0'}</span>
                                                        ${diffHtml}
                                                    </div>
                                                </td>
                                                `;
                                            }).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>`;

            setTimeout(() => {
                const tableWrapper = document.getElementById('analysisTableWrapper');
                if (tableWrapper) {
                    tableWrapper.scrollLeft = tableWrapper.scrollWidth;
                }
            }, 100);

            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: recentHeaders.map(h => getShortWedStr(h)), 
                    datasets: [{ 
                        label: '길드 총점', 
                        data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)), 
                        borderColor: '#ec4899', 
                        borderWidth: 3, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(236, 72, 153, 0.05)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    } 
                } 
            });

            // 차트 확대 모달 함수
            window.expandMvp = (type) => {
                const data = window._mvpFullData?.[type] || [];
                if (data.length === 0) return;
                const titles = { high: '이번 주 고득점 전체 랭킹', score: '점수 떡상 전체 랭킹', pct: '상승률 전체 랭킹', avg: '평균대비 떡상 전체 랭킹' };
                const colors = { high: ['blue','from-blue-50 to-cyan-50','border-blue-100'], score: ['orange','from-yellow-50 to-orange-50','border-orange-100'], pct: ['emerald','from-emerald-50 to-teal-50','border-emerald-100'], avg: ['purple','from-purple-50 to-fuchsia-50','border-purple-100'] };
                const c = colors[type] || colors.high;
                const formatVal = (m) => {
                    if(type==='high') return Math.round(m.val).toLocaleString();
                    if(type==='score') return '+'+Math.round(m.val).toLocaleString();
                    if(type==='pct') return '▲'+m.val.toFixed(1)+'%';
                    if(type==='avg') return '+'+Math.round(m.val).toLocaleString();
                    return m.val;
                };

                const overlay = document.createElement('div');
                overlay.id = 'mvpModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
                overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;width:100%;max-width:480px;max-height:80vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;';
                modal.innerHTML = `
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center shrink-0 bg-gradient-to-r ${c[1]}">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">${titles[type]}</h3>
                        <button onclick="document.getElementById('mvpModal').remove()" class="w-8 h-8 rounded-full bg-white/60 hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-1">
                        ${data.map((m, i) => `
                            <div class="flex justify-between items-center py-2 px-3 rounded-xl ${i < 3 ? 'bg-gradient-to-r ' + c[1] + ' border ' + c[2] : i % 2 === 0 ? 'bg-gray-50' : ''} transition-colors">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <span class="font-black text-${c[0]}-500 w-7 text-center text-sm ${i < 3 ? '' : 'text-gray-400'}">${i+1}</span>
                                    <div class="flex items-center gap-1.5">${window.getNicknameIcon(m.role)}<span class="font-bold text-gray-800 text-sm truncate" style="max-width:180px;">${m.name}</span></div>
                                </div>
                                <span class="font-black text-${c[0]}-600 text-sm shrink-0 ${i >= 3 ? 'text-gray-600' : ''}">${formatVal(m)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="p-3 border-t border-gray-100 text-center shrink-0">
                        <span class="text-[10px] text-gray-400 font-bold">총 ${data.length}명</span>
                    </div>
                `;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
            };

            window.expandTable = () => {
                const existing = document.getElementById('tableModal');
                if (existing) existing.remove();

                const overlay = document.createElement('div');
                overlay.id = 'tableModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:0.75rem;';
                overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;width:100%;max-width:95vw;height:90vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;';

                const gName = appState.analysisGuild;
                const guildTargets = appState.members.filter(m => m.guild === gName);
                const recentHeaders = [...appState.suroHeaders];
                const getWedStr = (h) => { const m2 = h.match(/(\d+)-(\d+)-(\d+)\(.\)\s*~\s*(\d+)-(\d+)-(\d+)/); return m2 ? m2[4]+'/'+m2[5]+'/'+m2[6] : h; };

                let modalSort = { field: appState.analysisFilters.sortField, order: appState.analysisFilters.sortOrder };
                let modalSearch = '';

                function renderModalTable() {
                    const searchTokens = modalSearch.length > 0 ? modalSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) : [];
                    const filtered = searchTokens.length > 0
                        ? guildTargets.filter(m => { const mn = m.isMain ? m.name : (m.mainCharName||''); return searchTokens.some(t => m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t)); })
                        : guildTargets;

                    const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;
                    const processed = filtered.map(m => {
                        const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0);
                        const vs = scores.filter(s => s > 0);
                        return { ...m, avg: vs.length > 0 ? Math.round(vs.reduce((a,b)=>a+b,0)/vs.length) : 0, recentScores: scores };
                    });

                    const f = modalSort.field, o = modalSort.order;
                    processed.sort((a,b) => {
                        if(f.startsWith('date_')){const th=f.replace('date_',''),hi=recentHeaders.indexOf(th),ph=hi>0?recentHeaders[hi-1]:null;const rate=(m)=>{const c=Math.round(Number(m.suro?.[th]))||0;if(!ph)return c>0?-500:-1000;const p=Math.round(Number(m.suro?.[ph]))||0;if(c===0&&p===0)return-1000;if(p===0&&c>0)return-500;return((c-p)/p)*100;};const rA=rate(a),rB=rate(b);if(rA===rB){const cA=Math.round(Number(a.suro?.[th]))||0,cB=Math.round(Number(b.suro?.[th]))||0;return o==='asc'?cA-cB:cB-cA;}return o==='asc'?rA-rB:rB-rA;}
                        if(f==='avg')return o==='asc'?a.avg-b.avg:b.avg-a.avg;
                        if(f==='score'){const vA=Math.round(Number(a.suro?.[currentHeader]))||0,vB=Math.round(Number(b.suro?.[currentHeader]))||0;return o==='asc'?vA-vB:vB-vA;}
                        return o==='asc'?String(a.name).localeCompare(String(b.name)):String(b.name).localeCompare(String(a.name));
                    });

                    const si = (col) => modalSort.field === col ? (modalSort.order === 'asc' ? ' ▲' : ' ▼') : '';
                    const tbody = document.getElementById('modalTableBody');
                    const thead = document.getElementById('modalTableHead');
                    if (thead) {
                        thead.innerHTML = `<tr>
                            <th class="p-3 text-center min-w-[50px] bg-gray-50">RANK</th>
                            <th class="p-3 min-w-[140px] cursor-pointer hover:bg-gray-200 bg-gray-50" onclick="window._modalSort('name')">캐릭터명${si('name')}</th>
                            <th class="p-3 text-center min-w-[110px] cursor-pointer bg-pink-50 text-pink-600 hover:bg-pink-100" onclick="window._modalSort('avg')">평균 (참여)${si('avg')}</th>
                            ${recentHeaders.map(h => `<th class="p-3 min-w-[100px] text-right cursor-pointer hover:bg-gray-200 bg-gray-50" onclick="window._modalSort('date_${h}')">${getWedStr(h)}${si('date_'+h)}</th>`).join('')}
                        </tr>`;
                    }
                    if (tbody) {
                        tbody.innerHTML = processed.map((m,i) => {
                            let row = `<tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50">
                                <td class="p-3 text-center text-gray-400 bg-white">${i+1}</td>
                                <td class="p-3 text-gray-800 bg-white"><div class="flex items-center leading-none">${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}${m.level>0?'<span class="text-[8px] text-gray-400 font-mono ml-1">Lv.'+m.level+'</span>':''}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div></div></td>
                                <td class="p-3 text-center text-pink-600 bg-pink-50/30">${m.avg.toLocaleString()}</td>`;
                            m.recentScores.forEach((s,si) => {
                                let dh='',ps=si>0?m.recentScores[si-1]:0;
                                if(s>0||(s===0&&ps>0)){if(ps>0){const dp=((s-ps)/ps*100);if(s>ps)dh=`<span class="text-[9px] text-red-500 font-bold block mt-0.5">▲ ${dp.toFixed(1)}%</span>`;else if(s<ps)dh=`<span class="text-[9px] text-blue-500 font-bold block mt-0.5">▼ ${Math.abs(dp).toFixed(1)}%</span>`;else dh=`<span class="text-[9px] text-gray-400 font-bold block mt-0.5">- 0.0%</span>`;}else if(s>0)dh=`<span class="text-[9px] text-red-500 font-bold block mt-0.5">▲ NEW</span>`;}
                                row+=`<td class="p-3 min-w-[100px] text-right font-mono ${s===0?'bg-red-50/20 text-red-400':'text-gray-700'}"><div class="flex flex-col items-end leading-tight min-h-[28px]"><span class="${s>0?'text-xs':'text-gray-400'}">${s>0?s.toLocaleString():'0'}</span>${dh}</div></td>`;
                            });
                            return row + '</tr>';
                        }).join('');
                    }
                }

                window._modalSort = (col) => {
                    if (modalSort.field === col) { modalSort.order = modalSort.order === 'asc' ? 'desc' : 'asc'; }
                    else { modalSort.field = col; modalSort.order = (col==='avg'||col==='score'||col.startsWith('date_')) ? 'desc' : 'asc'; }
                    renderModalTable();
                };

                modal.innerHTML = `
                    <div style="padding:1rem 1.25rem;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;gap:1rem;">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest shrink-0">전체 데이터 — ${gName}</h3>
                        <div class="flex items-center gap-2 flex-1 max-w-md">
                            <div class="flex-1 relative">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i>
                                <input id="modalSearchInput" type="text" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100" placeholder="닉네임/본캐/직업 검색" oninput="clearTimeout(window._mst);window._mst=setTimeout(()=>{window._modalSearchFn(this.value)},150)">
                            </div>
                            <button onclick="document.getElementById('tableModal').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors shrink-0"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div style="flex:1;overflow:auto;-webkit-overflow-scrolling:touch;" class="no-scrollbar">
                        <table class="w-full text-left text-xs whitespace-nowrap font-bold stick-head">
                            <thead id="modalTableHead" class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200"></thead>
                            <tbody id="modalTableBody" class="text-gray-700"></tbody>
                        </table>
                    </div>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                window._modalSearchFn = (v) => { modalSearch = v.trim(); renderModalTable(); };
                renderModalTable();

                const scrollDiv = modal.querySelector('[style*="overflow:auto"]');
                if (scrollDiv) scrollDiv.scrollLeft = scrollDiv.scrollWidth;
            };

            window.expandChart = () => {
                const gName = appState.analysisGuild;
                const guildTargets = appState.members.filter(m => m.guild === gName);
                const recentHeaders = [...appState.suroHeaders];
                const getShortWedStr = (h) => { const m2 = h.match(/(\d+)-(\d+)-(\d+)\(.\)\s*~\s*(\d+)-(\d+)-(\d+)/); return m2 ? m2[4]+'/'+m2[5]+'/'+m2[6] : h; };

                const overlay = document.createElement('div');
                overlay.id = 'chartModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
                overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;padding:1.5rem;width:100%;max-width:900px;max-height:90vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);position:relative;';
                modal.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">주간 총점 추이 — ${gName}</h3>
                        <button onclick="document.getElementById('chartModal').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="height:400px;position:relative;"><canvas id="expandedChart"></canvas></div>
                `;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                setTimeout(() => {
                    const ctx2 = document.getElementById('expandedChart');
                    if(!ctx2) return;
                    new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: recentHeaders.map(h => getShortWedStr(h)),
                            datasets: [{
                                label: '길드 총점',
                                data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)),
                                borderColor: '#ec4899', borderWidth: 3, pointRadius: 6, pointBackgroundColor: '#fff',
                                pointBorderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(236, 72, 153, 0.08)'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { backgroundColor: '#1f2937', titleFont: { size: 13, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 10,
                                    callbacks: { label: (c) => '총점: ' + c.parsed.y.toLocaleString() }
                                }
                            },
                            scales: {
                                y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11, weight: 'bold' }, callback: (v) => v.toLocaleString() } },
                                x: { grid: { display: false }, ticks: { font: { size: 11, weight: 'bold' } } }
                            }
                        }
                    });
                }, 50);
            };
        };
        
        window.setAnalysisSort = (f) => { 
            if(appState.analysisFilters.sortField === f) {
                appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            } else { 
                appState.analysisFilters.sortField = f; 
                appState.analysisFilters.sortOrder = (f==='score'||f==='rank'||f==='avg'||f.startsWith('date_')) ? 'desc' : 'asc'; 
            } 
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        };

        window._jobExpanded = false;
        window.updateJobChart = (target) => {
            const container = document.getElementById('jobChartContainer'); if(!container) return;
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || '미설정'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            window._jobSorted = sorted;
            const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
            window._jobMaxCount = maxCount;
            const barColors = ['#F9A8D4','#FCA5A5','#FDBA74','#FDE68A','#A7F3D0','#93C5FD','#C4B5FD','#F0ABFC','#6EE7B7','#7DD3FC','#FDA4AF','#D8B4FE','#A5B4FC','#99F6E4'];
            window._jobColors = barColors;
            const list = window._jobExpanded ? sorted : sorted.slice(0, 7);
            container.innerHTML = list.map((item, i) => {
                const pct = Math.round((item[1] / maxCount) * 100);
                const color = barColors[i % barColors.length];
                return `<div><div class="flex justify-between items-center mb-1"><span class="text-xs lg:text-sm font-bold text-gray-700">${item[0]}</span><span class="text-xs lg:text-sm font-black text-gray-500">${item[1]}</span></div><div class="w-full bg-gray-100 rounded-full h-2.5 lg:h-3 overflow-hidden"><div class="h-full rounded-full transition-all duration-700" style="width:${pct}%;background:${color}"></div></div></div>`;
            }).join('');
            const btn = document.getElementById('jobToggleBtn');
            if(btn) btn.style.display = sorted.length <= 7 ? 'none' : 'flex';
            const icon = document.getElementById('jobToggleIcon');
            const txt = document.getElementById('jobToggleText');
            if(icon) icon.className = window._jobExpanded ? 'fas fa-chevron-up text-[8px]' : 'fas fa-chevron-down text-[8px]';
            if(txt) txt.textContent = window._jobExpanded ? '접기' : '더보기 (' + (sorted.length - 7) + ')';
        };
        window.toggleJobChart = () => {
            window._jobExpanded = !window._jobExpanded;
            const select = document.querySelector('#jobChartContainer')?.closest('.shrink-0')?.querySelector('select');
            window.updateJobChart(select ? select.value : 'all');
        };

        window.renderMembers = (container) => {
            container.innerHTML = `
            <div class="flex flex-col gap-2 lg:gap-3 fade-in h-full">
                <div class="bg-white p-3 lg:p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-3 shrink-0">
                    <div class="flex overflow-x-auto no-scrollbar w-full gap-1.5 lg:gap-2 shrink-0 pb-0.5">
                        <button onclick="window.filterByGuild('all')" class="shrink-0 px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">전체<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === 'all' ? 'bg-white/20 text-white' : 'bg-gray-200/60 text-gray-400'}">${appState.members.length}</span></button>
                        ${appState.guilds.map(g => { const gc = appState.members.filter(m => m.guild === g.name).length; const gColors = {'뚠카롱':['bg-pink-500','bg-pink-400/20'],'뚱카롱':['bg-rose-600','bg-rose-400/20'],'밤카롱':['bg-indigo-500','bg-indigo-400/20'],'별카롱':['bg-amber-500','bg-amber-400/20'],'달카롱':['bg-blue-500','bg-blue-400/20'],'꿀카롱':['bg-orange-500','bg-orange-400/20']}; const [activeBg, activeBadge] = gColors[g.name] || ['bg-pink-500','bg-pink-400/20']; return `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === g.name ? activeBg + ' text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === g.name ? 'bg-white/25 text-white' : 'bg-gray-200/60 text-gray-400'}">${gc}</span></button>`; }).join('')}
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 lg:left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-8 lg:pl-10 pr-3 lg:pr-4 py-2 lg:py-2.5 bg-gray-50 border border-gray-100 rounded-xl outline-none text-[11px] lg:text-xs font-bold shadow-inner focus:ring-2 focus:ring-pink-50 transition-all" placeholder="닉네임 검색 (띄어쓰기로 다중검색)">
                        </div>

                        ${isAdmin() ? `<div class="flex gap-1.5 lg:gap-2 shrink-0 flex-wrap">
                            <button onclick="window.toggleKickMode()" class="px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all ${appState.isKickMode ? 'bg-red-500 text-white shadow-md animate-pulse' : 'bg-red-50 text-red-500 hover:bg-red-100'}">
                                <i class="fas fa-user-minus mr-1"></i> <span class="hidden sm:inline">일괄 추방</span> ${appState.isKickMode?'ON':'OFF'}
                            </button>
                            ${appState.isKickMode && appState.kickSelection.size > 0 ? `<button onclick="window.openBulkKickModal()" class="px-3 lg:px-4 py-1.5 lg:py-2 bg-red-600 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-md hover:bg-red-700 transition-all">${appState.kickSelection.size}명 추방</button>` : ''}
                            
                            ${!appState.isKickMode ? `
                            <button onclick="window.toggleBatchMode()" class="px-3 lg:px-4 py-1.5 lg:py-2 rounded-xl text-[10px] lg:text-xs font-bold transition-all ${appState.isBatchMode ? 'bg-gray-800 text-white shadow-md' : 'bg-pink-50 text-pink-500 hover:bg-pink-100'}">
                                <i class="fas fa-edit mr-1"></i> <span class="hidden sm:inline">일괄 수정</span> ${appState.isBatchMode?'OFF':'ON'}
                            </button>
                            ${appState.isBatchMode ? `<button onclick="window.saveBatchUpdates()" class="px-3 lg:px-4 py-1.5 lg:py-2 bg-pink-500 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-md animate-pulse">저장</button>` : ''}
                            <button onclick="window.openAddModal()" class="w-8 h-8 lg:w-9 lg:h-9 flex items-center justify-center rounded-xl bg-pink-50 text-pink-500 hover:bg-pink-100 shadow-sm shrink-0"><i class="fas fa-plus text-xs"></i></button>
                            ` : ''}
                        </div>` : ''}
                    </div>
                </div>

                <div id="memberTableContainer" class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
            </div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            
            const rawSearchTerm = appState.filters.search.trim();
            const searchTokens = rawSearchTerm.length > 0 
                ? rawSearchTerm.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0)
                : [];

            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                if (searchTokens.length === 0) return gMatch;
                const sMatch = searchTokens.some(token => {
                    return m.name.toLowerCase().includes(token) || 
                           (m.class||'').toLowerCase().includes(token) || 
                           (m.role||'').toLowerCase().includes(token) ||
                           (m.mainCharName || '').toLowerCase().includes(token) || 
                           (m.isMain && m.name.toLowerCase().includes(token)); 
                });
                return gMatch && sMatch; 
            });

            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.members > totalPages && totalPages > 0) appState.pagination.members = totalPages;
            if (appState.pagination.members < 1) appState.pagination.members = 1;
            
            const pageData = filtered.slice((appState.pagination.members - 1) * ITEMS_PER_PAGE, appState.pagination.members * ITEMS_PER_PAGE);
            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            
            let html = `<div class="overflow-auto flex-1 relative -webkit-overflow-scrolling-touch"><table class="w-full text-left min-w-[700px] lg:min-w-[900px] text-[10px] lg:text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[9px] lg:text-[10px] font-bold text-gray-500 border-b border-gray-100 shadow-sm"><tr><th class="py-2 px-2 text-center w-8 lg:w-12">${appState.isKickMode ? '선택' : 'No.'}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('name')">닉네임${sortIcon('name')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('mainInfo')">본캐${sortIcon('mainInfo')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('guild')">소속${sortIcon('guild')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('role')">직위${sortIcon('role')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('class')">직업${sortIcon('class')}</th>${isAdmin() ? '<th class="py-2 px-2 text-right">관리</th>' : ''}</tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            
            pageData.forEach((m, idx) => {
                const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                const mainMem = appState.members.find(x => x.name === mainName);
                const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                
                const targetRole = mainMem ? mainMem.role : (m.isMain ? m.role : '');
                
                // 크로칸슈 이상만 좌측 테두리 + 배경 (다크모드 대응)
                const isDark = document.documentElement.classList.contains('dark');
                let rowStyle = "";
                if (targetRole === '크라운') {
                    rowStyle = isDark 
                        ? "background:rgba(234,179,8,0.1);border-left:3px solid #F0C050;" 
                        : "background:linear-gradient(to right,#FFF9E6,#FFF3CC);border-left:3px solid #F0C050;";
                } else if (targetRole === '파르페') {
                    rowStyle = isDark 
                        ? "background:rgba(99,102,241,0.1);border-left:3px solid #8EA8F0;" 
                        : "background:linear-gradient(to right,#EBF0FF,#E4EAFF);border-left:3px solid #8EA8F0;";
                } else if (targetRole === '티라미슈') {
                    rowStyle = isDark 
                        ? "background:rgba(99,102,241,0.08);border-left:3px solid #A0B4E8;" 
                        : "background:linear-gradient(to right,#EBF0FF,#E8EDFF);border-left:3px solid #A0B4E8;";
                } else if (targetRole === '크로칸슈') {
                    rowStyle = isDark 
                        ? "background:rgba(34,197,94,0.1);border-left:3px solid #92D050;" 
                        : "background:linear-gradient(to right,#EEFFEE,#E5FAE5);border-left:3px solid #92D050;";
                }

                const pending = appState.pendingUpdates[m.id];
                const currentGuild = pending && pending.guild ? pending.guild : m.guild;
                const currentRole = pending && pending.role ? pending.role : m.role;
                const currentClass = pending && pending.class ? pending.class : (m.class || '');

                let roleHtml = `<span class="text-[10px]">${m.role}</span>`;
                if (!appState.isBatchMode && m.role === '아인슈페너') {
                    roleHtml = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold text-white tracking-tight shadow-sm" style="background-color: #FF99FF; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">${m.role}</span>`;
                }

                html += `<tr class="${pending ? 'batch-modified' : ''} hover:bg-pink-50/20 group transition-colors" style="${rowStyle}">
                    <td class="py-1.5 px-2 text-center text-gray-400 text-[11px]">
                        ${appState.isKickMode 
                            ? `<input type="checkbox" class="custom-checkbox" ${appState.kickSelection.has(m.id) ? 'checked' : ''} onchange="window.handleKickSelect('${m.id}')">`
                            : globalIndex}
                    </td>
                    <td class="py-1.5 px-2 font-bold text-gray-800 flex items-center leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td>
                    <td class="py-1.5 px-2 leading-tight">
                        <span class="block text-[11px] font-bold text-gray-700">${mainName}</span>
                        <span class="text-[9px] font-medium text-gray-400">${mainRankHtml}</span>
                    </td>
                    <td class="py-1.5 px-2">${appState.isBatchMode ? `<select onchange="window.stageUpdate('${m.id}', 'guild', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${appState.guilds.map(g=>`<option value="${g.name}" ${currentGuild===g.name?'selected':''}>${g.name}</option>`).join('')}</select>` : m.guild}</td>
                    <td class="py-1.5 px-2">${appState.isBatchMode ? `<select onchange="window.stageUpdate('${m.id}', 'role', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${(appState.guildRanks[currentGuild]||initialGuildRanks[currentGuild]||initialGuildRanks['뚠카롱']).map(r=>`<option value="${r}" ${currentRole===r?'selected':''}>${r}</option>`).join('')}</select>` : roleHtml}</td>
                    <td class="py-1.5 px-2">${appState.isBatchMode ? `<input type="text" value="${currentClass}" onchange="window.stageUpdate('${m.id}', 'class', this.value)" class="bg-white border rounded px-1 text-[10px] w-24 outline-none">` : `<span class="text-[10px] text-gray-400">${m.class||'-'}</span>`}</td>
                    <td class="py-1.5 px-2 text-right">
                        ${isAdmin() && !appState.isBatchMode && !appState.isKickMode ? `<div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="window.openEditModal('${m.id}')" class="w-7 h-7 rounded-lg border border-gray-100 text-blue-500 hover:bg-blue-50 flex items-center justify-center shadow-sm"><i class="fas fa-edit text-[10px]"></i></button><button onclick="window.openDeleteModal('${m.id}')" class="w-7 h-7 rounded-lg border border-gray-100 text-red-500 hover:bg-red-50 flex items-center justify-center shadow-sm"><i class="fas fa-trash text-[10px]"></i></button></div>` : ''}
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            
            html += `<div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50 relative z-20">
                <button onclick="changePage('members', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                <span class="text-xs font-bold text-gray-500">${appState.pagination.members} / ${totalPages || 1}</span>
                <button onclick="changePage('members', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
            </div>`;

            container.innerHTML = html;
        };

        window.renderBail = (container) => {
            const receivers = appState.members.filter(m => m.guild === '뚠카롱' && ['마카롱', '다쿠아즈'].includes(m.role)).sort((a,b) => smartCompare(a, b, 'name', 'asc'));
            const adminStats = window.getAdminBailStats();
            const totalStats = window.getBailTotalStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => {
                const amt = parseInt(h.amount) || 0;
                const isUse = amt < 0;
                const typeBadge = isUse ? '<span class="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded text-[9px] font-bold">사용</span>' : '<span class="bg-pink-100 text-pink-600 px-1.5 py-0.5 rounded text-[9px] font-bold">납부</span>';
                const amtColor = isUse ? 'text-blue-500' : 'text-pink-500';
                const amtDisplay = isUse ? `${amt}개` : `+${amt}개`;
                const memo = h.memo ? `<span class="text-[10px] text-gray-400 ml-1">(${h.memo})</span>` : '';
                return `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 font-mono text-gray-400 text-[10px]">${h.date}</td><td class="p-4">${typeBadge}</td><td class="p-4 text-gray-700">${h.payer}${memo}</td><td class="p-4 text-blue-500">${h.receiver}</td><td class="p-4 text-right ${amtColor}">${amtDisplay}</td></tr>`;
            }).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black ${count >= 0 ? 'text-pink-500' : 'text-blue-500'} text-lg">${count}개</span></div>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 ${isAdmin() ? 'lg:grid-cols-3' : ''} gap-8 fade-in h-full">
                ${isAdmin() ? `<div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">보석금 관리</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL MANAGEMENT</p>` : `<div style="display:none;">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">보석금 관리</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL MANAGEMENT</p>`}
                    </div>
                    <div class="flex gap-2 mb-6" id="bailTypeToggle">
                        <button onclick="window.setBailType('deposit')" class="bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all bg-pink-500 text-white shadow-md" data-type="deposit">💎 납부</button>
                        <button onclick="window.setBailType('use')" class="bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all bg-gray-100 text-gray-400 hover:bg-gray-200" data-type="use">📦 사용</button>
                    </div>
                    <div class="space-y-6 flex-1 overflow-y-auto no-scrollbar pb-6">
                        <div id="bailDepositForm">
                            <div class="space-y-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">납부자</label><input type="text" id="bailPayerInput" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" placeholder="닉네임 직접 입력"></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">수령자</label><select id="bailReceiver" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer">${receivers.map(r=>`<option value="${r.name}">${r.name} (${r.role})</option>`).join('')}</select></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">수량</label><input type="number" id="bailAmount" value="1" min="1" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner"></div>
                                <button onclick="window.submitBail()" id="btnBailSubmit" class="w-full py-6 bg-gray-900 text-white rounded-[2rem] font-bold text-xs shadow-2xl hover:bg-black transition-all active:scale-[0.98]">💎 납부 확인 및 저장</button>
                            </div>
                        </div>
                        <div id="bailUseForm" class="hidden">
                            <div class="space-y-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">사용 사유</label><input type="text" id="bailUseMemo" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" placeholder="예: 길드 이벤트 보상"></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">담당자</label><select id="bailUseReceiver" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer">${receivers.map(r=>`<option value="${r.name}">${r.name} (${r.role})</option>`).join('')}</select></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">사용 수량</label><input type="number" id="bailUseAmount" value="1" min="1" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner"></div>
                                <button onclick="window.submitBailUse()" id="btnBailUseSubmit" class="w-full py-6 bg-blue-600 text-white rounded-[2rem] font-bold text-xs shadow-2xl hover:bg-blue-700 transition-all active:scale-[0.98]">📦 사용 확인 및 저장</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t">
                            <div class="bg-pink-50 rounded-xl p-3 text-center"><p class="text-[9px] text-gray-400 font-bold">총 납부</p><p class="text-sm font-black text-pink-500">+${totalStats.totalIn}</p></div>
                            <div class="bg-blue-50 rounded-xl p-3 text-center"><p class="text-[9px] text-gray-400 font-bold">총 사용</p><p class="text-sm font-black text-blue-500">-${totalStats.totalOut}</p></div>
                            <div class="bg-gray-50 rounded-xl p-3 text-center"><p class="text-[9px] text-gray-400 font-bold">잔여</p><p class="text-sm font-black ${totalStats.net >= 0 ? 'text-green-500' : 'text-red-500'}">${totalStats.net}</p></div>
                        </div>
                        <div class="mt-4 border-t pt-4"><h4 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">간부별 수령 총계</h4><div class="grid grid-cols-1 gap-2">${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center">데이터 없음</p>'}</div></div>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">보석금 내역 (yy-mm-dd)</h3>
                        <span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase"><tr><th class="p-5">날짜</th><th class="p-5">구분</th><th class="p-5">납부자/사유</th><th class="p-5">수령자</th><th class="p-5 text-right">수량</th></tr></thead>
                            <tbody class="divide-y divide-gray-50">${historyRows || '<tr><td colspan="5" class="p-20 text-center text-gray-300 font-bold italic">내역이 존재하지 않습니다.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        window.setBailType = (type) => {
            const depForm = document.getElementById('bailDepositForm');
            const useForm = document.getElementById('bailUseForm');
            const btns = document.querySelectorAll('.bail-type-btn');
            btns.forEach(b => {
                if (b.dataset.type === type) { b.className = 'bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all ' + (type === 'deposit' ? 'bg-pink-500 text-white shadow-md' : 'bg-blue-600 text-white shadow-md'); }
                else { b.className = 'bail-type-btn flex-1 py-3 rounded-2xl font-bold text-xs transition-all bg-gray-100 text-gray-400 hover:bg-gray-200'; }
            });
            if (type === 'deposit') { depForm.classList.remove('hidden'); useForm.classList.add('hidden'); }
            else { depForm.classList.add('hidden'); useForm.classList.remove('hidden'); }
        };

        window.submitBail = async () => {
            const pI = document.getElementById('bailPayerInput'), rI = document.getElementById('bailReceiver'), aI = document.getElementById('bailAmount'), btn = document.getElementById('btnBailSubmit');
            const payer = pI.value.trim(), receiver = rI.value, amount = aI.value; if(!payer || !receiver || !amount) return window.showMsg("항목을 모두 입력하세요.", "error");
            if(!confirm(`${payer} 님의 보석금 ${amount}개를 저장하시겠습니까?`)) return;
            if (btn) { btn.disabled = true; btn.innerText = "전송 중..."; }
            if (await window.sendAction('save_bail', { payer, receiver, amount })) { pI.value = ''; aI.value = '1'; }
            else if (btn) { btn.disabled = false; btn.innerText = "💎 납부 확인 및 저장"; }
        };

        window.submitBailUse = async () => {
            const mI = document.getElementById('bailUseMemo'), rI = document.getElementById('bailUseReceiver'), aI = document.getElementById('bailUseAmount'), btn = document.getElementById('btnBailUseSubmit');
            const memo = mI.value.trim(), receiver = rI.value, amount = aI.value; if(!memo || !receiver || !amount) return window.showMsg("항목을 모두 입력하세요.", "error");
            const negAmount = '-' + amount;
            if(!confirm(`보석금 ${amount}개 사용 (${memo})을 기록하시겠습니까?`)) return;
            if (btn) { btn.disabled = true; btn.innerText = "전송 중..."; }
            if (await window.sendAction('save_bail', { payer: memo, receiver, amount: negAmount, memo })) { mI.value = ''; aI.value = '1'; }
            else if (btn) { btn.disabled = false; btn.innerText = "📦 사용 확인 및 저장"; }
        };

        window.renderPenalty = (container) => {
            const memberOptions = appState.members.map(m => `<option value="${m.name}">${m.name} (${m.guild})</option>`).sort();
            
            let activePenalties;
            if (isAdmin()) {
                const penaltyCounts = {};
                appState.penaltyHistory.forEach(h => {
                    penaltyCounts[h.name] = (penaltyCounts[h.name] || 0) + Number(h.points);
                });
                activePenalties = Object.entries(penaltyCounts).filter(([name, pts]) => pts > 0);
            } else {
                // 비로그인: 각 건을 개별 표시 (이름 비공개)
                activePenalties = appState.penaltyHistory.map(h => ['비공개', Number(h.points)]);
            }

            const penaltyRows = [...appState.penaltyHistory].map(h => {
                let displayDate = "-";
                if(h.date) {
                    const datePart = h.date.split(' ')[0];
                    if(datePart.length >= 2) displayDate = datePart.substring(2);
                }
                
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <td class="p-4 font-mono text-gray-400 text-[10px]">${displayDate}</td>
                    <td class="p-4 text-gray-700">${h.name}</td>
                    <td class="p-4 text-red-500">${h.points}점</td>
                    <td class="p-4 text-gray-500 text-[11px]">${h.reason}</td>
                </tr>
            `}).join('');

            container.innerHTML = `
            <div class="grid grid-cols-1 ${isAdmin() ? 'lg:grid-cols-3' : ''} gap-4 lg:gap-8 fade-in h-full">
                ${isAdmin() ? `<div class="lg:col-span-1 bg-white p-5 lg:p-10 rounded-2xl lg:rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-4 lg:mb-8">` : `<div style="display:none;">
                    <div class="mb-4 lg:mb-8">`}
                        <h3 class="text-base lg:text-xl font-bold text-gray-800 tracking-tight">벌점 부여</h3>
                        <p class="text-[10px] lg:text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">PENALTY RECORD</p>
                    </div>
                    <div class="space-y-4 lg:space-y-6 flex-1 overflow-y-auto no-scrollbar pb-4 lg:pb-6">
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">부여 날짜</label>
                            <input type="date" id="penaltyDate" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-inner" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">대상자</label>
                            <select id="penaltyTarget" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-sm cursor-pointer">
                                <option value="">대상자를 선택하세요</option>
                                ${memberOptions}
                            </select>
                        </div>
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">벌점 (1~10점)</label>
                            <select id="penaltyPoints" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-sm cursor-pointer">
                                ${[1,2,3,4,5,6,7,8,9,10].map(i => `<option value="${i}">${i}점</option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-1.5 lg:space-y-2">
                            <label class="text-[9px] lg:text-[10px] font-bold text-gray-400 ml-1 uppercase">부여 사유</label>
                            <textarea id="penaltyReason" rows="3" class="w-full bg-gray-50 border border-gray-100 rounded-xl lg:rounded-2xl p-3 lg:p-4 text-xs lg:text-sm font-bold outline-none shadow-inner resize-none" placeholder="상세 사유를 입력하세요"></textarea>
                        </div>
                        <button onclick="window.submitPenalty()" id="btnPenaltySubmit" class="w-full py-4 lg:py-6 bg-red-600 text-white rounded-xl lg:rounded-[2rem] font-bold text-[10px] lg:text-xs shadow-xl hover:bg-red-700 transition-all active:scale-[0.98] mt-2 lg:mt-4">벌점 저장</button>
                    </div>
                </div>

                <div class="lg:col-span-2 flex flex-col gap-4 lg:gap-6 h-full overflow-hidden">
                    <div class="bg-white p-5 lg:p-8 rounded-2xl lg:rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[120px] lg:min-h-[160px]">
                        <div class="mb-3 lg:mb-4">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-800 uppercase tracking-widest">현재 벌점 관리 대상자</h3>
                        </div>
                        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                            ${activePenalties.length > 0 
                                ? activePenalties.map(([name, pts]) => `
                                    <div class="flex items-center gap-3 bg-red-50 pl-2 pr-5 py-2 rounded-full border border-red-100 shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 font-bold text-xs shadow-sm">${pts}</div>
                                        <span class="text-xs font-bold text-red-600">${name}</span>
                                    </div>
                                  `).join('')
                                : '<p class="text-xs text-gray-300 font-bold italic w-full">현재 벌점자가 없습니다.</p>'
                            }
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl lg:rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden h-full">
                        <div class="p-4 lg:p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="text-[10px] lg:text-sm font-bold text-gray-800 uppercase tracking-widest">상세 부여 이력</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar">
                            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                                <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase">
                                    <tr>
                                        <th class="p-5">날짜</th>
                                        <th class="p-5">대상자</th>
                                        <th class="p-5">점수</th>
                                        <th class="p-5">부여 사유</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${penaltyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">벌점 이력이 없습니다.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        window.submitPenalty = async () => {
            const date = document.getElementById('penaltyDate').value;
            const target = document.getElementById('penaltyTarget').value;
            const points = document.getElementById('penaltyPoints').value;
            const reason = document.getElementById('penaltyReason').value.trim();
            const btn = document.getElementById('btnPenaltySubmit');

            if (!date || !target || !points || !reason) return window.showMsg("모든 항목을 입력해주세요.", "error");
            if (!confirm(`${target}님에게 ${date} 일자로 벌점 ${points}점을 부여하시겠습니까?`)) return;

            if (btn) { btn.disabled = true; btn.innerText = "저장 중..."; }
            if (await window.sendAction('save_penalty', { date: date, name: target, points: points, reason: reason })) {
                document.getElementById('penaltyReason').value = '';
            } else if (btn) {
                btn.disabled = false; btn.innerText = "벌점 저장";
            }
        };

        window.renderSheet = (container) => {
            if (!window._sheetState) {
                window._sheetState = { guild: '뚠카롱', search: '', mode: 'members', edited: {}, suroEdited: {} };
            }
            const ss = window._sheetState;

            container.innerHTML = `
            <div class="h-full flex flex-col gap-3 fade-in">
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4 lg:p-5 shrink-0">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <h3 class="text-sm lg:text-base font-bold text-gray-800"><i class="fas fa-table mr-2 text-emerald-500"></i>DB 시트 뷰어</h3>
                        <div class="flex gap-1.5 ml-auto">
                            ${['members','bail_history','penalty_history','operation_history','events'].map(t => 
                                `<button onclick="window._sheetState.mode='${t}';window._sheetState.edited={};window._sheetState.suroEdited={};window.renderSheet(document.getElementById('contentArea'))" class="px-2.5 py-1 rounded-lg text-[9px] font-bold transition-all ${ss.mode === t ? 'bg-emerald-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">${({members:'멤버+수로',bail_history:'보석금',penalty_history:'벌점',operation_history:'운영이력',events:'일정'})[t]}</button>`
                            ).join('')}
                        </div>
                    </div>
                    ${ss.mode === 'members' ? `
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="flex gap-1">
                            ${appState.guilds.map(g => 
                                `<button onclick="window._sheetState.guild='${g.name}';window.renderSheet(document.getElementById('contentArea'))" class="px-2.5 py-1.5 rounded-lg text-[9px] font-bold transition-all ${ss.guild === g.name ? 'bg-pink-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">${g.name.replace('카롱','')}</button>`
                            ).join('')}
                        </div>
                        <input type="text" id="sheetSearch" placeholder="이름 검색..." value="${ss.search}" oninput="window._sheetState.search=this.value;window._sheetRender()" class="bg-gray-50 border border-gray-100 rounded-lg px-2.5 py-1.5 text-[10px] font-bold outline-none w-36 shadow-inner">
                        <button onclick="window._sheetSave()" id="sheetSaveBtn" class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-[9px] font-bold shadow hover:bg-emerald-600 transition-all hidden"><i class="fas fa-save mr-1"></i>저장</button>
                        <button onclick="window._sheetDiscard()" id="sheetDiscardBtn" class="px-3 py-1.5 bg-gray-400 text-white rounded-lg text-[9px] font-bold shadow hover:bg-gray-500 transition-all hidden"><i class="fas fa-undo mr-1"></i>취소</button>
                        <span id="sheetEditCount" class="text-[9px] font-bold text-orange-500"></span>
                        <span class="text-[9px] text-gray-400 font-bold ml-auto" id="sheetCount"></span>
                    </div>` : `
                    <div class="flex flex-wrap items-center gap-2">
                        <button onclick="window._sheetAddRow()" class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-[9px] font-bold shadow hover:bg-blue-600 transition-all"><i class="fas fa-plus mr-1"></i>행 추가</button>
                        <button onclick="window._sheetSaveOther()" id="sheetOtherSaveBtn" class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-[9px] font-bold shadow hover:bg-emerald-600 transition-all hidden"><i class="fas fa-save mr-1"></i>저장</button>
                        <button onclick="window._sheetDiscardOther()" id="sheetOtherDiscardBtn" class="px-3 py-1.5 bg-gray-400 text-white rounded-lg text-[9px] font-bold shadow hover:bg-gray-500 transition-all hidden"><i class="fas fa-undo mr-1"></i>취소</button>
                        <span id="sheetOtherEditCount" class="text-[9px] font-bold text-orange-500"></span>
                        <span class="text-[9px] text-gray-400 font-bold ml-auto" id="sheetOtherCount"></span>
                    </div>`}
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden">
                    <div class="overflow-auto h-full" id="sheetTableWrap" style="max-height:68vh"></div>
                </div>
            </div>`;

            window._sheetRender();
        };

        window._sheetRender = () => {
            const wrap = document.getElementById('sheetTableWrap');
            if (!wrap) return;
            const ss = window._sheetState;

            if (ss.mode === 'members') {
                window._sheetRenderMembers(wrap);
            } else {
                window._sheetRenderTable(wrap, ss.mode);
            }
        };

        window._sheetUpdateButtons = () => {
            const ss = window._sheetState;
            const editCount = Object.keys(ss.edited).length + Object.keys(ss.suroEdited).length;
            const saveBtn = document.getElementById('sheetSaveBtn');
            const discardBtn = document.getElementById('sheetDiscardBtn');
            const countEl = document.getElementById('sheetEditCount');
            if (saveBtn) saveBtn.classList.toggle('hidden', editCount === 0);
            if (discardBtn) discardBtn.classList.toggle('hidden', editCount === 0);
            if (countEl) countEl.textContent = editCount > 0 ? `${editCount}건 수정됨` : '';
        };

        // ── 멤버+수로 시트 (편집 가능) ──
        window._sheetRenderMembers = (wrap) => {
            const ss = window._sheetState;
            const headers = appState.suroHeaders || [];
            
            let members = appState.members.filter(m => m.guild === ss.guild);
            if (ss.search.trim()) {
                const q = ss.search.toLowerCase();
                members = members.filter(m => m.name.toLowerCase().includes(q) || (m.mainCharName||'').toLowerCase().includes(q));
            }
            members.sort((a, b) => a.name < b.name ? -1 : a.name > b.name ? 1 : 0);

            const countEl = document.getElementById('sheetCount');
            if (countEl) countEl.textContent = `${members.length}명`;

            const shortHeaders = headers.map(h => {
                const match = h.match(/~ (\d{2}-\d{2}-\d{2}\([^)]+\))/);
                return match ? match[1] : h.substring(0, 15);
            });

            const memberFields = [
                { key: 'role', label: '직위', w: 60 },
                { key: 'class', label: '직업', w: 55 },
                { key: 'isMain', label: '본캐', w: 40, center: true },
                { key: 'mainCharName', label: '본캐닉', w: 60 }
            ];

            let html = `<table class="w-full text-left border-collapse" style="min-width:${500 + memberFields.length * 60 + headers.length * 85}px">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr class="text-[8px] lg:text-[9px] font-bold text-gray-500 uppercase">
                        <th class="p-1.5 border-b border-r border-gray-100 w-6 text-center sticky left-0 bg-gray-50 z-20">#</th>
                        <th class="p-1.5 border-b border-r border-gray-100 sticky left-6 bg-gray-50 z-20" style="min-width:70px">닉네임</th>
                        <th class="p-1.5 border-b border-r border-gray-100" style="min-width:50px">길드</th>
                        ${memberFields.map(f => `<th class="p-1.5 border-b border-r border-gray-100 ${f.center?'text-center':''}" style="min-width:${f.w}px">${f.label}</th>`).join('')}
                        ${shortHeaders.map(h => `<th class="p-1.5 border-b border-r border-gray-100 text-center text-emerald-600" style="min-width:80px">${h}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="text-[10px] lg:text-[11px] font-bold">`;

            members.forEach((m, i) => {
                const mid = m.id;
                const mEdits = ss.edited[mid] || {};
                const totalCols = 3 + memberFields.length + headers.length;
                
                if (i > 0 && i % 17 === 0) {
                    html += `<tr><td colspan="${totalCols}" class="p-0"><div class="h-[3px] bg-pink-200"></div></td></tr>`;
                }
                
                html += `<tr class="hover:bg-pink-50/30 transition-colors border-b border-gray-50 ${Object.keys(mEdits).length > 0 ? 'bg-orange-50/50' : ''}">
                    <td class="p-1 text-[9px] text-gray-300 border-r border-gray-50 text-center font-mono sticky left-0 bg-white z-10">${i+1}</td>
                    <td class="p-1 border-r border-gray-50 text-gray-800 sticky left-6 bg-white z-10 whitespace-nowrap">${m.name}</td>
                    <td class="p-1 border-r border-gray-50 text-gray-500">${m.guild}</td>`;
                
                // Editable member fields
                memberFields.forEach(f => {
                    const val = mEdits[f.key] !== undefined ? mEdits[f.key] : (f.key === 'isMain' ? (m.isMain ? 'TRUE' : 'FALSE') : (m[f.key] || ''));
                    const wasEdited = mEdits[f.key] !== undefined;
                    if (f.key === 'class') {
                        const allJobs = [...new Set([...MAPLE_JOBS, ...appState.members.map(m => m.class).filter(c => c && !MAPLE_JOBS.includes(c))])];
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <select class="w-full px-0.5 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors cursor-pointer"
                                onchange="window._sheetEditMember('${mid}','class',this.value)">
                                <option value="">-</option>
                                ${allJobs.map(j => `<option value="${j}" ${val === j ? 'selected' : ''}>${j}</option>`).join('')}
                            </select>
                        </td>`;
                    } else if (f.key === 'role') {
                        const guildRoles = initialGuildRanks[m.guild] || [];
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <select class="w-full px-0.5 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors cursor-pointer"
                                onchange="window._sheetEditMember('${mid}','role',this.value)">
                                ${guildRoles.map(r => `<option value="${r}" ${val === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                        </td>`;
                    } else if (f.key === 'isMain') {
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <select class="w-full px-0.5 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors text-center cursor-pointer"
                                onchange="window._sheetEditMember('${mid}','isMain',this.value)">
                                <option value="TRUE" ${val === 'TRUE' ? 'selected' : ''}>TRUE</option>
                                <option value="FALSE" ${val === 'FALSE' ? 'selected' : ''}>FALSE</option>
                            </select>
                        </td>`;
                    } else {
                        html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                            <input type="text" value="${String(val).replace(/"/g, '&quot;')}" 
                                class="w-full px-1 py-1 text-[10px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors ${f.center?'text-center':''}" 
                                onfocus="this.select()"
                                onchange="window._sheetEditMember('${mid}','${f.key}',this.value)">
                        </td>`;
                    }
                });

                // Editable suro scores
                headers.forEach(h => {
                    const suroKey = `${mid}_${h}`;
                    const origScore = m.suro?.[h] || '';
                    const val = ss.suroEdited[suroKey] !== undefined ? ss.suroEdited[suroKey] : origScore;
                    const wasEdited = ss.suroEdited[suroKey] !== undefined;
                    const displayVal = val ? Number(val).toLocaleString() : '';
                    html += `<td class="p-0 border-r border-gray-50 ${wasEdited ? 'bg-yellow-100' : ''}">
                        <input type="text" value="${val}" 
                            class="w-full px-1 py-1 text-[10px] font-mono font-bold outline-none bg-transparent border-0 focus:bg-emerald-50 transition-colors text-right" 
                            onfocus="this.select()"
                            onchange="window._sheetEditSuro('${mid}','${h}',this.value)">
                    </td>`;
                });

                html += `</tr>`;
            });

            html += `</tbody></table>`;
            wrap.innerHTML = html;
            window._sheetUpdateButtons();

            // Tab키: 같은 열 아래로 이동 (Shift+Tab: 위로)
            wrap.addEventListener('keydown', (e) => {
                if (e.key !== 'Tab') return;
                const el = document.activeElement;
                if (!el || !wrap.contains(el)) return;
                const td = el.closest('td');
                const tr = el.closest('tr');
                if (!td || !tr) return;

                e.preventDefault();
                const colIdx = Array.from(tr.children).indexOf(td);
                const nextTr = e.shiftKey ? tr.previousElementSibling : tr.nextElementSibling;
                if (!nextTr) return;

                const targetTd = nextTr.children[colIdx];
                if (!targetTd) return;
                const targetInput = targetTd.querySelector('input, select');
                if (targetInput) { targetInput.focus(); if (targetInput.select) targetInput.select(); }
            });
        };

        // Edit member field
        window._sheetEditMember = (memberId, field, newVal) => {
            const ss = window._sheetState;
            const m = appState.members.find(x => x.id === memberId);
            if (!m) return;
            const origVal = field === 'isMain' ? (m.isMain ? 'TRUE' : 'FALSE') : (m[field] || '');
            if (newVal === origVal) {
                if (ss.edited[memberId]) {
                    delete ss.edited[memberId][field];
                    if (Object.keys(ss.edited[memberId]).length === 0) delete ss.edited[memberId];
                }
            } else {
                if (!ss.edited[memberId]) ss.edited[memberId] = {};
                ss.edited[memberId][field] = newVal;
            }
            window._sheetUpdateButtons();
        };

        // Edit suro score
        window._sheetEditSuro = (memberId, periodLabel, newVal) => {
            const ss = window._sheetState;
            const m = appState.members.find(x => x.id === memberId);
            if (!m) return;
            const origVal = String(m.suro?.[periodLabel] || '');
            const key = `${memberId}_${periodLabel}`;
            if (newVal === origVal) {
                delete ss.suroEdited[key];
            } else {
                ss.suroEdited[key] = newVal;
            }
            window._sheetUpdateButtons();
        };

        // Save all changes
        window._sheetSave = async () => {
            const ss = window._sheetState;
            const btn = document.getElementById('sheetSaveBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>저장 중...'; }
            
            try {
                let count = 0;

                // Save member field edits
                for (const [memberId, changes] of Object.entries(ss.edited)) {
                    const dbChanges = {};
                    for (const [k, v] of Object.entries(changes)) {
                        if (k === 'isMain') dbChanges.is_main = v === 'TRUE' || v === 'true';
                        else if (k === 'mainCharName') dbChanges.main_char_name = v;
                        else if (k === 'joinDate') dbChanges.join_date = v;
                        else if (k === 'role') dbChanges.role = v;
                        else if (k === 'class') dbChanges.class = v;
                    }
                    if (Object.keys(dbChanges).length > 0) {
                        const { error } = await supaDb.from('members').update(dbChanges).eq('id', Number(memberId));
                        if (error) throw error;
                        count++;
                    }
                }

                // Save suro score edits
                for (const [key, val] of Object.entries(ss.suroEdited)) {
                    const [memberId, ...periodParts] = key.split('_');
                    const periodLabel = periodParts.join('_');
                    
                    // Get or create period
                    let { data: period } = await supaDb.from('suro_periods').select('id').eq('period_label', periodLabel).maybeSingle();
                    if (!period) {
                        const { data: np } = await supaDb.from('suro_periods').insert({ period_label: periodLabel, start_date: '', end_date: '' }).select().single();
                        period = np;
                    }
                    
                    if (val === '' || val === '0') {
                        await supaDb.from('suro_scores').delete().eq('member_id', Number(memberId)).eq('period_id', period.id);
                    } else {
                        await supaDb.from('suro_scores').upsert({ member_id: Number(memberId), period_id: period.id, score: Number(val) }, { onConflict: 'member_id,period_id' });
                    }
                    count++;
                }

                ss.edited = {};
                ss.suroEdited = {};
                window.showMsg(`${count}건 저장 완료!`, 'success');
                await window.fetchMembers();
            } catch(e) {
                window.showMsg('저장 실패: ' + e.message, 'error');
                console.error(e);
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>저장'; }
            }
        };

        // Discard changes
        window._sheetDiscard = () => {
            window._sheetState.edited = {};
            window._sheetState.suroEdited = {};
            window._sheetRender();
        };

        // ── 기타 테이블 (bail, penalty, history, events) - 편집/추가/삭제 가능 ──
        window._sheetRenderTable = (wrap, tableName) => {
            let data, columns, dbTable;
            if (tableName === 'bail_history') {
                data = appState.bailHistory || [];
                columns = ['date','payer','receiver','amount','memo'];
                dbTable = 'bail_history';
            } else if (tableName === 'penalty_history') {
                data = appState.penaltyHistory || [];
                columns = ['date','name','points','reason'];
                dbTable = 'penalty_history';
            } else if (tableName === 'operation_history') {
                data = [...(appState.history || [])].reverse();
                columns = ['date','category','name','content'];
                dbTable = 'operation_history';
            } else if (tableName === 'events') {
                data = appState.events || [];
                columns = ['date','title','content'];
                dbTable = 'events';
            } else {
                data = []; columns = []; dbTable = '';
            }

            const colLabels = {
                date:'날짜', payer:'납부자/사유', receiver:'수령자', amount:'수량', memo:'메모',
                name:'이름', points:'점수', reason:'사유', category:'구분', content:'내용',
                id:'ID', title:'제목'
            };

            const countEl = document.getElementById('sheetOtherCount');
            if (countEl) countEl.textContent = `${data.length}건`;

            let html = `<table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr class="text-[9px] font-bold text-gray-500 uppercase">
                        <th class="p-2 border-b border-r border-gray-100 w-8 text-center">#</th>
                        ${columns.map(c => `<th class="p-2 border-b border-r border-gray-100">${colLabels[c] || c}</th>`).join('')}
                        <th class="p-2 border-b border-gray-100 w-10 text-center">삭제</th>
                    </tr>
                </thead>
                <tbody class="text-[11px] font-bold">`;

            data.forEach((row, i) => {
                const rowId = row.id || '';
                html += `<tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 group" data-table="${dbTable}" data-row-idx="${i}">
                    <td class="p-1.5 text-[9px] text-gray-300 border-r border-gray-50 text-center font-mono">${i+1}</td>
                    ${columns.map(c => {
                        const val = row[c] ?? '';
                        if (c === 'amount' || c === 'points') {
                            return `<td class="p-0 border-r border-gray-50"><input type="number" value="${val}" class="w-full px-1.5 py-1.5 text-[11px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors text-right" data-col="${c}" oninput="window._sheetMarkOtherEdit(this)"></td>`;
                        }
                        return `<td class="p-0 border-r border-gray-50"><input type="text" value="${String(val).replace(/"/g, '&quot;')}" class="w-full px-1.5 py-1.5 text-[11px] font-bold outline-none bg-transparent border-0 focus:bg-blue-50 transition-colors" data-col="${c}" oninput="window._sheetMarkOtherEdit(this)"></td>`;
                    }).join('')}
                    <td class="p-1 border-gray-50 text-center">
                        <button onclick="window._sheetDeleteRow('${dbTable}', ${rowId ? rowId : 'null'}, this)" class="w-6 h-6 rounded-lg text-gray-300 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-trash text-[9px]"></i></button>
                    </td>
                </tr>`;
            });

            if (data.length === 0) {
                html += `<tr><td colspan="${columns.length+2}" class="p-10 text-center text-gray-300 font-bold text-xs">데이터 없음</td></tr>`;
            }

            html += `</tbody></table>`;
            wrap.innerHTML = html;
        };

        // 기타 테이블 행 추가
        window._sheetAddRow = async () => {
            const ss = window._sheetState;
            const tableName = ss.mode;
            let newRow = {};

            if (tableName === 'bail_history') {
                newRow = { date: new Date().toISOString().split('T')[0], payer: '', receiver: '', amount: 0, memo: '' };
            } else if (tableName === 'penalty_history') {
                newRow = { date: new Date().toISOString().split('T')[0], name: '', points: 1, reason: '' };
            } else if (tableName === 'operation_history') {
                newRow = { date: new Date().toISOString().split('T')[0], category: '', name: '', content: '' };
            } else if (tableName === 'events') {
                newRow = { date: new Date().toISOString().split('T')[0], title: '', content: '' };
            } else return;

            try {
                const { data, error } = await supaDb.from(tableName).insert(newRow).select();
                if (error) throw error;
                window.showMsg('행이 추가되었습니다.', 'success');
                await window.fetchMembers();
                window._sheetRender();
            } catch(e) {
                window.showMsg('추가 실패: ' + (e.message || e), 'error');
            }
        };

        // 기타 테이블 행 삭제
        window._sheetDeleteRow = async (tableName, rowId, btnEl) => {
            if (!rowId) {
                // id 없는 경우 (appState에서 직접 관리하는 데이터) - 위치 기반 삭제
                window.showMsg('ID가 없어 삭제할 수 없습니다.', 'error');
                return;
            }
            if (!confirm('이 행을 삭제하시겠습니까?')) return;
            try {
                const { error } = await supaDb.from(tableName).delete().eq('id', rowId);
                if (error) throw error;
                // 행 시각적으로 제거
                const tr = btnEl.closest('tr');
                if (tr) { tr.style.opacity = '0.3'; tr.style.pointerEvents = 'none'; }
                window.showMsg('삭제 완료', 'success');
                await window.fetchMembers();
                window._sheetRender();
            } catch(e) {
                window.showMsg('삭제 실패: ' + (e.message || e), 'error');
            }
        };

        // 기타 테이블 셀 수정 마킹 (저장 버튼 표시)
        window._pendingOtherEdits = new Map(); // rowId -> {tableName, rowData}

        window._sheetMarkOtherEdit = (input) => {
            const tr = input.closest('tr');
            const tableName = tr.dataset.table;
            const idx = parseInt(tr.dataset.rowIdx);

            // 해당 행의 모든 입력값 수집
            const inputs = tr.querySelectorAll('input, select');
            const rowData = {};
            inputs.forEach(inp => {
                const col = inp.dataset.col;
                if (col) {
                    rowData[col] = inp.type === 'number' ? Number(inp.value) : inp.value;
                }
            });

            // DB에서 해당 행의 id 찾기
            let sourceData;
            if (tableName === 'bail_history') sourceData = appState.bailHistory;
            else if (tableName === 'penalty_history') sourceData = appState.penaltyHistory;
            else if (tableName === 'operation_history') sourceData = [...(appState.history || [])].reverse();
            else if (tableName === 'events') sourceData = appState.events;

            const row = sourceData?.[idx];
            if (!row || !row.id) {
                input.style.background = '#fef2f2';
                return;
            }

            input.style.background = '#fef9c3';
            tr.style.background = '#fffbeb';
            window._pendingOtherEdits.set(String(row.id), { tableName, rowData });

            // 저장/취소 버튼 표시
            const saveBtn = document.getElementById('sheetOtherSaveBtn');
            const discardBtn = document.getElementById('sheetOtherDiscardBtn');
            const countEl = document.getElementById('sheetOtherEditCount');
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (discardBtn) discardBtn.classList.remove('hidden');
            if (countEl) countEl.textContent = `${window._pendingOtherEdits.size}개 행 수정됨`;
        };

        window._sheetSaveOther = async () => {
            const edits = window._pendingOtherEdits;
            if (edits.size === 0) return;

            const btn = document.getElementById('sheetOtherSaveBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>저장 중...'; }

            let ok = 0, fail = 0;
            for (const [rowId, { tableName, rowData }] of edits) {
                try {
                    const { error } = await supaDb.from(tableName).update(rowData).eq('id', Number(rowId));
                    if (error) throw error;
                    ok++;
                } catch(e) {
                    console.error('저장 실패:', rowId, e);
                    fail++;
                }
            }

            edits.clear();
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>저장'; btn.classList.add('hidden'); }
            document.getElementById('sheetOtherDiscardBtn')?.classList.add('hidden');
            const countEl = document.getElementById('sheetOtherEditCount');
            if (countEl) countEl.textContent = '';

            if (fail === 0) {
                window.showMsg(`${ok}건 저장 완료!`, 'success');
            } else {
                window.showMsg(`${ok}건 저장, ${fail}건 실패`, 'error');
            }
            await window.fetchMembers();
            window._sheetRender();
        };

        window._sheetDiscardOther = () => {
            window._pendingOtherEdits.clear();
            document.getElementById('sheetOtherSaveBtn')?.classList.add('hidden');
            document.getElementById('sheetOtherDiscardBtn')?.classList.add('hidden');
            const countEl = document.getElementById('sheetOtherEditCount');
            if (countEl) countEl.textContent = '';
            window._sheetRender();
            window.showMsg('수정 취소됨', 'success');
        };
        // ─── 가이드 편집기 (블록 템플릿 지원) ───
        window._guideEditorState = { slug: 'intro', pages: {} };

        // Block templates
        window._guideBlocks = [
            { id: 'card_red', icon: '❤️', label: '카드 (빨강)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#fef2f2,#fff1f2);border-bottom:1px solid #fecdd3;display:flex;align-items:center;gap:8px"><span style="font-size:14px">❤️</span><h4 style="font-size:12px;font-weight:900;color:#dc2626;margin:0">제목을 입력하세요</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>내용을 입력하세요</p></div></div>` },
            { id: 'card_blue', icon: '💎', label: '카드 (파랑)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#eff6ff,#eef2ff);border-bottom:1px solid #bfdbfe;display:flex;align-items:center;gap:8px"><span style="font-size:14px">💎</span><h4 style="font-size:12px;font-weight:900;color:#2563eb;margin:0">제목을 입력하세요</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>내용을 입력하세요</p></div></div>` },
            { id: 'card_amber', icon: '🍓', label: '카드 (주황)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#fffbeb,#fff7ed);border-bottom:1px solid #fde68a;display:flex;align-items:center;gap:8px"><span style="font-size:14px">🍓</span><h4 style="font-size:12px;font-weight:900;color:#b45309;margin:0">제목을 입력하세요</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>내용을 입력하세요</p></div></div>` },
            { id: 'card_green', icon: '☕', label: '카드 (초록)', html: `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden" style="margin-bottom:12px"><div style="padding:12px 20px;background:linear-gradient(to right,#f0fdf4,#ecfdf5);border-bottom:1px solid #bbf7d0;display:flex;align-items:center;gap:8px"><span style="font-size:14px">☕</span><h4 style="font-size:12px;font-weight:900;color:#15803d;margin:0">제목을 입력하세요</h4></div><div style="padding:20px;font-size:12px;color:#4b5563;line-height:1.8"><p>내용을 입력하세요</p></div></div>` },
            { id: 'highlight_pink', icon: '🌸', label: '강조 박스 (핑크)', html: `<div style="background:linear-gradient(135deg,#fdf2f8,#fff1f2);padding:24px;border-radius:16px;border:1px solid #fbcfe8;margin-bottom:12px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><span style="font-size:28px">🍓</span><div><h3 style="font-size:18px;font-weight:900;color:#1f2937;margin:0">제목</h3><p style="font-size:12px;color:#ec4899;font-weight:700;margin:4px 0 0 0">부제목</p></div></div><p style="font-size:13px;color:#6b7280">내용을 입력하세요</p></div>` },
            { id: 'count_grid', icon: '📊', label: '인원수 카드 (4칸)', html: `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px"><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#ec4899;margin:0">{{뚠카롱_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">🍓 뚠카롱 (1기)</p></div><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#f43f5e;margin:0">{{뚱카롱_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">🍰 뚱카롱 (2기)</p></div><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#6366f1;margin:0">{{부캐_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">🌙 부캐 길드 합산</p></div><div style="background:white;padding:16px;border-radius:16px;border:1px solid #f3f4f6;text-align:center"><p style="font-size:24px;font-weight:900;color:#374151;margin:0">{{전체_count}}</p><p style="font-size:10px;color:#9ca3af;font-weight:700;margin:4px 0 0 0">👥 전체 인원</p></div></div>` },
            { id: 'table_simple', icon: '📋', label: '표 (4열)', html: `<div style="background:white;border-radius:16px;border:1px solid #f3f4f6;overflow:hidden;margin-bottom:12px"><table style="width:100%;font-size:12px;border-collapse:collapse"><thead><tr style="font-size:10px;color:#9ca3af;border-bottom:1px solid #f3f4f6"><th style="padding:10px;text-align:left">항목1</th><th style="padding:10px;text-align:left">항목2</th><th style="padding:10px;text-align:center">항목3</th><th style="padding:10px;text-align:left">항목4</th></tr></thead><tbody style="font-weight:700;color:#374151"><tr style="background:rgba(254,249,195,0.3);border-bottom:1px solid #fafafa"><td style="padding:10px">데이터1</td><td style="padding:10px">데이터2</td><td style="padding:10px;text-align:center;color:#22c55e">O</td><td style="padding:10px;font-size:11px">데이터4</td></tr><tr style="border-bottom:1px solid #fafafa"><td style="padding:10px">데이터1</td><td style="padding:10px">데이터2</td><td style="padding:10px;text-align:center;color:#ef4444">X</td><td style="padding:10px;font-size:11px">데이터4</td></tr></tbody></table></div>` },
            { id: 'link_card', icon: '🔗', label: '링크 카드', html: `<a href="https://example.com" target="_blank" style="display:block;background:white;border-radius:16px;border:1px solid #f3f4f6;padding:16px;margin-bottom:12px;text-decoration:none;color:inherit"><div style="display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;background:#fdf2f8;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0"><i class="fas fa-link" style="color:#ec4899"></i></div><div><p style="font-weight:700;font-size:14px;color:#1f2937;margin:0">🔗 링크 제목</p><p style="font-size:10px;color:#9ca3af;margin:4px 0 0 0">설명을 입력하세요</p></div><i class="fas fa-external-link-alt" style="color:#d1d5db;margin-left:auto"></i></div></a>` },
            { id: 'notice_box', icon: '⚠️', label: '경고/안내 박스', html: `<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:12px 16px;margin-bottom:12px;font-size:11px;color:#dc2626;font-weight:700">⚠ 안내 내용을 입력하세요</div>` },
            { id: 'info_box', icon: '💡', label: '팁 박스', html: `<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:12px 16px;margin-bottom:12px;font-size:11px;color:#2563eb;font-weight:700">💡 팁 내용을 입력하세요</div>` },
            { id: 'color_badge', icon: '🏷️', label: '뱃지 그룹', html: `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px"><span style="background:#f0fdf4;color:#16a34a;padding:4px 12px;border-radius:8px;font-weight:700;font-size:12px">뱃지1 → 설명</span><span style="background:#fef2f2;color:#ef4444;padding:4px 12px;border-radius:8px;font-weight:700;font-size:12px">뱃지2 → 설명</span><span style="background:#ecfdf5;color:#059669;padding:4px 12px;border-radius:8px;font-weight:700;font-size:12px">뱃지3 → 설명</span></div>` },
            { id: 'guild_info', icon: '🎮', label: '길드 정보 카드', html: `<div style="background:white;border-radius:16px;border:1px solid #f3f4f6;padding:16px;margin-bottom:12px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">🍰</span><h4 style="font-weight:900;color:#1f2937;font-size:14px;margin:0">길드명</h4><span style="font-size:10px;background:#fef2f2;color:#ef4444;padding:2px 8px;border-radius:999px;font-weight:700">설명</span></div><span style="font-size:12px;font-weight:700;color:#9ca3af">49p</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px"><div style="background:#f9fafb;padding:8px 12px;border-radius:8px"><span style="color:#9ca3af">노블 조건:</span> <b>수로 필참</b></div><div style="background:#f9fafb;padding:8px 12px;border-radius:8px"><span style="color:#9ca3af">캐릭 제한:</span> <b>없음</b></div></div></div>` },
            { id: 'spacer', icon: '➖', label: '여백', html: `<div style="height:16px"></div>` },
            { id: 'image_card', icon: '🖼️', label: '이미지 카드', html: `<div style="background:white;border-radius:16px;border:1px solid #f3f4f6;overflow:hidden;margin-bottom:12px"><img src="이미지URL" style="width:100%;max-height:300px;object-fit:cover" alt="이미지"><div style="padding:12px 16px;font-size:12px;font-weight:700;color:#374151">이미지 설명을 입력하세요</div></div>` },
            { id: 'profile_grid', icon: '👤', label: '프로필 카드 (4열)', html: `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:12px"><div style="background:white;border-radius:16px;border:1px solid #f3f4f6;overflow:hidden"><img src="이미지URL" style="width:100%;height:180px;object-fit:cover" alt="프로필"><div style="padding:12px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:14px">❤️</span><b style="font-size:14px;color:#1f2937">닉네임</b></div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px"><span style="background:#fdf2f8;color:#ec4899;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">뚠카롱</span></div><p style="font-size:11px;color:#6b7280;margin:0">▶ 담당 업무 설명</p><p style="font-size:11px;color:#9ca3af;margin:6px 0 0 0;font-style:italic">" 한마디를 입력하세요 "</p></div></div></div>` },
        ];

        window.renderGuideEditor = async (container) => {
            const gs = window._guideEditorState;
            
            try {
                const { data } = await supaDb.from('guide_pages').select('*').order('id');
                if (data) data.forEach(p => gs.pages[p.slug] = p);
            } catch(e) { console.error(e); }

            const slugs = [
                { slug: 'intro', label: '길드 소개', icon: 'fa-heart' },
                { slug: 'ranks', label: '직위 & 부캐', icon: 'fa-medal' },
                { slug: 'links', label: '링크 모음', icon: 'fa-link' }
            ];

            container.innerHTML = `
            <div class="h-full flex flex-col gap-3 fade-in">
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4 shrink-0">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <h3 class="text-sm font-bold text-gray-800"><i class="fas fa-edit mr-2 text-pink-500"></i>가이드 페이지 편집</h3>
                        <div class="flex gap-1.5 ml-2">
                            ${slugs.map(s => `<button onclick="window._guideSelectPage('${s.slug}')" class="guide-slug-btn px-3 py-1.5 rounded-xl text-[10px] font-bold transition-all ${gs.slug === s.slug ? 'bg-pink-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}"><i class="fas ${s.icon} mr-1"></i>${s.label}</button>`).join('')}
                        </div>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="window._guideSave()" id="guideSaveBtn" class="px-4 py-1.5 bg-emerald-500 text-white rounded-xl text-[10px] font-bold shadow hover:bg-emerald-600 transition-all"><i class="fas fa-save mr-1"></i>저장</button>
                            <button onclick="window._guidePreview()" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-all"><i class="fas fa-eye mr-1"></i>미리보기</button>
                        </div>
                    </div>
                    <!-- Toolbar Row 1: Text formatting -->
                    <div class="flex flex-wrap gap-1 p-2 bg-gray-50 rounded-xl border border-gray-100 mb-1" id="guideToolbar">
                        <button onclick="document.execCommand('bold')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-black text-gray-600 transition-all" title="굵게"><b>B</b></button>
                        <button onclick="document.execCommand('italic')" class="w-7 h-7 rounded-lg hover:bg-white text-xs italic text-gray-600 transition-all" title="기울임"><i>I</i></button>
                        <button onclick="document.execCommand('underline')" class="w-7 h-7 rounded-lg hover:bg-white text-xs underline text-gray-600 transition-all" title="밑줄"><u>U</u></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('foreColor',false,'#ec4899')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-pink-500 transition-all" title="핑크">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#ef4444')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-red-500 transition-all" title="빨강">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#3b82f6')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-blue-500 transition-all" title="파랑">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#10b981')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-emerald-500 transition-all" title="초록">A</button>
                        <button onclick="document.execCommand('foreColor',false,'#374151')" class="w-7 h-7 rounded-lg hover:bg-white text-xs font-bold text-gray-700 transition-all" title="검정">A</button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('fontSize',false,'2')" class="w-7 h-7 rounded-lg hover:bg-white text-[9px] text-gray-600 transition-all" title="작게">S</button>
                        <button onclick="document.execCommand('fontSize',false,'4')" class="w-7 h-7 rounded-lg hover:bg-white text-sm text-gray-600 transition-all" title="크게">L</button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('insertUnorderedList')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="목록"><i class="fas fa-list-ul"></i></button>
                        <button onclick="document.execCommand('insertOrderedList')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="번호목록"><i class="fas fa-list-ol"></i></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="window._guideInsertLink()" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="링크"><i class="fas fa-link"></i></button>
                        <button onclick="document.execCommand('removeFormat')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-400 transition-all" title="서식제거"><i class="fas fa-eraser"></i></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="document.execCommand('justifyLeft')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="왼쪽"><i class="fas fa-align-left"></i></button>
                        <button onclick="document.execCommand('justifyCenter')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-gray-600 transition-all" title="가운데"><i class="fas fa-align-center"></i></button>
                        <span class="w-px h-6 bg-gray-200 mx-0.5"></span>
                        <button onclick="window._guideToggleSource()" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-orange-500 transition-all" title="HTML 소스"><i class="fas fa-code"></i></button>
                        <button onclick="window._guideUploadImage()" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-purple-500 transition-all" title="이미지 업로드"><i class="fas fa-image"></i></button>
                        <button onclick="document.getElementById('guideHelpPanel').classList.toggle('hidden')" class="w-7 h-7 rounded-lg hover:bg-white text-xs text-blue-500 transition-all" title="도움말"><i class="fas fa-question-circle"></i></button>
                    </div>
                    <!-- Toolbar Row 2: Block templates -->
                    <div class="relative">
                        <button onclick="document.getElementById('guideBlockMenu').classList.toggle('hidden')" class="flex items-center gap-2 px-3 py-1.5 bg-purple-50 text-purple-600 rounded-xl text-[10px] font-bold hover:bg-purple-100 transition-all border border-purple-100">
                            <i class="fas fa-puzzle-piece"></i>블록 삽입 ▾
                        </button>
                        <div id="guideBlockMenu" class="hidden absolute left-0 top-full mt-1 bg-white border border-gray-200 rounded-2xl shadow-2xl p-2 z-[100] w-80 max-h-[50vh] overflow-y-auto">
                            <div class="text-[9px] text-gray-400 font-bold px-3 py-1.5 uppercase">클릭하면 에디터에 삽입됩니다</div>
                            ${window._guideBlocks.map(b => `<button onclick="window._guideInsertBlock('${b.id}')" class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-50 text-xs font-bold text-gray-700 flex items-center gap-2 transition-all"><span>${b.icon}</span><span>${b.label}</span></button>`).join('')}
                        </div>
                    </div>
                    <div id="guideHelpPanel" class="hidden bg-blue-50 border border-blue-100 rounded-xl p-3 mt-2 text-[10px] text-blue-700 leading-relaxed">
                        <p class="font-bold text-[11px] mb-1.5"><i class="fas fa-info-circle mr-1"></i> 자동 변환 변수 (퍼블릭 뷰에서 실제 숫자로 바뀜)</p>
                        <div class="grid grid-cols-2 gap-1.5">
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-pink-500 select-all">{{뚠카롱_count}}</span> → 뚠카롱 인원수</div>
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-rose-500 select-all">{{뚱카롱_count}}</span> → 뚱카롱 인원수</div>
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-indigo-500 select-all">{{부캐_count}}</span> → 부캐길드 합산</div>
                            <div class="bg-white rounded-lg px-2 py-1 font-mono"><span class="text-gray-600 select-all">{{전체_count}}</span> → 전체 인원수</div>
                        </div>
                        <p class="mt-1.5 text-[9px] text-blue-500">💡 위 텍스트를 클릭해서 복사 후 원하는 위치에 붙여넣으세요.</p>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden flex flex-col min-h-0">
                    <div id="guideEditor" contenteditable="true" class="flex-1 p-5 outline-none text-sm text-gray-700 leading-relaxed overflow-y-auto" style="min-height:300px;max-height:60vh">${gs.pages[gs.slug]?.content || '<p>내용을 입력하세요...</p>'}</div>
                    <textarea id="guideSourceEditor" class="flex-1 p-5 outline-none text-xs font-mono text-gray-700 hidden overflow-y-auto resize-none border-t border-gray-100" style="min-height:300px;max-height:60vh"></textarea>
                </div>
                <div id="guidePreviewModal" class="hidden fixed inset-0 bg-black/30 z-[2000] flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-sm text-gray-800"><i class="fas fa-eye mr-2 text-pink-500"></i>미리보기</h3>
                            <button onclick="document.getElementById('guidePreviewModal').classList.add('hidden')" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="guidePreviewContent" class="p-5 overflow-y-auto flex-1 text-sm text-gray-700 leading-relaxed"></div>
                    </div>
                </div>
            </div>`;

            // Close block menu when clicking outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('guideBlockMenu');
                if (menu && !menu.parentElement.contains(e.target)) menu.classList.add('hidden');
            }, { once: false });
        };

        window._guideInsertBlock = (blockId) => {
            const block = window._guideBlocks.find(b => b.id === blockId);
            if (!block) return;
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            if (source && !source.classList.contains('hidden')) {
                // Source mode: append HTML
                source.value += '\n' + block.html;
            } else if (editor) {
                // Rich mode: insert at cursor or append
                editor.focus();
                const sel = window.getSelection();
                if (sel.rangeCount > 0 && editor.contains(sel.anchorNode)) {
                    document.execCommand('insertHTML', false, block.html);
                } else {
                    editor.innerHTML += block.html;
                }
            }
            document.getElementById('guideBlockMenu')?.classList.add('hidden');
        };

        window._guideSelectPage = (slug) => {
            window._guideEditorState.slug = slug;
            window.renderGuideEditor(document.getElementById('contentArea'));
        };

        window._guideInsertLink = () => {
            const url = prompt('링크 URL을 입력하세요:');
            if (url) document.execCommand('createLink', false, url);
        };

        window._guideToggleSource = () => {
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            if (source.classList.contains('hidden')) {
                source.value = editor.innerHTML;
                editor.classList.add('hidden');
                source.classList.remove('hidden');
                source.focus();
            } else {
                editor.innerHTML = source.value;
                source.classList.add('hidden');
                editor.classList.remove('hidden');
            }
        };

        window._guidePreview = () => {
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            const html = source.classList.contains('hidden') ? editor.innerHTML : source.value;
            document.getElementById('guidePreviewContent').innerHTML = html;
            document.getElementById('guidePreviewModal').classList.remove('hidden');
        };

        window._guideSave = async () => {
            const gs = window._guideEditorState;
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            const html = source.classList.contains('hidden') ? editor.innerHTML : source.value;
            const btn = document.getElementById('guideSaveBtn');
            
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>저장 중...'; }
            try {
                const { error } = await supaDb.from('guide_pages').update({ content: html, updated_at: new Date().toISOString() }).eq('slug', gs.slug);
                if (error) throw error;
                gs.pages[gs.slug] = { ...gs.pages[gs.slug], content: html };
                window.showMsg('가이드 저장 완료!', 'success');
            } catch(e) {
                window.showMsg('저장 실패: ' + e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>저장'; }
            }
        };

        // ─── 이미지 업로드 (Supabase Storage) ───
        window._guideUploadImage = () => {
            // 모달 생성
            const existing = document.getElementById('imgUploadModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'imgUploadModal';
            modal.className = 'fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4';
            modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[85vh] flex flex-col overflow-hidden">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-sm font-bold text-gray-800 dark:text-gray-100"><i class="fas fa-image mr-2 text-purple-500"></i>이미지 관리</h3>
                    <button onclick="document.getElementById('imgUploadModal').remove()" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 shrink-0">
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('imgUploadInput').click()" class="flex-1 py-3 bg-purple-500 text-white rounded-xl text-xs font-bold hover:bg-purple-600 transition-all shadow"><i class="fas fa-upload mr-1"></i>이미지 업로드</button>
                        <button onclick="window._guideInsertImageUrl()" class="px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl text-xs font-bold hover:bg-gray-200 transition-all"><i class="fas fa-link mr-1"></i>URL 직접 입력</button>
                    </div>
                    <input type="file" id="imgUploadInput" accept="image/png,image/jpeg,image/gif,image/webp" multiple class="hidden" onchange="window._guideHandleUpload(this.files)">
                    <div id="imgUploadProgress" class="hidden mt-3">
                        <div class="flex items-center gap-2 text-xs text-purple-600 font-bold">
                            <i class="fas fa-spinner fa-spin"></i><span id="imgUploadStatus">업로드 중...</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2 mt-2"><div id="imgUploadBar" class="bg-purple-500 h-2 rounded-full transition-all" style="width:0%"></div></div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="imgGalleryContainer">
                    <div class="text-center py-6 text-gray-400 text-xs"><i class="fas fa-spinner fa-spin mr-1"></i>갤러리 로딩 중...</div>
                </div>
            </div>`;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // 갤러리 로드
            window._guideLoadGallery();
        };

        window._guideLoadGallery = async () => {
            const container = document.getElementById('imgGalleryContainer');
            if (!container) return;
            try {
                const { data, error } = await supaDb.storage.from('guide-images').list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
                if (error) throw error;
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-400 text-xs"><i class="fas fa-images mr-1"></i>업로드된 이미지가 없습니다.</div>';
                    return;
                }
                const { data: { publicUrl: baseUrl } } = supaDb.storage.from('guide-images').getPublicUrl('');
                const images = data.filter(f => f.name && !f.name.startsWith('.')).map(f => ({
                    name: f.name,
                    url: baseUrl.replace(/\/$/, '') + '/' + f.name,
                    size: f.metadata?.size || 0,
                    created: f.created_at
                }));
                
                container.innerHTML = `
                    <div class="text-[9px] text-gray-400 font-bold mb-2 uppercase">업로드된 이미지 (${images.length}개) — 클릭하면 에디터에 삽입됩니다</div>
                    <div class="grid grid-cols-3 gap-2">
                        ${images.map(img => `
                            <div class="group relative rounded-xl overflow-hidden border border-gray-100 dark:border-gray-700 hover:border-purple-300 transition-all cursor-pointer" onclick="window._guideInsertImgTag('${img.url}')">
                                <img src="${img.url}" class="w-full h-24 object-cover" alt="${img.name}" loading="lazy">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all flex items-center justify-center">
                                    <span class="text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-all"><i class="fas fa-plus-circle mr-1"></i>삽입</span>
                                </div>
                                <button onclick="event.stopPropagation();window._guideDeleteImage('${img.name}')" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full text-[8px] opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600"><i class="fas fa-trash"></i></button>
                                <div class="p-1.5 bg-white dark:bg-gray-800"><p class="text-[8px] text-gray-400 truncate">${img.name}</p></div>
                            </div>
                        `).join('')}
                    </div>`;
            } catch(e) {
                container.innerHTML = `<div class="text-center py-6 text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>갤러리 로드 실패: ${e.message}</div>`;
            }
        };

        window._guideHandleUpload = async (files) => {
            if (!files || files.length === 0) return;
            const progress = document.getElementById('imgUploadProgress');
            const status = document.getElementById('imgUploadStatus');
            const bar = document.getElementById('imgUploadBar');
            if (progress) progress.classList.remove('hidden');

            let uploaded = 0;
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                const safeName = `${Date.now()}_${Math.random().toString(36).substring(2, 8)}.${ext}`;
                if (status) status.textContent = `업로드 중... (${uploaded + 1}/${files.length}) ${file.name}`;
                if (bar) bar.style.width = `${Math.round((uploaded / files.length) * 100)}%`;

                try {
                    const { error } = await supaDb.storage.from('guide-images').upload(safeName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                    if (error) throw error;
                    uploaded++;
                } catch(e) {
                    window.showMsg(`업로드 실패 (${file.name}): ${e.message}`, 'error');
                }
            }

            if (bar) bar.style.width = '100%';
            if (status) status.textContent = `${uploaded}개 업로드 완료!`;
            setTimeout(() => { if (progress) progress.classList.add('hidden'); }, 1500);

            // 갤러리 새로고침
            await window._guideLoadGallery();
            // 파일 input 초기화
            const input = document.getElementById('imgUploadInput');
            if (input) input.value = '';
            window.showMsg(`${uploaded}개 이미지 업로드 완료!`, 'success');
        };

        window._guideInsertImgTag = (url) => {
            const editor = document.getElementById('guideEditor');
            const source = document.getElementById('guideSourceEditor');
            const imgHtml = `<div style="margin:12px 0;text-align:center"><img src="${url}" style="max-width:100%;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)" alt="이미지"></div>`;

            if (source && !source.classList.contains('hidden')) {
                source.value += '\n' + imgHtml;
            } else if (editor) {
                editor.focus();
                document.execCommand('insertHTML', false, imgHtml);
            }
            document.getElementById('imgUploadModal')?.remove();
            window.showMsg('이미지가 삽입되었습니다!', 'success');
        };

        window._guideInsertImageUrl = () => {
            const url = prompt('이미지 URL을 입력하세요:');
            if (url) window._guideInsertImgTag(url);
        };

        window._guideDeleteImage = async (filename) => {
            if (!confirm(`"${filename}" 이미지를 삭제하시겠습니까?\n가이드에 삽입된 이미지도 깨질 수 있습니다.`)) return;
            try {
                const { error } = await supaDb.storage.from('guide-images').remove([filename]);
                if (error) throw error;
                window.showMsg('이미지 삭제 완료', 'success');
                await window._guideLoadGallery();
            } catch(e) {
                window.showMsg('삭제 실패: ' + e.message, 'error');
            }
        };

        window.renderHistory = (container) => { container.innerHTML = `<div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm overflow-hidden h-full flex flex-col"><div class="p-8 border-b font-bold text-gray-800 shrink-0 relative z-20 bg-white">운영 이력</div><div class="flex-1 overflow-y-auto no-scrollbar"><table class="w-full text-left text-xs whitespace-nowrap stick-head"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase"><tr><th class="p-6">DATE</th><th class="p-6">TYPE</th><th class="p-6">NAME</th><th class="p-6">CONTENT</th></tr></thead><tbody class="divide-y divide-gray-100">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">기록 없음</td></tr>` : [...appState.history].reverse().map(l => `<tr class="hover:bg-gray-50 transition-colors h-12 leading-none font-bold"><td class="p-6 text-gray-400 font-mono text-[10px]">${l.date}</td><td class="p-6"><span class="px-2 py-1 rounded-lg bg-gray-100 text-[9px] font-bold">${l.category}</span></td><td class="p-6 text-gray-700">${l.name}</td><td class="p-6 text-gray-500">${l.content}</td></tr>`).join('')}</tbody></table></div></div>`; };
        window.renderSettings = (container) => {
            const cfg = SITE_CONFIG || {};
            const guilds = cfg.guilds || appState.guilds;
            const roleDisplay = cfg.roleDisplay || {};
            const cutoffs = cfg.cutoffs || {};
            const suroExempt = cfg.suroExempt || [];
            const suroExemptLabel = cfg.suroExemptLabel || '아인슈페너';
            const suroExemptNote = cfg.suroExemptNote || '';
            const autoRankRules = cfg.autoRankRules || {};
            const guildStartDate = cfg.guildStartDate || '2020-03-17';
            const badgeStyles = cfg.guildBadgeStyles || {};
            const rowHighlight = cfg.rowHighlightRoles || {};
            const ranks = cfg.ranks || initialGuildRanks;
            const rolePriority = cfg.rolePriority || ROLE_PRIORITY;
            const iconOptions = ['fa-crown','fa-heart','fa-moon','fa-star','fa-sun','fa-cube','fa-gem','fa-fire','fa-bolt','fa-shield-alt','fa-dragon','fa-feather','fa-leaf','fa-snowflake'];

            // 길드 정보 카드 HTML
            const guildsHtml = guilds.map((g, gi) => `
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 space-y-3" data-guild-idx="${gi}">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-xl flex items-center justify-center text-white text-sm" style="background:${g.color}"><i class="fas ${g.icon}"></i></div>
                        <span class="font-bold text-gray-800 text-sm">${g.name}</span>
                        <button onclick="window._cfgRemoveGuild(${gi})" class="ml-auto text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[9px] text-gray-400 block mb-1">길드 이름</label><input class="cfg-guild-name w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${g.name}" data-idx="${gi}"></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">타입</label><input class="cfg-guild-type w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${g.type}" data-idx="${gi}"></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">대표색</label><div class="flex items-center gap-2"><input type="color" class="cfg-guild-color w-8 h-8 rounded-lg border-0 cursor-pointer" value="${g.color}" data-idx="${gi}"><span class="text-[10px] text-gray-400 font-mono">${g.color}</span></div></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">아이콘</label><select class="cfg-guild-icon w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" data-idx="${gi}">${iconOptions.map(ic => `<option value="${ic}" ${g.icon===ic?'selected':''}>${ic.replace('fa-','')}</option>`).join('')}</select></div>
                        <div><label class="text-[9px] text-gray-400 block mb-1">최대 인원</label><input type="number" class="cfg-guild-max w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${g.max}" data-idx="${gi}"></div>
                    </div>
                </div>`).join('');

            // 직위/이모지 편집 HTML
            const allRoleNames = [...new Set(Object.values(ranks).flat())];
            const rolesHtml = allRoleNames.map((rName, ri) => {
                const rd = roleDisplay[rName] || {};
                const pri = rolePriority[rName] !== undefined ? rolePriority[rName] : 99;
                return `<div class="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100">
                    <input class="cfg-role-emoji w-10 text-center bg-white border border-gray-200 rounded-lg px-1 py-1 text-sm outline-none" value="${rd.emoji || ''}" data-role="${rName}">
                    <span class="text-xs font-bold text-gray-700 flex-1">${rName}</span>
                    <select class="cfg-role-color bg-white border border-gray-200 rounded-lg px-2 py-1 text-[10px] font-bold outline-none" data-role="${rName}">
                        <option value="text-amber-600" ${rd.color==='text-amber-600'?'selected':''}>amber</option>
                        <option value="text-blue-600" ${rd.color==='text-blue-600'?'selected':''}>blue</option>
                        <option value="text-pink-600" ${rd.color==='text-pink-600'?'selected':''}>pink-600</option>
                        <option value="text-pink-500" ${rd.color==='text-pink-500'?'selected':''}>pink-500</option>
                        <option value="text-green-600" ${rd.color==='text-green-600'?'selected':''}>green</option>
                        <option value="text-orange-500" ${rd.color==='text-orange-500'?'selected':''}>orange</option>
                        <option value="text-gray-500" ${rd.color==='text-gray-500'?'selected':''}>gray-500</option>
                        <option value="text-gray-400" ${rd.color==='text-gray-400'?'selected':''}>gray-400</option>
                        <option value="text-red-600" ${rd.color==='text-red-600'?'selected':''}>red</option>
                        <option value="text-purple-600" ${rd.color==='text-purple-600'?'selected':''}>purple</option>
                    </select>
                    <input type="number" class="cfg-role-priority w-12 text-center bg-white border border-gray-200 rounded-lg px-1 py-1 text-[10px] font-bold outline-none" value="${pri}" data-role="${rName}" title="우선순위 (낮을수록 높은 직위)">
                </div>`;
            }).join('');

            // 커트라인 편집 HTML
            const cutoffGuildNames = Object.keys(cutoffs);
            const cutoffsTabsHtml = cutoffGuildNames.map((gn, gi) => `<button onclick="window._cfgShowCutoff('${gn}')" class="cfg-cutoff-tab px-4 py-2 rounded-xl text-xs font-bold transition-all ${gi===0?'bg-pink-500 text-white':'bg-gray-100 text-gray-500'}" data-guild="${gn}">${gn}</button>`).join('');
            const cutoffSections = cutoffGuildNames.map((gn, gi) => {
                const items = cutoffs[gn] || [];
                return `<div class="cfg-cutoff-section ${gi>0?'hidden':''}" data-guild="${gn}">
                    <div class="space-y-2" id="cutoffList_${gn.replace(/[^a-zA-Z가-힣]/g,'')}">${items.map((c, ci) => `
                        <div class="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100">
                            <span class="text-sm w-8 text-center">${(roleDisplay[c.rank]||{}).emoji||''}</span>
                            <input class="cfg-cutoff-rank flex-1 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none" value="${c.rank}" data-guild="${gn}" data-ci="${ci}" placeholder="직위명">
                            <input type="number" class="cfg-cutoff-min w-20 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none text-right" value="${c.min !== undefined ? c.min : ''}" data-guild="${gn}" data-ci="${ci}" placeholder="최소">
                            <span class="text-gray-300 text-xs">~</span>
                            <input type="number" class="cfg-cutoff-max w-20 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none text-right" value="${c.max !== undefined ? c.max : ''}" data-guild="${gn}" data-ci="${ci}" placeholder="최대">
                            <input class="cfg-cutoff-label flex-1 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none" value="${c.label||''}" data-guild="${gn}" data-ci="${ci}" placeholder="표시 라벨">
                            <input class="cfg-cutoff-note w-16 bg-white border border-gray-200 rounded-lg px-2 py-1 text-[10px] outline-none" value="${c.note||''}" data-guild="${gn}" data-ci="${ci}" placeholder="비고">
                            <button onclick="window._cfgRemoveCutoff('${gn}',${ci})" class="text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>
                        </div>`).join('')}</div>
                    <button onclick="window._cfgAddCutoff('${gn}')" class="mt-2 text-[10px] text-pink-500 hover:text-pink-700 font-bold"><i class="fas fa-plus mr-1"></i>커트라인 추가</button>
                </div>`;
            }).join('');

            // 수로 면제 직위 HTML
            const exemptHtml = allRoleNames.map(rn => `<label class="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100 cursor-pointer hover:bg-pink-50">
                <input type="checkbox" class="cfg-exempt-check custom-checkbox" value="${rn}" ${suroExempt.includes(rn)?'checked':''}>
                <span class="text-xs font-bold">${(roleDisplay[rn]||{}).emoji||''} ${rn}</span>
            </label>`).join('');

            // 자동 직위 배정 규칙 HTML
            const autoRankGuilds = Object.keys(autoRankRules);
            const autoRankHtml = autoRankGuilds.map(gn => {
                const rules = autoRankRules[gn] || [];
                return `<div class="space-y-2 mb-4">
                    <h4 class="text-xs font-bold text-gray-600">${gn}</h4>
                    <div class="space-y-1" id="autoRankList_${gn.replace(/[^a-zA-Z가-힣]/g,'')}">${rules.map((r, ri) => `
                        <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-1.5 border border-gray-100">
                            <input type="number" class="cfg-autorule-min w-24 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none text-right" value="${r.min}" data-guild="${gn}" data-ri="${ri}" placeholder="최소 점수">
                            <span class="text-gray-300 text-xs">이상 →</span>
                            <input class="cfg-autorule-rank flex-1 bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold outline-none" value="${r.rank}" data-guild="${gn}" data-ri="${ri}" placeholder="직위명">
                            <button onclick="window._cfgRemoveAutoRule('${gn}',${ri})" class="text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>
                        </div>`).join('')}</div>
                    <button onclick="window._cfgAddAutoRule('${gn}')" class="text-[10px] text-pink-500 hover:text-pink-700 font-bold"><i class="fas fa-plus mr-1"></i>규칙 추가</button>
                </div>`;
            }).join('');

            // 길드 배지 색상 HTML
            const badgeHtml = guilds.map(g => {
                const b = badgeStyles[g.name] || { bg: '#f3f4f6', text: '#666666', border: '#e5e7eb' };
                return `<div class="flex items-center gap-3 bg-gray-50 rounded-xl px-3 py-2 border border-gray-100">
                    <span class="text-xs font-bold text-gray-700 w-16">${g.name}</span>
                    <div class="flex items-center gap-1"><label class="text-[8px] text-gray-400">배경</label><input type="color" class="cfg-badge-bg w-6 h-6 rounded border-0 cursor-pointer" value="${b.bg}" data-guild="${g.name}"></div>
                    <div class="flex items-center gap-1"><label class="text-[8px] text-gray-400">글자</label><input type="color" class="cfg-badge-text w-6 h-6 rounded border-0 cursor-pointer" value="${b.text}" data-guild="${g.name}"></div>
                    <div class="flex items-center gap-1"><label class="text-[8px] text-gray-400">테두리</label><input type="color" class="cfg-badge-border w-6 h-6 rounded border-0 cursor-pointer" value="${b.border}" data-guild="${g.name}"></div>
                    <div class="ml-2 px-3 py-1 rounded-lg text-[10px] font-bold border" style="background:${b.bg};color:${b.text};border-color:${b.border}">${g.name} 미리보기</div>
                </div>`;
            }).join('');

            if(!window._settingsTab) window._settingsTab = 'system';
            const sTab = window._settingsTab;
            const stabs = [
                {id:'system', label:'시스템', icon:'fa-server'},
                {id:'design', label:'디자인', icon:'fa-paint-brush'},
                {id:'admin', label:'관리자', icon:'fa-user-shield'},
                {id:'backup', label:'백업', icon:'fa-download'}
            ];
            const stabsHtml = stabs.map(t => `<button onclick="window._settingsTab='${t.id}';window.renderSettings(document.getElementById('contentArea'));${t.id==='admin'?'setTimeout(()=>window._loadAdminList(),100)':''}" class="px-4 py-2 rounded-xl text-xs font-bold transition-all ${sTab===t.id ? 'bg-pink-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}"><i class="fas ${t.icon} mr-1"></i>${t.label}</button>`).join('');

            container.innerHTML = `
            <div class="fade-in space-y-4">
                <div class="flex gap-2 flex-wrap">${stabsHtml}</div>
                <div class="${sTab !== 'system' ? 'hidden' : ''}">
                <!-- 시스템 설정 -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 font-bold">
                    <h3 class="text-lg mb-6 text-gray-800 dark:text-gray-100">시스템 설정</h3>
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Supabase Project URL</label>
                            <input type="text" value="${SUPABASE_URL}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-mono outline-none shadow-inner" readonly>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Database Status</label>
                            <div class="w-full bg-green-50 border border-green-100 rounded-2xl p-5 text-xs font-bold text-green-600"><i class="fas fa-check-circle mr-2"></i>Supabase Connected (Seoul Region)</div>
                        </div>
                    </div>
                </div>
                </div>

                <div class="${sTab !== 'design' ? 'hidden' : ''}">
                <!-- ★ 디자인 설정 ★ -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 font-bold">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-pink-100 rounded-2xl flex items-center justify-center"><i class="fas fa-palette text-pink-500"></i></div>
                        <div><h3 class="text-xl text-gray-800">디자인 설정</h3><p class="text-[10px] text-gray-400">퍼블릭 페이지에 표시되는 디자인 요소를 수정합니다</p></div>
                    </div>
                    <p class="text-[10px] text-pink-400 mb-8"><i class="fas fa-info-circle mr-1"></i>변경 후 하단의 [디자인 설정 저장] 버튼을 눌러야 반영됩니다</p>

                    <!-- 기본 설정 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-calendar text-pink-400 text-xs"></i> 기본 정보</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[9px] text-gray-400 block mb-1">길드 시작일</label><input type="date" id="cfgStartDate" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${guildStartDate}"></div>
                            <div><label class="text-[9px] text-gray-400 block mb-1">수로 면제 라벨</label><input id="cfgExemptLabel" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${suroExemptLabel}"></div>
                            <div class="col-span-2"><label class="text-[9px] text-gray-400 block mb-1">수로 면제 안내 문구</label><input id="cfgExemptNote" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs font-bold outline-none" value="${suroExemptNote}" placeholder="예: 크로칸슈 이상 — 부캐 전부 수로 면제"></div>
                        </div>
                    </div>

                    <!-- 길드 정보 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-users text-pink-400 text-xs"></i> 길드 정보</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3" id="cfgGuildList">${guildsHtml}</div>
                        <button onclick="window._cfgAddGuild()" class="mt-3 text-[10px] text-pink-500 hover:text-pink-700 font-bold"><i class="fas fa-plus mr-1"></i>길드 추가</button>
                    </div>

                    <!-- 길드 배지 색상 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-tag text-pink-400 text-xs"></i> 길드 배지 색상</h4>
                        <div class="space-y-2" id="cfgBadgeList">${badgeHtml}</div>
                    </div>

                    <!-- 직위 이모지/색상 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-medal text-pink-400 text-xs"></i> 직위 이모지 / 색상 / 우선순위</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">${rolesHtml}</div>
                    </div>

                    <!-- 커트라인 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-chart-bar text-pink-400 text-xs"></i> 직위 커트라인</h4>
                        <div class="flex gap-2 mb-3">${cutoffsTabsHtml}</div>
                        ${cutoffSections}
                    </div>

                    <!-- 수로 면제 직위 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-shield-alt text-pink-400 text-xs"></i> 수로 면제 직위</h4>
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">${exemptHtml}</div>
                    </div>

                    <!-- 자동 직위 배정 규칙 -->
                    <div class="mb-8">
                        <h4 class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-magic text-pink-400 text-xs"></i> 자동 직위 배정 규칙</h4>
                        ${autoRankHtml}
                    </div>

                    <!-- 저장 버튼 -->
                    <div class="flex gap-3 pt-4 border-t border-gray-100">
                        <button onclick="window._cfgSave()" id="cfgSaveBtn" class="px-8 py-4 bg-pink-500 text-white rounded-2xl font-bold text-sm shadow-lg hover:bg-pink-600 transition-all"><i class="fas fa-save mr-2"></i>디자인 설정 저장</button>
                        <button onclick="window._cfgReset()" class="px-6 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-xs hover:bg-gray-200 transition-all"><i class="fas fa-undo mr-2"></i>초기화</button>
                    </div>
                </div>
                </div>

                <div class="${sTab !== 'admin' ? 'hidden' : ''}">
                <!-- ★ 관리자 계정 관리 ★ -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 font-bold">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-blue-100 rounded-2xl flex items-center justify-center"><i class="fas fa-user-shield text-blue-500"></i></div>
                        <div><h3 class="text-xl text-gray-800">관리자 계정 관리</h3><p class="text-[10px] text-gray-400">Google 로그인 후 승인된 사용자만 접근할 수 있습니다</p></div>
                    </div>
                    ${CURRENT_USER ? `<p class="text-[10px] text-blue-400 mb-6"><i class="fas fa-user mr-1"></i>현재 로그인: <strong>${CURRENT_USER.email}</strong> (${CURRENT_USER.role})</p>` : ''}
                    
                    <div id="adminListContainer" class="space-y-6">
                        <div class="text-center py-4 text-gray-300"><i class="fas fa-spinner fa-spin mr-1"></i> 로딩 중...</div>
                    </div>
                </div>
                </div>

                <div class="${sTab !== 'backup' ? 'hidden' : ''}">
                <!-- 데이터 백업 -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 font-bold">
                    <h3 class="text-xl mb-3 text-gray-800"><i class="fas fa-download mr-3 text-emerald-500"></i>데이터 백업</h3>
                    <p class="text-xs text-gray-400 mb-8">전체 DB를 JSON 파일로 다운로드합니다. 테이블별 개별 파일이 ZIP으로 묶여 저장됩니다.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-pink-100 rounded-xl flex items-center justify-center"><i class="fas fa-users text-pink-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">members</span></div>
                            <p class="text-[10px] text-gray-400">${appState.members.length}건</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-emerald-100 rounded-xl flex items-center justify-center"><i class="fas fa-chart-line text-emerald-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">suro_scores</span></div>
                            <p class="text-[10px] text-gray-400">${appState.suroHeaders.length}개 주차</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-blue-100 rounded-xl flex items-center justify-center"><i class="fas fa-gem text-blue-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">bail_history</span></div>
                            <p class="text-[10px] text-gray-400">${(appState.bailHistory||[]).length}건</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                            <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center"><i class="fas fa-exclamation-triangle text-red-500 text-xs"></i></div><span class="text-xs font-bold text-gray-700">penalty + history</span></div>
                            <p class="text-[10px] text-gray-400">${(appState.penaltyHistory||[]).length} + ${(appState.history||[]).length}건</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="window._backupAll()" id="backupAllBtn" class="px-8 py-4 bg-emerald-500 text-white rounded-2xl font-bold text-xs shadow-lg hover:bg-emerald-600 transition-all"><i class="fas fa-file-archive mr-2"></i>전체 백업 (ZIP)</button>
                        <button onclick="window._backupJSON()" class="px-6 py-4 bg-gray-100 text-gray-600 rounded-2xl font-bold text-xs hover:bg-gray-200 transition-all"><i class="fas fa-file-code mr-2"></i>단일 JSON</button>
                    </div>
                </div>
                </div>
            </div>`;
        };

        // ─── 디자인 설정 헬퍼 함수들 ───
        window._cfgShowCutoff = (gName) => {
            document.querySelectorAll('.cfg-cutoff-tab').forEach(t => t.classList.toggle('bg-pink-500', t.dataset.guild === gName));
            document.querySelectorAll('.cfg-cutoff-tab').forEach(t => t.classList.toggle('text-white', t.dataset.guild === gName));
            document.querySelectorAll('.cfg-cutoff-tab').forEach(t => { if(t.dataset.guild !== gName) { t.classList.add('bg-gray-100','text-gray-500'); t.classList.remove('bg-pink-500','text-white'); }});
            document.querySelectorAll('.cfg-cutoff-section').forEach(s => s.classList.toggle('hidden', s.dataset.guild !== gName));
        };

        window._cfgAddGuild = () => {
            window.showMsg('길드 추가: 저장 후 반영됩니다');
            const cfg = SITE_CONFIG || {};
            if (!cfg.guilds) cfg.guilds = [...appState.guilds];
            cfg.guilds.push({ id: 'new_' + Date.now(), name: '새길드', type: '신규', color: '#9ca3af', icon: 'fa-star', max: 200 });
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgRemoveGuild = (idx) => {
            if (!confirm('이 길드를 삭제하시겠습니까?')) return;
            const cfg = SITE_CONFIG || {};
            if (!cfg.guilds) cfg.guilds = [...appState.guilds];
            cfg.guilds.splice(idx, 1);
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgAddCutoff = (gName) => {
            const cfg = SITE_CONFIG || {};
            if (!cfg.cutoffs) cfg.cutoffs = {};
            if (!cfg.cutoffs[gName]) cfg.cutoffs[gName] = [];
            cfg.cutoffs[gName].push({ rank: '', min: 0, label: '', cssBg: 'bg-gray-50', cssBorder: 'border-gray-100', cssText: 'text-gray-600', cssValue: 'text-gray-500' });
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgRemoveCutoff = (gName, ci) => {
            const cfg = SITE_CONFIG || {};
            if (cfg.cutoffs?.[gName]) {
                cfg.cutoffs[gName].splice(ci, 1);
                SITE_CONFIG = cfg;
                window.renderSettings(document.getElementById('contentArea'));
            }
        };

        window._cfgAddAutoRule = (gName) => {
            const cfg = SITE_CONFIG || {};
            if (!cfg.autoRankRules) cfg.autoRankRules = {};
            if (!cfg.autoRankRules[gName]) cfg.autoRankRules[gName] = [];
            cfg.autoRankRules[gName].push({ min: 0, rank: '' });
            SITE_CONFIG = cfg;
            window.renderSettings(document.getElementById('contentArea'));
        };

        window._cfgRemoveAutoRule = (gName, ri) => {
            const cfg = SITE_CONFIG || {};
            if (cfg.autoRankRules?.[gName]) {
                cfg.autoRankRules[gName].splice(ri, 1);
                SITE_CONFIG = cfg;
                window.renderSettings(document.getElementById('contentArea'));
            }
        };

        window._cfgCollectAll = () => {
            const cfg = JSON.parse(JSON.stringify(SITE_CONFIG || {}));

            // 기본 정보
            cfg.guildStartDate = document.getElementById('cfgStartDate')?.value || '2020-03-17';
            cfg.suroExemptLabel = document.getElementById('cfgExemptLabel')?.value || '';
            cfg.suroExemptNote = document.getElementById('cfgExemptNote')?.value || '';

            // 길드 정보
            const guildCards = document.querySelectorAll('[data-guild-idx]');
            if (guildCards.length > 0) {
                cfg.guilds = [];
                guildCards.forEach(card => {
                    const idx = card.dataset.guildIdx;
                    cfg.guilds.push({
                        id: (SITE_CONFIG?.guilds?.[idx]?.id) || 'g_' + idx,
                        name: card.querySelector('.cfg-guild-name')?.value || '',
                        type: card.querySelector('.cfg-guild-type')?.value || '',
                        color: card.querySelector('.cfg-guild-color')?.value || '#9ca3af',
                        icon: card.querySelector('.cfg-guild-icon')?.value || 'fa-star',
                        max: parseInt(card.querySelector('.cfg-guild-max')?.value) || 200
                    });
                });
            }

            // 직위 이모지/색상/우선순위
            cfg.roleDisplay = cfg.roleDisplay || {};
            cfg.rolePriority = cfg.rolePriority || {};
            document.querySelectorAll('.cfg-role-emoji').forEach(el => {
                const rName = el.dataset.role;
                if (!cfg.roleDisplay[rName]) cfg.roleDisplay[rName] = {};
                cfg.roleDisplay[rName].emoji = el.value;
            });
            document.querySelectorAll('.cfg-role-color').forEach(el => {
                const rName = el.dataset.role;
                if (!cfg.roleDisplay[rName]) cfg.roleDisplay[rName] = {};
                cfg.roleDisplay[rName].color = el.value;
            });
            document.querySelectorAll('.cfg-role-priority').forEach(el => {
                const rName = el.dataset.role;
                cfg.rolePriority[rName] = parseInt(el.value) || 99;
            });

            // 커트라인
            cfg.cutoffs = cfg.cutoffs || {};
            document.querySelectorAll('.cfg-cutoff-section').forEach(sec => {
                const gn = sec.dataset.guild;
                const items = [];
                sec.querySelectorAll('.cfg-cutoff-rank').forEach(el => {
                    const ci = parseInt(el.dataset.ci);
                    const existing = cfg.cutoffs[gn]?.[ci] || {};
                    items.push({
                        ...existing,
                        rank: el.value,
                        min: (() => { const v = sec.querySelector(`.cfg-cutoff-min[data-ci="${ci}"]`)?.value; return v !== '' ? parseInt(v) : undefined; })(),
                        max: (() => { const v = sec.querySelector(`.cfg-cutoff-max[data-ci="${ci}"]`)?.value; return v !== '' ? parseInt(v) : undefined; })(),
                        label: sec.querySelector(`.cfg-cutoff-label[data-ci="${ci}"]`)?.value || '',
                        note: sec.querySelector(`.cfg-cutoff-note[data-ci="${ci}"]`)?.value || ''
                    });
                });
                cfg.cutoffs[gn] = items;
            });

            // 수로 면제
            cfg.suroExempt = [];
            document.querySelectorAll('.cfg-exempt-check:checked').forEach(el => cfg.suroExempt.push(el.value));

            // 자동 직위 배정
            cfg.autoRankRules = cfg.autoRankRules || {};
            document.querySelectorAll('.cfg-autorule-min').forEach(el => {
                const gn = el.dataset.guild;
                const ri = parseInt(el.dataset.ri);
                if (!cfg.autoRankRules[gn]) cfg.autoRankRules[gn] = [];
                if (!cfg.autoRankRules[gn][ri]) cfg.autoRankRules[gn][ri] = {};
                cfg.autoRankRules[gn][ri].min = parseInt(el.value) || 0;
            });
            document.querySelectorAll('.cfg-autorule-rank').forEach(el => {
                const gn = el.dataset.guild;
                const ri = parseInt(el.dataset.ri);
                if (!cfg.autoRankRules[gn]) cfg.autoRankRules[gn] = [];
                if (!cfg.autoRankRules[gn][ri]) cfg.autoRankRules[gn][ri] = {};
                cfg.autoRankRules[gn][ri].rank = el.value;
            });

            // 배지 색상
            cfg.guildBadgeStyles = cfg.guildBadgeStyles || {};
            document.querySelectorAll('.cfg-badge-bg').forEach(el => {
                const gn = el.dataset.guild;
                if (!cfg.guildBadgeStyles[gn]) cfg.guildBadgeStyles[gn] = {};
                cfg.guildBadgeStyles[gn].bg = el.value;
            });
            document.querySelectorAll('.cfg-badge-text').forEach(el => {
                const gn = el.dataset.guild;
                if (!cfg.guildBadgeStyles[gn]) cfg.guildBadgeStyles[gn] = {};
                cfg.guildBadgeStyles[gn].text = el.value;
            });
            document.querySelectorAll('.cfg-badge-border').forEach(el => {
                const gn = el.dataset.guild;
                if (!cfg.guildBadgeStyles[gn]) cfg.guildBadgeStyles[gn] = {};
                cfg.guildBadgeStyles[gn].border = el.value;
            });

            // undefined 제거
            Object.keys(cfg.cutoffs || {}).forEach(gn => {
                cfg.cutoffs[gn] = cfg.cutoffs[gn].map(c => {
                    const clean = { ...c };
                    if (clean.min === undefined) delete clean.min;
                    if (clean.max === undefined) delete clean.max;
                    if (!clean.note) delete clean.note;
                    return clean;
                });
            });

            return cfg;
        };

        window._cfgSave = async () => {
            const btn = document.getElementById('cfgSaveBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...'; }
            try {
                const newConfig = window._cfgCollectAll();
                const { error } = await supaDb.from('site_config').upsert({ id: 1, config: newConfig, updated_at: new Date().toISOString() });
                if (error) throw error;
                SITE_CONFIG = newConfig;

                // appState에도 반영
                if (newConfig.guilds) appState.guilds = newConfig.guilds;
                if (newConfig.ranks) { initialGuildRanks = newConfig.ranks; appState.guildRanks = newConfig.ranks; }
                if (newConfig.rolePriority) ROLE_PRIORITY = newConfig.rolePriority;
                if (newConfig.guildStartDate) GUILD_START_DATE = new Date(newConfig.guildStartDate);

                // 운영 이력 기록
                try {
                    await supaDb.from('operation_history').insert({ date: new Date().toISOString().split('T')[0], category: '설정', name: '디자인 설정', content: '디자인 설정이 변경되었습니다.' });
                } catch(e) {}

                window.showMsg('디자인 설정이 저장되었습니다!', 'success');
                window.renderSettings(document.getElementById('contentArea'));
            } catch(e) {
                window.showMsg('저장 실패: ' + e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-2"></i>디자인 설정 저장'; }
            }
        };

        window._cfgReset = async () => {
            if (!confirm('디자인 설정을 초기 상태로 되돌리시겠습니까?\n(현재 저장된 설정이 삭제됩니다)')) return;
            try {
                await supaDb.from('site_config').delete().eq('id', 1);
                SITE_CONFIG = null;
                window.showMsg('초기화 완료! 새로고침하면 기본값이 적용됩니다.', 'success');
                window.renderSettings(document.getElementById('contentArea'));
            } catch(e) {
                window.showMsg('초기화 실패: ' + e.message, 'error');
            }
        };

        window.saveSettings = () => { window.showMsg("설정이 저장되었습니다.", "success"); };

        // ─── 백업 기능 ───
        window._backupFetchAll = async () => {
            const btn = document.getElementById('backupAllBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>백업 중...'; }

            async function fetchAll(table, orderCol) {
                const pageSize = 1000;
                let all = [], from = 0;
                while (true) {
                    const { data, error } = await supaDb.from(table).select('*').order(orderCol, { ascending: true }).range(from, from + pageSize - 1);
                    if (error) throw error;
                    all = all.concat(data || []);
                    if (!data || data.length < pageSize) break;
                    from += pageSize;
                }
                return all;
            }

            const backup = {
                _meta: {
                    exported_at: new Date().toISOString(),
                    source: SUPABASE_URL,
                    version: '9.1'
                },
                members: await fetchAll('members', 'name'),
                suro_periods: await fetchAll('suro_periods', 'id'),
                suro_scores: await fetchAll('suro_scores', 'id'),
                bail_history: await fetchAll('bail_history', 'id'),
                penalty_history: await fetchAll('penalty_history', 'id'),
                operation_history: await fetchAll('operation_history', 'id'),
                events: await fetchAll('events', 'id'),
                guide_pages: await fetchAll('guide_pages', 'id')
            };

            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-archive mr-2"></i>전체 백업 (ZIP)'; }
            return backup;
        };

        window._backupJSON = async () => {
            try {
                const backup = await window._backupFetchAll();
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                a.href = url;
                a.download = `maplestory_guild_backup_${dateStr}.json`;
                a.click();
                URL.revokeObjectURL(url);
                window.showMsg('JSON 백업 완료!', 'success');
            } catch(e) {
                window.showMsg('백업 실패: ' + (e.message || e), 'error');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ██  관리자 화이트리스트 관리  ██
        // ═══════════════════════════════════════════════════════════════

        window._loadAdminList = async () => {
            const container = document.getElementById('adminListContainer');
            if (!container) return;
            try {
                const { data, error } = await supaDb.from('admin_whitelist').select('*').order('created_at');
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">등록된 관리자가 없습니다.</p>';
                    return;
                }
                
                const pending = data.filter(a => a.status === 'pending');
                const approved = data.filter(a => a.status === 'approved');
                const rejected = data.filter(a => a.status === 'rejected');
                
                let html = '';
                
                // 승인 대기 섹션
                if (pending.length > 0) {
                    html += `<div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>
                            <span class="text-xs font-bold text-amber-600">승인 대기 (${pending.length}명)</span>
                        </div>
                        <div class="space-y-2">${pending.map(a => `
                            <div class="flex items-center gap-3 bg-amber-50 rounded-xl px-4 py-3 border border-amber-200">
                                <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 text-[10px] font-bold shrink-0">${(a.name || a.email)[0].toUpperCase()}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-gray-700 truncate">${a.name || '-'}</p>
                                    <p class="text-[9px] text-gray-400 truncate">${a.email}</p>
                                    <p class="text-[8px] text-amber-400">${a.requested_at ? new Date(a.requested_at).toLocaleString('ko-KR') + ' 요청' : ''}</p>
                                </div>
                                <div class="flex gap-1.5 shrink-0">
                                    <button onclick="window._approveAdmin(${a.id}, '${a.email}')" class="px-3 py-1.5 bg-green-500 text-white rounded-lg text-[10px] font-bold hover:bg-green-600 transition-all"><i class="fas fa-check mr-1"></i>승인</button>
                                    <button onclick="window._rejectAdmin(${a.id}, '${a.email}')" class="px-3 py-1.5 bg-red-400 text-white rounded-lg text-[10px] font-bold hover:bg-red-500 transition-all"><i class="fas fa-times mr-1"></i>거절</button>
                                </div>
                            </div>
                        `).join('')}</div>
                    </div>`;
                }
                
                // 승인된 관리자 섹션
                if (approved.length > 0) {
                    html += `<div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                            <span class="text-xs font-bold text-green-600">승인됨 (${approved.length}명)</span>
                        </div>
                        <div class="space-y-2">${approved.map(a => `
                            <div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3 border border-gray-100 group hover:border-blue-200 transition-all">
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 text-[10px] font-bold shrink-0">${(a.name || a.email)[0].toUpperCase()}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-gray-700 truncate">${a.name || '-'}</p>
                                    <p class="text-[9px] text-gray-400 truncate">${a.email}</p>
                                </div>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full ${a.role === '마스터' ? 'bg-pink-100 text-pink-600' : a.role === '부마스터' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-500'}">${a.role || '관리자'}</span>
                                ${CURRENT_USER && CURRENT_USER.email !== a.email ? `<button onclick="window._removeAdmin(${a.id}, '${a.email}')" class="w-7 h-7 rounded-lg bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-600 text-[10px] transition-all opacity-0 group-hover:opacity-100 shrink-0"><i class="fas fa-times"></i></button>` : '<span class="text-[8px] text-green-500 font-bold">나</span>'}
                            </div>
                        `).join('')}</div>
                    </div>`;
                }
                
                // 거절된 사용자 섹션
                if (rejected.length > 0) {
                    html += `<div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-2 h-2 bg-red-400 rounded-full"></span>
                            <span class="text-xs font-bold text-red-400">거절됨 (${rejected.length}명)</span>
                        </div>
                        <div class="space-y-2">${rejected.map(a => `
                            <div class="flex items-center gap-3 bg-red-50/50 rounded-xl px-4 py-3 border border-red-100 group">
                                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-400 text-[10px] font-bold shrink-0">${(a.name || a.email)[0].toUpperCase()}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-gray-500 truncate">${a.name || '-'}</p>
                                    <p class="text-[9px] text-gray-400 truncate">${a.email}</p>
                                </div>
                                <div class="flex gap-1.5 shrink-0">
                                    <button onclick="window._approveAdmin(${a.id}, '${a.email}')" class="px-2.5 py-1 bg-green-100 text-green-600 rounded-lg text-[9px] font-bold hover:bg-green-200 transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-check mr-1"></i>승인</button>
                                    <button onclick="window._removeAdmin(${a.id}, '${a.email}')" class="w-7 h-7 rounded-lg bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-600 text-[10px] transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}</div>
                    </div>`;
                }
                
                container.innerHTML = html || '<p class="text-xs text-gray-400 text-center py-4">등록된 관리자가 없습니다.</p>';
            } catch (e) {
                container.innerHTML = `<p class="text-xs text-red-400 text-center py-4">로드 실패: ${e.message}</p>`;
            }
        };

        window._approveAdmin = async (id, email) => {
            try {
                const { error } = await supaDb.from('admin_whitelist').update({ 
                    status: 'approved', 
                    approved_at: new Date().toISOString() 
                }).eq('id', id);
                if (error) throw error;
                window.showMsg(`${email} 승인 완료!`, 'success');
                await window._loadAdminList();
            } catch (e) {
                window.showMsg('승인 실패: ' + e.message, 'error');
            }
        };

        window._rejectAdmin = async (id, email) => {
            if (!confirm(`"${email}" 접근을 거절하시겠습니까?`)) return;
            try {
                const { error } = await supaDb.from('admin_whitelist').update({ status: 'rejected' }).eq('id', id);
                if (error) throw error;
                window.showMsg(`${email} 거절됨`, 'success');
                await window._loadAdminList();
            } catch (e) {
                window.showMsg('거절 실패: ' + e.message, 'error');
            }
        };

        window._addAdmin = async () => { /* 미사용 - 자동 요청 방식 */ };

        window._removeAdmin = async (id, email, role) => {
            if (role === '마스터') { window.showMsg('마스터 계정은 삭제할 수 없습니다.', 'error'); return; }
            if (!confirm(`"${email}"을(를) 완전히 삭제하시겠습니까?\n다시 로그인하면 새로 승인 요청됩니다.`)) return;
            try {
                const { error } = await supaDb.from('admin_whitelist').delete().eq('id', id);
                if (error) throw error;
                window.showMsg(`${email} 삭제 완료`, 'success');
                await window._loadAdminList();
            } catch (e) {
                window.showMsg('삭제 실패: ' + e.message, 'error');
            }
        };

        window._backupAll = async () => {
            try {
                const backup = await window._backupFetchAll();
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const folderName = `guild_backup_${dateStr}`;

                // JSZip CDN 로드
                if (!window.JSZip) {
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                        s.onload = resolve;
                        s.onerror = reject;
                        document.head.appendChild(s);
                    });
                }

                const zip = new JSZip();
                const folder = zip.folder(folderName);

                // 메타 정보
                folder.file('_meta.json', JSON.stringify(backup._meta, null, 2));

                // 각 테이블별 파일
                const tables = ['members','suro_periods','suro_scores','bail_history','penalty_history','operation_history','events','guide_pages'];
                tables.forEach(t => {
                    folder.file(`${t}.json`, JSON.stringify(backup[t], null, 2));
                });

                // 전체 통합 파일도 포함
                folder.file('_full_backup.json', JSON.stringify(backup, null, 2));

                // CSV 형태로 members도 추가
                if (backup.members.length > 0) {
                    const csvCols = Object.keys(backup.members[0]);
                    const csvRows = [csvCols.join(',')];
                    backup.members.forEach(m => {
                        csvRows.push(csvCols.map(c => {
                            const v = String(m[c] ?? '').replace(/"/g, '""');
                            return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v}"` : v;
                        }).join(','));
                    });
                    folder.file('members.csv', '\uFEFF' + csvRows.join('\n'));
                }

                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${folderName}.zip`;
                a.click();
                URL.revokeObjectURL(url);
                window.showMsg(`백업 완료! (${tables.length}개 테이블)`, 'success');
            } catch(e) {
                console.error('백업 에러:', e);
                window.showMsg('백업 실패: ' + (e.message || e), 'error');
            }
        };

        window._memberSearchTimer = null;
        window.handleSearch = (v) => { appState.filters.search = v; appState.pagination.members = 1; if(window._memberSearchTimer) clearTimeout(window._memberSearchTimer); window._memberSearchTimer = setTimeout(() => window.updateMemberTable(), 100); };
        window.filterByGuild = (g) => { appState.filters.guild = g; appState.pagination.members = 1; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } appState.pagination.members = 1; window.updateMemberTable(); };
        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };
        
        window.openEditModal = (id) => { 
            const m = appState.members.find(x => x.id == id); if(!m) return;
            document.getElementById('modalTitle').innerText = '멤버 정보 수정'; document.getElementById('editMemberId').value = m.id; document.getElementById('inputName').value = m.name; document.getElementById('inputName').disabled = true;
            const allJobsForEdit = [...new Set([...MAPLE_JOBS, ...appState.members.map(m => m.class).filter(c => c && !MAPLE_JOBS.includes(c))])]; document.getElementById('inputClass').innerHTML = allJobsForEdit.map(j=>`<option value="${j}">${j}</option>`).join(''); document.getElementById('inputClass').value = m.class || '';
            document.getElementById('inputGuild').innerHTML = appState.guilds.map(g=>`<option value="${g.name}">${g.name}</option>`).join(''); document.getElementById('inputGuild').value = m.guild;
            onGuildSelectChange(m.guild); setTimeout(() => { document.getElementById('inputRole').value = m.role; }, 100);
            document.getElementById('inputIsMain').checked = m.isMain; document.getElementById('inputMainCharName').value = m.mainCharName || ''; toggleMainCharInput(); document.getElementById('memberModal').classList.remove('hidden');
        };
        window.openAddModal = () => {
            // 일괄 등록 모달 오픈
            document.getElementById('bulkAddBody').innerHTML = '';
            window._bulkAddRows(3); // 초기 3행
            document.getElementById('bulkAddModal').classList.remove('hidden');
            window._bulkUpdateCount();
        };

        window._bulkRowId = 0;
        window._bulkAddRow = () => {
            const idx = ++window._bulkRowId;
            const tbody = document.getElementById('bulkAddBody');
            const guilds = appState.guilds.map(g => g.name);
            const defaultGuild = guilds[0];
            const defaultRoles = initialGuildRanks[defaultGuild] || [];

            const tr = document.createElement('tr');
            tr.id = `bulkRow_${idx}`;
            tr.className = 'border-b border-gray-50 hover:bg-pink-50/20 transition-colors';
            tr.innerHTML = `
                <td class="p-1 text-center text-gray-300 text-[10px] font-mono bulk-row-num"></td>
                <td class="p-1"><input type="text" class="bulk-name w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100 focus:border-pink-200" placeholder="캐릭터명"></td>
                <td class="p-1">
                    <select class="bulk-guild w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" onchange="window._bulkGuildChange(this, ${idx})">
                        ${guilds.map(g => `<option value="${g}">${g}</option>`).join('')}
                    </select>
                </td>
                <td class="p-1">
                    <select class="bulk-role w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" id="bulkRole_${idx}">
                        ${defaultRoles.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                </td>
                <td class="p-1">
                    <select class="bulk-class w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer">
                        <option value="">-</option>
                        ${MAPLE_JOBS.map(j => `<option value="${j}">${j}</option>`).join('')}
                    </select>
                </td>
                <td class="p-1 text-center">
                    <input type="checkbox" class="bulk-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" checked onchange="window._bulkMainToggle(this, ${idx})">
                </td>
                <td class="p-1">
                    <input type="text" class="bulk-mainChar w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none hidden" id="bulkMainChar_${idx}" placeholder="본캐닉">
                </td>
                <td class="p-1 text-center">
                    <button onclick="document.getElementById('bulkRow_${idx}').remove();window._bulkUpdateCount()" class="w-6 h-6 rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-400 transition-all text-[10px]"><i class="fas fa-times"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
            window._bulkUpdateCount();
            // Focus the name input of new row
            tr.querySelector('.bulk-name').focus();
        };

        window._bulkAddRows = (n) => { for(let i=0; i<n; i++) window._bulkAddRow(); };

        window._bulkGuildChange = (sel, idx) => {
            const roles = initialGuildRanks[sel.value] || [];
            const roleEl = document.getElementById(`bulkRole_${idx}`);
            if(roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };

        window._bulkMainToggle = (cb, idx) => {
            const el = document.getElementById(`bulkMainChar_${idx}`);
            if(el) { cb.checked ? el.classList.add('hidden') : el.classList.remove('hidden'); }
        };

        window._bulkUpdateCount = () => {
            const rows = document.querySelectorAll('#bulkAddBody tr');
            rows.forEach((tr, i) => { const num = tr.querySelector('.bulk-row-num'); if(num) num.textContent = i+1; });
            const filled = [...rows].filter(tr => tr.querySelector('.bulk-name')?.value.trim()).length;
            document.getElementById('bulkAddCount').textContent = `${rows.length}행 (입력 ${filled}명)`;
        };

        window._bulkAddSave = async () => {
            const rows = document.querySelectorAll('#bulkAddBody tr');
            const members = [];
            const existingNames = new Set(appState.members.map(m => m.name));
            const newNames = new Set();
            const errors = [];

            rows.forEach((tr, i) => {
                const name = tr.querySelector('.bulk-name')?.value.trim();
                if (!name) return; // 빈 행 스킵
                if (existingNames.has(name)) { errors.push(`${i+1}행: "${name}" 이미 존재하는 닉네임`); return; }
                if (newNames.has(name)) { errors.push(`${i+1}행: "${name}" 중복 입력`); return; }
                newNames.add(name);

                members.push({
                    name: name,
                    guild: tr.querySelector('.bulk-guild')?.value || '뚠카롱',
                    role: tr.querySelector('.bulk-role')?.value || '팬케이크',
                    class: tr.querySelector('.bulk-class')?.value || '',
                    is_main: tr.querySelector('.bulk-isMain')?.checked !== false,
                    main_char_name: tr.querySelector('.bulk-mainChar')?.value.trim() || '',
                    join_date: new Date().toISOString().split('T')[0]
                });
            });

            if (errors.length > 0) { window.showMsg(errors.join('\n'), 'error'); return; }
            if (members.length === 0) { window.showMsg('입력된 멤버가 없습니다.', 'error'); return; }
            if (!confirm(`${members.length}명을 등록하시겠습니까?`)) return;

            const btn = document.getElementById('bulkAddSaveBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>저장 중...';

            try {
                const { error } = await supaDb.from('members').insert(members);
                if (error) throw error;

                // 운영이력
                const historyRows = members.map(m => ({
                    date: new Date().toISOString().split('T')[0],
                    category: '추가', name: m.name, content: `${m.guild} 길드에 추가됨`
                }));
                await supaDb.from('operation_history').insert(historyRows);

                window.showMsg(`${members.length}명 일괄 등록 완료!`, 'success');
                window.closeModal('bulkAddModal');
                await window.fetchMembers();
            } catch(e) {
                console.error('일괄 등록 에러:', e);
                window.showMsg('등록 실패: ' + (e.message || e), 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>일괄 저장';
            }
        };
        window.openDeleteModal = (id) => { appState.memberToDelete = appState.members.find(x => x.id == id); document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteModal').classList.remove('hidden'); };
        window.setDeleteType = (t) => { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all'; document.getElementById('btnKick').className = t === 'kick' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-red-600 text-white shadow-sm transition-all' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all'; };
        
        window.confirmDelete = async () => { 
            const reason = document.getElementById('deleteReason').value;
            
            if (appState.isKickMode && appState.kickSelection.size > 0) {
                const ids = Array.from(appState.kickSelection);
                const kickedNames = appState.members.filter(m => ids.includes(m.id)).map(m => m.name);
                
                if (!confirm(`${kickedNames.length}명을 정말 추방하시겠습니까?\n${kickedNames.join(', ')}`)) return;
                
                window.showLoading(true);
                window.setLoadProgress(10, '추방 처리 중...');
                
                try {
                    // 관련 수로 점수 먼저 삭제
                    window.setLoadProgress(20, '수로 데이터 정리 중...');
                    const { error: suroErr } = await supaDb.from('suro_scores').delete().in('member_id', ids);
                    if (suroErr) console.error('suro delete error:', suroErr);
                    
                    // 멤버 삭제
                    window.setLoadProgress(50, '멤버 삭제 중...');
                    const { error: memErr } = await supaDb.from('members').delete().in('id', ids);
                    if (memErr) throw memErr;
                    
                    // 운영이력 저장
                    if (reason) {
                        window.setLoadProgress(70, '이력 저장 중...');
                        const historyRows = kickedNames.map(name => ({
                            date: new Date().toISOString().split('T')[0],
                            category: '추방', name: name, content: reason
                        }));
                        await supaDb.from('operation_history').insert(historyRows);
                    }
                    
                    window.setLoadProgress(90, '데이터 갱신 중...');
                    window.showMsg(`${kickedNames.length}명 추방 완료.`, "success");
                } catch(e) {
                    console.error('추방 에러:', e);
                    window.showMsg("추방 처리 실패: " + (e.message || e), "error");
                }
                
                window.showLoading(false);
                window.closeModal('deleteModal');
                appState.isKickMode = false;
                appState.kickSelection.clear();
                await window.fetchMembers();
                return;
            }

            // Single member delete
            if (appState.memberToDelete) {
                window.showLoading(true);
                const delId = appState.memberToDelete.id;
                const delName = appState.memberToDelete.name;
                
                try {
                    // 관련 수로 점수 먼저 삭제
                    await supaDb.from('suro_scores').delete().eq('member_id', delId);
                    
                    // 멤버 삭제
                    const { error } = await supaDb.from('members').delete().eq('id', delId);
                    if (error) throw error;
                    
                    // 운영이력 저장
                    if (reason) {
                        await supaDb.from('operation_history').insert({
                            date: new Date().toISOString().split('T')[0],
                            category: appState.deleteType === 'kick' ? '추방' : '자진탈퇴',
                            name: delName, content: reason
                        });
                    }
                    
                    window.showMsg(`${delName} 제거 완료.`, "success");
                    await window.fetchMembers();
                } catch(e) {
                    console.error('삭제 에러:', e);
                    window.showMsg("제거 실패: " + (e.message || e), "error");
                }
                
                window.showLoading(false);
                window.closeModal('deleteModal');
            }
        };

        function onGuildSelectChange(v) { document.getElementById('inputRole').innerHTML = (appState.guildRanks[v] || initialGuildRanks[v] || initialGuildRanks['뚠카롱']).map(r => `<option value="${r}">${r}</option>`).join(''); }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }
        
        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('editMemberId').value;
            const data = { name: document.getElementById('inputName').value.trim(), guild: document.getElementById('inputGuild').value, role: document.getElementById('inputRole').value, class: document.getElementById('inputClass').value, isMain: document.getElementById('inputIsMain').checked, mainCharName: document.getElementById('inputMainCharName').value.trim(), joinDate: new Date().toISOString().split('T')[0] };
            if(await window.sendAction(id ? 'update' : 'add', id ? { ...data, id } : data)) window.closeModal('memberModal');
        };

        // ─── 수로 점수 입력 기능 ───
        window.renderSuroInput = (container) => {
            const currentHeader = window.getSuroPeriodHeader();
            const allHeaders = [...appState.suroHeaders];
            const headerOptions = allHeaders.includes(currentHeader) ? allHeaders : [...allHeaders, currentHeader];

            container.innerHTML = `
            <div class="flex flex-col gap-3 lg:gap-4 fade-in h-full">
                <div class="bg-white p-3 lg:p-5 rounded-2xl border border-gray-100 shadow-sm shrink-0">
                    <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-end">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">수로 주차 선택</label>
                            <select id="suroInputPeriod" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-2.5 lg:p-3 text-xs font-bold outline-none shadow-inner" onchange="window._suroInputState.page=1;window.loadSuroInputTable()">
                                ${headerOptions.map(h => `<option value="${h}" ${h === currentHeader ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">길드 필터</label>
                            <select id="suroInputGuild" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-2.5 lg:p-3 text-xs font-bold outline-none shadow-inner" onchange="window._suroInputState.page=1;window.loadSuroInputTable()">
                                ${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="window.openSuroPasteModal()" class="px-4 lg:px-5 py-2.5 lg:py-3 bg-indigo-500 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-lg hover:bg-indigo-600 transition-all">
                                <i class="fas fa-paste mr-1"></i> 붙여넣기
                            </button>
                            <button onclick="window.saveSuroScores()" class="px-5 lg:px-6 py-2.5 lg:py-3 bg-pink-500 text-white rounded-xl text-[10px] lg:text-xs font-bold shadow-lg hover:bg-pink-600 transition-all">
                                <i class="fas fa-save mr-1"></i> 점수 저장
                            </button>
                            <button onclick="window.clearSuroInputs()" class="px-3 lg:px-4 py-2.5 lg:py-3 bg-gray-100 text-gray-500 rounded-xl text-[10px] lg:text-xs font-bold hover:bg-gray-200 transition-all">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden flex flex-col min-h-0">
                    <div id="suroInputTableContainer" class="flex-1 overflow-auto"></div>
                </div>
            </div>`;
            window.loadSuroInputTable();
        };

        window._suroInputState = { page: 1, perPage: 9999 };

        window.loadSuroInputTable = () => {
            const container = document.getElementById('suroInputTableContainer');
            if (!container) return;
            const guild = document.getElementById('suroInputGuild').value;
            const period = document.getElementById('suroInputPeriod').value;
            const allMembers = appState.members
                .filter(m => m.guild === guild)
                .sort((a, b) => a.name < b.name ? -1 : a.name > b.name ? 1 : 0);

            const st = window._suroInputState;
            const totalPages = Math.max(1, Math.ceil(allMembers.length / st.perPage));
            if (st.page > totalPages) st.page = totalPages;
            const startIdx = (st.page - 1) * st.perPage;
            const pageMembers = allMembers.slice(startIdx, startIdx + st.perPage);

            container.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-100 shrink-0">
                <span class="text-[9px] font-bold text-gray-500"><i class="fas fa-users mr-1 text-pink-400"></i>${allMembers.length}명</span>
                <span class="text-[9px] font-bold text-pink-400">17명마다 페이지 구분선 표시</span>
            </div>
            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase border-b border-gray-200">
                    <tr>
                        <th class="p-2 lg:p-3 w-10 text-center">#</th>
                        <th class="p-2 lg:p-3">닉네임</th>
                        <th class="p-2 lg:p-3 hidden sm:table-cell">직위</th>
                        <th class="p-2 lg:p-3 w-24 text-center">현재 점수</th>
                        <th class="p-2 lg:p-3 w-32 lg:w-40">점수 입력</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 font-bold">
                    ${pageMembers.map((m, i) => {
                        const currentScore = Math.round(Number(m.suro?.[period])) || 0;
                        const globalIdx = startIdx + i;
                        const isPageBoundary = globalIdx > 0 && globalIdx % 17 === 0;
                        const pageNum = Math.floor(globalIdx / 17) + 1;
                        let row = '';
                        if (isPageBoundary) {
                            row += `<tr><td colspan="5" class="p-0"><div class="flex items-center gap-2 py-1 px-3 bg-pink-50 border-y-2 border-pink-200"><span class="text-[9px] font-black text-pink-400 tracking-widest uppercase">── PAGE ${pageNum} ──</span><span class="text-[9px] text-pink-300">(${globalIdx + 1}~${Math.min(globalIdx + 17, allMembers.length)}번째)</span></div></td></tr>`;
                        }
                        row += `
                        <tr class="hover:bg-pink-50/20 transition-colors">
                            <td class="p-2 lg:p-3 text-center text-gray-400 text-[10px]">${globalIdx + 1}</td>
                            <td class="p-2 lg:p-3 text-gray-800">
                                <div class="flex items-center">${window.getNicknameIcon(m.role)}<span class="text-[11px] lg:text-xs">${m.name}</span></div>
                            </td>
                            <td class="p-2 lg:p-3 text-gray-500 text-[10px] hidden sm:table-cell">${m.role}</td>
                            <td class="p-2 lg:p-3 text-center ${currentScore === 0 ? 'text-red-400' : 'text-gray-700'} text-[10px] lg:text-xs">${currentScore.toLocaleString()}</td>
                            <td class="p-2 lg:p-3">
                                <input type="number" 
                                    class="suro-score-input w-full bg-gray-50 border border-gray-100 rounded-lg px-2 lg:px-3 py-1.5 lg:py-2 text-[10px] lg:text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100 focus:border-pink-200 transition-all text-right" 
                                    data-member-id="${m.id}" 
                                    value="${currentScore || ''}" 
                                    placeholder="0" 
                                    min="0" step="1000">
                            </td>
                        </tr>`;
                        return row;
                    }).join('')}
                </tbody>
            </table>`;

            // Tab키: 아래로 이동
            container.addEventListener('keydown', (e) => {
                if (e.key !== 'Tab') return;
                const el = document.activeElement;
                if (!el || !el.classList.contains('suro-score-input')) return;
                e.preventDefault();
                const tr = el.closest('tr');
                const nextTr = e.shiftKey ? tr?.previousElementSibling : tr?.nextElementSibling;
                if (nextTr) {
                    const nextInput = nextTr.querySelector('.suro-score-input');
                    if (nextInput) { nextInput.focus(); nextInput.select(); }
                }
            });
        };

        window._suroInputPage = (delta) => {
            window._suroInputState.page += delta;
            window.loadSuroInputTable();
        };

        window.clearSuroInputs = () => {
            document.querySelectorAll('.suro-score-input').forEach(input => { input.value = ''; });
            window.showMsg("입력값이 초기화되었습니다.", "info");
        };

        // ─── 수로 붙여넣기 모달 ───
        window.openSuroPasteModal = () => {
            const currentHeader = document.getElementById('suroInputPeriod')?.value || '';
            const allHeaders = [...appState.suroHeaders];
            const headerOptions = allHeaders.includes(currentHeader) ? allHeaders : [...allHeaders, currentHeader];

            document.getElementById('suroPasteModal')?.remove();
            const modal = document.createElement('div');
            modal.id = 'suroPasteModal';
            modal.className = 'fixed inset-0 z-[2000] flex items-center justify-center bg-black/30 backdrop-blur-sm fade-in font-bold p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden border border-gray-100 max-h-[90vh] flex flex-col">
                    <div class="p-5 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center shrink-0">
                        <div><h3 class="text-base font-bold text-indigo-700 tracking-tight"><i class="fas fa-paste mr-2"></i>수로 점수 붙여넣기</h3>
                        <p class="text-[10px] text-indigo-400 mt-1">닉네임(탭)점수 형식의 데이터를 붙여넣으세요. 괄호 안 내용은 무시됩니다.</p></div>
                        <button onclick="document.getElementById('suroPasteModal').remove()"><i class="fas fa-times text-gray-400 text-lg"></i></button>
                    </div>
                    <div class="p-5 space-y-4 overflow-y-auto flex-1">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">저장할 주차</label>
                            <select id="suroPastePeriod" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-xs font-bold outline-none shadow-inner">
                                ${headerOptions.map(h => `<option value="${h}" ${h === currentHeader ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">데이터 붙여넣기</label>
                            <textarea id="suroPasteText" rows="10" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-xs font-mono outline-none shadow-inner resize-none focus:ring-2 focus:ring-indigo-100" placeholder="닉네임\t점수\n예: 도규\t253438\nSumireUesaka\t168137"></textarea>
                        </div>
                        <button onclick="window.parseSuroPaste()" class="w-full py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs hover:bg-indigo-600 transition-all shadow-lg"><i class="fas fa-search mr-1"></i> 데이터 분석</button>
                        <div id="suroPastePreview"></div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        };

        window.parseSuroPaste = () => {
            const raw = document.getElementById('suroPasteText').value.trim();
            if (!raw) { window.showMsg('데이터를 입력해주세요.', 'error'); return; }

            const lines = raw.split('\n').filter(l => l.trim());
            const parsed = [];
            const skipped = [];

            lines.forEach((line, i) => {
                // 탭 또는 여러 공백으로 분리
                const parts = line.split(/\t+/);
                if (parts.length < 2) {
                    // 공백으로도 시도 (마지막 숫자 부분 분리)
                    const spaceMatch = line.match(/^(.+?)\s+([\d,]+)\s*$/);
                    if (spaceMatch) {
                        parts[0] = spaceMatch[1];
                        parts[1] = spaceMatch[2];
                    } else {
                        skipped.push({ line: i + 1, text: line, reason: '형식 오류' });
                        return;
                    }
                }

                // 닉네임: 괄호 안 내용 제거
                let name = parts[0].replace(/\([^)]*\)/g, '').trim();
                // 점수: 콤마 제거 후 숫자 변환
                let scoreStr = parts[1].replace(/,/g, '').trim();
                let score = parseInt(scoreStr);

                if (!name) { skipped.push({ line: i + 1, text: line, reason: '닉네임 없음' }); return; }
                if (isNaN(score)) { skipped.push({ line: i + 1, text: line, reason: '점수 오류' }); return; }

                // DB 멤버 매칭
                const member = appState.members.find(m => m.name === name);
                parsed.push({ name, score, member, originalLine: line });
            });

            const matched = parsed.filter(p => p.member);
            const unmatched = parsed.filter(p => !p.member);
            const period = document.getElementById('suroPastePeriod').value;

            const preview = document.getElementById('suroPastePreview');
            preview.innerHTML = `
                <div class="space-y-3">
                    <div class="flex gap-2 flex-wrap text-[10px]">
                        <span class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-lg border border-emerald-100"><i class="fas fa-check mr-1"></i>매칭 ${matched.length}명</span>
                        <span class="px-3 py-1 bg-red-50 text-red-500 rounded-lg border border-red-100"><i class="fas fa-times mr-1"></i>미매칭 ${unmatched.length}명</span>
                        ${skipped.length > 0 ? `<span class="px-3 py-1 bg-gray-50 text-gray-400 rounded-lg border border-gray-100"><i class="fas fa-forward mr-1"></i>건너뜀 ${skipped.length}건</span>` : ''}
                    </div>
                    ${matched.length > 0 ? `
                    <div class="bg-gray-50 rounded-xl border border-gray-100 overflow-hidden">
                        <div class="max-h-[200px] overflow-y-auto">
                            <table class="w-full text-[10px]">
                                <thead class="bg-gray-100 sticky top-0"><tr>
                                    <th class="p-2 text-left text-gray-400">닉네임</th>
                                    <th class="p-2 text-left text-gray-400">소속</th>
                                    <th class="p-2 text-right text-gray-400">점수</th>
                                </tr></thead>
                                <tbody>${matched.map(p => `<tr class="border-t border-gray-100"><td class="p-2 text-gray-700">${p.name}</td><td class="p-2 text-gray-400">${p.member.guild}</td><td class="p-2 text-right text-emerald-600 font-mono">${p.score.toLocaleString()}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>` : ''}
                    ${unmatched.length > 0 ? `
                    <div class="bg-red-50 rounded-xl p-3 border border-red-100 text-[10px] text-red-500">
                        <p class="font-bold mb-1"><i class="fas fa-exclamation-triangle mr-1"></i>DB에 없는 닉네임 (저장 안 됨)</p>
                        <p class="text-red-400">${unmatched.map(p => p.name).join(', ')}</p>
                    </div>` : ''}
                    ${skipped.length > 0 ? `
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 text-[10px] text-gray-400">
                        <p class="font-bold mb-1">건너뛴 줄</p>
                        ${skipped.map(s => `<p>줄 ${s.line}: ${s.reason} - <span class="font-mono">${s.text.substring(0, 40)}</span></p>`).join('')}
                    </div>` : ''}
                    ${matched.length > 0 ? `
                    <button onclick="window.saveSuroPaste()" class="w-full py-3.5 bg-emerald-500 text-white rounded-xl font-bold text-xs hover:bg-emerald-600 transition-all shadow-lg">
                        <i class="fas fa-save mr-1"></i> "${period}" 주차에 ${matched.length}명 점수 저장
                    </button>` : ''}
                </div>`;

            // 파싱 결과 임시 저장
            window._suroParsed = matched;
        };

        window.saveSuroPaste = async () => {
            const matched = window._suroParsed;
            if (!matched || matched.length === 0) return;

            const periodLabel = document.getElementById('suroPastePeriod').value;
            if (!confirm(`"${periodLabel}" 주차에 ${matched.length}명의 점수를 저장하시겠습니까?`)) return;

            window.showLoading(true);
            window.setLoadProgress(10, '주차 확인 중...');
            try {
                // 주차 확인/생성
                let { data: period } = await supaDb.from('suro_periods').select('id').eq('period_label', periodLabel).maybeSingle();
                if (!period) {
                    const match = periodLabel.match(/(\d{2})-(\d{2})-(\d{2})\(.\)\s*~\s*(\d{2})-(\d{2})-(\d{2})/);
                    const startDate = match ? `20${match[1]}-${match[2]}-${match[3]}` : new Date().toISOString().split('T')[0];
                    const endDate = match ? `20${match[4]}-${match[5]}-${match[6]}` : new Date().toISOString().split('T')[0];
                    const { data: newPeriod, error: pErr } = await supaDb.from('suro_periods')
                        .insert({ period_label: periodLabel, start_date: startDate, end_date: endDate }).select().single();
                    if (pErr) throw pErr;
                    period = newPeriod;
                }

                window.setLoadProgress(30, '점수 저장 중...');
                const upsertRows = matched.map(p => ({
                    member_id: p.member.id,
                    period_id: period.id,
                    score: p.score
                }));

                const { error: uErr } = await supaDb.from('suro_scores')
                    .upsert(upsertRows, { onConflict: 'member_id,period_id' });
                if (uErr) throw uErr;

                window.setLoadProgress(80, '데이터 갱신 중...');
                window.showLoading(false);
                window.showMsg(`${matched.length}명의 수로 점수가 저장되었습니다!`, 'success');
                document.getElementById('suroPasteModal')?.remove();
                await window.fetchMembers();
                window.loadSuroInputTable();
            } catch(e) {
                window.showLoading(false);
                window.showMsg('저장 실패: ' + (e.message || e), 'error');
            }
        };

        window.saveSuroScores = async () => {
            const periodLabel = document.getElementById('suroInputPeriod').value;
            const inputs = document.querySelectorAll('.suro-score-input');
            if (!confirm(`"${periodLabel}" 주차의 ${inputs.length}명 점수를 저장하시겠습니까?`)) return;

            window.showLoading(true);
            window.setLoadProgress(10, '수로 점수 저장 준비...');
            try {
                // 해당 주차가 DB에 있는지 확인, 없으면 생성
                let { data: period } = await supaDb.from('suro_periods').select('id').eq('period_label', periodLabel).maybeSingle();
                if (!period) {
                    const match = periodLabel.match(/(\d{2})-(\d{2})-(\d{2})\(.\)\s*~\s*(\d{2})-(\d{2})-(\d{2})/);
                    const startDate = match ? `20${match[1]}-${match[2]}-${match[3]}` : new Date().toISOString().split('T')[0];
                    const endDate = match ? `20${match[4]}-${match[5]}-${match[6]}` : new Date().toISOString().split('T')[0];
                    const { data: newPeriod, error: pErr } = await supaDb.from('suro_periods')
                        .insert({ period_label: periodLabel, start_date: startDate, end_date: endDate }).select().single();
                    if (pErr) throw pErr;
                    period = newPeriod;
                }

                window.setLoadProgress(30, '점수 데이터 전송 중...');
                const upsertRows = [];
                inputs.forEach(input => {
                    const memberId = parseInt(input.dataset.memberId);
                    const score = parseInt(input.value) || 0;
                    upsertRows.push({ member_id: memberId, period_id: period.id, score: score });
                });

                const { error: uErr } = await supaDb.from('suro_scores')
                    .upsert(upsertRows, { onConflict: 'member_id,period_id' });
                if (uErr) throw uErr;

                window.setLoadProgress(80, '데이터 갱신 중...');
                window.showLoading(false);
                window.showMsg(`${upsertRows.length}명의 수로 점수가 저장되었습니다!`, 'success');
                await window.fetchMembers();
            } catch (e) {
                console.error('수로 점수 저장 에러:', e);
                window.showLoading(false);
                window.showMsg('저장 실패: ' + (e.message || e), 'error');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ██  길드원 동기화 (Nexon Open API)  ██
        // ═══════════════════════════════════════════════════════════════

        const NEXON_API_BASE = 'https://open.api.nexon.com';
        const MAPLE_WORLDS = ['스카니아','베라','루나','제니스','크로아','유니온','엘리시움','이노시스','레드','오로라','아케인','노바','리부트','리부트2'];

        window._getNexonApiKey = () => localStorage.getItem('nexon_api_key') || '';
        window._setNexonApiKey = (key) => localStorage.setItem('nexon_api_key', key.trim());
        window._getSyncWorld = () => localStorage.getItem('sync_world') || '루나';
        window._setSyncWorld = (w) => localStorage.setItem('sync_world', w);

        // Nexon API 호출 헬퍼
        window._nexonFetch = async (endpoint, params = {}) => {
            const apiKey = window._getNexonApiKey();
            if (!apiKey) throw new Error('Nexon API Key가 설정되지 않았습니다.');
            const qs = new URLSearchParams(params).toString();
            const url = `${NEXON_API_BASE}${endpoint}${qs ? '?' + qs : ''}`;
            const res = await fetch(url, { headers: { 'x-nxopen-api-key': apiKey } });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error?.message || `API 오류 (${res.status})`);
            }
            return res.json();
        };

        // 길드 oguild_id 조회
        window._getGuildId = async (guildName, worldName) => {
            const data = await window._nexonFetch('/maplestory/v1/guild/id', {
                guild_name: guildName, world_name: worldName
            });
            return data.oguild_id;
        };

        // 길드 기본 정보 (멤버 리스트 포함) 조회
        window._getGuildBasic = async (oguildId) => {
            const data = await window._nexonFetch('/maplestory/v1/guild/basic', {
                oguild_id: oguildId
            });
            return data;
        };

        // 캐릭터 OCID 조회
        window._getCharOcid = async (characterName) => {
            const data = await window._nexonFetch('/maplestory/v1/id', {
                character_name: characterName
            });
            return data.ocid;
        };

        // 캐릭터 기본 정보 (직업, 레벨 등) 조회
        window._getCharBasic = async (ocid) => {
            const data = await window._nexonFetch('/maplestory/v1/character/basic', {
                ocid: ocid
            });
            return data;
        };

        // 닉네임으로 직업/레벨 한번에 조회
        window._getCharInfo = async (characterName) => {
            try {
                const ocid = await window._getCharOcid(characterName);
                const basic = await window._getCharBasic(ocid);
                return {
                    name: basic.character_name || characterName,
                    class: basic.character_class || '',
                    level: basic.character_level || 0,
                    guild: basic.character_guild_name || '',
                    world: basic.world_name || '',
                    image: basic.character_image || ''
                };
            } catch (e) {
                return null;
            }
        };

        // 동기화 메인 로직
        window._runSync = async () => {
            const apiKey = window._getNexonApiKey();
            if (!apiKey) { window.showMsg('Nexon API Key를 먼저 입력해주세요.', 'error'); return; }
            
            const worldName = window._getSyncWorld();
            const resultDiv = document.getElementById('syncResult');
            const btn = document.getElementById('syncRunBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>동기화 중...'; }
            resultDiv.innerHTML = '<div class="text-center py-12 text-gray-400 font-bold"><i class="fas fa-spinner fa-spin text-2xl mb-3"></i><p class="text-xs">Nexon API에서 길드원 정보를 불러오는 중...</p></div>';

            try {
                const allApiMembers = {}; // { guildName: [memberName, ...] }
                const errors = [];

                for (const g of appState.guilds) {
                    try {
                        const oguildId = await window._getGuildId(g.name, worldName);
                        const basic = await window._getGuildBasic(oguildId);
                        allApiMembers[g.name] = basic.guild_member || [];
                    } catch (e) {
                        errors.push(`${g.name}: ${e.message}`);
                        allApiMembers[g.name] = null; // 조회 실패
                    }
                }

                // DB 멤버와 비교
                const dbMembers = appState.members; // [{name, guild, ...}]
                const dbNameSet = new Set(dbMembers.map(m => m.name));
                const dbByGuild = {};
                dbMembers.forEach(m => {
                    if (!dbByGuild[m.guild]) dbByGuild[m.guild] = new Set();
                    dbByGuild[m.guild].add(m.name);
                });

                // 모든 API 멤버를 하나의 Set으로
                const allApiNameSet = new Set();
                Object.values(allApiMembers).forEach(arr => {
                    if (arr) arr.forEach(name => allApiNameSet.add(name));
                });

                // 신규 멤버: API에 있고 DB에 없는 사람
                const newMembers = []; // [{name, guild}]
                for (const [gName, members] of Object.entries(allApiMembers)) {
                    if (!members) continue;
                    members.forEach(name => {
                        if (!dbNameSet.has(name)) {
                            newMembers.push({ name, guild: gName });
                        }
                    });
                }

                // 탈퇴 의심 멤버: DB에 있고 어떤 API 길드에도 없는 사람
                const goneMembers = []; // [{name, guild, id}]
                dbMembers.forEach(m => {
                    // 해당 길드의 API 조회가 성공했는데 그 길드 멤버 목록에 없는 경우
                    const apiList = allApiMembers[m.guild];
                    if (apiList && !apiList.includes(m.name)) {
                        // 다른 길드에도 없는지 확인
                        if (!allApiNameSet.has(m.name)) {
                            goneMembers.push({ name: m.name, guild: m.guild, id: m.id });
                        }
                    }
                });

                // 길드 이동 멤버: DB에서 A길드인데 API에서 B길드에 있는 경우
                const movedMembers = [];
                dbMembers.forEach(m => {
                    for (const [gName, members] of Object.entries(allApiMembers)) {
                        if (!members) continue;
                        if (gName !== m.guild && members.includes(m.name)) {
                            movedMembers.push({ name: m.name, fromGuild: m.guild, toGuild: gName, id: m.id });
                        }
                    }
                });

                // 닉변 의심 감지: 탈퇴 멤버 + 신규 멤버를 API 직업/길드로 매칭
                const nickChangeSuspects = []; // [{oldName, newName, guild, id, class}]
                if (goneMembers.length > 0 && newMembers.length > 0) {
                    // 신규 멤버 직업/레벨을 API에서 조회
                    const newMemberInfos = [];
                    for (const nm of newMembers) {
                        try {
                            const info = await window._getCharInfo(nm.name);
                            newMemberInfos.push({ ...nm, apiClass: info?.class || '', apiLevel: info?.level || 0 });
                        } catch(e) {
                            newMemberInfos.push({ ...nm, apiClass: '', apiLevel: 0 });
                        }
                        await new Promise(r => setTimeout(r, 80));
                    }
                    // 탈퇴 멤버의 DB 직업과 신규 멤버 API 직업 매칭
                    const usedGone = new Set();
                    const usedNew = new Set();
                    for (const gm of goneMembers) {
                        const dbInfo = dbMembers.find(d => d.id === gm.id);
                        if (!dbInfo || !dbInfo.class) continue;
                        for (let ni = 0; ni < newMemberInfos.length; ni++) {
                            if (usedNew.has(ni)) continue;
                            const nm = newMemberInfos[ni];
                            // 같은 길드 + 같은 직업 → 닉변 의심
                            if (nm.guild === gm.guild && nm.apiClass && nm.apiClass === dbInfo.class) {
                                nickChangeSuspects.push({
                                    oldName: gm.name, newName: nm.name, guild: gm.guild,
                                    id: gm.id, class: dbInfo.class, level: nm.apiLevel
                                });
                                usedGone.add(gm.id);
                                usedNew.add(ni);
                                break;
                            }
                        }
                    }
                    // 닉변 확정된 항목은 신규/탈퇴 목록에서 제거
                    if (nickChangeSuspects.length > 0) {
                        const goneIds = new Set(nickChangeSuspects.map(s => s.id));
                        const newNames = new Set(nickChangeSuspects.map(s => s.newName));
                        goneMembers.splice(0, goneMembers.length, ...goneMembers.filter(g => !goneIds.has(g.id)));
                        newMembers.splice(0, newMembers.length, ...newMembers.filter(n => !newNames.has(n.name)));
                    }
                }

                // 결과 렌더링
                let html = '';

                // 에러 표시
                if (errors.length > 0) {
                    html += `<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-4">
                        <p class="text-xs font-bold text-amber-600 mb-2"><i class="fas fa-exclamation-triangle mr-1"></i>일부 길드 조회 실패</p>
                        ${errors.map(e => `<p class="text-[10px] text-amber-500">${e}</p>`).join('')}
                    </div>`;
                }

                // 요약
                const successGuilds = Object.entries(allApiMembers).filter(([,v]) => v !== null);
                const totalApiCount = successGuilds.reduce((sum, [,arr]) => sum + arr.length, 0);
                html += `<div class="bg-white rounded-2xl border border-gray-100 p-5 mb-4 shadow-sm">
                    <h4 class="text-sm font-bold text-gray-700 mb-3"><i class="fas fa-chart-pie text-pink-400 mr-2"></i>동기화 요약</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 text-center">
                        <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                            <p class="text-lg font-bold text-blue-600">${totalApiCount}</p>
                            <p class="text-[9px] text-blue-400 font-bold">API 길드원 수</p>
                        </div>
                        <div class="bg-green-50 rounded-xl p-3 border border-green-100">
                            <p class="text-lg font-bold text-green-600">${newMembers.length}</p>
                            <p class="text-[9px] text-green-400 font-bold">신규 멤버</p>
                        </div>
                        <div class="bg-red-50 rounded-xl p-3 border border-red-100">
                            <p class="text-lg font-bold text-red-600">${goneMembers.length}</p>
                            <p class="text-[9px] text-red-400 font-bold">탈퇴 의심</p>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-3 border border-purple-100">
                            <p class="text-lg font-bold text-purple-600">${movedMembers.length}</p>
                            <p class="text-[9px] text-purple-400 font-bold">길드 이동</p>
                        </div>
                        <div class="bg-cyan-50 rounded-xl p-3 border border-cyan-100">
                            <p class="text-lg font-bold text-cyan-600">${nickChangeSuspects.length}</p>
                            <p class="text-[9px] text-cyan-400 font-bold">닉변 의심</p>
                        </div>
                    </div>
                </div>`;

                // 길드별 API 멤버 수
                html += `<div class="bg-white rounded-2xl border border-gray-100 p-5 mb-4 shadow-sm">
                    <h4 class="text-sm font-bold text-gray-700 mb-3"><i class="fas fa-users text-pink-400 mr-2"></i>길드별 현황</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                        ${successGuilds.map(([gn, arr]) => {
                            const dbCount = (dbByGuild[gn] || new Set()).size;
                            return `<div class="bg-gray-50 rounded-xl px-3 py-2 border border-gray-100 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-700">${gn}</span>
                                <span class="text-[10px] font-bold text-gray-400">API ${arr.length}명 / DB ${dbCount}명</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;

                // 닉변 의심 섹션
                if (nickChangeSuspects.length > 0) {
                    html += `<div class="bg-white rounded-2xl border border-cyan-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-cyan-600 mb-1"><i class="fas fa-user-edit mr-2"></i>닉네임 변경 의심 (${nickChangeSuspects.length}명)</h4>
                        <p class="text-[10px] text-gray-400 mb-4">탈퇴 멤버와 신규 멤버의 직업·길드가 일치하여 닉변으로 추정됩니다. 확인 후 닉네임을 변경하면 수로 데이터가 유지됩니다.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                        <th class="p-2 w-8 text-center"><input type="checkbox" checked onchange="document.querySelectorAll('.nc-check').forEach(c=>c.checked=this.checked)"></th>
                                        <th class="p-2 text-left">기존 닉네임</th>
                                        <th class="p-2 text-center">→</th>
                                        <th class="p-2 text-left">새 닉네임</th>
                                        <th class="p-2 text-left">소속</th>
                                        <th class="p-2 text-left">직업</th>
                                        <th class="p-2 text-center">레벨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${nickChangeSuspects.map((s, i) => `<tr class="border-b border-gray-50 hover:bg-cyan-50/30 transition-colors">
                                        <td class="p-1.5 text-center"><input type="checkbox" class="nc-check w-4 h-4" data-idx="${i}" checked></td>
                                        <td class="p-1.5"><span class="text-red-500 line-through font-bold">${s.oldName}</span></td>
                                        <td class="p-1.5 text-center text-gray-300"><i class="fas fa-arrow-right"></i></td>
                                        <td class="p-1.5"><span class="text-cyan-600 font-bold">${s.newName}</span></td>
                                        <td class="p-1.5 text-gray-500">${s.guild}</td>
                                        <td class="p-1.5 text-gray-500">${s.class}</td>
                                        <td class="p-1.5 text-center text-gray-500">${s.level || '-'}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="window._applyNickChanges()" id="ncApplyBtn" class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-cyan-600 transition-all">
                                <i class="fas fa-user-edit mr-2"></i>선택한 닉네임 변경 적용
                            </button>
                        </div>
                    </div>`;
                    window._nickChangeSuspects = nickChangeSuspects;
                }

                // 신규 멤버 추가 섹션 - 상세 정보 입력 테이블
                if (newMembers.length > 0) {
                    const guilds = appState.guilds.map(g => g.name);
                    html += `<div class="bg-white rounded-2xl border border-green-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-green-600 mb-1"><i class="fas fa-user-plus mr-2"></i>신규 멤버 발견 (${newMembers.length}명)</h4>
                        <p class="text-[10px] text-gray-400 mb-2">API에 존재하지만 DB에 등록되지 않은 멤버입니다. 정보를 입력 후 일괄 추가하세요.</p>
                        <div class="mb-3">
                            <button onclick="window._syncFetchAllCharInfo()" id="syncFetchInfoBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-bold text-[10px] shadow-sm hover:bg-indigo-600 transition-all">
                                <i class="fas fa-download mr-1"></i>API에서 직업/레벨 일괄 조회
                            </button>
                            <span id="syncFetchProgress" class="text-[10px] text-gray-400 ml-2"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs" id="syncNewTable">
                                <thead>
                                    <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                        <th class="p-2 w-8 text-center"><input type="checkbox" id="syncNewSelectAll" class="custom-checkbox" checked onchange="document.querySelectorAll('.sync-new-check').forEach(c=>c.checked=this.checked)"></th>
                                        <th class="p-2 text-left" style="min-width:100px">닉네임</th>
                                        <th class="p-2 text-left" style="min-width:90px">소속</th>
                                        <th class="p-2 text-left" style="min-width:90px">직위</th>
                                        <th class="p-2 text-left" style="min-width:100px">직업</th>
                                        <th class="p-2 text-center" style="min-width:60px">레벨</th>
                                        <th class="p-2 text-center" style="min-width:50px">본캐</th>
                                        <th class="p-2 text-left" style="min-width:100px">본캐닉</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${newMembers.map((m, i) => {
                                        const guildRoles = initialGuildRanks[m.guild] || initialGuildRanks[guilds[0]] || [];
                                        return `<tr class="border-b border-gray-50 hover:bg-green-50/30 transition-colors" id="syncNewRow_${i}">
                                            <td class="p-1 text-center"><input type="checkbox" class="sync-new-check custom-checkbox" data-idx="${i}" checked></td>
                                            <td class="p-1"><div class="bg-green-50 border border-green-200 rounded-lg px-2 py-1.5 text-xs font-bold text-green-700">${m.name}</div></td>
                                            <td class="p-1">
                                                <select class="sync-new-guild w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" data-idx="${i}" onchange="window._syncNewGuildChange(this)">
                                                    ${guilds.map(g => `<option value="${g}" ${g === m.guild ? 'selected' : ''}>${g}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="sync-new-role w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" id="syncNewRole_${i}">
                                                    ${guildRoles.map(r => `<option value="${r}">${r}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="sync-new-class w-full bg-gray-50 border border-gray-100 rounded-lg px-1 py-1.5 text-[10px] font-bold outline-none cursor-pointer" id="syncNewClass_${i}">
                                                    <option value="">-</option>
                                                    ${MAPLE_JOBS.map(j => `<option value="${j}">${j}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <input type="number" class="sync-new-level w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none text-center" id="syncNewLevel_${i}" value="0" min="0" max="300">
                                            </td>
                                            <td class="p-1 text-center">
                                                <input type="checkbox" class="sync-new-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" checked onchange="window._syncNewMainToggle(${i}, this.checked)">
                                            </td>
                                            <td class="p-1">
                                                <input type="text" class="sync-new-mainChar w-full bg-gray-50 border border-gray-100 rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none hidden" id="syncNewMainChar_${i}" placeholder="본캐닉">
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="window._syncAddNew()" id="syncAddBtn" class="px-6 py-3 bg-green-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-user-plus mr-2"></i>선택한 멤버 DB에 추가
                            </button>
                        </div>
                    </div>`;
                    window._syncNewMembers = newMembers;
                }

                // 탈퇴 의심 멤버 삭제 섹션 - 상세 정보 표시
                if (goneMembers.length > 0) {
                    html += `<div class="bg-white rounded-2xl border border-red-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-red-600 mb-1"><i class="fas fa-user-minus mr-2"></i>탈퇴 의심 멤버 (${goneMembers.length}명)</h4>
                        <p class="text-[10px] text-gray-400 mb-4">DB에 등록되어 있지만 어떤 길드에서도 찾을 수 없는 멤버입니다. 확인 후 삭제하세요.</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="syncGoneSelectAll" class="custom-checkbox" checked onchange="document.querySelectorAll('.sync-gone-check').forEach(c=>c.checked=this.checked)">
                            <label for="syncGoneSelectAll" class="text-[10px] font-bold text-gray-500 cursor-pointer">전체 선택</label>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-[9px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                        <th class="p-2 w-8 text-center">✓</th>
                                        <th class="p-2 text-left">닉네임</th>
                                        <th class="p-2 text-left">소속</th>
                                        <th class="p-2 text-left">직위</th>
                                        <th class="p-2 text-left">직업</th>
                                        <th class="p-2 text-center">본캐</th>
                                        <th class="p-2 text-left">본캐닉</th>
                                        <th class="p-2 text-left">가입일</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${goneMembers.map((m, i) => {
                                        const dbInfo = dbMembers.find(d => d.id === m.id) || {};
                                        return `<tr class="border-b border-gray-50 hover:bg-red-50/30 transition-colors">
                                            <td class="p-1 text-center"><input type="checkbox" class="sync-gone-check custom-checkbox" data-idx="${i}" checked></td>
                                            <td class="p-1"><span class="text-xs font-bold text-red-600">${m.name}</span></td>
                                            <td class="p-1"><span class="text-[10px] font-bold text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">${m.guild}</span></td>
                                            <td class="p-1"><span class="text-[10px] font-bold text-gray-500">${dbInfo.role || '-'}</span></td>
                                            <td class="p-1"><span class="text-[10px] font-bold text-gray-500">${dbInfo.class || '-'}</span></td>
                                            <td class="p-1 text-center"><span class="text-[10px] text-gray-400">${dbInfo.isMain !== false ? '✅' : '❌'}</span></td>
                                            <td class="p-1"><span class="text-[10px] text-gray-400">${dbInfo.mainCharName || '-'}</span></td>
                                            <td class="p-1"><span class="text-[10px] text-gray-400">${dbInfo.joinDate || '-'}</span></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="window._syncRemoveGone()" id="syncRemoveBtn" class="px-6 py-3 bg-red-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-red-600 transition-all">
                                <i class="fas fa-user-minus mr-2"></i>선택한 멤버 DB에서 삭제
                            </button>
                        </div>
                    </div>`;
                    window._syncGoneMembers = goneMembers;
                }

                // 길드 이동 멤버
                if (movedMembers.length > 0) {
                    html += `<div class="bg-white rounded-2xl border border-purple-200 p-5 mb-4 shadow-sm">
                        <h4 class="text-sm font-bold text-purple-600 mb-1"><i class="fas fa-exchange-alt mr-2"></i>길드 이동 감지 (${movedMembers.length}명)</h4>
                        <p class="text-[10px] text-gray-400 mb-4">DB의 소속 길드와 API의 실제 길드가 다른 멤버입니다.</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="syncMovedSelectAll" class="custom-checkbox" onchange="document.querySelectorAll('.sync-moved-check').forEach(c=>c.checked=this.checked)">
                            <label for="syncMovedSelectAll" class="text-[10px] font-bold text-gray-500 cursor-pointer">전체 선택</label>
                        </div>
                        <div class="max-h-64 overflow-y-auto space-y-1 mb-4 no-scrollbar">
                            ${movedMembers.map((m, i) => `<label class="flex items-center gap-3 bg-purple-50/50 hover:bg-purple-50 rounded-xl px-3 py-2 border border-purple-100/50 cursor-pointer transition-all">
                                <input type="checkbox" class="sync-moved-check custom-checkbox" data-idx="${i}" checked>
                                <span class="text-xs font-bold text-gray-700 flex-1">${m.name}</span>
                                <span class="text-[9px] font-bold text-gray-400">${m.fromGuild}</span>
                                <i class="fas fa-arrow-right text-[8px] text-purple-400"></i>
                                <span class="text-[9px] font-bold text-purple-600">${m.toGuild}</span>
                            </label>`).join('')}
                        </div>
                        <button onclick="window._syncUpdateMoved()" id="syncMoveBtn" class="w-full py-3 bg-purple-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-purple-600 transition-all">
                            <i class="fas fa-exchange-alt mr-2"></i>선택한 멤버 소속 변경
                        </button>
                    </div>`;
                    window._syncMovedMembers = movedMembers;
                }

                // 모두 일치
                if (newMembers.length === 0 && goneMembers.length === 0 && movedMembers.length === 0 && errors.length === 0) {
                    html += `<div class="bg-green-50 border border-green-200 rounded-2xl p-8 text-center">
                        <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-check text-green-500 text-xl"></i></div>
                        <p class="text-sm font-bold text-green-600">모든 길드원이 DB와 일치합니다!</p>
                        <p class="text-[10px] text-green-400 mt-1">변경 사항이 없습니다.</p>
                    </div>`;
                }

                resultDiv.innerHTML = html;

                // 신규 멤버가 있으면 자동으로 직업/레벨 일괄 조회
                if (window._syncNewMembers && window._syncNewMembers.length > 0) {
                    setTimeout(() => window._syncFetchAllCharInfo(), 300);
                }

            } catch (e) {
                resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                    <div class="w-14 h-14 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-times text-red-500 text-xl"></i></div>
                    <p class="text-sm font-bold text-red-600 mb-2">동기화 실패</p>
                    <p class="text-xs text-red-400">${e.message}</p>
                </div>`;
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync mr-2"></i>동기화 실행'; }
            }
        };

        // 신규 멤버 테이블 헬퍼
        window._syncNewGuildChange = (sel) => {
            const idx = sel.dataset.idx;
            const roles = initialGuildRanks[sel.value] || [];
            const roleEl = document.getElementById(`syncNewRole_${idx}`);
            if (roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };
        window._syncNewMainToggle = (idx, isMain) => {
            const el = document.getElementById(`syncNewMainChar_${idx}`);
            if (el) { isMain ? el.classList.add('hidden') : el.classList.remove('hidden'); }
        };

        // 닉변 적용
        window._applyNickChanges = async () => {
            const checks = document.querySelectorAll('.nc-check:checked');
            if (checks.length === 0) { window.showMsg('적용할 항목을 선택해주세요.', 'error'); return; }
            const selected = [];
            checks.forEach(c => selected.push(window._nickChangeSuspects[parseInt(c.dataset.idx)]));
            const lines = selected.map(s => `• ${s.oldName} → ${s.newName} (${s.guild}/${s.class})`);
            if (!confirm(`닉네임 변경을 적용하시겠습니까?\n기존 수로 데이터가 모두 유지됩니다.\n\n${lines.join('\n')}`)) return;
            const btn = document.getElementById('ncApplyBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>적용 중...';
            try {
                let ok = 0;
                for (const s of selected) {
                    const updateObj = { name: s.newName };
                    if (s.level) updateObj.level = s.level;
                    const { error } = await supaDb.from('members').update(updateObj).eq('id', s.id);
                    if (!error) {
                        ok++;
                        await supaDb.from('operation_history').insert({
                            date: new Date().toISOString().split('T')[0], category: '닉변',
                            name: s.newName, content: `닉네임 변경: ${s.oldName} → ${s.newName} (${s.guild}/${s.class}) — 동기화 감지`
                        });
                    }
                }
                window.showMsg(`${ok}명의 닉네임이 변경되었습니다!`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch(e) {
                window.showMsg('닉변 적용 실패: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-edit mr-2"></i>선택한 닉네임 변경 적용';
            }
        };

        // 신규 멤버 API에서 직업/레벨 일괄 조회
        window._syncFetchAllCharInfo = async () => {
            const btn = document.getElementById('syncFetchInfoBtn');
            const prog = document.getElementById('syncFetchProgress');
            if (!window._syncNewMembers || window._syncNewMembers.length === 0) return;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>조회 중...';
            const total = window._syncNewMembers.length;
            let done = 0, fail = 0;
            for (let i = 0; i < total; i++) {
                const m = window._syncNewMembers[i];
                prog.textContent = `${i+1}/${total} 조회 중...`;
                try {
                    const info = await window._getCharInfo(m.name);
                    if (info) {
                        const clsSel = document.getElementById(`syncNewClass_${i}`);
                        const lvlInput = document.getElementById(`syncNewLevel_${i}`);
                        if (clsSel && info.class) {
                            let found = false;
                            for (const opt of clsSel.options) { if (opt.value === info.class) { opt.selected = true; found = true; break; } }
                            if (!found) { const newOpt = document.createElement('option'); newOpt.value = info.class; newOpt.textContent = info.class; newOpt.selected = true; clsSel.appendChild(newOpt); }
                        }
                        if (lvlInput && info.level) lvlInput.value = info.level;
                        const row = document.getElementById(`syncNewRow_${i}`);
                        if (row) row.classList.add('bg-green-50/50');
                    } else { fail++; }
                } catch(e) { fail++; }
                // Rate limit 방지: 100ms 딜레이
                if (i < total - 1) await new Promise(r => setTimeout(r, 100));
            }
            done = total - fail;
            prog.textContent = `완료! ${done}명 성공, ${fail}명 실패`;
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-download mr-1"></i>API에서 직업/레벨 일괄 조회';
        };

        // 신규 멤버 추가 (상세 정보 포함)
        window._syncAddNew = async () => {
            const rows = document.querySelectorAll('#syncNewTable tbody tr');
            const toAdd = [];
            rows.forEach(row => {
                const check = row.querySelector('.sync-new-check');
                if (!check || !check.checked) return;
                const idx = parseInt(check.dataset.idx);
                const m = window._syncNewMembers[idx];
                const guild = row.querySelector('.sync-new-guild')?.value || m.guild;
                const role = row.querySelector('.sync-new-role')?.value || '길드원';
                const cls = row.querySelector('.sync-new-class')?.value || '';
                const lvl = parseInt(row.querySelector('.sync-new-level')?.value) || 0;
                const isMain = row.querySelector('.sync-new-isMain')?.checked !== false;
                const mainChar = row.querySelector('.sync-new-mainChar')?.value || '';
                toAdd.push({ name: m.name, guild, role, class: cls, level: lvl, is_main: isMain, main_char_name: mainChar, join_date: new Date().toISOString().split('T')[0] });
            });

            if (toAdd.length === 0) { window.showMsg('추가할 멤버를 선택해주세요.', 'error'); return; }
            const btn = document.getElementById('syncAddBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>추가 중...';
            
            try {
                const { error } = await supaDb.from('members').insert(toAdd);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    toAdd.map(m => ({ date: new Date().toISOString().split('T')[0], category: '동기화-추가', name: m.name, content: `${m.guild} 길드에 추가됨 (${m.role}/${m.class || '미설정'}) — API 동기화` }))
                );

                window.showMsg(`${toAdd.length}명이 DB에 추가되었습니다!`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch (e) {
                window.showMsg('추가 실패: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>선택한 멤버 DB에 추가';
            }
        };

        // 탈퇴 멤버 삭제 (상세 정보 확인)
        window._syncRemoveGone = async () => {
            const checks = document.querySelectorAll('.sync-gone-check:checked');
            if (checks.length === 0) { window.showMsg('삭제할 멤버를 선택해주세요.', 'error'); return; }
            
            const selected = [];
            checks.forEach(c => selected.push(window._syncGoneMembers[parseInt(c.dataset.idx)]));
            const detailLines = selected.map(m => {
                const dbInfo = appState.members.find(d => d.id === m.id) || {};
                return `• ${m.name} (${m.guild} / ${dbInfo.role || '-'} / ${dbInfo.class || '-'})`;
            });
            
            if (!confirm(`정말 ${selected.length}명을 DB에서 삭제하시겠습니까?\n\n${detailLines.join('\n')}`)) return;

            const btn = document.getElementById('syncRemoveBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>삭제 중...';
            
            try {
                const ids = selected.map(m => m.id);
                const { error } = await supaDb.from('members').delete().in('id', ids);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    selected.map(m => {
                        const dbInfo = appState.members.find(d => d.id === m.id) || {};
                        return { date: new Date().toISOString().split('T')[0], category: '동기화-삭제', name: m.name, content: `${m.guild}/${dbInfo.role || '-'}/${dbInfo.class || '-'} — API에서 미발견 (삭제)` };
                    })
                );

                window.showMsg(`${selected.length}명이 DB에서 삭제되었습니다.`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch (e) {
                window.showMsg('삭제 실패: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-minus mr-2"></i>선택한 멤버 DB에서 삭제';
            }
        };

        // 길드 이동 멤버 소속 변경
        window._syncUpdateMoved = async () => {
            const checks = document.querySelectorAll('.sync-moved-check:checked');
            if (checks.length === 0) { window.showMsg('변경할 멤버를 선택해주세요.', 'error'); return; }
            
            const btn = document.getElementById('syncMoveBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>변경 중...';
            
            try {
                for (const c of checks) {
                    const m = window._syncMovedMembers[parseInt(c.dataset.idx)];
                    const { error } = await supaDb.from('members').update({ guild: m.toGuild }).eq('id', m.id);
                    if (error) throw error;
                }

                const count = checks.length;
                await supaDb.from('operation_history').insert(
                    [...checks].map(c => {
                        const m = window._syncMovedMembers[parseInt(c.dataset.idx)];
                        return { date: new Date().toISOString().split('T')[0], category: '동기화-이동', name: m.name, content: `${m.fromGuild} → ${m.toGuild} 소속 변경 (API 동기화)` };
                    })
                );

                window.showMsg(`${count}명의 소속이 변경되었습니다.`, 'success');
                await window.fetchMembers();
                window._runSync();
            } catch (e) {
                window.showMsg('변경 실패: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-exchange-alt mr-2"></i>선택한 멤버 소속 변경';
            }
        };

        // 동기화 탭 렌더링
        window.renderSync = (container) => {
            const savedKey = window._getNexonApiKey();
            const savedWorld = window._getSyncWorld();
            const maskedKey = savedKey ? savedKey.slice(0, 8) + '••••••••' + savedKey.slice(-4) : '';

            container.innerHTML = `
            <div class="max-w-4xl fade-in space-y-6">
                <!-- API 키 설정 -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-gray-100 shadow-sm font-bold">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-tr from-blue-400 to-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-key"></i></div>
                        <div>
                            <h3 class="text-lg text-gray-800">Nexon Open API 설정</h3>
                            <p class="text-[10px] text-gray-400">길드원 동기화를 위해 Nexon Open API Key가 필요합니다</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">API Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="syncApiKeyInput" class="flex-1 border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-mono outline-none focus:ring-4 focus:ring-blue-50 shadow-inner" 
                                    placeholder="${maskedKey || 'Nexon Open API Key를 입력하세요'}" value="${savedKey}">
                                <button onclick="window._setNexonApiKey(document.getElementById('syncApiKeyInput').value); window.showMsg('API Key가 저장되었습니다!','success')" 
                                    class="px-5 bg-gray-900 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest hover:bg-black transition-all shadow-lg shrink-0">저장</button>
                            </div>
                            <p class="text-[9px] text-gray-300 ml-1 mt-1"><i class="fas fa-lock mr-1"></i>Key는 브라우저에만 저장되며 서버로 전송되지 않습니다 · <a href="https://openapi.nexon.com/ko/my-application/" target="_blank" class="text-blue-400 hover:underline">API Key 발급받기 →</a></p>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">서버 (월드)</label>
                            <select id="syncWorldSelect" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner cursor-pointer"
                                onchange="window._setSyncWorld(this.value)">
                                ${MAPLE_WORLDS.map(w => `<option value="${w}" ${w === savedWorld ? 'selected' : ''}>${w}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 동기화 실행 -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-pink-100 shadow-sm font-bold">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-tr from-pink-400 to-rose-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-sync"></i></div>
                            <div>
                                <h3 class="text-lg text-gray-800">길드원 동기화</h3>
                                <p class="text-[10px] text-gray-400">Nexon API의 실제 길드원 목록과 DB를 비교합니다</p>
                            </div>
                        </div>
                        <button onclick="window._runSync()" id="syncRunBtn" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transition-all">
                            <i class="fas fa-sync mr-2"></i>동기화 실행
                        </button>
                    </div>

                    <div class="bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-100">
                        <p class="text-[10px] text-gray-500 leading-relaxed">
                            <i class="fas fa-info-circle text-pink-400 mr-1"></i>
                            등록된 모든 길드(${appState.guilds.map(g => g.name).join(', ')})를 <strong>${savedWorld || '루나'}</strong> 서버에서 조회합니다.<br>
                            <i class="fas fa-arrow-right text-gray-300 mr-1 ml-3"></i> <span class="text-green-500">신규 멤버</span>: API에 있지만 DB에 없는 멤버 → 추가 가능<br>
                            <i class="fas fa-arrow-right text-gray-300 mr-1 ml-3"></i> <span class="text-red-500">탈퇴 의심</span>: DB에 있지만 API에 없는 멤버 → 삭제 가능<br>
                            <i class="fas fa-arrow-right text-gray-300 mr-1 ml-3"></i> <span class="text-purple-500">길드 이동</span>: DB와 API의 소속 길드가 다른 멤버 → 소속 변경 가능
                        </p>
                    </div>

                    <div id="syncResult">
                        <div class="text-center py-12 text-gray-300">
                            <i class="fas fa-cloud-download-alt text-4xl mb-3"></i>
                            <p class="text-xs font-bold">위 버튼을 눌러 동기화를 시작하세요</p>
                        </div>
                    </div>
                </div>

                <!-- 닉네임 중복 검사 -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-amber-100 shadow-sm font-bold">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-tr from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-clone"></i></div>
                            <div>
                                <h3 class="text-lg text-gray-800">닉네임 중복 검사</h3>
                                <p class="text-[10px] text-gray-400">DB에 동일한 닉네임으로 등록된 중복 데이터를 찾아 정리합니다</p>
                            </div>
                        </div>
                        <button onclick="window._runDupCheck()" id="dupCheckBtn" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transition-all">
                            <i class="fas fa-search mr-2"></i>중복 검사
                        </button>
                    </div>
                    <div id="dupResult">
                        <div class="text-center py-12 text-gray-300">
                            <i class="fas fa-copy text-4xl mb-3"></i>
                            <p class="text-xs font-bold">위 버튼을 눌러 중복 검사를 시작하세요</p>
                        </div>
                    </div>
                </div>

                <!-- DB 멤버 검색/편집 -->
                <div class="bg-white p-6 lg:p-8 rounded-[2rem] border border-blue-100 shadow-sm font-bold">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-tr from-blue-400 to-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-pen-square"></i></div>
                        <div>
                            <h3 class="text-lg text-gray-800">DB 멤버 편집</h3>
                            <p class="text-[10px] text-gray-400">닉네임 검색으로 멤버를 찾아 정보를 직접 수정하세요</p>
                        </div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="dbEditSearch" class="flex-1 border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none focus:ring-4 focus:ring-blue-50 shadow-inner" placeholder="닉네임 검색 (2글자 이상 입력)" oninput="window._dbEditSearch(this.value)">
                        <button onclick="window._dbEditLoadAll()" class="px-4 bg-gray-100 text-gray-600 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-all shrink-0">전체 보기</button>
                    </div>
                    <div id="dbEditResult">
                        <div class="text-center py-8 text-gray-300">
                            <i class="fas fa-search text-3xl mb-3"></i>
                            <p class="text-xs font-bold">닉네임을 검색하거나 전체 보기를 눌러주세요</p>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        // ═══════════════════════════════════════════════════════════════
        // ██  DB 멤버 검색/편집  ██
        // ═══════════════════════════════════════════════════════════════

        window._dbEditSearchTimer = null;
        window._dbEditSearch = (query) => {
            clearTimeout(window._dbEditSearchTimer);
            if (query.length < 2) {
                document.getElementById('dbEditResult').innerHTML = '<div class="text-center py-8 text-gray-300"><i class="fas fa-search text-3xl mb-3"></i><p class="text-xs font-bold">2글자 이상 입력하세요</p></div>';
                return;
            }
            window._dbEditSearchTimer = setTimeout(() => {
                const q = query.toLowerCase();
                const matches = appState.members.filter(m => m.name.toLowerCase().includes(q));
                window._renderDbEditTable(matches, `"${query}" 검색 결과: ${matches.length}명`);
            }, 300);
        };

        window._dbEditLoadAll = () => {
            window._renderDbEditTable([...appState.members].sort((a,b) => a.name.localeCompare(b.name)), `전체 멤버: ${appState.members.length}명`);
        };

        window._renderDbEditTable = (members, title) => {
            const resultDiv = document.getElementById('dbEditResult');
            if (members.length === 0) {
                resultDiv.innerHTML = '<div class="text-center py-8 text-gray-300"><i class="fas fa-user-slash text-2xl mb-2"></i><p class="text-xs font-bold">검색 결과가 없습니다</p></div>';
                return;
            }
            const guilds = appState.guilds.map(g => g.name);
            const pageSize = 50;
            const totalPages = Math.ceil(members.length / pageSize);
            window._dbEditMembers = members;

            window._dbEditRenderPage = (page) => {
                const start = (page - 1) * pageSize;
                const slice = members.slice(start, start + pageSize);

                let html = `<div class="flex items-center justify-between mb-3">
                    <p class="text-[10px] font-bold text-gray-400">${title}</p>
                    ${totalPages > 1 ? `<div class="flex items-center gap-1">
                        <button onclick="window._dbEditRenderPage(${Math.max(1, page-1)})" class="w-7 h-7 rounded-lg bg-gray-100 text-gray-500 text-[10px] hover:bg-gray-200 ${page<=1?'opacity-30':''}"><i class="fas fa-chevron-left"></i></button>
                        <span class="text-[10px] text-gray-400 px-2">${page}/${totalPages}</span>
                        <button onclick="window._dbEditRenderPage(${Math.min(totalPages, page+1)})" class="w-7 h-7 rounded-lg bg-gray-100 text-gray-500 text-[10px] hover:bg-gray-200 ${page>=totalPages?'opacity-30':''}"><i class="fas fa-chevron-right"></i></button>
                    </div>` : ''}
                </div>
                <div class="overflow-x-auto max-h-[60vh] overflow-y-auto no-scrollbar">
                    <table class="w-full text-xs" id="dbEditTable">
                        <thead class="sticky top-0 bg-white z-10">
                            <tr class="text-[8px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                <th class="p-1.5 text-left">ID</th>
                                <th class="p-1.5 text-left" style="min-width:100px">닉네임</th>
                                <th class="p-1.5 text-left">소속</th>
                                <th class="p-1.5 text-left">직위</th>
                                <th class="p-1.5 text-left">직업</th>
                                <th class="p-1.5 text-center">본캐</th>
                                <th class="p-1.5 text-left">본캐닉</th>
                                <th class="p-1.5 w-16 text-center">액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${slice.map((m, si) => {
                                const ri = start + si;
                                const guildRoles = initialGuildRanks[m.guild] || initialGuildRanks[guilds[0]] || [];
                                return `<tr class="border-b border-gray-50 hover:bg-blue-50/30 transition-colors" data-id="${m.id}" id="dbEditRow_${ri}">
                                    <td class="p-1"><span class="text-[9px] text-gray-300 font-mono">#${m.id}</span></td>
                                    <td class="p-1"><input type="text" class="dbe-name w-full bg-blue-50 border border-blue-200 rounded-lg px-2 py-1 text-[10px] font-bold outline-none focus:ring-2 focus:ring-blue-200" value="${m.name}"></td>
                                    <td class="p-1">
                                        <select class="dbe-guild bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer" onchange="window._dbeGuildChange(this, ${ri})">
                                            ${guilds.map(g => `<option value="${g}" ${g === m.guild ? 'selected' : ''}>${g}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="p-1">
                                        <select class="dbe-role bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer" id="dbeRole_${ri}">
                                            ${guildRoles.map(r => `<option value="${r}" ${r === m.role ? 'selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="p-1">
                                        <select class="dbe-class bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer">
                                            <option value="">-</option>
                                            ${MAPLE_JOBS.map(j => `<option value="${j}" ${j === (m.class||'') ? 'selected' : ''}>${j}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="p-1 text-center"><input type="checkbox" class="dbe-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" ${m.isMain !== false ? 'checked' : ''}></td>
                                    <td class="p-1"><input type="text" class="dbe-mainChar bg-gray-50 border border-gray-100 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-full" value="${m.mainCharName || ''}" placeholder="-"></td>
                                    <td class="p-1 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button onclick="window._dbeSaveRow(${ri})" class="w-6 h-6 rounded-md bg-blue-100 text-blue-500 hover:bg-blue-200 text-[9px] transition-all" title="저장"><i class="fas fa-save"></i></button>
                                            <button onclick="window._dbeDeleteRow(${ri})" class="w-6 h-6 rounded-md bg-red-100 text-red-500 hover:bg-red-200 text-[9px] transition-all" title="삭제"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
                resultDiv.innerHTML = html;
            };
            window._dbEditRenderPage(1);
        };

        window._dbeGuildChange = (sel, idx) => {
            const roles = initialGuildRanks[sel.value] || [];
            const roleEl = document.getElementById(`dbeRole_${idx}`);
            if (roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };

        window._dbeSaveRow = async (idx) => {
            const m = window._dbEditMembers[idx];
            if (!m) return;
            const row = document.getElementById(`dbEditRow_${idx}`);
            if (!row) return;

            const newName = row.querySelector('.dbe-name')?.value?.trim();
            const newGuild = row.querySelector('.dbe-guild')?.value;
            const newRole = row.querySelector('.dbe-role')?.value;
            const newClass = row.querySelector('.dbe-class')?.value || '';
            const newIsMain = row.querySelector('.dbe-isMain')?.checked !== false;
            const newMainChar = row.querySelector('.dbe-mainChar')?.value || '';

            if (!newName) { window.showMsg('닉네임을 입력해주세요.', 'error'); return; }

            const changes = {};
            if (newName !== m.name) changes.name = newName;
            if (newGuild !== m.guild) changes.guild = newGuild;
            if (newRole !== m.role) changes.role = newRole;
            if (newClass !== (m.class || '')) changes.class = newClass;
            if (newIsMain !== (m.isMain !== false)) changes.is_main = newIsMain;
            if (newMainChar !== (m.mainCharName || '')) changes.main_char_name = newMainChar;

            if (Object.keys(changes).length === 0) { window.showMsg('변경사항이 없습니다.', 'info'); return; }

            try {
                const { error } = await supaDb.from('members').update(changes).eq('id', m.id);
                if (error) throw error;

                const changeDesc = Object.entries(changes).map(([k,v]) => `${k}: ${v}`).join(', ');
                await supaDb.from('operation_history').insert({
                    date: new Date().toISOString().split('T')[0], category: '수정',
                    name: newName, content: `DB 편집 (#${m.id}) ${changeDesc}`
                });

                row.classList.add('bg-green-50');
                setTimeout(() => row.classList.remove('bg-green-50'), 1500);
                window.showMsg(`"${newName}" 수정 완료!`, 'success');
                await window.fetchMembers();
            } catch (e) {
                window.showMsg('수정 실패: ' + e.message, 'error');
            }
        };

        window._dbeDeleteRow = async (idx) => {
            const m = window._dbEditMembers[idx];
            if (!m) return;
            if (!confirm(`"${m.name}" (#${m.id}, ${m.guild}/${m.role || '-'}/${m.class || '-'})\n\n이 멤버를 DB에서 삭제하시겠습니까?`)) return;

            try {
                const { error } = await supaDb.from('members').delete().eq('id', m.id);
                if (error) throw error;

                await supaDb.from('operation_history').insert({
                    date: new Date().toISOString().split('T')[0], category: '삭제',
                    name: m.name, content: `DB 편집에서 삭제 (#${m.id}, ${m.guild}/${m.role || '-'})`
                });

                const row = document.getElementById(`dbEditRow_${idx}`);
                if (row) { row.classList.add('bg-red-50', 'opacity-50', 'line-through'); row.style.pointerEvents = 'none'; }
                window.showMsg(`"${m.name}" 삭제 완료`, 'success');
                await window.fetchMembers();
            } catch (e) {
                window.showMsg('삭제 실패: ' + e.message, 'error');
            }
        };

        window._runDupCheck = async () => {
            const resultDiv = document.getElementById('dupResult');
            const btn = document.getElementById('dupCheckBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>검사 중...'; }
            resultDiv.innerHTML = '<div class="text-center py-8 text-gray-400 font-bold"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-xs">중복 닉네임 검사 중...</p></div>';

            try {
                // 1000건 제한 우회: 페이지네이션으로 전체 조회
                let allMembers = [], page = 0, pageSize = 1000;
                while (true) {
                    const { data: batch, error: bErr } = await supaDb.from('members').select('*').order('id').range(page * pageSize, (page + 1) * pageSize - 1);
                    if (bErr) throw bErr;
                    allMembers = allMembers.concat(batch);
                    if (batch.length < pageSize) break;
                    page++;
                }

                const nameMap = {};
                allMembers.forEach(m => {
                    if (!nameMap[m.name]) nameMap[m.name] = [];
                    nameMap[m.name].push(m);
                });

                const duplicates = Object.entries(nameMap).filter(([, arr]) => arr.length > 1);

                if (duplicates.length === 0) {
                    resultDiv.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-2xl p-8 text-center">
                        <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-check text-green-500 text-xl"></i></div>
                        <p class="text-sm font-bold text-green-600">중복 닉네임이 없습니다!</p>
                        <p class="text-[10px] text-green-400 mt-1">총 ${allMembers.length}명 (${page+1}페이지 조회) 모두 고유한 닉네임입니다.</p>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center gap-2 flex-wrap mb-3">
                            <select id="mismatchGuild" class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-xs font-bold outline-none">
                                ${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                            <button onclick="window._runMismatchCheck()" id="mismatchCheckBtn" class="px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-search-plus mr-1"></i>직업/레벨 조회
                            </button>
                            <span id="mismatchProg" class="text-[10px] text-gray-400"></span>
                        </div>
                        <div id="mismatchResult"></div>
                    </div>`;
                } else {
                    const guilds = appState.guilds.map(g => g.name);
                    let html = `<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-4">
                        <p class="text-xs font-bold text-amber-600"><i class="fas fa-exclamation-triangle mr-1"></i>${duplicates.length}개의 중복 닉네임 발견 (총 ${duplicates.reduce((s,[,a]) => s+a.length, 0)}건)</p>
                        <p class="text-[10px] text-amber-500 mt-1">닉네임이 틀린 경우 <strong class="text-blue-500">직접 수정</strong> 가능합니다. 유지할 데이터를 라디오 버튼으로 선택 후 나머지를 삭제하세요.</p>
                    </div>`;

                    window._dupGroups = duplicates;

                    duplicates.forEach(([name, members], gi) => {
                        html += `<div class="bg-white border border-amber-200 rounded-2xl p-4 mb-3 shadow-sm" id="dupGroup_${gi}">
                            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full">${name}</span>
                                    <span class="text-[9px] text-gray-400">${members.length}건 중복</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="window._dupSaveEdits(${gi})" class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-[10px] font-bold hover:bg-blue-600 transition-all shadow-sm">
                                        <i class="fas fa-save mr-1"></i>수정 저장
                                    </button>
                                    <button onclick="window._dupDeleteUnchecked(${gi})" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-[10px] font-bold hover:bg-red-600 transition-all shadow-sm">
                                        <i class="fas fa-trash mr-1"></i>미체크 삭제
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs">
                                    <thead>
                                        <tr class="text-[8px] font-bold text-gray-400 uppercase border-b border-gray-200">
                                            <th class="p-1.5 w-8 text-center">유지</th>
                                            <th class="p-1.5 text-left">ID</th>
                                            <th class="p-1.5 text-left" style="min-width:100px">닉네임</th>
                                            <th class="p-1.5 text-left">소속</th>
                                            <th class="p-1.5 text-left">직위</th>
                                            <th class="p-1.5 text-left">직업</th>
                                            <th class="p-1.5 text-center">본캐</th>
                                            <th class="p-1.5 text-left">본캐닉</th>
                                            <th class="p-1.5 text-left">가입일</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${members.map((m, mi) => {
                                            const guildRoles = initialGuildRanks[m.guild] || initialGuildRanks[guilds[0]] || [];
                                            return `<tr class="border-b border-gray-50 hover:bg-amber-50/30 transition-colors" data-id="${m.id}">
                                            <td class="p-1 text-center">
                                                <input type="radio" name="dupKeep_${gi}" class="dup-keep-radio w-4 h-4 text-green-500 cursor-pointer" data-gi="${gi}" data-mi="${mi}" ${mi === 0 ? 'checked' : ''}>
                                            </td>
                                            <td class="p-1"><span class="text-[9px] text-gray-300 font-mono">#${m.id}</span></td>
                                            <td class="p-1"><input type="text" class="dup-edit-name w-full bg-amber-50 border border-amber-200 rounded-lg px-2 py-1 text-[10px] font-bold outline-none focus:ring-2 focus:ring-amber-200 focus:border-amber-300" value="${m.name}" data-original="${m.name}"></td>
                                            <td class="p-1">
                                                <select class="dup-edit-guild bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer" onchange="window._dupGuildChange(this)">
                                                    ${guilds.map(g => `<option value="${g}" ${g === m.guild ? 'selected' : ''}>${g}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="dup-edit-role bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer">
                                                    ${guildRoles.map(r => `<option value="${r}" ${r === m.role ? 'selected' : ''}>${r}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1">
                                                <select class="dup-edit-class bg-gray-50 border border-gray-100 rounded-lg px-1 py-1 text-[10px] font-bold outline-none cursor-pointer">
                                                    <option value="">-</option>
                                                    ${MAPLE_JOBS.map(j => `<option value="${j}" ${j === m.class ? 'selected' : ''}>${j}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="p-1 text-center"><input type="checkbox" class="dup-edit-isMain w-4 h-4 text-pink-500 rounded cursor-pointer" ${m.is_main !== false ? 'checked' : ''}></td>
                                            <td class="p-1"><input type="text" class="dup-edit-mainChar bg-gray-50 border border-gray-100 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-full" value="${m.main_char_name || ''}" placeholder="-"></td>
                                            <td class="p-1"><span class="text-[10px] text-gray-400">${m.join_date || '-'}</span></td>
                                        </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    });

                    html += `<div class="flex justify-end gap-2 mt-4">
                        <button onclick="window._dupSaveAllEdits()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-blue-600 transition-all">
                            <i class="fas fa-save mr-2"></i>전체 수정 저장
                        </button>
                        <button onclick="window._dupDeleteAllUnchecked()" class="px-6 py-3 bg-red-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-red-600 transition-all">
                            <i class="fas fa-trash mr-2"></i>전체 중복 일괄 정리
                        </button>
                    </div>`;

                    resultDiv.innerHTML = html;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                    <p class="text-sm font-bold text-red-600">검사 실패</p>
                    <p class="text-xs text-red-400 mt-1">${e.message}</p>
                </div>`;
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-search mr-2"></i>중복 검사'; }
            }
        };

        // ██ 레벨/직업 불일치 검사 (API 조회) ██
        window._runMismatchCheck = async () => {
            const resultDiv = document.getElementById('mismatchResult');
            const btn = document.getElementById('mismatchCheckBtn');
            const prog = document.getElementById('mismatchProg');
            const guildName = document.getElementById('mismatchGuild')?.value;
            if (!resultDiv || !guildName) return;
            const apiKey = window._getNexonApiKey();
            if (!apiKey) { window.showMsg('Nexon API Key를 먼저 설정해주세요 (길드원 동기화 탭).', 'error'); return; }
            
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>조회 중...';
            resultDiv.innerHTML = '';
            
            const members = appState.members.filter(m => m.guild === guildName);
            const results = []; // {member, apiClass, apiLevel, classDiff, levelDiff}
            
            for (let i = 0; i < members.length; i++) {
                const m = members[i];
                if (prog) prog.textContent = `${i+1}/${members.length} (${m.name})`;
                try {
                    const info = await window._getCharInfo(m.name);
                    if (info) {
                        results.push({
                            member: m, 
                            apiClass: info.class || '', apiLevel: info.level || 0,
                            classDiff: info.class && m.class !== info.class,
                            levelDiff: info.level && (m.level || 0) !== info.level
                        });
                    } else {
                        results.push({ member: m, apiClass: '', apiLevel: 0, classDiff: false, levelDiff: false });
                    }
                } catch(e) {
                    results.push({ member: m, apiClass: '', apiLevel: 0, classDiff: false, levelDiff: false });
                }
                if (i < members.length - 1) await new Promise(r => setTimeout(r, 80));
            }
            if (prog) prog.textContent = `완료! ${members.length}명 조회`;
            
            window._mmResults = results;
            const diffCount = results.filter(r => r.classDiff || r.levelDiff).length;
            
            let html = `<div class="bg-indigo-50 border border-indigo-200 rounded-xl p-3 mb-3">
                <p class="text-[10px] font-bold text-indigo-600"><i class="fas fa-info-circle mr-1"></i>${guildName} ${members.length}명 조회 완료 · 불일치 ${diffCount}명 · 변경할 항목을 직접 수정 후 일괄 저장하세요</p>
            </div>`;
            html += `<div class="overflow-x-auto max-h-[400px] overflow-y-auto"><table class="w-full text-xs"><thead class="sticky top-0 bg-white z-10">
                <tr class="text-[8px] font-bold text-gray-400 uppercase border-b border-gray-200">
                    <th class="p-1.5 w-8 text-center"><input type="checkbox" onchange="document.querySelectorAll('.mm-save').forEach(c=>c.checked=this.checked)" checked></th>
                    <th class="p-1.5 text-left">닉네임</th>
                    <th class="p-1.5 text-left">DB 직업</th>
                    <th class="p-1.5 text-left">API 직업</th>
                    <th class="p-1.5 text-center">DB Lv</th>
                    <th class="p-1.5 text-center">API Lv</th>
                </tr></thead><tbody>`;
            
            results.forEach((r, i) => {
                const cDiff = r.classDiff;
                const lDiff = r.levelDiff;
                const rowCls = (cDiff || lDiff) ? 'bg-amber-50/50' : '';
                html += `<tr class="border-b border-gray-50 ${rowCls}" data-idx="${i}">
                    <td class="p-1 text-center">${(cDiff||lDiff) ? '<input type="checkbox" class="mm-save w-4 h-4" data-idx="'+i+'" checked>' : '<span class="text-gray-300 text-[9px]">✓</span>'}</td>
                    <td class="p-1.5 font-bold">${r.member.name}${r.member.level>0?'<span class="text-[8px] text-gray-400 ml-1">Lv.'+r.member.level+'</span>':''}</td>
                    <td class="p-1.5 ${cDiff?'text-red-500':'text-gray-400'}">${r.member.class||'(미설정)'}</td>
                    <td class="p-1.5"><select class="mm-class bg-gray-50 border ${cDiff?'border-amber-300 bg-amber-50':'border-gray-100'} rounded px-1 py-0.5 text-[10px] font-bold outline-none" data-idx="${i}">
                        <option value="">-</option>
                        ${MAPLE_JOBS.map(j => `<option value="${j}" ${j===(r.apiClass||r.member.class)?'selected':''}>${j}</option>`).join('')}
                        ${r.apiClass && !MAPLE_JOBS.includes(r.apiClass) ? `<option value="${r.apiClass}" selected>${r.apiClass}</option>` : ''}
                    </select></td>
                    <td class="p-1.5 text-center ${lDiff?'text-red-500':'text-gray-400'}">${r.member.level||0}</td>
                    <td class="p-1.5 text-center"><input type="number" class="mm-level bg-gray-50 border ${lDiff?'border-amber-300 bg-amber-50':'border-gray-100'} rounded px-1 py-0.5 text-[10px] font-bold outline-none w-16 text-center" data-idx="${i}" value="${r.apiLevel||r.member.level||0}" min="0" max="300"></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            html += `<div class="mt-3 flex justify-between items-center">
                <p class="text-[9px] text-gray-400">체크된 불일치 항목 + 수동 수정 모두 저장됩니다</p>
                <button onclick="window._applyMismatchFixes()" id="mmApplyBtn" class="px-5 py-2.5 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-indigo-600 transition-all">
                    <i class="fas fa-save mr-1"></i>변경사항 일괄 저장
                </button>
            </div>`;
            resultDiv.innerHTML = html;
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-search-plus mr-1"></i>직업/레벨 조회';
        };

        // 불일치 일괄 저장
        window._applyMismatchFixes = async () => {
            const btn = document.getElementById('mmApplyBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>저장 중...';
            try {
                let updated = 0;
                const rows = document.querySelectorAll('.mm-save:checked');
                // 체크된 불일치 항목
                for (const chk of rows) {
                    const idx = parseInt(chk.dataset.idx);
                    const r = window._mmResults[idx];
                    if (!r) continue;
                    const clsSel = document.querySelector(`.mm-class[data-idx="${idx}"]`);
                    const lvlInput = document.querySelector(`.mm-level[data-idx="${idx}"]`);
                    const newClass = clsSel?.value || r.member.class || '';
                    const newLevel = parseInt(lvlInput?.value) || 0;
                    const updateObj = {};
                    if (newClass !== (r.member.class || '')) updateObj.class = newClass;
                    if (newLevel !== (r.member.level || 0)) updateObj.level = newLevel;
                    if (Object.keys(updateObj).length > 0) {
                        const { error } = await supaDb.from('members').update(updateObj).eq('id', r.member.id);
                        if (!error) updated++;
                    }
                }
                // 체크 안 됐어도 수동으로 값을 바꾼 행도 저장
                document.querySelectorAll('.mm-level').forEach(async (inp) => {
                    const idx = parseInt(inp.dataset.idx);
                    const r = window._mmResults[idx];
                    if (!r) return;
                    const chk = document.querySelector(`.mm-save[data-idx="${idx}"]`);
                    if (chk && chk.checked) return; // 이미 처리됨
                    const clsSel = document.querySelector(`.mm-class[data-idx="${idx}"]`);
                    const newClass = clsSel?.value || '';
                    const newLevel = parseInt(inp.value) || 0;
                    const updateObj = {};
                    if (newClass && newClass !== (r.member.class || '')) updateObj.class = newClass;
                    if (newLevel !== (r.member.level || 0)) updateObj.level = newLevel;
                    if (Object.keys(updateObj).length > 0) {
                        await supaDb.from('members').update(updateObj).eq('id', r.member.id);
                        updated++;
                    }
                });
                window.showMsg(updated + '명 업데이트 완료!', 'success');
                await window.fetchMembers();
            } catch(e) {
                window.showMsg('저장 실패: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-1"></i>변경사항 일괄 저장';
            }
        };

        // 중복 테이블 길드 변경 시 직위 갱신
        window._dupGuildChange = (sel) => {
            const tr = sel.closest('tr');
            const roleEl = tr.querySelector('.dup-edit-role');
            const roles = initialGuildRanks[sel.value] || [];
            if (roleEl) roleEl.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
        };

        // 중복 그룹 내 수정사항 저장
        window._dupSaveEdits = async (gi) => {
            const group = window._dupGroups[gi];
            if (!group) return;
            const [, members] = group;
            const groupEl = document.getElementById(`dupGroup_${gi}`);
            if (!groupEl) return;

            const rows = groupEl.querySelectorAll('tbody tr');
            let updated = 0;
            try {
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const m = members[i];
                    const newName = row.querySelector('.dup-edit-name')?.value?.trim();
                    const newGuild = row.querySelector('.dup-edit-guild')?.value;
                    const newRole = row.querySelector('.dup-edit-role')?.value;
                    const newClass = row.querySelector('.dup-edit-class')?.value || '';
                    const newIsMain = row.querySelector('.dup-edit-isMain')?.checked !== false;
                    const newMainChar = row.querySelector('.dup-edit-mainChar')?.value || '';

                    if (!newName) continue;

                    const changes = {};
                    if (newName !== m.name) changes.name = newName;
                    if (newGuild !== m.guild) changes.guild = newGuild;
                    if (newRole !== m.role) changes.role = newRole;
                    if (newClass !== (m.class || '')) changes.class = newClass;
                    if (newIsMain !== (m.is_main !== false)) changes.is_main = newIsMain;
                    if (newMainChar !== (m.main_char_name || '')) changes.main_char_name = newMainChar;

                    if (Object.keys(changes).length > 0) {
                        const { error } = await supaDb.from('members').update(changes).eq('id', m.id);
                        if (error) throw error;
                        
                        const changeDesc = Object.entries(changes).map(([k,v]) => `${k}: ${v}`).join(', ');
                        await supaDb.from('operation_history').insert({
                            date: new Date().toISOString().split('T')[0], category: '수정',
                            name: newName, content: `DB 편집 (#${m.id}) ${changeDesc}`
                        });
                        updated++;
                    }
                }
                if (updated > 0) {
                    window.showMsg(`${updated}건 수정 완료!`, 'success');
                    await window.fetchMembers();
                    window._runDupCheck();
                } else {
                    window.showMsg('변경사항이 없습니다.', 'info');
                }
            } catch (e) {
                window.showMsg('수정 실패: ' + e.message, 'error');
            }
        };

        // 전체 그룹 수정사항 저장
        window._dupSaveAllEdits = async () => {
            if (!window._dupGroups) return;
            let totalUpdated = 0;
            try {
                for (let gi = 0; gi < window._dupGroups.length; gi++) {
                    const [, members] = window._dupGroups[gi];
                    const groupEl = document.getElementById(`dupGroup_${gi}`);
                    if (!groupEl) continue;
                    const rows = groupEl.querySelectorAll('tbody tr');

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const m = members[i];
                        const newName = row.querySelector('.dup-edit-name')?.value?.trim();
                        const newGuild = row.querySelector('.dup-edit-guild')?.value;
                        const newRole = row.querySelector('.dup-edit-role')?.value;
                        const newClass = row.querySelector('.dup-edit-class')?.value || '';
                        const newIsMain = row.querySelector('.dup-edit-isMain')?.checked !== false;
                        const newMainChar = row.querySelector('.dup-edit-mainChar')?.value || '';

                        if (!newName) continue;
                        const changes = {};
                        if (newName !== m.name) changes.name = newName;
                        if (newGuild !== m.guild) changes.guild = newGuild;
                        if (newRole !== m.role) changes.role = newRole;
                        if (newClass !== (m.class || '')) changes.class = newClass;
                        if (newIsMain !== (m.is_main !== false)) changes.is_main = newIsMain;
                        if (newMainChar !== (m.main_char_name || '')) changes.main_char_name = newMainChar;

                        if (Object.keys(changes).length > 0) {
                            const { error } = await supaDb.from('members').update(changes).eq('id', m.id);
                            if (error) throw error;
                            await supaDb.from('operation_history').insert({
                                date: new Date().toISOString().split('T')[0], category: '수정',
                                name: newName, content: `일괄 DB 편집 (#${m.id}) ${Object.entries(changes).map(([k,v])=>`${k}:${v}`).join(', ')}`
                            });
                            totalUpdated++;
                        }
                    }
                }
                if (totalUpdated > 0) {
                    window.showMsg(`총 ${totalUpdated}건 수정 완료!`, 'success');
                    await window.fetchMembers();
                    window._runDupCheck();
                } else {
                    window.showMsg('변경사항이 없습니다.', 'info');
                }
            } catch (e) {
                window.showMsg('일괄 수정 실패: ' + e.message, 'error');
            }
        };

        // 개별 그룹의 미체크 항목 삭제
        window._dupDeleteUnchecked = async (gi) => {
            const group = window._dupGroups[gi];
            if (!group) return;
            const [name, members] = group;

            // 선택된 radio 찾기
            const keepRadio = document.querySelector(`input[name="dupKeep_${gi}"]:checked`);
            if (!keepRadio) { window.showMsg('유지할 데이터를 선택해주세요.', 'error'); return; }
            const keepIdx = parseInt(keepRadio.dataset.mi);
            const keepMember = members[keepIdx];

            const toDelete = members.filter((_, i) => i !== keepIdx);
            if (toDelete.length === 0) return;

            const detail = toDelete.map(m => `  #${m.id} (${m.guild}/${m.role || '-'}/${m.class || '-'})`).join('\n');
            if (!confirm(`"${name}" 중복 정리\n\n✅ 유지: #${keepMember.id} (${keepMember.guild}/${keepMember.role || '-'})\n\n🗑️ 삭제 (${toDelete.length}건):\n${detail}`)) return;

            try {
                const ids = toDelete.map(m => m.id);
                const { error } = await supaDb.from('members').delete().in('id', ids);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    toDelete.map(m => ({ date: new Date().toISOString().split('T')[0], category: '중복삭제', name: m.name, content: `중복 제거 (#${m.id}, ${m.guild}/${m.role || '-'}) — 유지: #${keepMember.id}` }))
                );

                window.showMsg(`"${name}" 중복 ${toDelete.length}건 삭제 완료!`, 'success');
                
                // UI에서 해당 그룹 완료 표시
                const groupEl = document.getElementById(`dupGroup_${gi}`);
                if (groupEl) {
                    groupEl.innerHTML = `<div class="flex items-center gap-3 py-2">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"><i class="fas fa-check text-green-500 text-xs"></i></div>
                        <span class="text-xs font-bold text-green-600">"${name}" 정리 완료 — #${keepMember.id} 유지</span>
                    </div>`;
                }
                await window.fetchMembers();
            } catch (e) {
                window.showMsg('삭제 실패: ' + e.message, 'error');
            }
        };

        // 전체 중복 일괄 정리
        window._dupDeleteAllUnchecked = async () => {
            if (!window._dupGroups || window._dupGroups.length === 0) return;

            let totalDelete = 0;
            const allToDelete = [];

            window._dupGroups.forEach(([name, members], gi) => {
                const keepRadio = document.querySelector(`input[name="dupKeep_${gi}"]:checked`);
                if (!keepRadio) return;
                const keepIdx = parseInt(keepRadio.dataset.mi);
                members.forEach((m, i) => {
                    if (i !== keepIdx) { allToDelete.push({ ...m, keepId: members[keepIdx].id }); totalDelete++; }
                });
            });

            if (totalDelete === 0) { window.showMsg('삭제할 중복 데이터가 없습니다.', 'error'); return; }
            if (!confirm(`총 ${totalDelete}건의 중복 데이터를 삭제하시겠습니까?\n\n각 그룹에서 라디오 버튼으로 선택한 데이터만 유지됩니다.`)) return;

            try {
                const ids = allToDelete.map(m => m.id);
                const { error } = await supaDb.from('members').delete().in('id', ids);
                if (error) throw error;

                await supaDb.from('operation_history').insert(
                    allToDelete.map(m => ({ date: new Date().toISOString().split('T')[0], category: '중복삭제', name: m.name, content: `일괄 중복 제거 (#${m.id}, ${m.guild}/${m.role || '-'}) — 유지: #${m.keepId}` }))
                );

                window.showMsg(`총 ${totalDelete}건의 중복 데이터가 삭제되었습니다!`, 'success');
                await window.fetchMembers();
                window._runDupCheck(); // 결과 새로고침
            } catch (e) {
                window.showMsg('일괄 삭제 실패: ' + e.message, 'error');
            }
        };


        // ═══ 모바일 하단 탭바 ═══
        window._mobileTab = (tab) => {
            router(tab);
        };
        window._mobileOpenMore = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            sb.classList.remove('-translate-x-full');
            ov.classList.remove('hidden');
        };
        window._updateMobileTab = (tab) => {
            document.querySelectorAll('.mobile-tab').forEach(btn => {
                const t = btn.dataset.tab;
                btn.classList.toggle('active', t === tab || (t === 'guide_intro' && tab?.startsWith('guide_')));
            });
        };

        // ═══ 가이드 페이지 렌더 (퍼블릭) ═══
        // --- HOME (통합 페이지: 소개 + 통계 + 직위 + 링크 + 일정) ---
        window.renderHome = async (container) => {
            const guilds = SITE_CONFIG?.guilds || [{name:'뚠카롱'},{name:'뚱카롱'},{name:'밤카롱'},{name:'별카롱'},{name:'달카롱'},{name:'꿀카롱'}];
            const guildColors = {'뚠카롱':'#ec4899','뚱카롱':'#e11d48','밤카롱':'#6366f1','별카롱':'#ca8a04','달카롱':'#2563eb','꿀카롱':'#d97706'};
            
            const replacePlaceholders = (html) => {
                if(!html) return '';
                html = html.replace(/\{\{뚠카롱_count\}\}/g, appState.members.filter(m=>m.guild==='뚠카롱').length);
                html = html.replace(/\{\{뚱카롱_count\}\}/g, appState.members.filter(m=>m.guild==='뚱카롱').length);
                html = html.replace(/\{\{부캐_count\}\}/g, appState.members.filter(m=>['밤카롱','별카롱','달카롱','꿀카롱'].includes(m.guild)).length);
                html = html.replace(/\{\{전체_count\}\}/g, appState.members.length);
                return html;
            };

            // border 클래스 strip (DB HTML에 하드코딩된 border 제거)
            const stripBorder = (html) => {
                if(!html) return '';
                return html.replace(/\bborder\b/g, '')
                    .replace(/\bborder-gray-100\b/g, '')
                    .replace(/\bborder-gray-200\b/g, '')
                    .replace(/\bborder-pink-100\b/g, '')
                    .replace(/\bborder-pink-200\/50\b/g, '')
                    .replace(/\bborder-red-100\b/g, '')
                    .replace(/\bborder-blue-100\b/g, '');
            };

            // 가이드 3개 병렬 로드
            let introHtml = '', ranksHtml = '', linksHtml = '';
            try {
                const [introRes, ranksRes, linksRes] = await Promise.all([
                    supaDb.from('guide_pages').select('content').eq('slug','intro').maybeSingle(),
                    supaDb.from('guide_pages').select('content').eq('slug','ranks').maybeSingle(),
                    supaDb.from('guide_pages').select('content').eq('slug','links').maybeSingle()
                ]);
                introHtml = stripBorder(replacePlaceholders(introRes.data?.content || ''));
                ranksHtml = stripBorder(replacePlaceholders(ranksRes.data?.content || ''));
                linksHtml = stripBorder(replacePlaceholders(linksRes.data?.content || ''));
            } catch(e) { console.error('Guide load error:', e); }

            // 통계 카드
            const statsCards = guilds.map(g => {
                const cnt = appState.members.filter(m => m.guild === g.name).length;
                const color = guildColors[g.name] || '#888';
                const shortName = g.name.replace('카롱','');
                return `<div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl p-3 text-center shadow-sm">
                    <div class="text-xl font-black" style="color:${color}">${cnt}</div>
                    <div class="text-[9px] font-bold text-gray-400 mt-0.5 tracking-wider">${shortName}카롱</div>
                </div>`;
            }).join('');

            // 이벤트 로드
            let eventsHtml = '';
            try {
                const { data: events } = await supaDb.from('events').select('*').order('date', { ascending: false }).limit(5);
                if (events && events.length > 0) {
                    eventsHtml = events.map(ev => `<div class="min-w-[150px] p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 flex-shrink-0">
                        <div class="text-[10px] font-bold text-pink-500">${ev.date || ''}</div>
                        <div class="text-xs font-bold text-gray-700 dark:text-gray-200 mt-0.5">${ev.title || ''}</div>
                    </div>`).join('');
                }
            } catch(e) { console.error('Events load error:', e); }

            const editBtn = isAdmin() ? `<button onclick="router('guide_edit')" class="text-[9px] font-bold text-pink-400 hover:text-pink-600 bg-pink-50 dark:bg-pink-900/30 px-2 py-1 rounded-lg transition-all"><i class="fas fa-edit mr-1"></i>편집</button>` : '';

            container.innerHTML = `<div class="flex flex-col gap-4 fade-in">
                <!-- 길드 소개 + 규칙 (DB HTML) -->
                <div class="relative">
                    <div class="absolute right-4 top-3 z-20">${editBtn}</div>
                    <div class="home-guide-content">${introHtml || '<div class="bg-gradient-to-br from-pink-50 via-rose-50 to-purple-50 dark:from-gray-800 dark:via-gray-800 dark:to-gray-800 p-6 rounded-2xl"><h3 class="text-lg font-black text-gray-800 dark:text-gray-100">뚠카롱에 오신 것을 환영합니다!</h3><p class="text-sm text-gray-500 mt-2">메이플스토리 리부트2 서버 길드 연합입니다.</p></div>'}</div>
                </div>

                <!-- 직위 안내 -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 relative">
                    <div class="absolute right-4 top-3 z-20">${editBtn}</div>
                    <h4 class="text-sm font-black text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2"><i class="fas fa-medal text-pink-400"></i>직위 안내</h4>
                    <div class="home-guide-content">${ranksHtml || '<p class="text-xs text-gray-400">직위 정보가 없습니다.</p>'}</div>
                </div>

                <!-- 링크 모음 -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 relative">
                    <div class="absolute right-4 top-3 z-20">${editBtn}</div>
                    <h4 class="text-sm font-black text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2"><i class="fas fa-link text-pink-400"></i>링크 모음</h4>
                    <div class="home-guide-content">${linksHtml || '<p class="text-xs text-gray-400">링크 정보가 없습니다.</p>'}</div>
                </div>

                <!-- 최근 일정 -->
                ${eventsHtml ? `<div class="bg-white dark:bg-gray-800 rounded-2xl p-5">
                    <h4 class="text-sm font-black text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2"><i class="fas fa-calendar text-pink-400"></i>최근 일정</h4>
                    <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">${eventsHtml}</div>
                </div>` : ''}
            </div>`;
            // guide DB HTML에 하드코딩된 border를 inline style로 강제 제거
            setTimeout(() => {
                container.querySelectorAll('.home-guide-content, .home-guide-content *').forEach(el => {
                    el.style.borderColor = 'transparent';
                    el.style.borderWidth = '0';
                });
            }, 50);
        };

        // --- 직위 반영 (관리자 전용 페이지) ---
        window.renderRoleAssign = (container) => {
            container.innerHTML = `<div class="flex flex-col gap-4 fade-in">
                <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-3 text-xs font-bold text-amber-700 dark:text-amber-300">
                    <i class="fas fa-lock mr-1"></i> 관리자 전용 — 수로 점수 기반 직위 자동 반영
                </div>

                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl p-5">
                    <h4 class="text-sm font-black text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2"><i class="fas fa-medal text-amber-500"></i>직위 자동 부여</h4>
                    <p class="text-xs text-gray-500 mb-3">최근 수로 점수 기준으로 직위를 산정합니다. 마카롱/다쿠아즈 제외, 본캐만 대상.</p>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="window.autoAssignRoles()" class="px-4 py-2.5 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold transition-all shadow"><i class="fas fa-magic mr-1"></i>뚠카롱 직위 산정</button>
                        <button onclick="window.autoAssignRolesDdung()" class="px-4 py-2.5 bg-rose-500 hover:bg-rose-600 text-white rounded-xl text-xs font-bold transition-all shadow"><i class="fas fa-magic mr-1"></i>뚱카롱 직위 산정</button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl p-5">
                    <h4 class="text-sm font-black text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2"><i class="fas fa-coffee text-purple-500"></i>아인슈페너 강등 검사</h4>
                    <p class="text-xs text-gray-500 mb-3">본캐가 크로칸슈 미달인 아인슈페너 멤버를 감지하고, 바로 강등할 수 있습니다. (아인슈페너는 신청제 → 자동 부여 ❌, 강등만)</p>
                    <button onclick="window._checkEinDemotion()" class="px-4 py-2.5 bg-purple-500 hover:bg-purple-600 text-white rounded-xl text-xs font-bold transition-all shadow"><i class="fas fa-search mr-1"></i>강등 대상 검사</button>
                    <div id="einDemotionResult" class="mt-3"></div>
                </div>

                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl p-5">
                    <h4 class="text-sm font-black text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2"><i class="fas fa-user-check text-blue-500"></i>본캐 정보 오기입 검사</h4>
                    <p class="text-xs text-gray-500 mb-3">본캐 닉네임이 DB에 없거나, 본캐 필드가 잘못 설정된 멤버를 검사합니다.</p>
                    <button onclick="window._checkMainCharErrors()" class="px-4 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-xl text-xs font-bold transition-all shadow"><i class="fas fa-search mr-1"></i>오기입 검사</button>
                    <div id="mainCharErrorResult" class="mt-3"></div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-3 text-xs text-blue-700 dark:text-blue-300 leading-relaxed">
                    <i class="fas fa-info-circle mr-1"></i>
                    직위 산정 후 <strong>변경 컬럼 드롭다운</strong>으로 수동 수정 가능 · <strong>체크박스 해제</strong>로 특정 멤버 제외
                </div>
            </div>`;
        };

        // 아인슈페너 강등 대상 검사 + 실제 강등 실행
        // ── 본캐 정보 오기입 검사 ──
        window._checkMainCharErrors = () => {
            const members = appState.members;
            const nameSet = new Set(members.map(m => m.name));
            const errors = [];

            members.forEach(m => {
                const mainName = (m.mainCharName || '').trim();

                // 1) 부캐인데 본캐 필드가 비어있음
                if(!m.isMain && !mainName) {
                    errors.push({ type: 'empty', id: m.id, name: m.name, guild: m.guild, currentMain: '', msg: '부캐인데 본캐 필드가 비어있음' });
                    return;
                }

                if(m.isMain) {
                    // 2) 본캐인데 자기 이름을 써놓음 → 비워야 함
                    if(mainName && mainName === m.name) {
                        errors.push({ type: 'self_ref', id: m.id, name: m.name, guild: m.guild, currentMain: mainName, msg: '본캐인데 본캐필드에 자기 이름' });
                        return;
                    }
                    // 3) 본캐인데 다른 사람 이름 → isMain이 잘못 설정됨
                    if(mainName && mainName !== m.name && nameSet.has(mainName)) {
                        errors.push({ type: 'wrong_main', id: m.id, name: m.name, guild: m.guild, currentMain: mainName, msg: `본캐인데 본캐필드가 "${mainName}"` });
                    }
                    return;
                }

                // 부캐 검사
                if(mainName) {
                    // 4) 본캐 닉네임이 DB에 없음
                    if(!nameSet.has(mainName)) {
                        errors.push({ type: 'not_found', id: m.id, name: m.name, guild: m.guild, currentMain: mainName, msg: `본캐 "${mainName}" DB에 없음` });
                    }
                }
            });

            const el = document.getElementById('mainCharErrorResult');
            if(errors.length === 0) {
                el.innerHTML = '<div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-xl text-xs font-bold text-green-600"><i class="fas fa-check mr-1"></i>오기입 없음 — 본캐 정보가 모두 정상입니다.</div>';
                return;
            }

            window._mainCharErrors = errors;

            // 본캐 목록 (자동완성용 datalist)
            const mainChars = members.filter(m => m.isMain).map(m => m.name).sort();
            let datalist = `<datalist id="mainCharSuggest">${mainChars.map(n => `<option value="${n}">`).join('')}</datalist>`;

            const typeLabels = {
                empty: { label: '본캐 필드 비어있음', color: 'amber', icon: 'fa-exclamation' },
                not_found: { label: 'DB에 없는 본캐', color: 'red', icon: 'fa-question-circle' },
                self_ref: { label: '본캐인데 자기 이름 입력', color: 'orange', icon: 'fa-sync' },
                wrong_main: { label: '본캐인데 다른 사람 지정', color: 'purple', icon: 'fa-exchange-alt' }
            };

            const byType = {};
            errors.forEach(e => { if(!byType[e.type]) byType[e.type] = []; byType[e.type].push(e); });

            let html = `<div class="space-y-2 mt-2">${datalist}
                <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-xl text-xs font-bold text-red-600 dark:text-red-400 flex justify-between items-center">
                    <span><i class="fas fa-exclamation-triangle mr-1"></i>오기입 ${errors.length}건 발견</span>
                    <button onclick="window._saveMainCharFixes()" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-[10px] font-bold transition-all shadow"><i class="fas fa-save mr-1"></i>수정사항 일괄 저장</button>
                </div>`;

            Object.entries(byType).forEach(([type, list]) => {
                const t = typeLabels[type];
                html += `<div class="rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700">
                    <div class="px-3 py-2 bg-${t.color}-100 dark:bg-${t.color}-900/40 text-xs font-bold text-${t.color}-700 dark:text-${t.color}-300"><i class="fas ${t.icon} mr-1"></i>${t.label} (${list.length}건)</div>`;
                list.forEach((e, i) => {
                    const fixType = type === 'wrong_main' ? 'clear' : 'set';
                    html += `<div class="flex items-center gap-2 px-3 py-2 border-b border-gray-100 dark:border-gray-700 text-xs last:border-b-0 flex-wrap">
                        <input type="checkbox" data-fix-chk="${e.id}" class="mainchar-chk w-3.5 h-3.5 accent-blue-500 cursor-pointer shrink-0">
                        <span class="font-bold text-gray-700 dark:text-gray-300 w-24 shrink-0">${e.name}</span>
                        <span class="text-gray-400 text-[10px] w-16 shrink-0">${e.guild}</span>
                        <span class="text-${t.color}-600 dark:text-${t.color}-400 text-[10px] flex-1">${e.msg}</span>
                        <span class="text-[10px] text-gray-400 shrink-0">→</span>
                        ${type === 'wrong_main'
                            ? `<select data-fix-id="${e.id}" data-fix-type="wrong_main" class="mainchar-fix bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-36 shrink-0" onchange="this.closest('div').querySelector('.mainchar-chk').checked=true">
                                <option value="__keep__">수정 안함</option>
                                <option value="__to_alt__">부캐로 변경 (본캐: ${e.currentMain})</option>
                                <option value="__clear__">본캐 필드 비우기</option>
                            </select>`
                        : type === 'self_ref'
                            ? `<select data-fix-id="${e.id}" data-fix-type="self_ref" class="mainchar-fix bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-36 shrink-0" onchange="this.closest('div').querySelector('.mainchar-chk').checked=true">
                                <option value="__keep__">수정 안함</option>
                                <option value="__clear__">본캐 필드 비우기</option>
                            </select>`
                            : `<input list="mainCharSuggest" data-fix-id="${e.id}" data-fix-type="normal" class="mainchar-fix bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-2 py-1 text-[10px] font-bold outline-none w-28 shrink-0" placeholder="본캐 닉네임" value="${e.currentMain}" oninput="this.closest('div').querySelector('.mainchar-chk').checked=true">`
                        }
                    </div>`;
                });
                html += `</div>`;
            });

            html += `</div>`;
            el.innerHTML = html;
        };

        window._saveMainCharFixes = async () => {
            // 체크된 ID 수집
            const checkedIds = new Set();
            document.querySelectorAll('.mainchar-chk:checked').forEach(el => checkedIds.add(el.dataset.fixChk));

            const fixes = {};
            document.querySelectorAll('.mainchar-fix').forEach(el => {
                const id = el.dataset.fixId;
                if(!checkedIds.has(id)) return; // 체크 안 된 건 스킵
                const fixType = el.dataset.fixType;
                const val = (el.value || '').trim();

                if(fixType === 'wrong_main' || fixType === 'self_ref') {
                    if(val === '__keep__') return; // 수정 안함
                    const orig = (window._mainCharErrors || []).find(e => e.id === id);
                    if(val === '__to_alt__') {
                        // 본캐→부캐로 변경, mainCharName 유지
                        fixes[id] = { isMain: false, mainCharName: orig?.currentMain || '' };
                    } else if(val === '__clear__') {
                        // 본캐 필드 비우기 (isMain 유지)
                        fixes[id] = { mainCharName: '' };
                    }
                } else {
                    const orig = (window._mainCharErrors || []).find(e => e.id === id);
                    if(orig && val !== orig.currentMain) {
                        fixes[id] = { mainCharName: val };
                    }
                }
            });

            const fixCount = Object.keys(fixes).length;
            if(fixCount === 0) return window.showMsg('변경된 항목이 없습니다.', 'error');
            if(!confirm(fixCount + '건의 본캐 정보를 수정하시겠습니까?')) return;

            window.showLoading(true);
            window.setLoadProgress(30, '본캐 정보 수정 중...');

            let done = 0;
            for(const [id, fix] of Object.entries(fixes)) {
                const updateData = {};
                if(fix.mainCharName !== undefined) updateData.main_char_name = fix.mainCharName;
                if(fix.isMain !== undefined) updateData.is_main = fix.isMain;
                await supaDb.from('members').update(updateData).eq('id', id);
                done++;
                window.setLoadProgress(30 + Math.floor(60 * done / fixCount), `${done}/${fixCount} 수정 중...`);
            }

            window.setLoadProgress(95, '데이터 갱신 중...');
            window.showMsg(fixCount + '건 본캐 정보 수정 완료!', 'success');
            await window.fetchMembers();
            window._checkMainCharErrors();
            window.showLoading(false);
        };

        window._checkEinDemotion = () => {
            const einMembers = appState.members.filter(m => m.role === '아인슈페너');
            if(einMembers.length === 0) {
                document.getElementById('einDemotionResult').innerHTML = '<p class="text-xs text-gray-400 mt-2">아인슈페너 멤버가 없습니다.</p>';
                return;
            }

            // 본캐별로 아인슈페너 그룹핑
            const mainMap = {};
            einMembers.forEach(m => {
                const mainName = m.mainCharName || '';
                if(!mainName) return;
                if(!mainMap[mainName]) {
                    const mainChar = appState.members.find(mc => mc.name === mainName);
                    const allAlts = appState.members.filter(mc => mc.mainCharName === mainName && mc.name !== mainName);
                    mainMap[mainName] = { main: mainChar, einList: [], allAltCount: allAlts.length };
                }
                mainMap[mainName].einList.push(m);
            });

            const demotions = [];
            const warnings = [];

            Object.entries(mainMap).forEach(([mainName, info]) => {
                const mainChar = info.main;
                const einList = info.einList;
                const altCount = info.allAltCount;
                const mainRole = mainChar?.role || '알수없음';

                if(['스콘','반죽(휴면)','뚠스콘'].includes(mainRole)) {
                    einList.forEach(m => {
                        demotions.push({ name: m.name, guild: m.guild, id: m.id, mainName, mainRole, reason: '본캐 스콘/반죽' });
                    });
                    return;
                }

                if(['팬케이크','롤케이크','부팬케이크','부케이크'].includes(mainRole)) {
                    const allowed = Math.floor(altCount / 2);
                    const einCount = einList.length;
                    if(einCount > allowed) {
                        warnings.push({
                            mainName, mainRole, altCount, allowed, einCount, excess: einCount - allowed,
                            einList: einList.map(m => ({ name: m.name, guild: m.guild, id: m.id }))
                        });
                    }
                    return;
                }
            });

            const el = document.getElementById('einDemotionResult');
            if(demotions.length === 0 && warnings.length === 0) {
                el.innerHTML = '<div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-xl text-xs font-bold text-green-600 mt-2"><i class="fas fa-check mr-1"></i>강등/초과 대상 없음</div>';
                return;
            }

            let html = '';

            if(demotions.length > 0) {
                const byGuild = {};
                demotions.forEach(d => { if(!byGuild[d.guild]) byGuild[d.guild] = []; byGuild[d.guild].push(d); });
                html += `<div class="bg-red-50 dark:bg-red-900/20 rounded-xl overflow-hidden border border-red-200 dark:border-red-800 mt-2">
                    <div class="p-3 bg-red-100 dark:bg-red-900/40 text-xs font-bold text-red-700 dark:text-red-300"><i class="fas fa-ban mr-1"></i>본캐 스콘/반죽 \u2014 아인슈페너 전부 압수 (${demotions.length}명)</div>`;
                Object.keys(byGuild).sort().forEach(guild => {
                    html += `<div class="px-3 py-1.5 bg-red-50/50 text-[10px] font-bold text-red-500 border-b border-red-100">${guild} (${byGuild[guild].length}명)</div>`;
                    byGuild[guild].forEach(d => {
                        html += `<div class="flex items-center gap-3 px-3 py-2 border-b border-red-50 text-xs">
                            <input type="checkbox" checked data-ein-id="${d.id}" class="ein-chk w-4 h-4 accent-red-500 cursor-pointer">
                            <span class="font-bold text-red-600 w-28">${d.name}</span>
                            <span class="text-gray-400">본캐: ${d.mainName} (${d.mainRole})</span>
                        </div>`;
                    });
                });
                html += `<div class="p-3 flex justify-between items-center">
                    <span class="text-[10px] text-red-400">체크된 멤버의 아인슈페너 직위를 해제합니다.</span>
                    <button onclick="window._executeEinDemotion()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl text-xs font-bold transition-all shadow"><i class="fas fa-arrow-down mr-1"></i>강등 실행</button>
                </div></div>`;
            }

            if(warnings.length > 0) {
                html += `<div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl overflow-hidden border border-amber-200 dark:border-amber-800 mt-3">
                    <div class="p-3 bg-amber-100 dark:bg-amber-900/40 text-xs font-bold text-amber-700 dark:text-amber-300"><i class="fas fa-exclamation-triangle mr-1"></i>면제 초과 \u2014 아인슈페너 수 > 허용수 (${warnings.length}건)</div>`;
                warnings.forEach(w => {
                    html += `<div class="p-3 border-b border-amber-100 dark:border-amber-800">
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <span class="font-bold text-amber-700 text-xs">${w.mainName}</span>
                            <span class="text-[10px] text-gray-400">(${w.mainRole})</span>
                            <span class="text-[10px] bg-amber-200 text-amber-700 px-2 py-0.5 rounded-full font-bold">부캐 ${w.altCount}명 \u00b7 허용 ${w.allowed}명 \u00b7 아인슈페너 ${w.einCount}명 \u00b7 <span class="text-red-600">${w.excess}명 초과</span></span>
                        </div>
                        <div class="space-y-1">`;
                    w.einList.forEach(e => {
                        html += `<div class="flex items-center gap-2 text-xs text-gray-600 pl-2">
                            <input type="checkbox" data-ein-id="${e.id}" class="ein-warn-chk w-3.5 h-3.5 accent-amber-500 cursor-pointer">
                            <span>${e.name}</span> <span class="text-gray-300">(${e.guild})</span>
                        </div>`;
                    });
                    html += `</div>
                        <p class="text-[10px] text-amber-500 mt-2"><i class="fas fa-info-circle mr-1"></i>${w.excess}명의 아인슈페너 직위를 해제하거나, 부캐를 추가 가입해주세요.</p>
                    </div>`;
                });
                html += `<div class="p-3 flex justify-between items-center">
                    <span class="text-[10px] text-amber-500">체크한 멤버만 아인슈페너 해제</span>
                    <button onclick="window._executeEinWarning()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold transition-all shadow"><i class="fas fa-arrow-down mr-1"></i>선택 강등</button>
                </div></div>`;
            }

            el.innerHTML = html;
            window._einDemotions = demotions;
        };

        window._executeEinDemotion = async () => {
            const allDemotions = window._einDemotions || [];
            const checkedIds = new Set();
            document.querySelectorAll('.ein-chk:checked').forEach(c => checkedIds.add(c.dataset.einId));
            const targets = allDemotions.filter(d => checkedIds.has(d.id));
            if(targets.length === 0) return window.showMsg('선택된 강등 대상이 없습니다.', 'error');
            if(!confirm(targets.length + '명의 아인슈페너 직위를 해제하시겠습니까?')) return;
            window.showLoading(true);
            let done = 0;
            for(const t of targets) {
                const newRole = t.guild === '뚠카롱' ? '스콘' : '뚠스콘';
                await supaDb.from('members').update({ role: newRole }).eq('id', t.id);
                done++;
                window.setLoadProgress(20 + Math.floor(60 * done / targets.length), `${done}/${targets.length} 강등 중...`);
            }
            window.showMsg(targets.length + '명 아인슈페너 강등 완료!', 'success');
            await window.fetchMembers();
            window.renderRoleAssign(document.getElementById('contentArea'));
            window.showLoading(false);
        };

        window._executeEinWarning = async () => {
            const checkedIds = new Set();
            document.querySelectorAll('.ein-warn-chk:checked').forEach(c => checkedIds.add(c.dataset.einId));
            if(checkedIds.size === 0) return window.showMsg('강등할 멤버를 체크해주세요.', 'error');
            if(!confirm(checkedIds.size + '명의 아인슈페너 직위를 해제하시겠습니까?')) return;
            window.showLoading(true);
            let done = 0;
            const ids = [...checkedIds];
            for(const id of ids) {
                const m = appState.members.find(mm => mm.id === id);
                const newRole = m?.guild === '뚠카롱' ? '스콘' : '뚠스콘';
                await supaDb.from('members').update({ role: newRole }).eq('id', id);
                done++;
                window.setLoadProgress(20 + Math.floor(60 * done / ids.length), `${done}/${ids.length} 강등 중...`);
            }
            window.showMsg(ids.length + '명 아인슈페너 강등 완료!', 'success');
            await window.fetchMembers();
            window.renderRoleAssign(document.getElementById('contentArea'));
            window.showLoading(false);
        };

        window.renderGuide = async (container, section) => {
            const guideTab = section || 'intro';
            container.innerHTML = '<div class="p-4 text-center text-gray-300 font-bold text-xs">로딩 중...</div>';
            try {
                const { data, error } = await supaDb.from('guide_pages').select('content').eq('slug', guideTab).maybeSingle();
                if (error) throw error;
                let body = data?.content || '<p class="text-gray-400 text-center">내용이 없습니다.</p>';
                body = body.replace(/\{\{뚠카롱_count\}\}/g, appState.members.filter(m=>m.guild==='뚠카롱').length);
                body = body.replace(/\{\{뚱카롱_count\}\}/g, appState.members.filter(m=>m.guild==='뚱카롱').length);
                body = body.replace(/\{\{부캐_count\}\}/g, appState.members.filter(m=>['밤카롱','별카롱','달카롱','꿀카롱'].includes(m.guild)).length);
                body = body.replace(/\{\{전체_count\}\}/g, appState.members.length);
                container.innerHTML = `<div class="flex flex-col gap-4 fade-in h-full"><div class="flex-1 overflow-y-auto no-scrollbar">${body}</div></div>`;
            } catch(e) {
                console.error(e);
                container.innerHTML = '<p class="text-red-400 text-center font-bold text-xs p-10">가이드 로딩 실패</p>';
            }
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initSidebar();
            await window._authCheck();
            window.fetchMembers();
        });
    </script>
</body>
</html>
